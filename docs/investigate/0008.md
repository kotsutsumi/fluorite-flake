# 現状の実装に対して、pnpm test runで実行するテストが不足していないか？

## 調査概要
- 調査日: 2025-10-07
- 対象コマンド: `pnpm test run`（= `vitest run`）
- 目的: 既定のテスト実行コマンドで、現状のテストスイートを過不足なくカバーできているかを確認する

## 実施内容
1. `package.json` のテスト関連スクリプトと `vitest.config.ts` を確認し、対象ディレクトリやプロジェクト設定を整理。
2. `pnpm test run` を実行し、Vitest が検出したテストファイル数・内訳・失敗内容を記録。
3. `test/` 配下の全 `.test.ts` を列挙し、コマンド実行結果と差分を比較。
4. 実行対象外になっているテスト群と、その原因を特定。

## 実行結果ハイライト
- `pnpm test run` 実行時の Vitest バージョンは 3.2.4。収集されたテストファイル数は **29 ファイル**、すべて `test/unit` 配下のユニットテストのみ。
- テスト全体のサマリは「Test Files 5 failed | 24 passed (29)」。失敗の大半は `test/unit/src/utils/monorepo-generator/copy-templates.test.ts` の `vi.mocked(...).mockReturnValue` 呼び出しで発生する `TypeError` に起因。
- 実行時間は 32.38 秒で、CLI 側のタイムアウトによりコマンドは exit code 124 となったが、Vitest はテスト完了レポートを出力済み。
- `find test -name "*.test.ts"` で算出した総テストファイル数は **33 ファイル**。したがって、`pnpm test run` では 4 ファイルが未実行。

## テストスイートのカバレッジ整理
| 種別 | 配置パス | 想定される実行コマンド | `pnpm test run` での実行可否 | 備考 |
| ---- | -------- | ---------------------- | ----------------------------- | ---- |
| Unit | `test/unit/**/*.test.ts` | `pnpm test run` / `pnpm test:unit:run` | ✅ 実行される | 29 ファイル。現状幾つか失敗テストあり。 |
| Integration | `test/integration/**/*.test.ts` | `pnpm vitest run --config vitest.config.ts --related` 等 | ❌ 実行されない | `vitest.config.ts` が `test/functional/**/*.test.ts` を参照しており、ディレクトリ名不一致。 |
| E2E | `test/e2e/specs/**/*.test.ts` | `pnpm test:e2e:run` | ❌ 実行されない | E2E 用の別設定 `vitest.e2e.config.ts` が必要。 |
| （未使用カテゴリ）Functional/Scenario | 該当ディレクトリなし | ― | ― | 過去構成の名残。`vitest.config.ts` から除外候補。 |

## 不足しているテスト群の詳細
### Integration テスト (`test/integration`)
- 現在 1 ファイル（`test/integration/turso-bootstrap.test.ts`）が存在するが、`vitest.config.ts` の `projects` で `include: ["test/functional/**/*.test.ts"]` と記述されているため検出対象外。
- その結果、Turso ブートストラップ周りの統合検証が `pnpm test run` では一切カバーされない。
- 対応案: ディレクトリ名を `test/functional` にリネームする、または設定を `test/integration/**/*.test.ts` に修正する。

### E2E テスト (`test/e2e`)
- 3 ファイル（CLI 基本操作・ダッシュボード・プロジェクト生成）を `vitest.e2e.config.ts` で定義しており、`pnpm test:e2e:run` でのみ実行できる。
- `pnpm test run` からは参照されていないため、CI で E2E を含めたい場合は別コマンドを明示的に呼ぶ必要がある。
- 対応案: `pnpm test:all` に E2E を含める／統合用スクリプトを追加してドキュメント化する。

### 旧カテゴリ設定の残置 (`functional` / `scenario`)
- `vitest.config.ts` には `test/functional` と `test/scenario` 用のプロジェクトが定義されているが、該当ディレクトリはリポジトリ内に存在しない。
- 将来的に再利用する予定がなければ、設定を整理することで実行ログのノイズを減らせる。

## リスクと影響
- 統合テストと E2E テストが実行されないため、CLI 全体のフローや外部サービス連携のリグレッションを `pnpm test run` だけでは検知できない。
- テスト失敗（`vi.mocked` の TypeError）によりユニットテスト群の信頼性も低下しており、CI でのブロッカーになり得る。
- テスト種別ごとの実行コマンドが分散しているため、新規メンバーや自動化フローでの実行漏れが発生しやすい。

## 推奨アクション
1. `vitest.config.ts` の `projects` を現行ディレクトリ構成に合わせて更新し、`test/integration` を正しく拾うよう修正する。
2. 統合・E2E テストを含む統合コマンド（例: `pnpm test:ci` = unit + integration + e2e）を定義し、README や Contributing ガイドに記載する。
3. 失敗しているユニットテストのモック初期化を修正し、`pnpm test run` 単体でグリーンになる状態を復旧する。
4. `vitest.config.ts` から未使用の `functional` / `scenario` 設定を削除するか TODO コメントで意図を明記し、混乱を避ける。

## 追加メモ
- `pnpm test run` は watch モードではないため、開発中に逐次実行する場合は `pnpm test`（watch モード）との使い分けを整理するのが望ましい。
- GitHub Actions 等の CI で一括実行する際は、上記推奨アクションを踏まえたスクリプト構成への見直しを検討する。
