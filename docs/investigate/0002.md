# Next.jsプロジェクト生成時、Tursoのデータベースにテーブルが作られない・シーダーが実行されない問題を解決する

## 背景

- `fluorite create` コマンドで Next.js (fullstack admin) テンプレートを生成し、データベースプロバイダとして Turso を選択した場合を対象とする。
- 生成物には `pnpm predev`/`prestart` フックとして `scripts/ensure-db.ts` が組み込まれており、初回起動時に Prisma スキーマの反映 (`pnpm db:push`) とシード投入 (`pnpm db:seed`) を自動実行する想定。
- しかし実際には、Turso 側にテーブルが存在せず、データの投入も行われていないとの報告があり、初期セットアップが失敗している疑いがある。

## 現象

- 生成したプロジェクトで `pnpm dev` あるいは `pnpm predev` を実行しても Turso (libsql) インスタンス上にテーブルが作成されない。
- `pnpm db:seed` を個別に実行しても、Turso 側にはレコードが登録されず、`prisma/dev.db` (SQLite) にデータが追加される。
- Prisma CLI 実行ログにはエラーが出ず、コマンド自体は正常終了するため失敗に気づきにくい。

## 再現手順

1. `fluorite create` を実行し、テンプレートを `nextjs-fullstack-admin`、データベースを Turso に設定する。
2. 生成されたプロジェクトディレクトリへ移動し、`.env.local` に `DATABASE_URL=libsql://...` と `TURSO_AUTH_TOKEN=...` を設定する。
3. `pnpm install && pnpm dev` を実行する（`predev` フックで `scripts/ensure-db.ts` が走る）。
4. Turso ダッシュボード、または `turso db shell` でテーブル一覧を確認する。

### 期待結果

- Prisma の `db push` が Turso に対して実行され、必要なテーブルが作成される。
- シーダー (`prisma/seed.ts`) が Turso に接続し、初期データが投入される。

### 実際の結果

- `prisma/dev.db` (ローカル SQLite) にテーブルが生成され、Turso 側は空のまま。
- `pnpm db:seed` 実行時も同じく SQLite にデータが追加され、Turso 側にはデータが存在しない。

## 調査ログ

- `templates/nextjs-fullstack-admin/scripts/ensure-db.ts` では `normalizeLocalDatabaseEnv` が `file:` スキーマの URL を優先して `DATABASE_URL` 系の環境変数を上書きする。
- `templates/nextjs-fullstack-admin/src/lib/db.ts` では、Turso 利用時でも Prisma CLI 用に `PRISMA_DATABASE_URL` を `file:./prisma/dev.db` に埋め戻す処理が存在する。
- その結果、`ensure-db.ts` が Prisma CLI (`pnpm db:push`, `pnpm db:seed`) を呼び出す際に、環境変数 `DATABASE_URL`/`PRISMA_DATABASE_URL` が SQLite 向けに書き換わり、CLI が Turso ではなくローカルファイルに対して実行される。
- Prisma CLI がローカル SQLite にアクセスするため、Turso 側に変更が反映されず、`seed.ts` も SQLite に接続してしまう。

## 根本原因

- Turso で `libsql://` URL を指定している場合でも、`ensure-db.ts` 内の環境変数正規化処理が `PRISMA_DATABASE_URL` の `file:` URL を検出して「ローカル SQLite 利用」と誤判定し、CLI 実行時にローカルファイルへ接続先を切り替えてしまうことが原因。
- これは `lib/db.ts` が Prisma Client 用のフォールバックとして `PRISMA_DATABASE_URL=file:./prisma/dev.db` を設定する実装と干渉しているために発生している。

## 影響範囲

- Turso (libsql) を利用する生成プロジェクト全体。Supabase (PostgreSQL) では再現しない。
- プロジェクト初期セットアップ時にデータベースが空のままになるため、アプリケーションのログイン・ダッシュボード機能が正常に機能しない。
- 気づかず開発を進めると、本番環境にデプロイした際にデータ初期化手順が欠落するリスクがある。

## 対応策候補

1. **CLI 実行時の環境変数優先順序を修正する**  
   - `ensure-db.ts` で `libsql://` が指定されている場合は `PRISMA_DATABASE_URL` を上書きしない、または `DATABASE_URL` の値を優先して CLI を実行する。  
   - Prisma CLI が Turso に接続できるように `--url` パラメータで明示する案も検討。
2. **`lib/db.ts` のフォールバックロジックを条件付きにする**  
   - `DATABASE_URL` が `libsql://` である場合は `PRISMA_DATABASE_URL` を `file:` に書き換えない。  
   - または、Prisma Client と CLI の接続先を分離する設定（`prisma/schema.prisma` で `env("DIRECT_DATABASE_URL")` など）を導入して衝突を防ぐ。
3. **初期セットアップの検証コマンドを追加する**  
   - `predev` 実行後に `turso db shell --execute "SELECT name FROM sqlite_master..."` のようなヘルスチェックを行い、Turso 側への適用可否を判定して警告を出す。

## 実装タスク案

- [ ] `ensure-db.ts` 内で `libsql://` ケースを検出し、Prisma CLI の実行環境を Turso 用 URL に固定する。
- [ ] `lib/db.ts` の `ensurePrismaEnv` 呼び出し条件を見直し、`PRISMA_DATABASE_URL` が未定義かつローカルファイル利用時のみ設定するよう修正する。
- [ ] Prisma CLI 実行後にテーブル存在チェックを行い、失敗時はエラーで停止させるログを追加する。
- [ ] ドキュメント（README / `docs/getting-started` 等）に Turso 環境の検証手順とトラブルシュートを追記する。

## 懸念・フォローアップ

- Prisma CLI が `libsql://` を扱う際に `TURSO_AUTH_TOKEN` をどのように受け取るか検証が必要（環境変数か `.env` ファイルに依存）。  
- 今後 Supabase など他プロバイダ追加時に同様の環境変数競合が起きないかを確認し、共通ユーティリティ化する余地がある。  
- CI (`scripts/ci-db.sh`) でも同様の環境変数上書きが発生していないか要チェック。  
- 既に生成済みプロジェクト利用者向けに、データベースを再初期化する手順（`pnpm db:reset` など）と注意喚起を共有する必要がある。  

## 次のアクション

- 優先度高: CLI 実行時に Turso へ正しく接続するよう実装修正し、テンプレートの挙動を再検証する。
- 優先度中: 既存プロジェクトへの影響を調査し、修正内容のマイグレーションガイドを作成する。
- 優先度低: Turso 利用時の自動テスト（Vitest もしくは e2e）を追加し、再発防止を図る。
