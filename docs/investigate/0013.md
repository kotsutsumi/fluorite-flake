# ローカルSQLiteでNext.jsプロジェクト生成が失敗する

## 調査サマリー
- Next.js フルスタック管理テンプレートで「ローカル SQLite」を選択すると、生成フェーズで内部的に `Template generation failed: Next.js フルスタック管理テンプレートではデータベースの選択が必須です` が投げられ、スピナーが失敗して `Command failed with exit code 1` で終了する。ユーザーには原因が表示されず、デバッグログにも `{}` しか残らない。
- `collectDatabaseAndBlobConfiguration` は `database` を含むオブジェクトを返しているが、`collectUserInputs` が `databaseConfig` と `blobConfig` しか保持しておらず、`ConfirmationInputs` 型にも `database` が存在しないため選択値が途中で失われる（src/commands/create/commands.ts:216-246, src/commands/create/confirmation/index.ts:16-34）。
- `createCommand` / `newCommand` は `inputs.databaseConfig` が存在するときにだけ `database` を `createProjectConfig` へ渡す実装になっており、プロビジョニングを伴わない SQLite 経路では `config.database` が `undefined` のまま（src/commands/create/commands.ts:510-560）。
- `generateFullStackAdmin` は `config.database` を必須としているため、未設定の状態で呼び出すと `success: false` が返り、結果的に例外が発生して処理が中断される（src/commands/create/template-generators/nextjs-fullstack-admin.ts:748-777）。

## 再現手順
1. `pnpm dev new` を実行し、プロジェクト名に任意の値を入力する。
2. テンプレートに `Next.js - fullstack-admin` を選択する。
3. データベース選択で「ローカル SQLite - プロビジョニング不要のローカルデータベース」を選ぶ。
4. 確認プロンプトで `Y` を入力すると、生成フェーズのスピナーが失敗し `Command failed with exit code 1` で終了する。

```
✖ ❌ プロジェクトの作成に失敗しました
🐛 デバッグ: プロジェクトの生成に失敗しました: {}
```

## 期待される挙動
- ローカル SQLite 選択時でもテンプレートコピー、依存関係インストール、Prisma 初期化が完了し、完了メッセージと次の手順が表示される。
- 確認画面に選択したデータベース種別が表示され、失敗時には具体的な原因がわかるメッセージが出力される。

## 原因分析
### 1. 入力収集フェーズで `database` が失われている
- `collectDatabaseAndBlobConfiguration` が返す `database` を `collectUserInputs` が拾っていないため、確認フェーズ以降では選択情報が保持されていない。

### 2. プロビジョニング不要のケースで `config.database` が未設定
- `createCommand` / `newCommand` は `inputs.databaseConfig` の有無で `database` を決定している。SQLite 経路ではプロビジョニングをスキップするため `inputs.databaseConfig` が `undefined` になり、`config.database` がセットされない。

### 3. テンプレート生成器が `config.database` を必須としている
- `generateFullStackAdmin` は `config.database` の存在を前提に `.env` 置換や Prisma スキーマ選択を行っており、未設定だと `Template generation failed` 例外を投げる。

## 修正方針案
1. `ConfirmationInputs` に `database?: DatabaseType` を追加し、`collectUserInputs` で `database` を保持・返却する。確認画面でもデータベース種別を表示できるようにする。
2. `createAndValidateConfig` 呼び出し時に `database ?? inputs.database` を渡すよう調整し、SQLite 経路でも `config.database` が確実に設定されるようにする。
3. 失敗時に `result.errors` や `error.message` をユーザーへ表示し、デバッグログでもメッセージを出力して原因が追跡できるようにする。
4. `new` / `create` 両コマンドについて `--database sqlite` を指定したユニットテストを追加し、モノレポ・非モノレポ双方の経路を回帰テストに含める。

## 未解決事項 / 次のアクション
- 確認画面へデータベース情報を表示する際の i18n 文言（src/i18n/en.json, src/i18n/ja.json）を整備する。
- エラー表示改善が既存のスピナー挙動やログ整形に与える影響を確認する。
- ローカル SQLite 選択時に `.env*` のプレースホルダーが期待どおり `file:./prisma/dev.db` へ置換されることを別途検証する。
