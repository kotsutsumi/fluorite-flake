# Next.js プロジェクト生成時のログ改善

## 概要

- Next.js の fullstack-admin テンプレートを CLI で生成すると、`pnpm` の進捗ログと `ora` スピナーが競合し、ログが読みにくくなる。
- `pnpm` の動的レポーターが改行なしで行を上書きする挙動と、スピナーが同じ行を再描画する挙動がぶつかり、警告文や進捗が崩れて表示される。
- 警告や失敗メッセージの視認性が下がり、利用者が重要な情報を見落とすリスクがある。

## 再現手順

1. `pnpm dev new` を実行し、開発モードで CLI を起動する。
2. プロンプトで `Next.js - React-based full-stack web framework` と `turso` を選択し、モノレポ構成を維持したまま進める。
3. Turso 既存プロジェクトを選び、プロビジョニングを開始する。
4. `pnpm install` が走るタイミングでログが崩れて表示される。

## 現象詳細

以下の通り、`pnpm` の進捗行がスピナー行に上書きされ、末尾が欠けたり混ざったりする。

```
rogress: resolved 1, reused 0, downloaded 0, addapps/web                                 |  WARN  deprecated apollo-server-micro@3.13.0
⠋ nextjs プロジェクトを作成中: test1🐛 デバッグ: create コマンドが次の引数で呼び出されました...
Progress: resolved 932, reused 808, downloaded 4,Packages: +822
```

この状態では、`⚠️` や ` WARN ` などの重要なログが視覚的に判別しづらい。

## 技術的背景と原因仮説

- `src/commands/create/generator.ts` で `ora` スピナーを常時動かしたまま、Next.js テンプレート生成処理を進めている。
- Next.js fullstack-admin テンプレートでは `src/commands/create/template-generators/nextjs-fullstack-admin.ts` 内で `execa("pnpm", ["install"], { stdio: "inherit" })` を呼び出す。
- `pnpm` のデフォルトレポーターは進捗表示のために `\r`（キャリッジリターン）で行頭に戻って上書きする。
- スピナーも同様に行単位で再描画するため、両者が同じ行を取り合い、改行されずにログが合成されてしまう。
- `stdio: "inherit"` のため、CLI 側ではログを整形する余地がなく、そのままターミナルに流れてしまう。

## 改善案

### 案1: スピナーの一時停止・再開制御

- `pnpm` を実行する直前に `spinner.stop()` してから実行し、完了後に `spinner.start()` で再開する。
- 進捗情報は `spinner.stopAndPersist({ symbol: "…" })` などで個別行として残す。
- 実装負荷が低く、`pnpm` 側の挙動を変えずに解消できる。

### 案2: pnpm のレポーターを変更

- `pnpm install --reporter append-only` のように動的更新を行わないレポーターへ切り替える。
- CLI 実装側では `execa` の引数に `["install", "--reporter", "append-only"]` を付与するか、環境変数で `pnpm config set reporter append-only` を適用する。
- ログは冗長になるが、行崩れは発生しなくなる。
- `pnpm` のバージョンアップに伴ってレポーター仕様が変わる場合は再調整が必要。

### 案3: ログを CLI 側でバッファリングして再整形

- `stdio: "pipe"` で `pnpm` の標準出力を受け取り、`readline` などで `\r` を含む行を検知して都度改行に変換する。
- 自前でログを整形してから `console.log` すれば、スピナーとの競合を防ぎつつ進捗情報を保持できる。
- 実装コストは高いが、最も柔軟にログ体裁を制御できる。

### 案4: スピナーを情報トースト方式に変更

- プロビジョニング進捗を段階ごとの `console.log` に切り替え、長時間処理のみ個別スピナーを表示する。
- 既存の細かな進捗メッセージを `ora` スピナー以外の UI（チェックリスト、プログレスバー等）に移行する。
- UX を見直す必要があるが、ログ衝突問題は根本的に解消できる。

## 推奨アクション

1. 短期: 案1 を実装してスピナーと `pnpm` の同時描画を回避する。
2. 併せて `--reporter append-only` を試し、ログの視認性とユーザー体験を比較する。
3. 中期: 案3 のバッファリングが必要かどうか、他テンプレート（Expo/Tauri）でも同様の問題が起きていないかを確認する。
4. UX 改善を検討する場合は、案4 をベースにプロビジョニングメッセージの情報設計を再評価する。

## 未解決・追加調査項目

- `pnpm` v10 系以外（CI など）の環境でどの程度再現するか要確認。
- Windows 端末や非 UTF-8 端末で制御文字の扱いが異なる可能性があるため、ターミナル互換性の検証が必要。
- `ora` 以外のスピナー（`cli-spinners` や `listr2` 等）への移行余地を調査する。
- ログ崩れによって重要な Warn/Error が見落とされていないか、ユーザーテストまたはヒアリングで確認する。
