# Next.js プロジェクト生成時に pnpm 10.18.1 への更新通知が出る

## 概要
- `pnpm dev new` で Next.js (`fullstack-admin` テンプレート、モノレポ構成) を生成すると、依存関係インストール中に `Update available! 10.18.0 → 10.18.1.` が表示される。
- ローカル環境では `pnpm 10.18.1` が既に利用可能であり、CLI も検証フェーズで最新版を検出しているため、ユーザーから見ると「最新なのに更新通知が出る」状態になっている。
- 原因はテンプレート内の `packageManager: "pnpm@10.18.0"` が Corepack によって優先され、生成直後のワークスペースで `pnpm 10.18.0` が強制使用されていること。

## 影響範囲
- `templates/monorepo/package.json.template` を利用するモノレポ構成の生成コマンド全般（確認済み: Next.js `fullstack-admin`）。
- CLI 実行環境が pnpm 10.18.1 以上でも、生成物側では 10.18.0 がダウンロードされ、初回インストール時に更新通知が繰り返し表示される。
- 生成されたリポジトリで `pnpm install` を再実行しても同じ通知が表示されるため、チーム共有時に毎回案内が出る。

## 再現手順
1. `pnpm -v` でローカル版が `10.18.1` であることを確認する。
2. `pnpm dev new` を実行し、Next.js `fullstack-admin` テンプレートをモノレポ構成で選択する。
3. 依存関係インストールの過程で以下のポップアップが表示される。

```
╭───────────────────────────────────────────────╮
│                                               │
│     Update available! 10.18.0 → 10.18.1.      │
│     Changelog: https://pnpm.io/v/10.18.1      │
│   To update, run: corepack use pnpm@10.18.1   │
│                                               │
╰───────────────────────────────────────────────╯

Done in 32.7s using pnpm v10.18.0
```

## 観測された挙動
- CLI の冒頭で `✅ pnpm v10.18.1 を検出しました。` が表示され、ローカル環境では最新版が使われている。
- 依存関係のインストール終了時に `Done in 32.7s using pnpm v10.18.0` と出力され、実際には 10.18.0 が利用されている。
- 生成物の `package.json` に `packageManager: "pnpm@10.18.0"` が埋め込まれ、Corepack が旧バージョンをインストールする。

## 原因分析
- モノレポ用テンプレート `templates/monorepo/package.json.template:4` で `packageManager` が固定値 `pnpm@10.18.0` になっている。
- 同テンプレートの `engines.pnpm` も `>=10.18.0` に固定されており、実質的に 10.18.x 系を想定した生成物になる。
- プロジェクト生成後のファイル `temp/dev/<project>/package.json:4` にも同じ値が入り、Corepack により 10.18.0 が優先される。
- `src/utils/pnpm-validator/validate-pnpm.ts` はローカルの pnpm バージョンを検証するだけで、取得したバージョン文字列を生成処理側へ渡していないため、テンプレート側へ反映されない。

## 対応方針案
1. **テンプレートの動的置換**  
   - `validatePnpm` が検出したバージョン文字列を `monorepo-generator` に渡し、`packageManager` と `engines.pnpm` を動的に差し替える。  
   - 失敗時はフォールバックとして `pnpm@latest` か `>=10` のような緩めの条件に戻す。
2. **短期的なバージョン引き上げ**  
   - 直近で必要なだけであれば `pnpm@10.18.1` へテンプレートを更新する。
   - ただし次のパッチリリースで同じ問題が再発するため定期的なメンテナンスが必須。
3. **バージョン固定を見直す**  
   - `packageManager` フィールドそのものを削除し、利用者のローカル pnpm に委ねる（代替としてドキュメントで `corepack use` の実行を促す）。
   - もしくは `packageManager` だけ `pnpm@latest` とし、`engines.pnpm` を `>=10` に緩和する。

## 次のアクション
- [ ] `validatePnpm` の戻り値拡張（バージョン文字列取得）とテンプレートへの受け渡し可否を検討。
- [ ] テンプレート更新が必要なディレクトリ（`templates/monorepo` 以外に同様の固定値がないか）を棚卸し。
- [ ] 修正後に `pnpm dev new` を再実行し、更新通知が表示されないことと `Done in ... using pnpm v10.18.1` になることを確認。
- [ ] 生成物の `README` / `Getting Started` に `corepack use` 手順を追記する必要があるか判断。

## 補足メモ
- `pnpm -v`（ローカル環境）: `10.18.1`
- 生成された `pnpm-lock.yaml` は 10.18.0 で生成されるが、`packageManager` を更新すれば再生成時に追従する見込み。
- Prisma など他の依存パッケージでも同様の更新通知が出るケースがあり、バージョン固定ポリシーを整理しておくと運用コストを下げられる。
