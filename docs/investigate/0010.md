# Next.jsプロジェクト生成時に next.config.* が二重生成される

## 調査サマリー
- 2025-10-07 時点の `create` コマンド（Next.js / fullstack-admin テンプレート）では、生成物に `next.config.mjs` と `next.config.ts` の 2 ファイルが同梱される。
- `.mjs` 側には `outputFileTracingRoot` や `serverExternalPackages` など LibSQL / Prisma 連携に必要な設定が記述されており、実質こちらが有効設定ファイルとして読み込まれる。
- `.ts` 側は `/* config options here */` のスタブのみで、Next.js は `.mjs` を優先的に解釈するため未使用のまま残る。開発者はどちらを編集すべきか判断しづらく、不要ファイルが ESLint やエディタで警告対象になる。
- テンプレートコピー処理（`copyTemplateDirectory`）には重複ファイルを除去する機構がなく、テンプレート配下に両方を置いている現状が直接原因。

## 背景
`fullstack-admin` テンプレートは Turso / Supabase を想定した高度な設定を持つ。LibSQL のネイティブモジュール除外や `outputFileTracingRoot` による monorepo 連携が必要になり、E SM の `next.config.mjs` をカスタムで用意した形跡がある。一方、テンプレート雛形作成時の `create-next-app --ts` の初期成果物（`next.config.ts`）が片付けられずに残っている。

## 再現手順
1. リポジトリルートで `pnpm dev` を実行し、開発モードの CLI を起動する。
2. `create` コマンドを選択し、プロジェクトタイプに `nextjs`, テンプレートに `fullstack-admin`, 任意のプロジェクト名（例: `test1`）を指定する。データベースは Turso / Supabase いずれでも再現する。
3. モノレポ選択時は `temp/dev/<project>/apps/web/`、単体プロジェクト時は `temp/dev/<project>/` に生成物が作られ、`next.config.mjs` と `next.config.ts` が同居する。

## 現状分析
### テンプレート構造
- `templates/nextjs-fullstack-admin/next.config.mjs`  
  - `serverExternalPackages` や `config.resolve.fallback` を通じて LibSQL 関連パッケージをクライアントバンドルから除外している。
  - `outputFileTracingRoot` によって `apps/web` 配下でも Turborepo のルート解決が機能するよう調整している。
- `templates/nextjs-fullstack-admin/next.config.ts`  
  - `import type { NextConfig } from 'next';` のみを含む初期スタブ。記述内容がないためビルド結果には影響しない。

### コピー処理の挙動
- `src/commands/create/template-generators/nextjs-fullstack-admin.ts` → `copyTemplateDirectory` の呼び出しでテンプレート直下の全ファイルをそのままコピーする。
- 除外パターンは `node_modules/**` など一部に限られ、`next.config.*` 系は除外されない。生成後に不要ファイルを削除するフェーズも存在しない。

### Next.js 側の読み込み順
- Next.js 15 系では `next.config.ts` も公式サポートされるが、ファイルが複数存在する場合は `.mjs` / `.js` が優先され、`.ts` は評価されない。
- `.ts` が未使用のまま残るため、VS Code 等では「未使用ファイル」として警告が出るほか、共同開発者が `.ts` 側を編集しても本番設定に反映されないリスクがある。

## 技術的補足
- `next.config.mjs` は ESM として実行されるため、LibSQL の ESM パッケージに対して `serverExternalPackages` を適用できる。一方 `next.config.ts` は transpile の都合で CommonJS 化され、ESM 専用パッケージの `import` が制限される。現在のカスタム設定は `.ts` 化すると追加検証が必須。
- `.ts` 側を活かす場合は `defineConfig` ユーティリティや `satisfies NextConfig` を活用して型の恩恵を受けられるが、`.mjs` のロジックを移植したうえで `outputFileTracingRoot` 等が正常に動作するか確かめる必要がある。

## 解決案
1. **`.ts` ファイルをテンプレートから削除する（推奨）**  
   - テンプレートの `next.config.ts` を撤去し、`copyTemplateDirectory` に追加対応は不要。  
   - 影響範囲が最小で、既存ユーザーにも影響がない。  
   - 型サポートは得られないが、現行ロジックを変更せずに済む。
2. **`.mjs` の内容を `.ts` に移植し、`.mjs` を廃止する**  
   - `next.config.ts` に `import { NextConfig } from 'next'` や `defineConfig` を用いてロジックを移植。  
   - ESM 専用パッケージの扱い・`serverExternalPackages` の互換性検証、出力された `.next` の挙動確認が必要。  
   - eslint / biome での拡張設定や `pnpm build` 実行でのサニティチェックを合わせて行う。
3. **生成後に不要ファイルをクリーンアップする処理を追加**  
   - `copyTemplateDirectory` 後に `next.config.ts` を削除する実装を CLI 側で行う。  
   - テンプレート資産を直接触りたくない場合の暫定策だが、根本的なファイル整理はテンプレート側で行った方が保守が容易。

## 未決事項 / 次のアクション
- テンプレートオーナーに `.mjs` を正とするか `.ts` へ乗り換えるかをヒアリングし、採用方針を決定する。
- 方針決定後、テンプレートディレクトリと `scripts/copy-templates.mjs`（ビルド時にテンプレートを dist へ複製）で同一の整理を行う。
- `.ts` 採用に切り替える場合は、`pnpm build` / `pnpm test:run` を通した回帰確認と、LibSQL / Prisma 接続シナリオでの E2E 検証を追加で計画する。
- ドキュメント（README やテンプレート案内）に「編集すべき設定ファイル」を明記し、開発者が迷わないようにする。
