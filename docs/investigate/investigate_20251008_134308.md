# 調査結果レポート: プロジェクト作成時のdev起動問題

**調査日時**: 2025年10月8日 13:43:08
**ブランチ**: feature/fix-dev-startup-issue
**調査者**: Claude Code Investigation

## 問題概要

プロジェクト作成時にドキュメント（docs）プロジェクトも同時に生成された場合、プロジェクトルートで `pnpm dev` を実行すると以下のエラーが発生する：

```
sh: next: command not found
ERR_PNPM_RECURSIVE_RUN_FIRST_FAIL  test3-docs@0.1.0 dev: `next dev`
spawn ENOENT
WARN   Local package.json exists, but node_modules missing, did you mean to install?
```

## 調査結果

### 1. 問題の根本原因

**主原因**: docsプロジェクト内で依存関係がインストールされていない

- docsプロジェクト (`apps/docs`) は正常に作成されている
- docsプロジェクトのpackage.jsonには `next` の依存関係が記載されている
- しかし、docsプロジェクト内に `node_modules` ディレクトリが存在しない
- ルートの `dev` スクリプトがWorkspaceManagerによって自動生成され、並列実行される

### 2. エラー発生のメカニズム

1. **プロジェクト作成プロセス**:
   - `generateProject()` → monorepo構造作成 → テンプレートコピー → docsプロジェクト作成
   - フルスタックテンプレートで `runSetupCommands()` により `pnpm install` が実行される

2. **dev script生成**:
   - `syncRootScripts()` → `WorkspaceManager.detectWorkspaces()` → `generateRootScripts()`
   - 自動生成されたdev script: `"dev": "pnpm --filter test3-docs run dev & pnpm --filter test3-web run dev"`

3. **エラー発生**:
   - docsプロジェクトで `next dev` 実行 → `next: command not found`

### 3. プロジェクト構造分析

**調査対象プロジェクト**: `temp/dev/test3`

```
test3/
├── package.json (ルート workspace設定)
├── pnpm-workspace.yaml
├── apps/
│   ├── web/ (正常にnode_modulesあり)
│   └── docs/ (node_modulesなし) ← 問題の箇所
└── packages/
```

**ルートpackage.json の問題のdev script**:
```json
"dev": "pnpm --filter test3-docs run dev & pnpm --filter test3-web run dev"
```

**docsプロジェクトpackage.json**:
```json
{
  "name": "test3-docs",
  "dependencies": {
    "next": "^15.5.4",
    "nextra": "^4.6.0",
    "nextra-theme-docs": "^4.6.0"
  },
  "scripts": {
    "dev": "next dev"
  }
}
```

### 4. 技術的分析

**コードトレース結果**:

1. **プロジェクト生成**: `src/commands/create/generator.ts`
   - `generateProject()` → `handleAdvancedTemplate()` または `handleStandardTemplate()`

2. **monorepo構造作成**: `src/utils/monorepo-generator/`
   - `createMonorepoStructure()`: `apps/web` のみ作成
   - `copyMonorepoTemplates()`: ルートテンプレートファイルをコピー

3. **フルスタックテンプレート**: `src/commands/create/template-generators/nextjs-fullstack-admin.ts`
   - `runSetupCommands()` で `pnpm install` 実行（行491-494）
   - ただし、docsプロジェクトの作成タイミングが install 後の可能性

4. **workspace管理**: `src/utils/workspace-manager/workspace-manager.ts`
   - `generateAggregatedScripts()` でdev script自動生成（行265-310）
   - 依存関係の存在チェックなし

## 解決方針

### 推奨解決策: プロジェクト作成後の再インストール

**実装箇所**: `src/commands/create/generator.ts` の `generateProject()` 関数

**修正内容**:
1. プロジェクト生成完了後に `pnpm install` を再実行
2. monorepoの場合のみ実行（simpleプロジェクトは対象外）

**メリット**:
- 最も確実で安全な解決方法
- 既存コードへの影響が最小
- 他の類似問題も予防可能

### 代替解決策

**解決策2: docsプロジェクト作成タイミングの調整**
- docsプロジェクトを `pnpm install` の前に作成
- より根本的だが実装が複雑

**解決策3: WorkspaceManagerの改善**
- dev script生成時に依存関係の存在をチェック
- node_modulesがない場合はdev scriptから除外
- エラー予防として有効

## 次のステップ

1. **実装フェーズ**: 推奨解決策の実装
2. **テスト**: 複数のテンプレートで動作確認
3. **回帰テスト**: 既存機能への影響確認

## 影響範囲

- **対象**: monorepoモードでのプロジェクト作成
- **テンプレート**: フルスタックテンプレート（nextjs-fullstack-admin等）
- **影響**: 初回dev起動時のエラー

## 関連ファイル

- `src/commands/create/generator.ts`
- `src/commands/create/template-generators/nextjs-fullstack-admin.ts`
- `src/utils/workspace-manager/workspace-manager.ts`
- `src/utils/monorepo-generator/`
- `temp/dev/test3/` (検証用プロジェクト)