# Next.js プロジェクト生成時の Turso テーブル作成・シード失敗調査

## 概要
- `pnpm dev new` で Next.js (`fullstack-admin` テンプレート) を生成すると、Turso クラウド環境のテーブル作成とシード投入が 3 環境（dev/staging/prod）すべてで失敗する。
- Prisma 6.16.3 を libsql アダプター経由で起動する際に `datasourceUrl` と `datasources` を同時指定しており、Prisma クライアントから「Can not use "datasourceUrl" and "datasources" options at the same time.」と警告されて処理が中断される。
- CLI は失敗後も処理を「成功」とみなして完了するため、初回起動までにテーブル作成・シードが行われない状態でチームへ成果物が共有されるリスクがある。

## 影響範囲
- 対象コマンド: `pnpm dev new`
- 選択構成: `projects → nextjs → fullstack-admin`、データベース `turso` 既存利用、`autoMigrate: true`
- Turso 既存環境の dev/staging/prod すべてで同じ例外が発生する。

## 再現手順
1. `pnpm dev new` を実行し、モノレポ構成を有効にした状態で Next.js `fullstack-admin` テンプレートと Turso 既存 DB を選択する。
2. CLI がプロビジョニングを完了した後の `🗄️ Tursoクラウドデータベースにテーブルを作成中...` フェーズで各環境向けのテーブル作成が走る。
3. dev/staging/prod の順に同一の Prisma 例外が発生し、「アプリケーション初回起動時にテーブル作成が実行される」とメッセージが表示される。

## 観測された挙動
```
⚠️ dev環境のテーブル作成で問題が発生しました: Can not use "datasourceUrl" and "datasources" options at the same time. Pick one of them
Read more at https://pris.ly/d/client-constructor
```
- 同じログが staging/prod でも繰り返される。
- 例外発生後も CLI 全体は `New command completed successfully` で終了し、`env-files.zip` などの成果物も生成される。

## 原因分析
- `src/utils/turso-cli/provisioning.ts:674-681` で PrismaClient を初期化する際、libsql アダプターを渡しつつ `datasourceUrl` と `datasources.db.url` の両方を設定している。
- Prisma 6.12 以降、libsql/edge アダプター経由の初期化ではどちらか片方のみを指定するよう仕様が変更されており、両方を渡すと上記エラーで起動が止まる。
- そのためテーブル作成用の SQL 実行処理が一切走らず、結果的に Turso 側のテーブルとシードデータが存在しない。

## 対応方針案
1. PrismaClient 初期化時の引数から `datasources` ブロックを削除し、`datasourceUrl` のみを残す（またはその逆に統一する）。
    - Prisma の型定義上、libsql アダプター使用時は `datasourceUrl` のみで十分。
    - 修正後は `pnpm dev new` を再実行してテーブル作成・シードが期待通りに動作するか確認する。
2. 上記変更にあわせて Turso テーブル作成モジュールのユニットテスト／結合テストを追加し、PrismaClient の呼び出しオプションが片方に絞られていることを検証する。
3. CLI 出力文面を更新し、エラーが発生した場合はユーザーに気付きやすい形で失敗扱いとし、`env-files.zip` 生成など後続処理をスキップさせる（必要性検討）。

## 開発メモ
- Prisma 例外自体はキャッチされず、そのまま CLI ログに警告として出力されるため、将来的に Prisma のメジャー更新が入ると挙動が変わる可能性がある。
- 既存の `appendAuthToken` ロジックや libsql 接続テストには問題が無く、PrismaClient の初期化オプションだけが非互換となっている。

## 次のアクション
- [ ] PrismaClient 初期化パラメータの修正実装
- [ ] 再現コマンドに対する回帰テスト整備
- [ ] Turso テーブル自動作成の成功ログを確認し、調査メモを更新

## 参考ログ（要約）
- CLI 実行コマンド: `pnpm dev new`
- Prisma バージョン: 6.16.3
- 発生メッセージ: `Can not use "datasourceUrl" and "datasources" options at the same time.`
- 最終出力: `New command completed successfully`（実際にはテーブル未作成）
