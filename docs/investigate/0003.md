# Next.jsプロジェクト生成時、ローカル SQLite データベースファイルのパスが揺らぐ問題を解決する

## 背景

- `fluorite create` の Next.js (fullstack admin) テンプレートは、ローカル開発時に `file:./prisma/dev.db` を利用した SQLite を既定とする。
- `pnpm db:reset` や `pnpm dev` 実行時に Prisma CLI がこの DB を作り直し、`scripts/ensure-db.ts` がスキーマ適用・シード投入を担う設計。
- ところが、生成される DB ファイルの場所が安定せず、アプリケーションが期待どおり起動しないケースが複数報告されている。

## 現象

- Prisma CLI 実行後に `prisma/dev.db` ではなく `prisma/prisma/dev.db` が生成される。タイミングによって `dev.db` がルート直下にできる場合もある。
- `pnpm dev` 起動時に `SQLITE_ERROR: no such table` などのエラーが出てアプリが落ちる。DB ファイルが存在しても、アプリが参照するパスと一致していない。
- `.gitignore` には `prisma/dev.db` しか登録されていないため、`prisma/prisma/dev.db` がコミット対象になるリスクがある。

## 再現手順

1. `fluorite create` → テンプレート `nextjs-fullstack-admin` → データベースで「ローカル SQLite」を選択。
2. 生成プロジェクトで `pnpm install` を実行し、`.env.local` に既定の `DATABASE_URL=file:./prisma/dev.db` を設定する。
3. `pnpm db:reset` → `pnpm dev` を順に実行する。
4. `ls prisma` を確認すると、`dev.db` と `prisma/dev.db` が混在したり、アプリが DB へ接続できず落ちる状況を再現できる。

## 調査ログ

- Prisma は `schema.prisma` が存在する `prisma/` ディレクトリを基準に `file:` URL を解釈する。`PRISMA_DATABASE_URL=file:./prisma/dev.db` のまま CLI を呼ぶと `prisma/prisma/dev.db` が生成される。
- テンプレート `.env.*` には `file:./prisma/dev.db` が埋め込まれており、`scripts/ensure-db.ts` は `normalizeLocalDatabaseEnv` で `file:` URL を絶対パスへ変換している。変換が成功すれば最終的に `file:///abs/path/prisma/dev.db` へ統一される。
- ただし `normalizeLocalDatabaseEnv` が実行される前に `lib/db.ts` の `ensurePrismaEnv` が `PRISMA_DATABASE_URL=file:./prisma/dev.db` を再設定すると、相対パスが再び CLI に渡され、`prisma/prisma/dev.db` の生成が繰り返される。
- `stabilizeLocalSqlitePath` は `prisma/prisma/dev.db` を検知して `prisma/dev.db` へリネームするが、ファイルが生成直後に開かれていると移動できず不整合が残るケースがある。
- `.env` テンプレートで `DIRECT_DATABASE_URL` が未設定の場合、`lib/db.ts` がフォールバックとして `DEFAULT_SQLITE_URL` を指し、環境によって値が揺らぐ。

## 根本原因

- Prisma スキーマの場所と `.env` 内の相対パス指定がずれており、CLI が `prisma/prisma/dev.db` を生成してしまう。
- `scripts/ensure-db.ts` と `src/lib/db.ts` がそれぞれ環境変数を上書きしており、実行タイミングによって相対パスが復活する。
- リネーム用ガード (`stabilizeLocalSqlitePath`) が存在するものの、絶対パス化が一貫して行われないため、DB ファイルが複数箇所に散らばる。
- `.gitignore` が不完全で、誤った DB ファイルがリポジトリに紛れ込む恐れがある。

## 対応策候補

1. **環境変数の一元化**  
   - `.env` テンプレートを `file:./dev.db`（スキーマ基準ディレクトリに合わせる）へ修正、あるいは初期値から絶対パス URL を設定する。  
   - `normalizeLocalDatabaseEnv` を必ず通過させ、CLI に渡す段階では絶対 URL に統一する。
2. **`lib/db.ts` の初期化順序を調整**  
   - `libsql://`（Turso）利用時は既存 URL を尊重し、`file:` へ書き換えない。  
   - ローカル SQLite の場合のみ `normalizeSqliteUrl` の結果を `process.env` に上書きし、CLI との整合を維持する。
3. **`scripts/ensure-db.ts` のガード強化**  
   - Prisma CLI 実行後に `prisma/prisma/dev.db` が存在したら警告を出し、`prisma/dev.db` へ移動させる。  
   - `DATABASE_URL` が未設定でもローカル絶対パスを再設定し、CLI が常に同じファイルにアクセスするよう保証する。
4. **.gitignore の拡張**  
   - `prisma/prisma/dev.db` や `*.db-journal` などを追記し、不要ファイルのコミットを防ぐ。
5. **テスト整備**  
   - `pnpm db:reset` 後に DB ファイルの位置を検証する e2e / unit テストを追加し、リグレッションを防止する。

## 実装タスク案

- [ ] `.env` テンプレートおよびジェネレーター (`template-generators/nextjs-fullstack-admin.ts`) を更新し、ローカル DB の URL を Prisma の解釈に合わせる。  
- [ ] `scripts/ensure-db.ts` を再構成し、`normalizeLocalDatabaseEnv` → 絶対 URL 変換 → Prisma CLI 実行 → 生成ファイルの検証という流れを強制する。  
- [ ] `lib/db.ts` の `ensurePrismaEnv` をローカル専用に限定し、Turso や Supabase の URL を上書きしない。  
- [ ] `.gitignore` に `prisma/prisma/dev.db` および関連ジャーナルファイルを追加する。  
- [ ] `pnpm db:reset` を呼び出すテストを用意し、生成されるファイルパスを検証する仕組みを導入する。

## 懸念・フォローアップ

- Prisma CLI は実行ディレクトリによって解決パスが変わるため、生成スクリプトやテストが `process.cwd()` を意図せず変更しないよう注意が必要。  
- Turso などリモート DB とローカル SQLite を頻繁に切り替えるユーザー向けに、`.env` の更新手順と推奨コマンドをドキュメント化する必要がある。  
- 既に `prisma/prisma/dev.db` が生成されてしまったプロジェクトでは手動でファイルを移動・削除するガイドが必要。  
- Windows / WSL 環境でのパス変換（`pathToFileURL`）を検証し、クロスプラットフォームでも同じ挙動になるか確認する。

## 次のアクション

- `.env` テンプレート、`scripts/ensure-db.ts`、`src/lib/db.ts` の環境変数処理を修正し、`pnpm db:reset` 後に常に `prisma/dev.db` のみが生成される状態を実現する。  
- `.gitignore` とドキュメントを更新し、テストで再発防止を図る。  
