# Next.jsプロジェクト生成時のデータベース選択にローカルSQLite専用の選択肢を追加したい

## 調査サマリー
- 2025-10-07 時点の Fluorite CLI は、`promptForDatabase` が Turso/Supabase の二択を提示するのみで（`src/utils/user-input/prompt-database.ts:12-28`）、ローカルに完結する SQLite を選べない。
- `--database` 引数や内部型（`DatabaseType`）も `"turso" | "supabase"` に限定されており（`src/commands/create/types.ts:17`、`src/commands/create/validators.ts:57-60`）、入力値を検証する時点で SQLite を弾いてしまう。
- Next.js フルスタック管理テンプレート自体は `prisma/dev.db` や SQLite 向けスキーマを同梱しており、`.env` 既定値もローカル SQLite を想定しているが `DATABASE_PROVIDER` が Turso のまま上書きされるため（`templates/nextjs-fullstack-admin/.env`）、生成直後は意図とずれが生じる。
- プロビジョニングフェーズでは Turso/Supabase CLI への認証や既存リソース探索が必須になっており（`src/commands/create/database-provisioning/prompts.ts:16-117`、`service.ts:1-120`）、ローカル SQLite を選べればこの重いフローをスキップできる見込み。

## 現状整理
### CLI の入力フロー
- `collectDatabaseAndBlobConfiguration` はテンプレートが DB 連携を含む場合に `promptForDatabase` を呼び出す設計で、現状は Turso/Supabase のいずれかを必ず返す（`src/commands/create/commands.ts:129-183`）。
- `DatabaseType` / `DatabaseProvisioningConfig` などの型定義がローカル SQLite を許容しておらず、以降の処理で分岐を追加できない（`src/commands/create/types.ts:17`、`src/commands/create/database-provisioning/types.ts:8-31`）。
- `validateDatabase` と i18n メッセージも Turso/Supabase の記述に固定されているため、CLI 引数で `--database sqlite` を渡しても即エラーになる（`src/commands/create/validators.ts:57-68`、`src/i18n/en.json` / `src/i18n/ja.json`）。

### プロビジョニング処理
- `collectDatabaseConfig` はプロバイダ選択後に CLI 認証チェックや既存リソースの探索を行う前提で、SQLite のように「プロビジョニング不要」のケースを想定していない（`src/commands/create/database-provisioning/prompts.ts:16-117`）。
- `DatabaseProvisioningService` は provider ごとに Turso/Supabase 用の処理を実装しており、`skipProvisioning` が true でも結果オブジェクトは Turso/Supabase のクレデンシャル構造を返すよう設計されている（`src/commands/create/database-provisioning/service.ts:21-118`）。
- `create` コマンド本体では `inputs.databaseConfig` が存在する場合にのみプロビジョニングを実行し、その結果をテンプレート生成へ渡しているため（`src/commands/create/commands.ts:344-379`）、SQLite を追加する場合は `databaseConfig` 自体を生成しない or SQLite 用の軽量設定を返す必要がある。

### テンプレート資産
- Next.js フルスタック管理テンプレートにはローカル用の Prisma スキーマと SQLite データベースが同梱済み（`templates/nextjs-fullstack-admin/prisma/schema.prisma`、`dev.db`）。
- テンプレート生成フェーズでは `PRISMA_SCHEMAS` と `DATABASE_SETUP_STEP` が Turso/Supabase に限定されており（`src/commands/create/template-generators/nextjs-fullstack-admin.ts:25-34`）、SQLite を選ぶ場合のスキップ文言や `.env` 置換ロジックが未整備。
- `.env` 初期ファイルは `DATABASE_PROVIDER=turso` を既定値にしているが、ローカル開発説明では SQLite (file:./prisma/dev.db) を推奨しておりドキュメントとの齟齬がある（`templates/nextjs-fullstack-admin/.env`、`templates/nextjs-fullstack-admin/README.md:32-41`）。

## 解決したい UX / 要件
- Next.js フルスタック系テンプレートでローカル開発しかしないケースのために、CLI 上で「ローカル SQLite（プロビジョニングなし）」を公式な選択肢として提示したい。
- Turso/Supabase の CLI 認証やリソース作成を必須にせず、生成後すぐ `pnpm db:reset` → `pnpm dev` で起動できる状態を保証する。
- `.env` の `DATABASE_PROVIDER` や `DATABASE_URL` が SQLite 用の値で確定するようにし、テンプレート README の記述と生成結果を一致させる。

## 実装検討ポイント
- `DatabaseType` および `validateDatabase` に `"sqlite"`（命名は `local-sqlite` など検討）を追加し、`promptForDatabase` のオプションへ新しい選択肢を挿入する。
- `collectDatabaseAndBlobConfiguration` で SQLite が選択された場合は `collectDatabaseConfig` を呼ばず、`databaseConfig` を `undefined` に保つ（または SQLite 専用の軽量設定型を導入）ことでプロビジョニングフェーズを完全にスキップする。
- `DatabaseProvisioningConfig` / `DatabaseProvisioningService` へ SQLite を追加する場合は、`provider` フィールドをオプショナル化する or ユニオン型に分岐を作り、`skipProvisioning` フラグだけで成立するよう調整する。
- `nextjs-fullstack-admin` ジェネレーターの `PRISMA_SCHEMAS` と `buildEnvReplacements` に SQLite 分岐を追加し、`DATABASE_SETUP_STEP` に「既存の dev.db をそのまま使う」旨の文言を用意する。
- `.env*` テンプレートで `DATABASE_PROVIDER` の初期値を SQLite に寄せる（Turso/Supabase 選択時はジェネレーターで上書き）。必要であれば `schema.sqlite.prisma` を追加し、Turso/Supabase とは別にメンテする。
- i18n 辞書（`src/i18n/en.json` / `ja.json`）へ SQLite 説明文を追加し、`--database` 引数説明のカッコ表記も更新する。
- CLI の確認画面やドキュメント (`docs/` 配下) にローカル SQLite パスを追記し、E2E / 単体テストで `--database sqlite` の経路をカバーする。

## 想定フロー（ドラフト）
1. ユーザーが Next.js フルスタック管理テンプレートを選択。
2. データベース選択プロンプトに「Turso」「Supabase」「ローカル SQLite」の 3 択が表示される。
3. 「ローカル SQLite」を選ぶと、プロビジョニング関連の追加プロンプトは一切表示されず確認画面へ遷移。
4. 生成後の `.env*` は `DATABASE_PROVIDER=sqlite`、`DATABASE_URL=file:./prisma/dev.db` などローカル接続情報が埋まった状態になる。
5. 付随する README / 次の手順メッセージでは `pnpm db:reset` によるローカル DB 初期化のみ案内される。

### ステージング/本番環境での扱い案
- `.env.staging` / `.env.prod` は SQLite 選択時も `file:` スキームのまま生成し、コメントで「本番運用では Turso/Supabase などクラウド DB への移行を推奨」と明示する。
- CLI 生成後の「次に行うこと」ログや README へ、ステージング/本番で SQLite を継続使用する場合の制約（単一ノード・バックアップ手段なし・同時接続に弱い等）を警告として追記する。
- 将来的に Turso/Supabase へ移行する手順（env の書き換え、`pnpm db:push` 等）をテンプレート README に「移行ガイド」としてまとめ、SQLite からのステップアップを支援する。
- ビルド成果物の `.env` 雛形には `DATABASE_PROVIDER=sqlite` を維持しつつ、環境ごとに空欄プレースホルダーを用意しておき、ユーザーがターミナル上で選択肢を再実行せずとも差し替えやすい構成にする。

## リスク / 懸念点
- `DatabaseProvisioningService` 周辺は SQLite 分岐がない前提で書かれているため、単に `databaseConfig` を `undefined` にすると確認画面やログ出力の整合性が崩れる恐れがある。
- `buildEnvReplacements` は Turso でもローカル開発用に `file:./prisma/dev.db` を設定しているため、SQLite 専用分岐を加える際に既存ロジックとの重複や整合性を確認する必要がある。
- 将来的に他テンプレート（Expo/Tauri）でも同様の選択肢を提供する場合、`DatabaseType` をテンプレート横断で共有する設計が最適か検討が必要。
- 追加のユニットテストが存在しないため、既存テストの改修と CI の結果確認を行わないとリグレッションを見逃す恐れがある。

## 未解決事項 / 次のアクション
- SQLite 選択肢のラベル・内部識別子（`sqlite` vs `local-sqlite`）を確定する。
- テンプレート側に `schema.sqlite.prisma` を追加するか、既存 `schema.prisma` を流用するかを決める。
- `.env.staging`・`.env.prod` など本番向けファイルで SQLite を選んだ場合の扱い（そのままローカル運用か、別途ドキュメントで注意書きを入れるか）を整理する。
- 実装後は `pnpm dev` を使った CLI 操作と `pnpm test` / `pnpm build` の一式テストを回し、`docs/reviews/src/...` の対応レビューも更新する。
