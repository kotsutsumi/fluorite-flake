# Next.jsプロジェクト生成で出力される環境変数セットの整理案

## 調査サマリー
- `buildEnvReplacements` が Turso 選択時でも dev 環境の URL をローカル SQLite で初期化しており、プロビジョニング結果の `credentials` が欠けたケースでは `.env.development` が `file:./prisma/dev.db` のままになる（`src/commands/create/template-generators/nextjs-fullstack-admin.ts:196-245`）。
- `.env*` テンプレートには Blob 変数の互換目的サフィックス（`*_DEV` / `*_STG` など）が残っており、生成後も `BLOB_READ_WRITE_TOKEN` 系が二重に並ぶ（`templates/nextjs-fullstack-admin/.env.development:45-50` など）。
- Supabase 未選択でも Supabase 用のプレースホルダーが埋め込まれ、逆に Turso 未選択でも Turso 変数が残るため、最終的な環境変数が実際に利用するプロバイダと一致しない（`templates/nextjs-fullstack-admin/.env.staging:21-37`）。
- `DATABASE_URL` / `DIRECT_DATABASE_URL` / `PRISMA_DATABASE_URL` が常に同一値で吐き出される。Prisma CLI や `lib/db.ts` での互換ハンドリングは存在するものの、不要な重複がトラブルを招いている（関連調査: `docs/investigate/0002.md`）。
- 認証シークレットはテンプレートにハードコードされた `change-me-*` を残したままコピーされ、`src/lib/auth.ts` 側では `process.env.BETTER_AUTH_SECRET` が空だと開発用固定値へフォールバックするためセキュリティ/UX のどちらにも好ましくない（`templates/nextjs-fullstack-admin/.env:13-14`, `templates/nextjs-fullstack-admin/.env.development:13-14`, `templates/nextjs-fullstack-admin/.env.staging:13-14`, `templates/nextjs-fullstack-admin/.env.prod:13-14`, `templates/nextjs-fullstack-admin/src/lib/auth.ts:107`）。

## 再現手順（Turso 選択時の dev 環境 URL ずれ）
1. `pnpm dev` で CLI を起動し、`create` → プロジェクトタイプ `nextjs` → テンプレート `fullstack-admin` を選択。
2. データベースに Turso を選び、`skipProvisioning` を許可するか、Turso CLI に未ログインの状態で進める。
3. 生成されたプロジェクト配下（例: `temp/dev/<project>/apps/web/`）の `.env.development` を確認すると、`DATABASE_URL`/`DIRECT_DATABASE_URL`/`PRISMA_DATABASE_URL` が `file:./prisma/dev.db` のままになっており、期待していた `libsql://...-dev` URL へ置き換わっていない。

## 現状整理
### 環境変数テンプレートの構造
- ローカル/開発/ステージング/本番ごとの `.env*` がテンプレート側で事前定義済み。いずれも Turso・Supabase 両方の項目を持つ（`templates/nextjs-fullstack-admin/.env*:21-50`）。
- Blob 用変数は `_DEV` / `_STG` / `_PROD` サフィックス付きと重複定義されており、コメントにも互換目的と書かれているが由来は `env-clear-vercel.ts` のレガシー変数群（`templates/nextjs-fullstack-admin/scripts/env-clear-vercel.ts:53-75`）。

### 生成処理の流れ
- テンプレートコピー後、`configureEnvironmentFiles` が `buildEnvReplacements` で決定したマップを `.env*` へ注入する構成（`src/commands/create/template-generators/nextjs-fullstack-admin.ts:341-364`）。
- Turso 用の初期値はローカル SQLite をベースにし、`credentials?.urls` が存在する場合のみ `libsql://` URL を上書きする。一方 Supabase 用は固定接頭辞で `postgresql://` URL を合成する（同:196-305）。
- プロビジョニングをスキップしたケースでは `context.databaseCredentials` が `undefined` のまま渡されるため、dev/staging/prod すべてがローカル URL に留まる。

## 課題詳細
### 1. Turso 生成物が dev 環境でもローカル SQLite を指してしまう
- `skipProvisioning`（あるいは CLI 認証失敗）時に `credentials` が存在しないと、`{{DEV_DATABASE_URL}}` などが上書きされず `file:` URL 維持となる。
- `.env.development` と `.env` の差分もなく、開発者が Turso を選んだ意図と乖離する。

### 2. Blob 変数の二重定義
- `BLOB_READ_WRITE_TOKEN` と `_DEV` サフィックス付きが同じ値で並ぶため、プロジェクト初学者がどちらを設定すべきか分かりにくい。
- Vercel CLI 向け `env-clear-vercel.ts` では `_DEV` などを扱っているが、CLI 生成物では既に `{{DEV_BLOB_*}}` プレースホルダーを用意しているため二重管理になっている。

### 3. Supabase / Turso 用変数の混在
- Turso を選択しても Supabase プレースホルダーが空文字のまま残り、環境変数管理サービス（1Password, Doppler など）で不要なキーが散乱する。
- 逆に Supabase 選択時でも `TURSO_*` が残り、Secret Manager へ反映する際にエラーや混乱を招く可能性がある。

### 4. DATABASE_URL 系の重複と名前の意図不一致
- 現状は `DATABASE_URL` / `DIRECT_DATABASE_URL` / `PRISMA_DATABASE_URL` が同じ値で埋められる。Prisma CLI が `DIRECT_DATABASE_URL` を利用するのはリモート接続時の最適化が目的であり、SQLite では意味が薄い。
- `docs/investigate/0002.md` で指摘されているように、`PRISMA_DATABASE_URL` を安易に `file:` へ戻す処理が他のロジックと干渉しているため、変数の役割整理が必要。

### 5. BETTER_AUTH_SECRET の自動生成不足
- 4 つの `.env*` で `change-me-*` がそのまま残る。Better Auth 側は未設定でもローカル開発を続行できるが、本番運用時に秘密情報の初期化を忘れるリスクが高い。
- CLI 側で `crypto.randomBytes(32)` などを用いて環境ごとに固有のシークレットを発行し、生成ログでも値の扱いを注意喚起するのが望ましい。

## 改善案
1. **Turso dev URL の設定ロジックを見直す**  
   - `skipProvisioning` 時でも `databaseConfig.naming.dev` を用いて `libsql://<slug>-dev.turso.io` を自動入力する。  
   - CLI 認証後に取得した `credentials` があれば優先し、未取得でも命名規則ベースの URL を埋めて手動修正が不要な状態にする。
2. **Blob 変数を単一キーに集約**  
   - `.env*` から `_DEV` / `_STG` / `_PROD` サフィックス付きの重複定義を削除し、`env-clear-vercel.ts` 側で新しいキー名称へ移行する。必要であれば後方互換用のマイグレーションを同時に提供。
3. **選択したデータベース以外の環境変数ブロックを削除**  
   - `configureEnvironmentFiles` 内でテンプレートを書き換える際、不要なプレースホルダーを空文字ではなくコメントアウト/削除する。  
   - または `.env.*` テンプレートをプロバイダ別に分割し、コピー段階で必要なファイルを選択する仕組みに変更する。
4. **DATABASE_URL 系の役割を再定義**  
   - Prisma が `DIRECT_DATABASE_URL` を必要とするのは Supabase/PostgreSQL 想定のみ。SQLite/Turso の場合は `DATABASE_URL` と `PRISMA_DATABASE_URL` に集約し、余計な重複を避ける。  
   - `ensure-db.ts` や `lib/db.ts` のロジックと整合性を取りつつ、`docs/investigate/0002.md` での TODO を同じタイミングで解決する。
5. **BETTER_AUTH_SECRET を CLI 生成時に自動設定**  
   - `configureEnvironmentFiles` 実行後に `.env*` を再読み込みし、空の `BETTER_AUTH_SECRET` に対して乱数を挿入する処理を追加。  
   - 生成レポート（`nextSteps`）にも値の保存/共有方法を明記し、既存ユーザー向けの移行手順をドキュメント化する。

## 未解決事項 / 次のアクション
- Turso URL 自動補完の仕様（`skipProvisioning` 時にどの程度確定情報を入力するか）を決める。
- Blob 変数の後方互換をどこまで維持するかを Vercel 用スクリプト担当者と要相談。
- Supabase/Turso いずれかのみを残す場合、既存テンプレートを分岐させるかテンプレート生成後に `.env` を再書き込みするか方針を決定する。
- `DATABASE_URL` 系統の整理に合わせて、Prisma マイグレーション/シードスクリプトの動作確認と追加テスト（特に Turso + Supabase 両ケース）を用意する。
- `BETTER_AUTH_SECRET` 自動生成を行う場合、再実行時（`--force` での上書き）に意図せず値を更新しないよう、既存ファイルに値があればスキップする条件を実装する。
