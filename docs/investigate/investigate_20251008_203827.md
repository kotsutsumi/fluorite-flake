# Expo管理画面機能実装調査報告書

## 調査概要

**調査日時**: 2025-10-08 20:38
**ブランチ**: feature/expo-admin-dashboard
**調査者**: Claude Code AI
**調査目的**: Expoプロジェクト生成時に、Next.jsプロジェクト生成と同等の管理画面機能を同梱し、GraphQLでログインやPOST表示ができる連携を実装する

## 要求仕様

1. Expoプロジェクトに同梱される管理画面をNext.jsプロジェクト生成と同等のものを配置
2. GraphQLでログインやPOSTの表示がExpo側からできる連携まで実装
3. テストを実装する
4. Expoプロジェクトの生成のときだけの拡張
5. ブランチはdevelopから派生すること
6. 今後Next.jsのプロジェクト生成が修正されたら同様に修正すること

## 現在の実装状況

### 既存のテンプレート構造

#### Next.js Fullstack Admin テンプレート
- **場所**: `templates/nextjs-fullstack-admin/`
- **主要機能**:
  - Better Authを用いたメール+パスワード認証
  - 役割ベースのアクセス制御（管理者/組織管理者/一般ユーザー）
  - 組織とメンバーの管理UI
  - プロフィール更新・ファイルアップロードのサンプル実装
  - Prisma + Tailwind CSS + shadcn/ui + Kibo UIコンポーネント
- **データベース**: SQLite/Turso/Supabase対応
- **認証**: Better Auth
- **GraphQL**: Apollo Server統合済み

#### Expo GraphQL テンプレート
- **場所**: `templates/expo-graphql/`
- **現在の構成**:
  - `backend/` - GraphQL APIサーバー（Apollo Server + Fastify）
  - `expo/` - React Native モバイルアプリ
  - `docs/` - ドキュメント
- **現在の制限**:
  - バックエンドは基本的なHelloクエリのみ実装
  - 認証機能なし
  - データベース機能なし
  - 管理画面機能なし

### プロジェクト生成システム

#### コマンド定義
- **場所**: `src/commands/create/constants.ts`
- **Next.js**: `fullstack-admin`テンプレート利用可能
- **Expo**: `fullstack-graphql`テンプレート利用可能

#### 生成フロー
- **場所**: `src/commands/create/generator.ts`
- **フロー**:
  1. テンプレートタイプ判定
  2. 拡張テンプレート処理（`handleAdvancedTemplate`）
  3. Next.js → `generateFullStackAdmin`
  4. Expo → `generateExpoGraphQL`

## 技術要件分析

### データベーススキーマ
Next.js fullstack-adminで定義されているスキーマ：

```prisma
// 主要モデル
model User {
  id, email, role, name, image
  MemberId, memberSince, metadata
  posts, accounts, sessions, memberships
}

model Post {
  id, title, content, published
  author関連
}

model Organization {
  id, name, slug, metadata
  members
}

model Member {
  id, role, joinedAt
  user, organization関連
}

model Session {
  認証セッション管理
}

model Account {
  外部プロバイダー連携
}
```

### GraphQL API要件
管理画面で必要なGraphQL操作：

**Query**:
- `users`: ユーザー一覧取得
- `posts`: 投稿一覧取得
- `organizations`: 組織一覧取得
- `user(id)`: ユーザー詳細取得
- `post(id)`: 投稿詳細取得

**Mutation**:
- `login(email, password)`: ログイン
- `logout`: ログアウト
- `createPost(title, content)`: 投稿作成
- `updatePost(id, title, content)`: 投稿更新
- `deletePost(id)`: 投稿削除
- `createUser(email, name, role)`: ユーザー作成
- `updateUser(id, ...)`: ユーザー更新

**Subscription**:
- `postUpdated`: 投稿リアルタイム更新
- `userStatusChanged`: ユーザーステータス変更

### 認証・認可要件
- **認証**: Better Auth互換のGraphQL認証
- **認可**: 役割ベース（admin, org_admin, user）
- **セッション管理**: JWTまたはセッションベース
- **Expo側**: Apollo Clientでの認証状態管理

## 実装課題と制約

### 技術的課題
1. **アーキテクチャ統合**: Next.js管理画面をExpoプロジェクトに統合
2. **GraphQL移植**: Better Auth認証をGraphQLリゾルバーに移植
3. **スキーマ共有**: PrismaスキーマをExpo/Next.js間で共有
4. **認証連携**: ExpoアプリからNext.js管理画面への認証連携

### プロジェクト構造の検討
以下の3つのアプローチが考えられる：

#### アプローチ1: 管理画面別フォルダ
```
expo-project/
├── backend/          # GraphQL API
├── expo/            # React Native App
└── admin/           # Next.js管理画面
```

#### アプローチ2: Monorepo統合
```
expo-project/
├── apps/
│   ├── backend/     # GraphQL API
│   ├── mobile/      # Expo App
│   └── admin/       # Next.js Admin
└── packages/
    └── shared/      # 共通ライブラリ
```

#### アプローチ3: 機能統合
```
expo-project/
├── backend/         # GraphQL API + Next.js API Routes
├── expo/           # React Native App
├── admin/          # Admin UI Components
└── shared/         # 共有スキーマ・型定義
```

## 実装方針

### 推奨アプローチ: アプローチ2（Monorepo統合）

**理由**:
- 既存のmonorepo生成機能を活用可能
- Next.js fullstack-adminの構造をそのまま利用可能
- スキーマ・型定義の共有が容易
- 将来的な保守性が高い

### 実装ステップ

#### Phase 1: テンプレート拡張
1. `templates/expo-graphql/`を`templates/expo-fullstack-admin/`に拡張
2. `admin/`ディレクトリにNext.js管理画面を配置
3. `packages/shared/`に共通スキーマを配置

#### Phase 2: GraphQL API拡張
1. `backend/src/schema/`にGraphQLスキーマ定義追加
2. `backend/src/resolvers/`にリゾルバー実装
3. Better Auth認証をGraphQLコンテキストに統合
4. Prismaクライアント統合

#### Phase 3: Expo側実装
1. Apollo Clientセットアップ
2. 認証状態管理実装
3. 管理画面機能のモバイル対応UI
4. リアルタイム更新機能

#### Phase 4: テスト実装
1. GraphQL APIのユニットテスト
2. 認証フローのE2Eテスト
3. Expo側の結合テスト
4. 管理画面のPlaywrightテスト

### ファイル構成

#### 新規作成が必要なファイル
```
templates/expo-fullstack-admin/
├── apps/
│   ├── backend/
│   │   ├── src/
│   │   │   ├── schema/        # GraphQLスキーマ定義
│   │   │   ├── resolvers/     # GraphQLリゾルバー
│   │   │   ├── auth/          # 認証ロジック
│   │   │   └── context.ts     # GraphQLコンテキスト
│   │   └── prisma/
│   │       └── schema.prisma  # データベーススキーマ
│   ├── mobile/                # Expo App
│   │   ├── src/
│   │   │   ├── graphql/       # GraphQLクエリ・ミューテーション
│   │   │   ├── auth/          # 認証状態管理
│   │   │   └── screens/       # 管理画面相当のモバイルUI
│   │   └── apollo.config.js
│   └── admin/                 # Next.js管理画面
│       └── [Next.js fullstack-adminの内容をコピー]
└── packages/
    └── shared/
        ├── types/             # 共通型定義
        ├── graphql/           # GraphQLスキーマ・クエリ
        └── auth/              # 認証ユーティリティ
```

#### 修正が必要なファイル
1. `src/commands/create/constants.ts`: 新しいテンプレート定義追加
2. `src/commands/create/template-generators/expo-graphql.ts`: 拡張機能実装
3. `src/commands/create/generator.ts`: 新しいテンプレート処理追加

### データフロー設計

```
[Expo App] <--GraphQL--> [Apollo Server] <--Prisma--> [Database]
                              ^
                              |
                         [Next.js Admin] <--Better Auth--> [Session Store]
```

### 認証フロー設計

1. **Expo側ログイン**: GraphQL Mutation `login` → JWT Token取得
2. **セッション管理**: Apollo Client AuthLinkでトークン管理
3. **管理画面アクセス**: Next.js側でセッション検証
4. **権限制御**: GraphQLリゾルバーレベルでRole-based制御

## リスク要因

### 高リスク
1. **複雑性増加**: 3つのアプリケーション（Expo/Next.js/GraphQL）の統合
2. **認証互換性**: Better AuthとGraphQL認証の統合課題
3. **型安全性**: GraphQLスキーマとTypeScriptの一貫性維持

### 中リスク
1. **パフォーマンス**: Monorepoビルド時間の増加
2. **依存関係**: 複数プラットフォーム間の依存関係管理
3. **テスト複雑性**: 複数レイヤーのテスト実装

### 低リスク
1. **設定管理**: 複数環境の設定ファイル管理
2. **デプロイ**: 複数サービスのデプロイ戦略

## 次のステップ

### 実装推奨
この調査の結果、実装は**推奨**します。

**理由**:
- 既存の`nextjs-fullstack-admin`テンプレートが非常に完成度が高い
- GraphQL統合のためのApollo Serverが既に組み込まれている
- Monorepo生成機能が既に存在し、統合が可能
- 段階的実装により、リスクを最小化できる

### 優先度の高いタスク
1. **Phase 1**: テンプレート構造の設計と実装（工数: 2-3日）
2. **Phase 2**: GraphQL APIの実装（工数: 3-4日）
3. **Phase 3**: Expo側の実装（工数: 2-3日）
4. **Phase 4**: テスト実装（工数: 1-2日）

**総工数見積もり**: 8-12日

### 成功基準
1. ✅ Expoプロジェクト生成時に管理画面が同梱される
2. ✅ GraphQLでログイン・POST表示ができる
3. ✅ Expo側から管理画面機能にアクセス可能
4. ✅ 包括的なテストが実装されている
5. ✅ Next.jsテンプレート更新時の追従可能性が担保されている

## 技術仕様書

### GraphQLスキーマ設計

```graphql
type User {
  id: ID!
  email: String!
  name: String
  role: Role!
  posts: [Post!]!
  createdAt: DateTime!
  updatedAt: DateTime!
}

type Post {
  id: ID!
  title: String!
  content: String
  published: Boolean!
  author: User!
  createdAt: DateTime!
  updatedAt: DateTime!
}

enum Role {
  ADMIN
  ORG_ADMIN
  USER
}

type Query {
  me: User
  users(limit: Int, offset: Int): [User!]!
  posts(published: Boolean, limit: Int, offset: Int): [Post!]!
  post(id: ID!): Post
}

type Mutation {
  login(email: String!, password: String!): AuthPayload!
  logout: Boolean!
  createPost(title: String!, content: String): Post!
  updatePost(id: ID!, title: String, content: String): Post!
  deletePost(id: ID!): Boolean!
}

type AuthPayload {
  token: String!
  user: User!
}
```

### Apollo Client設定

```typescript
// expo/src/apollo/client.ts
import { ApolloClient, InMemoryCache, createHttpLink } from '@apollo/client';
import { setContext } from '@apollo/client/link/context';
import AsyncStorage from '@react-native-async-storage/async-storage';

const httpLink = createHttpLink({
  uri: 'http://localhost:4000/graphql',
});

const authLink = setContext(async (_, { headers }) => {
  const token = await AsyncStorage.getItem('authToken');
  return {
    headers: {
      ...headers,
      authorization: token ? `Bearer ${token}` : "",
    }
  };
});

export const client = new ApolloClient({
  link: authLink.concat(httpLink),
  cache: new InMemoryCache(),
});
```

## 結論

この調査により、Expo管理画面機能の実装は**技術的に実現可能**であり、**費用対効果が高い**と判断されます。既存のNext.js fullstack-adminテンプレートの高い完成度を活用し、段階的なアプローチによりリスクを最小化しながら実装を進めることを推奨します。

実装後は、両方のテンプレート（Next.js fullstack-admin、Expo fullstack-admin）の機能的等価性を維持し、将来的な機能追加時には両方のテンプレートに反映する仕組みを構築することが重要です。