# Fluorite-flake CLIアーキテクチャ

## 1. CLI システム概要

Fluorite-flakeのCLIは、Commander.jsをベースとしたモダンなコマンドラインインターフェースです。マルチコマンド、国際化対応、対話型プロンプト、リアルタイムダッシュボードなど豊富な機能を提供します。

### 1.1 CLIアーキテクチャ概観

```
┌─────────────────────────────────────────────────────────────────┐
│                     CLI アーキテクチャ                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │    エントリ  │    │  コマンド   │    │ インターフェース │      │
│  │   ポイント   │ ──►│   ルーター  │ ──►│    レイヤー     │      │
│  │             │    │             │    │                 │      │
│  │ ├ cli.ts    │    │ ├ create    │    │ ├ 対話プロンプト │      │
│  │ ├ 引数解析   │    │ ├ dashboard │    │ ├ TUIダッシュ    │      │
│  │ ├ i18n設定  │    │ ├ deploy    │    │ ├ WebSocket     │      │
│  │ └ グローバル │    │ ├ logs      │    │ └ REST API      │      │
│  │   オプション │    │ └ ipc       │    │                 │      │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                       コマンド実行フロー                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 引数解析・前処理                                             │
│     ├ pnpm '--' セパレータ除去                                  │
│     ├ ロケール早期検出・設定                                     │
│     └ グローバルオプション処理                                   │
│                                                                 │
│  2. コマンドルーティング                                         │
│     ├ サブコマンド判定                                           │
│     ├ オプション検証                                             │
│     └ アクション関数呼び出し                                     │
│                                                                 │
│  3. 実行・エラーハンドリング                                     │
│     ├ 非同期処理管理                                             │
│     ├ プロセス終了コード制御                                     │
│     └ 国際化メッセージ表示                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 2. コマンド構成

### 2.1 コマンド階層

```
fluorite-flake
├── create [options]                      # プロジェクト生成（メインコマンド）
├── dashboard [service] [options]         # マルチサービスダッシュボード
│   ├── multi <services...> [options]    # 複数サービス同時監視
│   ├── all [options]                     # 全サービス監視
│   └── sidecar [options]                 # Tauriサイドカーモード
├── deploy [name] [options]               # Cloudflare Worker デプロイ
├── r2 <action> [bucket-name]             # R2バケット管理
├── logs [worker-name] [options]          # Workerログ監視
├── ipc [options]                         # IPCサーバー起動
├── ipc-test [options]                    # IPCテスト
└── tui [options]                         # TUIダッシュボード（非推奨）
```

### 2.2 コマンド詳細設計

#### 2.2.1 create コマンド
```
┌─────────────────────────────────────────────────────────┐
│                  createコマンド設計                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  コマンド形式:                                          │
│  fluorite-flake create [options]                        │
│  fluorite-flake new [options]     # エイリアス          │
│                                                         │
│  オプション:                                            │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ --name <name>           プロジェクト名              │ │
│  │ --path <path>           プロジェクトパス            │ │
│  │ --framework <fw>        フレームワーク              │ │
│  │                         (nextjs|expo|tauri|flutter) │ │
│  │ --database <db>         データベース                │ │
│  │                         (none|turso|supabase)       │ │
│  │ --orm <orm>             ORM (prisma|drizzle)        │ │
│  │ --storage <storage>     ストレージ                  │ │
│  │ --no-deployment         デプロイ設定スキップ        │ │
│  │ --no-auth              認証設定スキップ             │ │
│  │ --package-manager <pm>  パッケージマネージャー      │ │
│  │ --mode <mode>          モード (full|minimal|test)   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  実行モード:                                            │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 1. 対話モード (デフォルト)                          │ │
│  │    └ オプション未指定時、promptsで設定収集          │ │
│  │                                                     │ │
│  │ 2. CLIモード                                        │ │
│  │    ├ 全オプション指定で非対話実行                   │ │
│  │    ├ 必須項目の検証                                 │ │
│  │    └ データベース使用時のORM必須チェック            │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 2.2.2 dashboard コマンド
```
┌─────────────────────────────────────────────────────────┐
│                dashboardコマンド設計                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  メインコマンド:                                        │
│  fluorite-flake dashboard [service] [options]           │
│                                                         │
│  サポートサービス:                                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ • vercel      - Vercelプロジェクト・デプロイ監視    │ │
│  │ • supabase    - Supabaseプロジェクト・DB監視        │ │
│  │ • turso       - TursoデータベースとAPI監視          │ │
│  │ • aws         - AWS EC2、S3、Lambda監視             │ │
│  │ • github      - GitHubリポジトリとActions監視       │ │
│  │ • cloudflare  - Cloudflare Workers、Pages、R2監視  │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  オプション:                                            │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ --mode <mode>      出力モード (tui|cli|json)        │ │
│  │ --theme <theme>    カラーテーマ (dark|light|auto)   │ │
│  │ --layout <layout>  レイアウト (grid|tabs|split)     │ │
│  │ --refresh <ms>     リフレッシュ間隔                 │ │
│  │ --json            JSON出力 (--mode json同等)       │ │
│  │ --host <host>      通信ホスト                       │ │
│  │ --port <port>      通信ポート                       │ │
│  │ --token <token>    認証トークン                     │ │
│  │ --protocol <proto> プロトコル (ws|rest)             │ │
│  │ --project <proj>   プロジェクトフィルタ             │ │
│  │ --region <region>  リージョンフィルタ               │ │
│  │ --env <env>        環境フィルタ                     │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  サブコマンド:                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ multi <services...>  複数サービス同時監視           │ │
│  │ all                  全サービス監視                 │ │
│  │ sidecar             Tauriサイドカーモード           │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 3. 国際化アーキテクチャ

### 3.1 i18n システム設計
```
┌─────────────────────────────────────────────────────────┐
│                  国際化システム                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ロケール検出フロー:                                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │                                                     │ │
│  │ 1. 早期検出（Commander初期化前）                     │ │
│  │    ├ findLocaleArgument() でprocess.argv走査        │ │
│  │    ├ --locale=ja / -L ja 形式をサポート             │ │
│  │    └ setLocale() で早期設定                         │ │
│  │                                                     │ │
│  │ 2. Commander解析後の再設定                          │ │
│  │    ├ preActionフックで再チェック                    │ │
│  │    ├ optsWithGlobals() でオプション取得             │ │
│  │    └ v8/v9互換性を維持                              │ │
│  │                                                     │ │
│  │ 3. 優先順位                                         │ │
│  │    ├ 明示的オプション > 環境変数                    │ │
│  │    ├ 環境変数 > システムロケール                    │ │
│  │    └ デフォルト: 英語 (en)                          │ │
│  │                                                     │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  メッセージ管理:                                        │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ src/utils/i18n.ts                                   │ │
│  │ ┌─────────────────────────────────────────────────┐ │ │
│  │ │ export function getCliDescription(): string {   │ │ │
│  │ │   return getCurrentLocale() === 'ja'            │ │ │
│  │ │     ? 'マルチフレームワーク対応プロジェクト...'   │ │ │
│  │ │     : 'Multi-framework project generator...';   │ │ │
│  │ │ }                                               │ │ │
│  │ │                                                 │ │ │
│  │ │ export function formatInvalidOption(            │ │ │
│  │ │   option: string, value: string                 │ │ │
│  │ │ ): string {                                     │ │ │
│  │ │   return getCurrentLocale() === 'ja'            │ │ │
│  │ │     ? `無効な${option}: ${value}`               │ │ │
│  │ │     : `Invalid ${option}: ${value}`;            │ │ │
│  │ │ }                                               │ │ │
│  │ └─────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.2 サポート言語
| 言語コード | 言語名 | 実装状況 |
|------------|--------|----------|
| `en` | English | ✅ 完全対応 |
| `ja` | 日本語 | ✅ 完全対応 |

## 4. 引数処理・バリデーション

### 4.1 引数処理フロー
```
┌─────────────────────────────────────────────────────────┐
│                  引数処理フロー                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. 前処理                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ const sanitizedUserArgs = process.argv.slice(2)     │ │
│  │   .filter(arg => arg !== '--');                     │ │
│  │                                                     │ │
│  │ // pnpm実行時の '--' セパレータを除去               │ │
│  │ const argvToParse = [...process.argv];              │ │
│  │ const separatorIndex = argvToParse.indexOf('--');   │ │
│  │ if (separatorIndex !== -1) {                        │ │
│  │   argvToParse.splice(separatorIndex, 1);            │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  2. バリデーション                                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ createコマンドの場合:                               │ │
│  │                                                     │ │
│  │ ├ フレームワーク値チェック                          │ │
│  │ │  (['nextjs','expo','tauri','flutter'])           │ │
│  │ ├ データベース値チェック                            │ │
│  │ │  (['none','turso','supabase'])                   │ │
│  │ ├ ストレージ値チェック                              │ │
│  │ │  (['none','vercel-blob','cloudflare-r2',...])    │ │
│  │ ├ 必須項目チェック（CLIモード時）                   │ │
│  │ │  (name, framework, path, database, storage...)   │ │
│  │ └ 条件依存チェック                                  │ │
│  │    (database !== 'none' なら orm必須)              │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  3. エラーハンドリング                                  │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ 国際化されたエラーメッセージ表示                   │ │
│  │ ├ process.exit(1) でプロセス終了                    │ │
│  │ └ ヘルプ表示（引数なし時）                          │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 4.2 バリデーションルール

#### 4.2.1 createコマンドのバリデーション
```typescript
┌─────────────────────────────────────────────────────────┐
│                 バリデーションルール                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  必須フィールド検証（CLIモード）:                       │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ const requiredFields = [                            │ │
│  │   'name',        // プロジェクト名                  │ │
│  │   'framework',   // フレームワーク                  │ │
│  │   'path',        // プロジェクトパス                │ │
│  │   'database',    // データベース選択                │ │
│  │   'storage',     // ストレージ選択                  │ │
│  │   'packageManager' // パッケージマネージャー        │ │
│  │ ];                                                  │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  値域検証:                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ framework: ['nextjs', 'expo', 'tauri', 'flutter']   │ │
│  │ database: ['none', 'turso', 'supabase']             │ │
│  │ orm: ['prisma', 'drizzle']                          │ │
│  │ storage: ['none', 'vercel-blob', 'cloudflare-r2',   │ │
│  │          'aws-s3', 'supabase-storage']              │ │
│  │ packageManager: ['npm', 'pnpm', 'yarn', 'bun']      │ │
│  │ mode: ['full', 'minimal', 'test']                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  条件依存検証:                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ if (database !== 'none' && !orm) {                  │ │
│  │   throw new Error(getOrmRequiredMessage());         │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 5. コマンド実行エンジン

### 5.1 Commander.js 統合
```
┌─────────────────────────────────────────────────────────┐
│                Commander.js統合                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  プログラム初期化:                                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ const program = new Command();                      │ │
│  │                                                     │ │
│  │ program                                             │ │
│  │   .name('fluorite-flake')                           │ │
│  │   .description(getCliDescription())                 │ │
│  │   .version(packageJson.version)                     │ │
│  │   .option('-L, --locale <locale>',                  │ │
│  │           getLocaleOptionDescription());            │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  ライフサイクルフック:                                  │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ program.hook('preAction', (thisCommand) => {        │ │
│  │   const opts = typeof thisCommand.optsWithGlobals   │ │
│  │     === 'function'                                  │ │
│  │     ? thisCommand.optsWithGlobals()                 │ │
│  │     : thisCommand.opts();                           │ │
│  │                                                     │ │
│  │   if (opts?.locale) {                               │ │
│  │     setLocale(opts.locale);                         │ │
│  │   }                                                 │ │
│  │ });                                                 │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  コマンド登録:                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ program                                             │ │
│  │   .command('create')                                │ │
│  │   .alias('new')                                     │ │
│  │   .description(getCreateCommandDescription())       │ │
│  │   .option('--name <name>', 'Project name')          │ │
│  │   .option('--framework <framework>', '...')         │ │
│  │   .action(async (options) => {                      │ │
│  │     await createProject(config);                    │ │
│  │   });                                               │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 5.2 非同期処理管理
```
┌─────────────────────────────────────────────────────────┐
│                非同期処理アーキテクチャ                  │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  アクション関数設計:                                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ .action(async (options) => {                        │ │
│  │   try {                                             │ │
│  │     // 1. 設定検証・前処理                          │ │
│  │     const config = validateAndProcessOptions(opts); │ │
│  │                                                     │ │
│  │     // 2. メイン処理実行                            │ │
│  │     await executeMainLogic(config);                 │ │
│  │                                                     │ │
│  │     // 3. 成功時の後処理                            │ │
│  │     console.log(getSuccessMessage());               │ │
│  │                                                     │ │
│  │   } catch (error) {                                 │ │
│  │     // 4. エラーハンドリング                        │ │
│  │     console.error(getErrorMessage(error));          │ │
│  │     process.exit(1);                                │ │
│  │   }                                                 │ │
│  │ });                                                 │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  プロセス管理:                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ プロセス終了コード制御                            │ │
│  │ │  ├ 成功: 0                                       │ │
│  │ │  ├ 一般エラー: 1                                 │ │
│  │ │  └ バリデーションエラー: 1                       │ │
│  │ │                                                 │ │
│  │ ├ シグナルハンドリング                              │ │
│  │ │  ├ SIGINT (Ctrl+C)                              │ │
│  │ │  └ SIGTERM                                      │ │
│  │ │                                                 │ │
│  │ └ 非同期リソース管理                                │ │
│  │    ├ WebSocket接続の適切な終了                     │ │
│  │    ├ ファイル出力の完了待機                         │ │
│  │    └ スピナー・プログレスバーの停止                 │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 6. 対話型インターフェース

### 6.1 プロンプトシステム
```
┌─────────────────────────────────────────────────────────┐
│                プロンプトシステム                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  prompts ライブラリ統合:                                │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ import prompts from 'prompts';                      │ │
│  │                                                     │ │
│  │ const questions = [                                 │ │
│  │   {                                                 │ │
│  │     type: 'text',                                   │ │
│  │     name: 'projectName',                            │ │
│  │     message: getProjectNamePrompt(),                │ │
│  │     validate: (value: string) =>                    │ │
│  │       value.length > 0 || getValidationError()     │ │
│  │   },                                                │ │
│  │   {                                                 │ │
│  │     type: 'select',                                 │ │
│  │     name: 'framework',                              │ │
│  │     message: getFrameworkPrompt(),                  │ │
│  │     choices: [                                      │ │
│  │       { title: 'Next.js', value: 'nextjs' },       │ │
│  │       { title: 'Expo', value: 'expo' },             │ │
│  │       { title: 'Tauri', value: 'tauri' },           │ │
│  │       { title: 'Flutter', value: 'flutter' }        │ │
│  │     ]                                               │ │
│  │   },                                                │ │
│  │   // ... 他の質問                                   │ │
│  │ ];                                                  │ │
│  │                                                     │ │
│  │ const response = await prompts(questions);          │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  条件分岐プロンプト:                                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ // データベース選択に応じてORM選択を表示             │ │
│  │ {                                                   │ │
│  │   type: (prev) => prev === 'none' ? null : 'select',│ │
│  │   name: 'orm',                                      │ │
│  │   message: getOrmPrompt(),                          │ │
│  │   choices: [                                        │ │
│  │     { title: 'Prisma', value: 'prisma' },           │ │
│  │     { title: 'Drizzle', value: 'drizzle' }          │ │
│  │   ]                                                 │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  プロンプトフロー:                                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 1. プロジェクト基本情報                             │ │
│  │    ├ プロジェクト名                                 │ │
│  │    ├ プロジェクトパス                               │ │
│  │    └ フレームワーク選択                             │ │
│  │                                                     │ │
│  │ 2. データベース・ORM設定                            │ │
│  │    ├ データベース選択                               │ │
│  │    └ ORM選択（条件付き）                            │ │
│  │                                                     │ │
│  │ 3. ストレージ・認証設定                             │ │
│  │    ├ ストレージ選択                                 │ │
│  │    └ 認証設定                                       │ │
│  │                                                     │ │
│  │ 4. 開発環境設定                                     │ │
│  │    ├ パッケージマネージャー                         │ │
│  │    ├ デプロイ設定                                   │ │
│  │    └ 追加機能（Storybook等）                        │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 6.2 UI コンポーネント
```
┌─────────────────────────────────────────────────────────┐
│                  UIコンポーネント                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  視覚効果ライブラリ:                                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ chalk   - テキストカラー・スタイリング             │ │
│  │ │  ├ chalk.red() / .green() / .yellow()             │ │
│  │ │  ├ chalk.bold() / .dim() / .underline()           │ │
│  │ │  └ chalk.bgBlue() / .bgRed()                      │ │
│  │ │                                                   │ │
│  │ ├ ora     - スピナー・プログレスインジケータ         │ │
│  │ │  ├ ora('Loading...').start()                      │ │
│  │ │  ├ spinner.succeed() / .fail()                    │ │
│  │ │  └ spinner.text = 'Updated text'                  │ │
│  │ │                                                   │ │
│  │ └ blessed - TUIダッシュボード（dashboard機能）       │ │
│  │    ├ リアルタイムウィジェット                        │ │
│  │    ├ インタラクティブ操作                           │ │
│  │    └ マルチサービス統合表示                         │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  進捗表示パターン:                                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ // プロジェクト生成時                               │ │
│  │ const spinner = ora({                               │ │
│  │   text: getGeneratingMessage(),                     │ │
│  │   color: 'cyan'                                     │ │
│  │ }).start();                                         │ │
│  │                                                     │ │
│  │ try {                                               │ │
│  │   await generateProject(config);                    │ │
│  │   spinner.succeed(getSuccessMessage());             │ │
│  │ } catch (error) {                                   │ │
│  │   spinner.fail(getErrorMessage(error));             │ │
│  │   throw error;                                      │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 7. ダッシュボード統合

### 7.1 TUIダッシュボード
```
┌─────────────────────────────────────────────────────────┐
│               TUIダッシュボードアーキテクチャ            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  blessed-contrib 統合:                                  │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ Grid レイアウトシステム                           │ │
│  │ │  ├ グリッドベース配置                             │ │
│  │ │  ├ 動的リサイズ対応                               │ │
│  │ │  └ レスポンシブ設計                               │ │
│  │ │                                                   │ │
│  │ ├ ウィジェット                                       │ │
│  │ │  ├ Table（データ一覧表示）                        │ │
│  │ │  ├ Line（メトリクス・チャート）                   │ │
│  │ │  ├ Log（リアルタイムログ）                        │ │
│  │ │  ├ Gauge（リソース使用率）                        │ │
│  │ │  └ Progress（進捗状況）                           │ │
│  │ │                                                   │ │
│  │ └ インタラクション                                   │ │
│  │    ├ キーボードショートカット                       │ │
│  │    ├ マウス操作サポート                             │ │
│  │    └ 設定変更・操作実行                             │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  レイアウト設計:                                        │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ┌─────────┬─────────┬─────────┬─────────┐           │ │
│  │ │Service  │Metrics  │ Logs    │Actions  │           │ │
│  │ │Status   │Chart    │Stream   │Panel    │           │ │
│  │ │         │         │         │         │           │ │
│  │ ├─────────┼─────────┴─────────┼─────────┤           │ │
│  │ │Projects │   Resource Usage  │Deploymt │           │ │
│  │ │List     │   (CPU/Memory)    │History  │           │ │
│  │ │         │                   │         │           │ │
│  │ ├─────────┴───────────────────┴─────────┤           │ │
│  │ │           Real-time Events            │           │ │
│  │ │          (WebSocket Stream)           │           │ │
│  │ └───────────────────────────────────────┘           │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 7.2 リアルタイム通信
```
┌─────────────────────────────────────────────────────────┐
│              リアルタイム通信アーキテクチャ              │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  プロトコルスタック:                                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ┌─────────────────────────────────────────────────┐ │ │
│  │ │                 WebSocket                       │ │ │
│  │ │  ├ ws ライブラリベース                          │ │ │
│  │ │  ├ JSON-RPC プロトコル                          │ │ │
│  │ │  ├ 認証トークン検証                             │ │ │
│  │ │  └ 自動再接続・ハートビート                     │ │ │
│  │ └─────────────────────────────────────────────────┘ │ │
│  │ ┌─────────────────────────────────────────────────┐ │ │
│  │ │                 REST API                        │ │ │
│  │ │  ├ Express.jsサーバー                           │ │ │
│  │ │  ├ ポーリングベース更新                         │ │ │
│  │ │  ├ JSON データフォーマット                      │ │ │
│  │ │  └ HTTP認証（Bearer Token）                     │ │ │
│  │ └─────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  データフロー:                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ CLI Client                                          │ │
│  │     │                                               │ │
│  │     ▼ (WebSocket/REST)                              │ │
│  │ IPC Server                                          │ │
│  │     │                                               │ │
│  │     ├─► Service Adapters                            │ │
│  │     │   ├ AWS Adapter                               │ │
│  │     │   ├ Vercel Adapter                            │ │
│  │     │   ├ Supabase Adapter                          │ │
│  │     │   └ Cloudflare Adapter                        │ │
│  │     │                                               │ │
│  │     ▼                                               │ │
│  │ Dashboard Orchestrator                              │ │
│  │     │                                               │ │
│  │     ▼ (データ集約・配信)                            │ │
│  │ TUI Dashboard / JSON Output                         │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 8. エラーハンドリング戦略

### 8.1 エラー分類・処理
```
┌─────────────────────────────────────────────────────────┐
│                エラーハンドリング戦略                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  エラーカテゴリ:                                        │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 1. バリデーションエラー                             │ │
│  │    ├ 無効なオプション値                             │ │
│  │    ├ 必須項目欠如                                   │ │
│  │    ├ 条件依存違反                                   │ │
│  │    └ ファイルパス関連                               │ │
│  │                                                     │ │
│  │ 2. システムエラー                                   │ │
│  │    ├ ファイルI/O エラー                             │ │
│  │    ├ ネットワーク接続エラー                         │ │
│  │    ├ パッケージマネージャーエラー                   │ │
│  │    └ 外部サービス API エラー                        │ │
│  │                                                     │ │
│  │ 3. 実行時エラー                                     │ │
│  │    ├ プロジェクト生成失敗                           │ │
│  │    ├ テンプレート処理エラー                         │ │
│  │    ├ 依存関係インストール失敗                       │ │
│  │    └ 設定書き込みエラー                             │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  エラー処理パターン:                                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ try {                                               │ │
│  │   await riskyOperation();                           │ │
│  │ } catch (error) {                                   │ │
│  │   if (error instanceof ValidationError) {           │ │
│  │     console.error(formatValidationError(error));    │ │
│  │     process.exit(1);                                │ │
│  │   }                                                 │ │
│  │                                                     │ │
│  │   if (error instanceof NetworkError) {              │ │
│  │     console.error(formatNetworkError(error));       │ │
│  │     if (retryCount < MAX_RETRIES) {                 │ │
│  │       await retry();                                │ │
│  │     } else {                                        │ │
│  │       process.exit(1);                              │ │
│  │     }                                               │ │
│  │   }                                                 │ │
│  │                                                     │ │
│  │   // 予期しないエラー                               │ │
│  │   console.error(formatUnexpectedError(error));      │ │
│  │   process.exit(1);                                  │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 9. パフォーマンス最適化

### 9.1 起動時間最適化
```
┌─────────────────────────────────────────────────────────┐
│                パフォーマンス最適化                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  起動時間最適化:                                        │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 1. 遅延ローディング                                 │ │
│  │    ├ dynamic import() でコマンド実装を遅延読み込み  │ │
│  │    ├ 重いライブラリの条件読み込み                   │ │
│  │    └ 使用されないモジュールの読み込み回避           │ │
│  │                                                     │ │
│  │ 2. 設定キャッシュ                                   │ │
│  │    ├ パッケージバージョン情報のキャッシュ           │ │
│  │    ├ テンプレートマッピングの事前解決               │ │
│  │    └ 設定検証結果のメモ化                           │ │
│  │                                                     │ │
│  │ 3. 並列処理                                         │ │
│  │    ├ 複数ファイルの並列生成                         │ │
│  │    ├ 非同期I/O操作の最適化                          │ │
│  │    └ Promise.allSettled() による効率的待機          │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  メモリ使用量最適化:                                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ ストリーミング処理                                │ │
│  │ │  ├ 大きなテンプレートファイルのストリーム読み込み │ │
│  │ │  ├ ファイル生成時のバッファ管理                   │ │
│  │ │  └ メモリリーク防止                               │ │
│  │ │                                                   │ │
│  │ ├ 適切なスコープ管理                                │ │
│  │ │  ├ 使い終わったオブジェクトの明示的解放           │ │
│  │ │  ├ 循環参照の回避                                 │ │
│  │ │  └ WeakMap/WeakSet の活用                         │ │
│  │ │                                                   │ │
│  │ └ リソース管理                                       │ │
│  │    ├ ファイルハンドルの適切なクローズ               │ │
│  │    ├ WebSocket接続の明示的切断                      │ │
│  │    └ タイマー・インターバルの適切なクリア           │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 10. 拡張性・保守性

### 10.1 新コマンド追加パターン
```
┌─────────────────────────────────────────────────────────┐
│                新コマンド追加パターン                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  手順:                                                  │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 1. コマンド実装作成                                 │ │
│  │    └ src/commands/new-command.ts                    │ │
│  │                                                     │ │
│  │ 2. CLI登録                                          │ │
│  │    └ src/cli.ts に .command() 追加                  │ │
│  │                                                     │ │
│  │ 3. 型定義追加                                       │ │
│  │    └ src/types/ に必要な型を定義                    │ │
│  │                                                     │ │
│  │ 4. i18n メッセージ追加                              │ │
│  │    └ src/utils/i18n.ts にメッセージ関数追加         │ │
│  │                                                     │ │
│  │ 5. テスト追加                                       │ │
│  │    ├ test/unit/commands/new-command.test.ts         │ │
│  │    └ test/functional/cli/new-command.test.ts        │ │
│  │                                                     │ │
│  │ 6. ドキュメント更新                                 │ │
│  │    ├ README.md                                      │ │
│  │    └ docs/ 関連ファイル                             │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  ベストプラクティス:                                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ 単一責任原則の遵守                                │ │
│  │ ├ 既存パターンとの一貫性維持                        │ │
│  │ ├ 適切なエラーハンドリング                          │ │
│  │ ├ 国際化メッセージ対応                              │ │
│  │ ├ 包括的なテストカバレッジ                          │ │
│  │ └ 後方互換性の考慮                                  │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

*次章: [03_ジェネレーター設計](./03_ジェネレーター設計.md)*