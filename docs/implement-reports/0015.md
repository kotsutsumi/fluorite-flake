# テストケースの拡充 - 実装報告

## 実装概要

- **計画**: `docs/plans/0015.md` - Next.js プロジェクト生成テストケースの拡充
- **実装期間**: 2025年10月6日
- **ステータス**: ✅ 完了

## 実装内容

### 1. 調査・分析フェーズ

#### テスト実行とカバレッジ取得
- `pnpm test` を実行し、18ファイル・219テストが 29.30 秒で成功することを確認。
- `@vitest/coverage-v8` を devDependencies に追加し、`pnpm test:coverage -- --reporter=lcov --reporter=json-summary` を実行。19ファイル・221テスト、29.80 秒で完走し、`coverage/` 以下に HTML/JSON/LCOV レポートを生成。
- `coverage/coverage-final.json` を解析し、Next.js 関連ファイル／ユーティリティのステートメント・関数カバレッジを算出。

#### Next.js 関連コンポーネントの棚卸し
- 主要実装: `src/commands/create/template-generators/nextjs-fullstack-admin.ts`（369行）
- 補助ロジック: `generator.ts`, `validators.ts`, `prompts/blob-prompts.ts`
- ユーティリティ: `src/utils/turso-cli/`（9ファイル）, `src/utils/supabase-cli/`（9ファイル）, `src/utils/template-manager/`（3ファイル）

#### 既存テストコードの棚卸し
- コア: `validators.test.ts`（17ケース）, `generator.test.ts`（9ケース）
- ユーティリティ: `turso-cli/*.test.ts`（44ケース）, `supabase-cli/*.test.ts`（34ケース）, `template-manager/copy-template.test.ts`（1ケース）
- E2E: `project-creation.test.ts`（11シナリオ）

### 2. ソースコードとテストの対応マッピング

| 対象領域 | 主対象ファイル | 対応テスト | ステートメント網羅率 | 関数網羅率 |
|----------|----------------|------------|------------------------|-------------|
| ジェネレータ基盤 | `generator.ts` | `generator.test.ts` | 69.05% (116/168) | 83.33% (5/6) |
| バリデーション | `validators.ts` | `validators.test.ts` | 43.75% (14/32) | 25.00% (2/8) |
| Next.js テンプレート | `nextjs-fullstack-admin.ts` | 該当テストなし | 7.49% (23/307) | 0% (0/7) |
| Turso CLI | `src/utils/turso-cli/` | `turso-cli/*.test.ts` | 34.28% (277/808) | 78.79% (26/33) |
| Supabase CLI | `src/utils/supabase-cli/` | `supabase-cli/*.test.ts` | 13.56% (168/1239) | 100% (15/15) |
| Blob 設定プロンプト | `prompts/blob-prompts.ts` | なし | 0% (0/176) | 100% (1/1) |
| テンプレート管理 | `template-manager/` | `copy-template.test.ts` | 79.41% (108/136) | 100% (6/6) |

### 3. ギャップ分析と優先度付け

#### High Priority
1. **Next.js 固有テンプレート生成のユニットテスト実装**
   - カバー対象: `buildEnvReplacements`, `configureEnvironmentFiles`, `selectPrismaSchema`, `runSetupCommands`, `generateFullStackAdmin`
   - 期待効果: ステートメントカバレッジ 7.49% → 70%以上
2. **外部 CLI 依存エラーハンドリング強化**
   - 対象: Turso/Supabase プロビジョニング分岐および `pnpm` セットアップコマンド失敗時の経路

#### Medium Priority
1. Blob 設定フロー（`blob-prompts.ts`）の対話テスト追加
2. 国際化メッセージ（英語/日本語、成功・異常系）の網羅テスト
3. 部分的失敗時のリカバリー処理検証（環境変数生成、テンプレートコピー）

#### Low Priority
1. 生成ファイル内容のスナップショット検証
2. エラーメッセージのローカライゼーション整合性確認

### 4. ドキュメント整備
- `docs/reports/testing/nextjs-generation-coverage.md` を全面更新し、実測カバレッジ値・テスト件数・改善提案を反映。
- `docs/reviews/src/commands/create/nextjs-generation.md` は現行分析内容と整合していることを確認し、必要箇所を軽微に調整（主要ファイルの行数など）。

## 主要発見事項

- Next.js フルスタックテンプレート（369行）はステートメント 7.49%、関数 0/7 と未テスト領域が顕著。
- バリデーション層 (`validators.ts`) は既存テストで 43.75% に留まり、新規テンプレート定義やエラーメッセージ分岐が未検証。
- Turso/Supabase CLI ユーティリティは正常系の関数網羅率が高い一方で、大量のセットアップ／プロビジョニング分岐（計 2,047 ステートメント）が未実行。
- `blob-prompts.ts` は 176 ステートメント全て未カバーであり、Vercel Blob 統合フローの品質保証が行われていない。

## 推奨される次ステップ

### 即時（1〜2週間）
1. Next.js 固有テンプレート向けユニットテスト作成
2. 外部 CLI 失敗シナリオ（Turso/Supabase）のモック追加
3. Blob 設定対話フローのユニットテスト

### 中期（〜1ヶ月）
1. 国際化メッセージの網羅テスト（成功・異常系）
2. 生成物スナップショット比較の自動化
3. カバレッジ集計の自動生成スクリプト

### 長期（四半期）
1. テスト品質メトリクスの継続モニタリング
2. 新テンプレート／オプション追加時のテストガードレール整備

## 工数見積もり（再評価）
- High Priority: 2.5日（テンプレートテスト 1.5日 + 外部 CLI エラー 1日）
- Medium Priority: 2日（Blob 0.5日 + 国際化 1日 + 部分的失敗 0.5日）
- Low Priority: 1.5日（テンプレート整合性 1日 + エラーメッセージ 0.5日）
- **合計**: 約 6 日（開発者 1 名換算）

## 生成物と変更点
- `docs/reports/testing/nextjs-generation-coverage.md`: 実測値ベースのレポートに更新
- `docs/reviews/src/commands/create/nextjs-generation.md`: 記載整合性を確認し補足
- `coverage/` ディレクトリ: HTML/LCOV/JSON レポート生成（再実行可）
- `package.json` / `pnpm-lock.yaml`: `@vitest/coverage-v8` を追加し、既存パッケージの integrity 値を最新化

## 結論

計画 0015 のゴールである Next.js 生成フローのテスト可視化は達成されたが、主要ロジックの多くが依然として未テストであり High Priority のギャップが継続。今後はテンプレート生成と外部 CLI 依存部のテスト追加を最優先で進め、測定値を 2 週間以内に再取得することを推奨する。