# Next.jsプロジェクトセットアップ後、pnpm env:encryptを自動実行 - 実装報告

**実装日**: 2025-01-07
**計画書**: docs/plans/0018.md
**ステータス**: 実装完了

## 実装概要

Next.jsフルスタックテンプレート生成直後に環境変数ファイルの暗号化を自動実行する機能を実装しました。セキュアなチーム共有を実現するため、CLIが `pnpm env:encrypt` を自動実行してパスワード付きZIPを作成する仕組みを構築しました。

## 実装したコンポーネント

### 1. 環境変数暗号化ユーティリティモジュール
**パス**: `src/utils/env-encryption/`

#### 作成ファイル:
- `index.ts` - エクスポートインターフェース
- `should-encrypt-env.ts` - 実行可否判定ロジック
- `create-encryption-prompt.ts` - 対話的確認プロンプト
- `run-env-encryption.ts` - 実際の暗号化実行処理

#### 主要機能:
- **環境チェック**: TTY環境、スクリプト存在、zipコマンド利用可能性を確認
- **プロンプト制御**: ユーザーへの対話的確認（デフォルト：YES）
- **コマンド実行**: モノレポ・単一リポジトリ両対応の実行ロジック
- **エラーハンドリング**: 詳細なエラー情報と復旧手順提示

### 2. テンプレートジェネレーター統合
**パス**: `src/commands/create/template-generators/nextjs-fullstack-admin.ts`

#### 実装内容:
- `processEnvEncryption` 関数追加 - 暗号化ワークフローの制御
- `generateFullStackAdmin` 関数更新 - セットアップ後の暗号化実行
- 結果に応じたnextSteps動的更新

#### 処理フロー:
1. セットアップコマンド完了後に暗号化処理を実行
2. 環境チェック → プロンプト → 実行 → 結果反映の流れ
3. 成功・失敗・スキップすべての結果をnextStepsに反映

### 3. 国際化メッセージ拡張
**パス**: `src/i18n.ts`, `src/i18n/ja.json`, `src/i18n/en.json`

#### 追加メッセージ:
- `envEncryption.confirmPrompt` - 実行確認プロンプト
- `envEncryption.processing` - 実行中メッセージ
- `envEncryption.success` - 成功時メッセージ（zipパス付き）
- `envEncryption.failed` - 失敗時メッセージ
- `envEncryption.skipped` - スキップ時メッセージ
- `envEncryption.manualCommand` - マニュアル実行コマンド
- `envEncryption.shareInstruction` - 共有時の注意喚起

### 4. .gitignore更新
**パス**: `templates/nextjs-fullstack-admin/.gitignore`

#### 追加項目:
```gitignore
# Environment variable encryption
env-files.zip
```

暗号化ファイルの誤コミット防止措置を実装しました。

### 5. テストケース実装
**パス**: `test/unit/src/utils/env-encryption.test.ts`, `test/unit/src/commands/create/template-generators/nextjs-fullstack-admin.test.ts`

#### テスト範囲:
- **env-encryptionユーティリティ**: 各関数の単体テスト（成功・失敗・エラーケース）
- **統合テスト**: nextjs-fullstack-adminでの暗号化フロー統合テスト
- **エラーシナリオ**: 非TTY環境、zipコマンド不在、ユーザースキップ等

## 技術実装詳細

### 環境判定ロジック
```typescript
export interface EncryptionEnvironmentCheck {
    canExecute: boolean;
    isTTY: boolean;
    hasScript: boolean;
    hasZip: boolean;
    scriptPath?: string;
    reason?: string;
}
```

TTY環境、スクリプトファイル存在、zipコマンド利用可能性を総合的に判定し、実行不可の場合は理由を明示します。

### モノレポ対応
```typescript
const args = isMonorepo
    ? ["--filter", appDirectory, "env:encrypt"]
    : ["env:encrypt"];
```

モノレポ構成では `--filter` オプションを使用し、適切なワークスペースで暗号化を実行します。

### エラーハンドリング戦略
1. **環境不整合**: 実行前チェックでエラー回避
2. **ユーザーキャンセル**: 適切なフォールバック手順提示
3. **実行失敗**: 詳細エラー情報とマニュアル復旧手順
4. **予期しないエラー**: 包括的エラーキャッチと安全な復旧

## ユーザーエクスペリエンス

### 正常フロー
```text
✅ プロジェクト生成が完了しました
🔐 環境変数を安全に共有するため暗号化を実行しますか？ (Y/n)
✔ 暗号化を開始します
Enter password for encryption: ********
Confirm password: ********
✅ env-files.zip を生成しました（apps/web/env-files.zip）
📤 チームに渡す際はパスワードを安全に共有してください
```

### エラー時のフォールバック
- 非TTY環境やzipコマンド不在の場合は理由を明示してマニュアル手順を提示
- ユーザーがスキップした場合も適切なマニュアル手順を案内
- すべてのケースでnextStepsに復旧手順が含まれる

## 品質保証

### テストカバレッジ
- **単体テスト**: 全関数の正常・異常系をカバー
- **統合テスト**: nextjs-fullstack-adminとの統合動作を検証
- **エラーハンドリング**: 各種エラーシナリオを網羅

### 国際化対応
- 日本語・英語両言語でメッセージを実装
- i18nシステムとの完全統合

### セキュリティ考慮
- 暗号化ファイル（env-files.zip）の.gitignore追加
- パスワード入力の透過実装（stdio: "inherit"）
- エラー時の機密情報漏洩防止

## 実装完了確認

### ✅ 機能要件
- Next.jsテンプレート生成後に暗号化プロンプト表示
- 成功時にenv-files.zip作成と位置通知
- 失敗時に再実行手順表示
- モノレポ/単一構成両対応

### ✅ 品質要件
- 全テストパス（単体・統合テスト実装済み）
- 国際化完全対応（日本語・英語）
- エラーハンドリング網羅

### ✅ セキュリティ要件
- .gitignoreにenv-files.zip追加
- パスワード入力の適切な透過処理
- 機密情報の適切な保護

## 今後の拡張可能性

1. **他テンプレート対応**: env-encryptionユーティリティは汎用的に設計されており、他のテンプレートでも再利用可能
2. **暗号化方式拡張**: zip以外の暗号化アルゴリズム（GPG等）への対応
3. **CI連携**: 非対話環境での自動暗号化サポート
4. **クラウド統合**: Vercel等への自動アップロード機能

## 結論

計画された全機能を実装し、テストとドキュメント整備も完了しました。Next.jsフルスタックテンプレートでの環境変数暗号化自動実行により、チーム開発でのセキュアな環境変数共有が大幅に改善されます。

エラーハンドリングとユーザビリティを重視した設計により、様々な環境での安定した動作を実現しています。