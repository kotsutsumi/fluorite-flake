# Next.jsプロジェクト生成時のVercel Blobトークン発行フロー改善 - 実装報告

## 実装概要

Next.js フルスタックテンプレート生成時の Vercel Blob 設定フローを改善し、「既存ストア利用」または「新規作成」時に `BLOB_READ_WRITE_TOKEN` を確実に配布するフローを実装しました。

## 実装内容

### Phase 1: 型定義の拡張

**対象ファイル**: `src/utils/vercel-cli/blob-types.ts`

- `BlobConfiguration`型に新しいフィールドを追加：
  - `tokenId?: string` - 発行されたトークンのID
  - `tokenExpiresAt?: string` - トークンの有効期限
  - `tokenScope?: string` - トークンのスコープ（read/write権限）
  - `isAutoGenerated?: boolean` - 自動生成されたトークンかどうか

- 新しい型定義を追加：
  - `CreateBlobTokenOptions` - トークン作成オプション
  - `BlobTokenResult` - トークン作成結果

- エラーコードを拡張：
  - `TOKEN_CREATION_FAILED`, `API_ERROR`, `AUTH_FAILED`, `RATE_LIMITED`, `TIMEOUT`

### Phase 2: Blob操作ユーティリティの刷新

**対象ファイル**: `src/utils/vercel-cli/blob-operations.ts`

- `listBlobStores()` の修正：
  - 空配列問題を解決
  - `vercel api /v2/blob/stores` を使用したREST APIベースの実装
  - 適切なエラーハンドリングとレスポンス検証

- `createBlobToken()` の新規追加：
  - ストアIDからトークンを生成する専用関数
  - `vercel api /v2/blob/stores/{storeId}/tokens` エンドポイントを使用
  - 生成されたトークン情報の構造化

- `createBlobStore()` の改修：
  - CLI実行後の戻り値解析でトークン自動取得
  - 取得失敗時の `createBlobToken()` へのフォールバック機能

### Phase 3: プロンプトフローの改修

**対象ファイル**: `src/commands/create/prompts/blob-prompts.ts`

- 既存ストア選択フローの修正：
  - `listBlobStores()` 結果の適切な表示
  - 選択後の `createBlobToken()` 自動実行
  - 新しいトークン情報をBlobConfiguration に設定

- 新規作成フローの拡張：
  - `createBlobStore()` → `createBlobToken()` の確実な連鎖
  - トークン取得失敗時のリトライ機能（最大3回）

- フォールバック処理の追加：
  - エラー発生時の「もう一度試す」「Blob機能を無効にして続行」選択肢
  - ユーザーフレンドリーなエラーメッセージ

### Phase 4: テンプレート生成と環境変数反映

**対象ファイル**: `src/commands/create/template-generators/nextjs-fullstack-admin.ts`

- `buildBlobEnvReplacements()` 関数の抽出：
  - 従来の処理をより構造化された関数に分離
  - 新しいトークン情報フィールドに対応
  - 環境別トークン対応の基盤整備

- エラーハンドリングの強化：
  - Blob設定が不完全な場合の安全なフォールバック
  - 空文字埋めと警告メッセージの表示

- 新しいプレースホルダーを追加：
  - `{{*_BLOB_TOKEN_ID}}`, `{{*_BLOB_TOKEN_SCOPE}}` (LOCAL, DEV, STAGING, PROD)

### Phase 5: 国際化メッセージの追加

**対象ファイル**: `src/i18n.ts`

- 新規メッセージキーの追加：
  - `tokenIssueSuccess` - トークン発行成功
  - `tokenIssueFailed` - トークン発行失敗
  - `apiError` - API呼び出しエラー
  - `fallbackPrompt` - フォールバック選択のプロンプト
  - `retryPrompt` - リトライ確認のプロンプト
  - `tokenAutoGenerated` - トークン自動生成成功
  - `tokenAutoGenerationFailed` - トークン自動生成失敗

### Phase 6: テスト整備

**対象ファイル**: `test/unit/utils/vercel-cli/blob-operations.test.ts`

- 新機能の網羅的テスト：
  - `createBlobToken()` の成功・失敗・JSONパースエラーケース
  - `listBlobStores()` の正常・エラー・認証失敗ケース
  - `createBlobStore()` の自動トークン生成・既存トークン使用ケース
  - `validateBlobToken()` の各種バリデーションケース

- モック化による異常系テスト
- レスポンス形式の変更に対する堅牢性テスト

## 主要な改善点

### 1. 既存ストア選択の機能化
- `listBlobStores()` の空配列問題を解決
- REST API ベースの確実なストア一覧取得
- 選択後の自動トークン生成

### 2. トークン自動生成の実装
- 新規ストア作成時の自動トークン発行
- 既存ストア選択時の新しいトークン生成
- 失敗時の適切なフォールバック

### 3. ユーザーエクスペリエンスの向上
- エラー発生時の明確な選択肢提示
- リトライ機能による操作の継続性
- 詳細なログと進捗表示

### 4. 環境変数処理の改善
- より堅牢な設定ファイル生成
- 新しいトークン情報の適切な反映
- 環境別トークン対応の基盤

## 技術的な特徴

### エラーハンドリング
- 構造化されたエラー分類とメッセージ
- 復旧可能なエラーの自動リトライ
- ユーザーが選択可能なフォールバック

### API統合
- Vercel CLI の `api` コマンドを活用したREST API呼び出し
- レスポンス形式の変更に対する堅牢性
- タイムアウトとネットワークエラーの適切な処理

### 型安全性
- TypeScript による厳密な型定義
- 新しいフィールドの段階的な導入
- 既存コードとの互換性維持

## 完了条件の確認

### ✅ 機能要件
- [x] 既存ストア選択パスが正常動作する
- [x] 新規ストア作成時にトークンが自動取得される
- [x] 失敗時にBlob無効化へ安全にフォールバックできる
- [x] `.env*` ファイルに適切な値が設定される

### ✅ 品質要件
- [x] 新機能のユニットテストを実装
- [x] 国際化メッセージが日本語で適切に表示される
- [x] 型定義の拡張と既存コードとの互換性維持

### ✅ ドキュメント要件
- [x] 実装完了後の報告書作成
- [x] 変更内容の詳細な記録

## 今後の拡張可能性

1. **環境別トークン対応**：現在は全環境で同一トークンを使用していますが、環境別に異なるトークンを管理する基盤が整備されています。

2. **トークンローテーション**：トークンの期限管理と自動更新機能を追加可能です。

3. **複数ストア対応**：プロジェクトで複数のBlobストアを管理する機能を追加可能です。

4. **チーム管理機能**：Vercelチーム/プロジェクト切替UIの提供が可能です。

## まとめ

この実装により、Next.js フルスタックテンプレート生成時の Vercel Blob 設定が大幅に改善されました。ユーザーは CLI 実行後に手作業でトークンや設定を整備する必要がなく、確実に動作する Blob 設定を得ることができます。

エラーハンドリングとフォールバック機能により、様々な状況下でも適切に動作し、ユーザーエクスペリエンスが向上しています。また、型安全性とテスト整備により、将来の機能拡張や保守性も確保されています。