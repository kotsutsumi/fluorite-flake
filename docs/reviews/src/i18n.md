# i18n システムレビュー報告書

## 概要

`src/i18n.ts` は CLI 全体のメッセージ取得とロケール自動検出を担うコアモジュールです。最新実装では、環境変数・macOS 設定・Intl API を段階的に参照する多層ロケール判定と、README 生成や対話的プロンプトを含むメッセージセットを型安全に扱う仕組みが整備されています。

## ロケール検出ロジック

1. 明示的な環境変数 (`FLUORITE_LOCALE`, `LC_ALL`, `LC_MESSAGES`, `LANGUAGE`) を優先。
2. macOS の場合は `defaults read -g AppleLocale` および `AppleLanguages` を 1 秒タイムアウト付きで参照。
3. `Intl.DateTimeFormat().resolvedOptions().locale` の結果を利用可能であれば採用。
4. システム環境変数 `LANG` を最後に確認し、いずれも失敗した場合はフォールバックロケール `en` を返却。

すべてのステップで `normalizeLocale()` による小文字化・接頭辞マッチングを行い、`en`/`ja` 以外は無視します。

## メッセージ構造

- `RawLocaleMessages`：JSON ファイルの厳密な構造を表現。`cli`・`create`・`readme`・`debug` セクションを保持し、`create.args.simple` など JSON 固有のキーも型で管理。
- `LocaleMessages`：実際の利用形。`create.invalidProjectType` などを高階関数に変換し、プレースホルダ付き文字列を `formatMessage()` で補完できるようにしています。
- `transformMessages()`：数値フォーマットを含めたテンプレート置換を実施し、`nextStepCommand()` や `pnpmVersionTooOld()` のような便利関数を提供。

## JSON リソース (`src/i18n/en.json`, `src/i18n/ja.json`)

- `cli` セクション：コマンド一覧・使用例・ヘルプヒントを多言語対応。
- `create` セクション：引数説明、検証エラー、スピナー文言に加え、`promptProjectName` / `directoryExists` など CLI の対話部分も翻訳キー化。
- `readme` セクション：README 生成で利用する見出し・説明・コマンド配列を保持し、monorepo / シンプル両方に対応する文面を提供。
- `debug` セクション：開発モード向けのログ文言を集約。

## キャッシュ戦略

- `messagesCache` にロケール別の `LocaleMessages` を保持し、二度目以降の読み込みコストを削減。
- `getMessagesForLocale()` は明示的ロケール取得用のヘルパーで、キャッシュも共用。

## エラーハンドリング

- JSON 読み込み失敗時はフォールバックロケールを再試行し、それでも失敗した場合は例外を投げます。
- macOS 設定読み取りや Intl API が例外を投げても処理を中断せず、後続ロジックへ安全にフォールバックします。

## 今後の改善余地

- JSON キー追加時に `LocaleMessages` 側の型更新が必要なため、自動生成やスキーマ検証の導入が有効。
- `create.args.simple` は利用箇所が限定されており、型の一貫性を保つための置換戦略（例: optional chaining）を検討できます。
