# Next.js / Vercel 連携セットアップ自動化

[ STATUS:DONE ]

## 概要

Next.js テンプレート生成時に、Vercel CLI との連携を自動セットアップする機能を実装する。
CLI から Vercel プロジェクトへの環境変数適用・クリア操作を行えるようにし、初回セットアップ完了後すぐにデプロイ可能な状態を整える。
Turso だけでなく Supabase を選択したケースでも連携スクリプトが期待通り動作するようにする。

## ゴール

1. `pnpm env:apply-vercel` が生成済みプロジェクトで利用でき、Turso / Supabase いずれの構成でも環境変数を Vercel へ反映できる
2. `pnpm env:clear-vercel` で Vercel 上の環境変数をクリアできる
3. `ci-db.sh` 相当の処理が Turso / Supabase 双方に対応し、CI 実行時に適切な DB セットアップが行える
4. 生成テンプレートに含まれるドキュメントや README が上記新機能の利用方法を案内している

## アウトオブスコープ

- Vercel 側への自動デプロイパイプライン構築（本計画では環境変数登録まで）
- 既存ユーザー環境への移行スクリプト提供
- GitHub Actions との連携（Vercel 連携のみに焦点を当てる）

## 依存関係・前提条件

- ✅ `src/utils/vercel-cli` に存在する Vercel CLI ラッパー機能
- ✅ Turso / Supabase 向け CLI ユーティリティ (`src/utils/turso-cli`, `src/utils/supabase-cli`)
- ✅ `templates/nextjs-fullstack-admin`（今回の設定対象テンプレート）
- ✅ `temp/refs/nextjs/apps/backend/scripts/` の参考実装
- ユーザーのローカル環境に Vercel CLI がインストール済みかつログイン済み

## 詳細実装計画

### Phase 1: スクリプトテンプレート作成

**所要時間**: 2-3時間

#### 1.1 環境変数設定の整理

- **Turso用環境変数**:

  ```
  TURSO_DATABASE_URL_DEV, TURSO_DATABASE_URL_STG, TURSO_DATABASE_URL_PROD
  TURSO_AUTH_TOKEN_DEV, TURSO_AUTH_TOKEN_STG, TURSO_AUTH_TOKEN_PROD
  DATABASE_URL_DEV, DATABASE_URL_STG, DATABASE_URL_PROD
  ```

- **Supabase用環境変数**:

  ```
  NEXT_PUBLIC_SUPABASE_URL_DEV, NEXT_PUBLIC_SUPABASE_URL_STG, NEXT_PUBLIC_SUPABASE_URL_PROD
  NEXT_PUBLIC_SUPABASE_ANON_KEY_DEV, NEXT_PUBLIC_SUPABASE_ANON_KEY_STG, NEXT_PUBLIC_SUPABASE_ANON_KEY_PROD
  SUPABASE_SERVICE_ROLE_KEY_DEV, SUPABASE_SERVICE_ROLE_KEY_STG, SUPABASE_SERVICE_ROLE_KEY_PROD
  DATABASE_URL_DEV, DATABASE_URL_STG, DATABASE_URL_PROD
  ```

- **共通環境変数**:
  ```
  NODE_ENV_DEV, NODE_ENV_STG, NODE_ENV_PROD
  NEXT_PUBLIC_ENV_DEV, NEXT_PUBLIC_ENV_STG, NEXT_PUBLIC_ENV_PROD
  NEXT_PUBLIC_APP_URL_DEV, NEXT_PUBLIC_APP_URL_STG, NEXT_PUBLIC_APP_URL_PROD
  BETTER_AUTH_URL_DEV, BETTER_AUTH_URL_STG, BETTER_AUTH_URL_PROD
  BETTER_AUTH_SECRET_DEV, BETTER_AUTH_SECRET_STG, BETTER_AUTH_SECRET_PROD
  BLOB_READ_WRITE_TOKEN_DEV, BLOB_READ_WRITE_TOKEN_STG, BLOB_READ_WRITE_TOKEN_PROD
  BLOB_STORE_ID_DEV, BLOB_STORE_ID_STG, BLOB_STORE_ID_PROD
  ```

#### 1.2 スクリプトファイルの作成

以下のファイルを `templates/nextjs-fullstack-admin/scripts/` に作成:

- `env-apply-vercel.ts` - 開発環境用環境変数適用
- `env-apply-vercel-staging.ts` - ステージング環境用環境変数適用
- `env-apply-vercel-prod.ts` - 本番環境用環境変数適用
- `env-clear-vercel.ts` - Vercel環境変数クリア
- `env-tools.ts` - 共通ユーティリティ関数
- `ci-db.sh` - データベースセットアップスクリプト

#### 1.3 型定義とユーティリティ作成

- プロジェクト設定読み込み機能
- 環境変数ファイル読み込み・パース機能
- Vercel CLI実行ラッパー関数
- データベース種別検出機能

### Phase 2: package.json スクリプト統合

**所要時間**: 1時間

#### 2.1 package.json テンプレート更新

`templates/nextjs-fullstack-admin/package.json` に以下のスクリプトを追加:

```json
{
	"scripts": {
		"env:apply-vercel": "tsx scripts/env-apply-vercel.ts",
		"env:apply-vercel:staging": "tsx scripts/env-apply-vercel-staging.ts",
		"env:apply-vercel:prod": "tsx scripts/env-apply-vercel-prod.ts",
		"env:clear-vercel": "tsx scripts/env-clear-vercel.ts",
		"ci:db": "bash scripts/ci-db.sh"
	}
}
```

### Phase 3: テンプレート生成時の処理統合

**所要時間**: 1-2時間

#### 3.1 create コマンド統合

`src/commands/create.ts` を更新して:

- データベース選択時にSupabase対応を追加
- 環境変数ファイルテンプレート生成
- プロジェクト設定ファイル生成（`.vercel/project.json` のプレースホルダー）

#### 3.2 環境ファイルテンプレート作成

各データベース種別用の `.env` ファイルテンプレート:

- `.env.template` (Turso用)
- `.env.supabase.template` (Supabase用)

### Phase 4: CI/CD スクリプト更新

**所要時間**: 2時間

#### 4.1 ci-db.sh のマルチDB対応

- Turso / Supabase 自動検出機能
- 環境変数プロモーション機能強化
- エラーハンドリング改善

#### 4.2 データベース初期化処理

- Prisma スキーマ生成
- データベース push/migrate処理
- 初期データシード処理

### Phase 5: テスト実装

**所要時間**: 3-4時間

#### 5.1 単体テスト

```
test/unit/utils/vercel-cli/
├── env-tools.test.ts     # 環境変数処理テスト
├── project-config.test.ts # プロジェクト設定テスト
└── vercel-executor.test.ts # Vercel CLI実行テスト
```

#### 5.2 統合テスト

```
test/functional/create-nextjs/
├── vercel-integration.test.ts # Vercel連携テスト
└── multi-db-support.test.ts   # マルチDB対応テスト
```

#### 5.3 手動テストシナリオ

1. Turso選択時のテンプレート生成 → 環境変数適用 → クリア
2. Supabase選択時のテンプレート生成 → 環境変数適用 → クリア
3. CI環境でのデータベースセットアップ

### Phase 6: ドキュメント整備

**所要時間**: 1-2時間

#### 6.1 README更新

`templates/nextjs-fullstack-admin/README.md` に以下セクションを追加:

- Vercel連携セットアップ手順
- 環境変数設定ガイド
- デプロイメントワークフロー
- トラブルシューティング

#### 6.2 使用例とコマンドリファレンス

```bash
# 開発環境の環境変数をVercelに適用
pnpm env:apply-vercel

# ステージング環境の環境変数をVercelに適用
pnpm env:apply-vercel:staging

# 本番環境の環境変数をVercelに適用
pnpm env:apply-vercel:prod

# Vercel上の環境変数をクリア
pnpm env:clear-vercel
```

## 技術仕様詳細

### Vercel プロジェクト名生成ルール

- パターン: `{PROJECT_NAME}-{SUFFIX}`
- SUFFIX: `-dev`, `-staging`, `-prod`
- 例: `my-app` → `my-app-dev`, `my-app-staging`, `my-app-prod`

### エラーハンドリング戦略

1. **Vercel CLI未インストール**: 明確なインストール手順を提示
2. **ログイン未完了**: `vercel login` 実行を促す
3. **認証情報不足**: 必要な環境変数一覧を表示
4. **プロジェクト未設定**: `.vercel/project.json` 設定手順を案内

### セキュリティ考慮事項

- 環境変数値のログ出力防止
- 本番環境への誤適用防止確認プロンプト
- 機密情報の暗号化保存推奨

## テスト戦略

### 自動テスト

- **単体テスト**: 各ユーティリティ関数の正常系・異常系
- **統合テスト**: Vercel CLI モック化による統合フロー
- **リグレッションテスト**: 既存機能への影響確認

### 手動テスト

- **実環境テスト**: 実際のVercelプロジェクトでのE2Eテスト
- **多環境テスト**: Development/Staging/Production環境での動作確認
- **多DB種別テスト**: Turso/Supabase両方での動作確認

## リスク管理

### 高リスク

- **Vercel CLI依存**: ユーザー環境でのCLIセットアップ失敗
  - 軽減策: 詳細なセットアップドキュメント + トラブルシューティングガイド

### 中リスク

- **環境変数設定ミス**: 間違った環境への変数適用
  - 軽減策: 確認プロンプト + ドライラン機能

### 低リスク

- **スクリプト依存増加**: テンプレートの複雑性増加
  - 軽減策: モジュール化 + 適切なドキュメント化

## 検証基準

### 成功基準

- [ ] Turso使用時にVercel環境変数が正しく適用される
- [ ] Supabase使用時にVercel環境変数が正しく適用される
- [ ] 環境変数クリア機能が正常動作する
- [ ] CI/CDスクリプトが両DB種別で正常動作する
- [ ] 全テストがパスする
- [ ] ドキュメントが完全で理解しやすい

### パフォーマンス基準

- [ ] 環境変数適用が60秒以内に完了
- [ ] エラー時の適切なロールバック機能
- [ ] CLI操作のレスポンス時間が許容範囲内

## 次のアクション

1. Phase 1の実装から開始
2. 各Phaseごとに動作確認とレビュー実施
3. 全Phase完了後の総合テスト実施
4. ステータスを [ STATUS:READY ] に変更して実装開始
