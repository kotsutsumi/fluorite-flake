# Next.jsプロジェクトセットアップ後、pnpm env:encryptを自動実行

[ STATUS:DONE ]

## 概要

Next.jsフルスタックテンプレート生成直後に `.env*` ファイルの暗号化を自動実行し、セキュアなチーム共有を実現する。CLIが `pnpm env:encrypt` を自動実行してパスワード付きZIPを作成し、即座にチーム配布可能な状態を提供する。

## 背景

- 現状のCLIはテンプレートに `.env`, `.env.development`, `.env.staging`, `.env.prod` を生成するが、暗号化はユーザーが `pnpm env:encrypt` を手動で実行する必要がある。
- 暗号化スクリプトは `templates/nextjs-fullstack-admin/scripts/env-tools.ts` に実装済みで、ZIP作成前にパスワードの二重入力と `zip` コマンド存在チェックを行う。
- 生成直後のタイミングで暗号化を行わないと、 `.env*` が平文のまま共有されるリスクがあり、テンプレートの「即時チーム共有」コンセプトと矛盾する。

## 現状の課題

### 1. 手動実行前提による漏れ

- CLIが暗号化ステップを案内せず、ユーザーがコマンドを実行し忘れる可能性が高い。

### 2. ワークスペース構成の複雑さ

- モノレポ選択時は `apps/web` 下でスクリプトを叩く必要があるが、既存ドキュメントでは明示されていない。

### 3. 国際化されていない案内

- 暗号化に関するガイダンスが英語中心で、CLIのi18nシステムにも文言が存在しない。

### 4. 失敗時のハンドリング不足

- `zip` コマンド未インストールやCI等の非TTY環境で失敗した場合に、再試行手段やマニュアル手順を提示していない。

### 5. 成果物のガバナンス

- 生成される `env-files.zip` が `.gitignore` に含まれておらず、誤ってコミットするリスクがある。

## 達成目標

### 主要目標

1. Next.jsフルスタックテンプレート生成完了後に `pnpm env:encrypt` を自動実行し、成功時に結果とZIPの保存場所を通知する。
2. 暗号化実行前にユーザーへ対話的な確認（実行/スキップ）を行い、実行時にはパスワード入力プロンプトをCLIに透過する。
3. 自動化が失敗した場合でも、明確な再実行コマンドとマニュアル手順を提示する。
4. モノレポ/単一リポジトリの両構成において安定的にコマンドを実行できるようにする。

### 品質目標

- `docs/reviews/src/commands/create/*.md` など関連ドキュメントを同期。
- Vitestで成功・失敗・スキップの分岐をカバー。
- 日本語/英語メッセージをi18n辞書へ追加し、出力が二言語で整合。
- `.gitignore` 等で秘密ファイルを誤コミットしない状態を保証。

## 実装スコープ

### 含まれる作業

- `src/commands/create/template-generators/nextjs-fullstack-admin.ts` に暗号化ワークフローを追加（確認プロンプト、`execa` 実行、ログ出力）。
- `src/commands/create/generator.ts`（必要に応じて）でNext.js専用後処理フックを組み込めるようリファクタリング。
- `src/i18n.ts` のメッセージ辞書拡張（実行確認、成功メッセージ、失敗リカバリー案内）。
- `templates/nextjs-fullstack-admin/.gitignore` への `env-files.zip` 追加。
- 付随するユーティリティ（例: `src/utils/command-runner/*` が存在する場合は共通化）とテストコードの整備。
- ドキュメント更新（レビュー文書、ユーザーガイドへの手順追記）。

### 除外される作業

- Next.js以外のテンプレートへの暗号化自動化展開。
- 環境変数暗号化方式自体の変更（zip以外の暗号化アルゴリズム導入など）。
- Vercel上への自動アップロードやCI連携の追加。

## ユーザーエクスペリエンス設計

### 生成後の対話フロー

1. テンプレート生成とセットアップ（`pnpm install` など）完了後に、暗号化実行可否を確認するプロンプトを表示（デフォルトYES）。
2. 同意した場合は `🔐` ログを表示しつつ `pnpm env:encrypt` を実行。パスワード入力はそのまま `env-tools` のプロンプトを利用。
3. 成功時は `env-files.zip` の保存パスと次のアクション（共有方法、解凍手順）を案内。
4. スキップまたは失敗時は、再実行コマンド（例: `pnpm env:encrypt` または `pnpm --filter ${packageName} env:encrypt`）と復旧手順をCLI出力と `nextSteps` に追加。

### CLIログ例

```text
✅ プロジェクト生成が完了しました
🔐 環境変数を安全に共有するため暗号化を実行しますか？ (Y/n)
✔ 暗号化を開始します
Enter password for encryption: ********
Confirm password: ********
✅ env-files.zip を生成しました（apps/web/env-files.zip）
📤 チームに渡す際はパスワードを安全に共有してください
```

## 実装計画

### 1. ユーティリティモジュール作成

**ファイル**: `src/utils/env-encryption/index.ts`

```typescript
// 暗号化実行制御
export { runEnvEncryption } from "./run-env-encryption.js";
export { shouldEncryptEnv } from "./should-encrypt-env.js";
export { createEncryptionPrompt } from "./create-encryption-prompt.js";
```

**主要機能**:
- 暗号化実行可否判定（TTY確認、スクリプト存在確認）
- 対話的確認プロンプト
- `execa` によるコマンド実行とエラーハンドリング

### 2. テンプレートジェネレーター拡張

**ファイル**: `src/commands/create/template-generators/nextjs-fullstack-admin.ts`

**変更箇所**:
- `runSetupCommands` 実行後に `runEnvEncryption` を呼び出し
- 暗号化結果を `TemplateGenerationResult.nextSteps` に反映
- 失敗時のリカバリー手順を `nextSteps` に追加

### 3. i18n辞書拡張

**ファイル**: `src/i18n.ts`

**追加メッセージ**:
```typescript
envEncryption: {
  confirmPrompt: '環境変数を暗号化しますか？',
  processing: '🔐 環境変数を暗号化中...',
  success: '✅ env-files.zip を生成しました',
  failed: '❌ 暗号化に失敗しました',
  skipped: 'ℹ️ 暗号化をスキップしました',
  manualCommand: '手動実行: pnpm env:encrypt'
}
```

### 4. テンプレート設定更新

**ファイル**: `templates/nextjs-fullstack-admin/.gitignore`

**追加行**:
```
# 環境変数暗号化ファイル
env-files.zip
```

## 実装順序

### Phase 1: 基盤ユーティリティ実装
1. `src/utils/env-encryption/` モジュール作成
2. 暗号化実行ロジックとエラーハンドリング実装
3. 単体テスト追加

### Phase 2: テンプレートジェネレーター統合
1. `nextjs-fullstack-admin.ts` に暗号化フロー追加
2. `TemplateGenerationResult` への結果反映
3. 統合テスト更新

### Phase 3: 国際化とUI改善
1. `i18n.ts` メッセージ辞書拡張
2. 対話的プロンプトとログ改善
3. `.gitignore` テンプレート更新

### Phase 4: テストとドキュメント
1. すべてのテストケース実装
2. レビュー文書更新
3. 品質ゲートチェック

## テスト戦略

### 単体テスト
- **env-encryption ユーティリティ**: TTY環境、コマンド実行、エラーハンドリング
- **nextjs-fullstack-admin**: 暗号化フロー統合、結果反映
- **i18n**: 新規メッセージキー存在確認

### 統合テスト
- **Next.js生成フロー**: 暗号化プロンプト表示、成功時ZIP作成
- **エラーシナリオ**: zip未インストール、非TTY環境、ユーザースキップ

## 成功基準

### 機能要件
- ✅ Next.jsテンプレート生成後に暗号化プロンプト表示
- ✅ 成功時に `env-files.zip` 作成と位置通知
- ✅ 失敗時に再実行手順表示
- ✅ モノレポ/単一構成両対応

### 品質要件
- ✅ 全テストパス（`pnpm test:run`）
- ✅ リントエラーなし（`pnpm lint`）
- ✅ ビルド成功（`pnpm build`）
- ✅ レビュー文書同期更新

### セキュリティ要件
- ✅ `.gitignore` に `env-files.zip` 追加
- ✅ 平文環境変数の誤コミット防止
- ✅ パスワード入力の透過実装
