# TUI ダッシュボード統合実装計画

[ STATUS:DONE ]

## 概要

既存の Vercel / Turso / Supabase / GitHub 各コマンドラッパーを統合し、単一の CLI コマンド `fluorite dashboard` から主要な運用情報と主要操作を実行できる TUI ダッシュボードを実装する。

## 目標

1. **統合運用管理**: 複数サービスの状態を一元管理
2. **ブラウザレス操作**: CLI内で主要な運用タスクを完結
3. **リアルタイム監視**: リアルタイムでの状態監視とアラート
4. **多言語対応**: 既存のi18nシステムを活用した国際化
5. **直感的UX**: キーボード操作中心の効率的なユーザー体験

## アーキテクチャ設計

### 技術スタック

- **UI Framework**: Ink v6.3.1 + @inkjs/ui v2.0.0
- **状態管理**: valtio ベースのグローバルストア
- **グラフ描画**: asciichart 1.5.25（自作ラッパー経由）
- **国際化**: 既存のi18nシステム
- **テスト**: ink-testing-library + Vitest

### モジュール構造

```
src/commands/dashboard/
├── index.ts                    # メインエクスポート
├── dashboard-command.ts        # コマンド定義
├── components/
│   ├── layout/
│   │   ├── main-layout.tsx     # メインレイアウト
│   │   ├── sidebar.tsx         # サービス選択サイドバー
│   │   └── detail-panel.tsx    # 詳細表示パネル
│   ├── charts/
│   │   ├── ascii-chart.tsx     # ASCII チャート表示
│   │   ├── trend-graph.tsx     # トレンドグラフ
│   │   └── metrics-display.tsx # メトリクス表示
│   ├── services/
│   │   ├── vercel-panel.tsx    # Vercel管理パネル
│   │   ├── turso-panel.tsx     # Turso管理パネル
│   │   ├── supabase-panel.tsx  # Supabase管理パネル
│   │   └── github-panel.tsx    # GitHub管理パネル
│   └── common/
│       ├── status-banner.tsx   # ステータスバナー
│       ├── loading-spinner.tsx # ローディング表示
│       ├── error-modal.tsx     # エラーモーダル
│       └── confirmation-modal.tsx # 確認モーダル
├── state/
│   ├── dashboard-store.ts      # メインストア
│   ├── vercel-store.ts         # Vercel状態管理
│   ├── turso-store.ts          # Turso状態管理
│   ├── supabase-store.ts       # Supabase状態管理
│   └── github-store.ts         # GitHub状態管理
├── services/
│   ├── vercel/
│   │   ├── client.ts           # Vercel APIクライアント
│   │   └── types.ts            # Vercel型定義
│   ├── turso/
│   │   ├── client.ts           # Turso APIクライアント
│   │   └── types.ts            # Turso型定義
│   ├── supabase/
│   │   ├── client.ts           # Supabase APIクライアント
│   │   └── types.ts            # Supabase型定義
│   └── github/
│       ├── client.ts           # GitHub APIクライアント
│       └── types.ts            # GitHub型定義
├── hooks/
│   ├── use-dashboard.ts        # ダッシュボード共通ロジック
│   ├── use-vercel-dashboard.ts # Vercel固有ロジック
│   ├── use-turso-dashboard.ts  # Turso固有ロジック
│   ├── use-supabase-dashboard.ts # Supabase固有ロジック
│   └── use-github-dashboard.ts # GitHub固有ロジック
├── utils/
│   ├── auth-manager.ts         # 認証管理
│   ├── error-handler.ts        # エラーハンドリング
│   └── cache-manager.ts        # キャッシュ管理
└── __tests__/
    ├── components/             # コンポーネントテスト
    ├── services/               # サービステスト
    └── integration/            # 統合テスト
```

### スコープ外

- 各サービスの高度な管理機能（Vercel環境変数編集UI、Supabase SQLエディタ）
- GitHub Issue/PR作成などの双方向操作（MVP では閲覧とリンク表示のみ）
- リアルタイム課金・使用量制御機能

## 実装手順

### Phase 1: 基盤実装 (Week 1-2)

#### Step 1.1: コアコンポーネント作成
```typescript
// src/commands/dashboard/dashboard-command.ts
export const dashboardCommand = {
  name: 'dashboard',
  description: 'Launch TUI dashboard for service management',
  action: launchDashboard
};
```

#### Step 1.2: メインレイアウト構築
- 左右 2 カラム構成（サービス一覧 / 詳細パネル）
- キーボードナビゲーション実装
- 基本的なステータス表示

#### Step 1.3: 状態管理システム
```typescript
// src/commands/dashboard/state/dashboard-store.ts
export const dashboardStore = proxy({
  activeService: 'vercel' as ServiceType,
  isLoading: false,
  authStatus: {} as Record<ServiceType, AuthStatus>
});
```

### Phase 2: サービス統合 (Week 3-4)

#### Step 2.1: Vercel統合
- **表示機能**: チーム/プロジェクト一覧、デプロイ状況、環境変数スロット
- **操作機能**: デプロイ再実行、ログURLコピー
- **CLI呼び出し**: `vercel whoami`, `vercel projects list`, `vercel deployments ls`

#### Step 2.2: Turso Cloud統合
- **表示機能**: データベース一覧、レプリカ数、レプリケーション遅延
- **操作機能**: branch作成、使用量アラート
- **CLI呼び出し**: `turso auth status`, `turso db list`, `turso db show`

#### Step 2.3: Supabase統合
- **表示機能**: プロジェクト状態、Branch状況、シークレット一覧
- **操作機能**: `db reset`, `functions deploy`ショートカット
- **CLI呼び出し**: `supabase projects list`, `supabase projects get`

#### Step 2.4: GitHub統合
- **表示機能**: リポジトリ情報、Actions実行履歴
- **操作機能**: Workflow手動トリガー、エラーログリンク
- **CLI呼び出し**: `gh auth status`, `gh repo view`, `gh workflow list`

### Phase 3: 高度な機能実装 (Week 5-6)

#### Step 3.1: リアルタイム監視
- 自動リフレッシュ機能（30秒間隔）
- メトリクストレンド表示
- アラート通知システム

#### Step 3.2: グラフ機能
```typescript
// src/commands/dashboard/components/charts/ascii-chart.tsx
export const AsciiChart: React.FC<ChartProps> = ({ data, title }) => {
  const chartString = asciichart.plot(data, { height: 10 });
  return <Text>{chartString}</Text>;
};
```

#### Step 3.3: 認証フロー統合
- 全サービスの認証状態一括チェック
- ログインガイダンスモーダル
- ブラウザ連携サポート

### Phase 4: UX最適化とテスト (Week 7-8)

#### Step 4.1: パフォーマンス最適化
- valtioのSnapshot最適化
- 再描画最小化
- キャッシュ戦略実装

#### Step 4.2: エラーハンドリング
- ネットワークエラー対応
- CLIコマンド失敗時のフォールバック
- ユーザーフレンドリーなエラーメッセージ

#### Step 4.3: i18n対応
```typescript
// src/i18n/ja.json
{
  "dashboard": {
    "title": "サービスダッシュボード",
    "services": {
      "vercel": "Vercel",
      "turso": "Turso Cloud",
      "supabase": "Supabase",
      "github": "GitHub"
    }
  }
}
```

## UI/UX 設計指針

### レイアウト設計

- **2カラム構成**: 左サイドバー（サービス一覧）+ 右詳細パネル
- **タブナビゲーション**: 概要 / 操作 / ログ / メトリクス
- **レスポンシブデザイン**: ターミナル幅に応じたレイアウト自動調整

### キーボードショートカット

```typescript
const keyBindings = {
  // サービス選択
  'v': 'vercel',
  't': 'turso',
  's': 'supabase',
  'g': 'github',

  // ナビゲーション
  'j': 'down',
  'k': 'up',
  'h': 'left',
  'l': 'right',

  // アクション
  'r': 'refresh',
  'q': 'quit',
  'Enter': 'select',
  'Escape': 'back'
};
```

### 視覚的フィードバック

- **ステータスインジケータ**: 成功（緑）/ 警告（黄）/ エラー（赤）
- **プログレスバー**: 長時間操作の進捗表示
- **アニメーション**: スピナー、フェードイン/アウト効果

## 状態管理アーキテクチャ

### valtioベースストア設計

```typescript
// src/commands/dashboard/state/dashboard-store.ts
export const dashboardStore = proxy({
  // UI状態
  activeService: 'vercel' as ServiceType,
  activeTab: 'overview' as TabType,
  isLoading: false,

  // 認証状態
  authStatus: {
    vercel: 'unknown',
    turso: 'unknown',
    supabase: 'unknown',
    github: 'unknown'
  } as Record<ServiceType, AuthStatus>,

  // データキャッシュ
  dataCache: new Map(),
  lastRefresh: new Date()
});
```

### React Hooksパターン

```typescript
// src/commands/dashboard/hooks/use-dashboard.ts
export const useDashboard = () => {
  const snapshot = useSnapshot(dashboardStore);

  const refreshAllServices = useCallback(async () => {
    // 全サービスの状態更新
  }, []);

  return { snapshot, refreshAllServices };
};
```

### エラーハンドリング統一化

```typescript
// src/commands/dashboard/utils/error-handler.ts
export class DashboardError extends Error {
  constructor(
    public service: ServiceType,
    public code: ErrorCode,
    message: string
  ) {
    super(message);
  }
}
```

## 認証フロー統合

### 認証状態管理

```typescript
// src/commands/dashboard/utils/auth-manager.ts
export class AuthManager {
  async checkAllServices(): Promise<Record<ServiceType, AuthStatus>> {
    const results = await Promise.allSettled([
      this.checkVercelAuth(),
      this.checkTursoAuth(),
      this.checkSupabaseAuth(),
      this.checkGitHubAuth()
    ]);

    return this.processAuthResults(results);
  }

  private async checkVercelAuth(): Promise<AuthStatus> {
    try {
      const result = await execAsync('vercel whoami');
      return result.exitCode === 0 ? 'authenticated' : 'unauthenticated';
    } catch (error) {
      return 'error';
    }
  }
}
```

### ログインガイダンス

1. **自動検出**: アプリ起動時に全サービスの認証状態を並列チェック
2. **モーダル表示**: 未認証サービスがある場合、ログインガイダンスを表示
3. **ブラウザ連携**: デバイスコード認証時のURLコピー機能
4. **再試行機構**: 認証完了後の自動状態更新

### エラーハンドリング

- **ネットワークエラー**: リトライ機構付きエラー表示
- **CLIエラー**: exit codeに応じた適切なメッセージ表示
- **タイムアウト**: 長時間操作のキャンセル機能

## CLI連携とエントリーポイント

### コマンド登録

```typescript
// src/commands/dashboard.ts
export const dashboardCommand = defineCommand({
  meta: {
    name: 'dashboard',
    description: 'Launch interactive TUI dashboard for service management'
  },
  args: {
    service: {
      type: 'string',
      description: 'Start with specific service (vercel|turso|supabase|github)'
    }
  },
  async run({ args }) {
    await launchDashboard(args.service);
  }
});
```

## テスト戦略

### テストカテゴリ

```
test/
├── unit/dashboard/
│   ├── components/         # コンポーネントテスト
│   ├── services/           # サービスロジックテスト
│   └── state/              # 状態管理テスト
├── integration/dashboard/
│   ├── auth-flow.test.ts   # 認証フローテスト
│   └── service-integration.test.ts # サービス統合テスト
└── scenario/dashboard/
    └── full-workflow.test.ts # エンドツーエンドテスト
```

### テスト実装パターン

```typescript
// test/unit/dashboard/components/vercel-panel.test.tsx
import { render } from 'ink-testing-library';
import { VercelPanel } from '../../../../src/commands/dashboard/components/services/vercel-panel.js';

describe('VercelPanel', () => {
  it('プロジェクト一覧を正しく表示する', () => {
    const { lastFrame } = render(<VercelPanel projects={mockProjects} />);
    expect(lastFrame()).toContain('プロジェクト名');
  });
});
```

### モック戦略

- **CLIコマンドモック**: 実際のCLI呼び出しをモック化
- **認証状態モック**: 各サービスの認証状態をシミュレーション
- **ネットワークエラー**: タイムアウト、接続エラーのシナリオテスト

## 品質基準

### コード品質
- **TypeScript**: 100% 型安全性
- **テストカバレッジ**: 85%以上
- **JSDoc**: 全パブリック API に文書化
- **アクセシビリティ**: キーボード操作完全対応

### パフォーマンス
- **起動時間**: 2秒以内
- **メモリ使用量**: 100MB以内
- **CPU使用率**: アイドル時 <5%
- **レスポンシブ性**: 100ms以内のキー入力応答

### UX品質
- **直感性**: 3回以内のキー操作で主要機能へアクセス
- **一貫性**: 全サービスで統一されたUI/UXパターン
- **エラーハンドリング**: ユーザーフレンドリーなエラーメッセージ

## リスク管理

### 技術的リスク
1. **CLIバージョン互換性**: 各サービスCLIのバージョン変更対応
2. **パフォーマンス劣化**: メモリ使用量やレスポンシブ性の管理
3. **認証エラー**: サービス別の認証方式の相違への対応
4. **UIレイアウト**: ターミナルサイズ変更時のレイアウト崩れ

### 対策
- **継続的テスト**: CI/CDでの定期的な互換性テスト
- **フォールバック機構**: CLIエラー時の適切な代替手段提供
- **グレーシフルデグラデーション**: 部分的な機能不全時の継続的な操作可能性
- **ユーザーガイダンス**: エラー時の明確な指示と解決手順

## 成功指標

1. **操作効率**: 従来のブラウザ操作と比較して50%の時間短縮
2. **ユーザー満足度**: アンケートでの満足度 85%以上
3. **エラー減少**: サービス操作エラーの 70%減少
4. **採用率**: チームメンバーの 80%以上が定期的に使用
5. **保守性**: 月あたりのメンテナンス時間 4時間以内

## 今後の拡張計画

1. **メトリクスダッシュボード**: サービス横断のパフォーマンス分析
2. **アラートシステム**: システム異常の背景通知
3. **AI支援**: ログ分析や問題診断のAIアシスタント
4. **テンプレート管理**: サービス設定のテンプレート化と共有

## 技術検証結果 (2025-10-05)

### Ink + @inkjs/ui 検証
- **バージョン**: ink v6.3.1 + @inkjs/ui v2.0.0 + React 19
- **検証内容**: `temp/ink-ui-smoke/index.tsx`で基本的なTUI構築を確認
- **結果**: テキスト入力、セレクト、ステータス表示が正常動作
- **注意点**: Raw mode非対応環境ではモックSTDINが必要

### asciichart 検証
- **バージョン**: asciichart 1.5.25
- **検証内容**: `temp/ascii-chart-smoke/index.ts`でグラフ描画テスト
- **結果**: サイン波、トレンドグラフの描画成功
- **機能**: カスタムフォーマッタ、カラー制御、リアルタイム更新対応
- **将来計画**: 長期メンテナンス懸念のため、ラッパー層経由で将来的に自前実装へ移行予定
