# テストケースの拡充

[ STATUS:DONE ]

## 背景

- Next.js プロジェクト生成フローは、`src/commands/create` 配下のテンプレート選択・バリデーション・ファイル生成・DB プロビジョニングを横断しており、CLI の主要価値を占める中核機能である。
- 現状 `test/unit/src/commands/create/*.test.ts` や `test/e2e/specs/create/project-creation.test.ts` が存在するものの、テンプレート更新や周辺ユーティリティ拡張の頻度が高く、テスト網羅状況の体系的な可視化が行われていない。
- 将来的なテンプレート数・オプション増加に備え、Next.js 向けのテスト整備状況を定量・定性的に評価するレポート基盤が必要。

## 目的

- Next.js プロジェクト生成に関係するソースコードと既存テストの対応関係を洗い出し、機能網羅・異常系・国際化・ファイル生成検証の観点で十分かどうかを判定する。
- ギャップを優先度付きで整理したレポートを作成し、追加で作成すべきテストケースのリストおよび推奨アプローチを提示する。

## 成果物

1. `docs/reports/testing/nextjs-generation-coverage.md`（新規作成）
   - 現状のテスト配置とカバレッジ指標の概要
   - カバレッジ不足領域の優先度付きバックログ
   - 推奨テスト種別（ユニット / 統合 / E2E）と責務範囲
2. `docs/reviews/src/commands/create/nextjs-generation.md` 更新（既存の場合）
   - 調査内容とコードベースの差分観察結果を同期
3. 追加テストに向けたチケット草案（`docs/tickets/` へのドラフト、必要な場合）

## スコープ

- 対象モジュール
  - テンプレート生成: `src/commands/create/template-generators/nextjs-fullstack-admin.ts`
  - プロンプト / 設定: `src/commands/create/prompts/*.ts`, `src/commands/create/config.ts`
  - 検証ユーティリティ: `src/commands/create/validators.ts`, `src/commands/create/template-selector/*.ts`
  - 関連ユーティリティ: `src/utils/turso-cli/*`, `src/utils/supabase-cli/*`, `src/utils/monorepo-generator/*`
- 対象テスト
  - 単体: `test/unit/src/commands/create/*.test.ts`, `test/unit/template-manager/*.test.ts`
  - 統合・E2E: `test/e2e/specs/create/project-creation.test.ts` および関連ヘルパー
  - ユーティリティ: `test/unit/utils/turso-cli/*.test.ts`, `test/unit/utils/supabase-cli/*.test.ts`
- 計測範囲: `pnpm test:coverage` の出力、Vitest のカバレッジレポート、`test/e2e/reports/` のスクリーンショット・ログ

## アウトオブスコープ

- Next.js 以外のテンプレート（Expo, Tauri など）のテスト評価
- 新規テスト実装そのもの（本計画ではレポート作成まで）
- CI 上の実行最適化やパフォーマンス改善の検討

## 調査観点

- **機能網羅性**: プロンプト分岐、オプション適用、テンプレート差し替えの分岐カバレッジ
- **異常系 / リカバリー**: バリデーション失敗、CLI 依存コマンドエラー、ファイル競合時のハンドリング
- **国際化**: `getMessages()` を通る CLI メッセージが各ロケールでテストされているか
- **ファイル生成検証**: 生成物（`templates/nextjs-fullstack-admin` 配下）の存在チェック、Diff 検証、環境変数ファイル整合性
- **外部依存**: Turso / Supabase CLI ラッパーのモック、ネットワークアクセスなしでの信頼性

## 測定指標

- 行カバレッジ / ブランチカバレッジ: Next.js 関連ファイルの最低達成率（暫定目標 80% 行、60% ブランチ）
- テストケース対機能一覧表: 機能 1 件につき最低 1 ケースを目標とした網羅率
- 重大度別ギャップ数: High / Medium / Low の分類で 0/3/5 件以内を目標

## 作業フロー

### Phase 0: 事前準備（0.5 日）

- `pnpm install` 状態と Node.js 20+ を確認し、カバレッジ取得環境を整備
- `FLUORITE_LOCALE=en` などロケール差異影響を確認

### Phase 1: 基礎データ取得（1 日）

- `pnpm test:coverage -- --reporter=lcov --reporter=json-summary` を実行し、`coverage/lcov-report` と `coverage/coverage-summary.json` を収集
- `pnpm test --filter='create'` で対象テストの成功可否を確認
- E2E ログ（`test/e2e/logs`, `test/e2e/reports`）の最新化状況を記録

### Phase 2: 静的マッピング（1.5 日）

- Next.js 関連ソースファイルごとに主な責務と分岐一覧を抽出し、スプレッドシート（または Markdown テーブル）に転記
- 各責務に紐づく既存テストケースをマッピングし、未網羅領域を仮抽出
- CLI メッセージの i18n 呼び出し箇所を `rg "getMessages" src/commands/create` 等で確認し、テスト有無を判定

### Phase 3: ギャップ検証（1 日）

- 未網羅と推定された箇所について、ソースを再確認し重大度（High: 致命的、Medium: 実務影響、Low: 補完）を付与
- 必要に応じて限定的な追加テスト実行（例: `pnpm test --filter='turso-cli'`）で再現性を検証
- 異常系の再現が難しい場合は、ログ / モック差分の確認手順を記録

### Phase 4: レポート整備（1 日）

- 成果物 1 の構成に従い、概要・詳細分析・推奨アクション・添付資料（カバレッジサマリ抜粋）を記述
- `docs/reviews/src/commands/create/nextjs-generation.md` を更新し、コードリーディング記録を同期
- 追加テストが必要な場合は、各ギャップに対応するチケット草案を `docs/tickets/` にドラフト作成

### Phase 5: レビュー & フォローアップ（0.5 日）

- レポート内容をチームレビュー（PR コメント想定）で確認
- 指摘事項を反映し、完了条件を満たしていることを最終チェック

## レポート構成案（成果物 1）

1. サマリー（目的・結論・重大なギャップ）
2. 対象範囲と前提条件
3. 計測結果（カバレッジテーブル、テスト一覧）
4. 詳細分析（観点別ギャップ、根拠ソース / テスト参照）
5. 優先度付き改善提案（推奨テスト種別、想定工数）
6. 次アクションとフォローアップ計画
7. 付録（指標取得手順、利用コマンド、ログ抜粋）

## 完了条件

- 成果物 1 のレポートがレビュー済みで、重要ギャップに優先度が割り当てられている
- 成果物 2（該当する場合）が最新コードと矛盾しない
- 重大度 High のギャップに対して、追跡用チケット草案または次アクションが明示されている
- 使用したコマンド・ログ・カバレッジ結果が再現できる手順として記録されている

## リスクと軽減策

- **カバレッジ測定の不安定化**: CI とローカルの差異 → Node バージョン固定・`pnpm store prune` 実施
- **E2E 実行時間の増大**: ログ生成負荷 → 必要部分のみ抽出・スクリーンショットは差分がある場合に限定
- **テンプレート更新との競合**: 並行開発でソースが変わる → 調査対象コミットを固定し、差分発生時は再測定
- **外部 CLI 認証問題**: Turso / Supabase CLI が未ログイン → ダミートークンを用いたモック戦略を事前に整理

## 依存関係

- Vitest / Biome / tsx の既存セットアップ
- `docs/plans/0010.md`（Vercel 連携計画）で定義された環境変数命名との整合性確認
- `docs/reviews/src/commands/create/*.md` における既存知見

## スケジュール目安

- 全体工数: 5 日（開発者 1 名換算）
  - Phase 0-1: 1.5 日
  - Phase 2: 1.5 日
  - Phase 3: 1 日
  - Phase 4-5: 1 日
- 緊急調査が入った場合に備え、1 日分のバッファを確保
