# Next.jsプロジェクト生成時にVercelBlobの設定が行えない

[ STATUS:DONE ]

## 概要

Next.jsフルスタックテンプレートの生成時にVercel Blob設定を自動化し、ユーザーが即座に使用可能な状態でプロジェクトを提供する機能を実装します。

## 背景

- `templates/nextjs-fullstack-admin/.env*` では Vercel Blob 関連のプレースホルダーが用意されているが、CLI 生成フローが値を埋めておらず手作業が発生している
- `src/commands/create/prompts/blob-prompts.ts` や `src/utils/vercel-cli/*` には Blob 設定用の基盤コードが存在するものの、Next.js テンプレートで期待通り呼び出されていない
- その結果、プロジェクト生成後に BLOB_READ_WRITE_TOKEN / Store ID / Base URL を揃える作業が残り、マルチ環境の `.env` が初期状態で破綻している

## 現状の課題分析

### 1. 起動条件の問題

- `src/commands/create/commands.ts` で Blob 設定フローを呼び出す条件が `template.includes("nextjs")` になっており、実際のテンプレートキー (`fullstack-admin` など) ではヒットせずプロンプトが起動しない

### 2. UI/UXの問題

- Blob プロンプトは「新規/既存」の二択＋別途 confirm での利用可否という構成で、要件にある「利用しない」を明確な選択肢として提示できていない

### 3. データ構造の問題

- `BlobConfiguration` は Store ID とトークンしか保持しておらず、Base URL や Store 名を `.env` に配送できない

### 4. テンプレートの問題

- `.env`, `.env.development`, `.env.staging`, `.env.prod` に Base URL 用のプレースホルダーが無く、ストレージエンドポイントを他コンポーネントから参照できない

### 5. 国際化の問題

- エラーハンドリングやメッセージが英語混在のままで、i18n ディクショナリにも未登録の文言が点在する

## 達成目標

### 主要目標

1. **自動化されたBlob設定**: Next.js テンプレート生成時に Vercel Blob 利用方針（新規作成 / 既存利用 / 利用しない）を必ず選択させる
2. **完全な環境設定**: 新規作成を選ぶと `BLOB_READ_WRITE_TOKEN`・Store ID・Base URL を取得し、開発/ステージング/本番で共通利用できるよう `.env*` に即時反映する
3. **既存ストア対応**: 既存ストア選択時も同様に Store 情報を取得し、全環境の `.env*` を整えた状態でテンプレートを生成する
4. **安全なフォールバック**: Blob を利用しない場合は関連変数を空文字に初期化し、テンプレート側で安全にフォールバックできることを確認する

### 品質目標

- 操作結果を `docs/reviews/src/commands/create/*.md` へ反映
- ユニットテスト/テンプレート生成テストで主要パスをカバー
- 国際化対応（日本語/英語）

## 実装スコープ

### 含まれる作業

- `src/commands/create/commands.ts` - Blob設定フロー起動条件の修正
- `src/commands/create/prompts/blob-prompts.ts` - プロンプトUI改善（3択選択）
- `src/commands/create/template-generators/nextjs-fullstack-admin.ts` - 環境変数置換ロジック
- `src/utils/vercel-cli/*` - 型と実装更新（Base URL 取得、エラー分類の強化）
- `templates/nextjs-fullstack-admin/.env*` - Base URL用プレースホルダー追加
- `src/i18n.ts` - 新規メッセージの国際化対応
- テストの作成・更新

### 除外される作業

- Next.js 以外のテンプレートへの Blob 統合
- Vercel CLI 未インストール時の自動セットアップやチーム切り替え UI の提供
- BLOB_READ_WRITE_TOKEN の権限管理やローテーション機構の実装

## ユーザーエクスペリエンス設計

### 基本フロー

```
fluorite-flake create
├── Next.jsフルスタックテンプレート選択
├── Vercel Blob設定プロンプト（必須表示）
│   ├── ① 新規ストア作成
│   ├── ② 既存ストア利用
│   └── ③ Blob機能を使用しない
└── プロジェクト生成・設定反映
```

### 詳細フロー

#### ① 新規ストア作成パス

1. BLOB_READ_WRITE_TOKEN の入力・検証
2. ストア名入力（デフォルト: `${projectName}-blob`）
3. `vercel blob store add --json` 実行
4. Store ID / Store URL / トークンを設定値として保持

#### ② 既存ストア利用パス

1. BLOB_READ_WRITE_TOKEN の入力・検証
2. `vercel blob store list --json` でストア一覧取得
3. ストア選択
4. Store ID / Store URL と入力トークンを保持

#### ③ Blob機能を使用しないパス

1. Blob関連処理をスキップ
2. `.env*` のBlob系変数は空文字で初期化

### 最終結果

生成完了後、全ての`.env*`ファイルに以下が設定される：

- `BLOB_READ_WRITE_TOKEN_*`
- `BLOB_STORE_ID_*`
- `BLOB_BASE_URL_*`

README には設定完了状況と確認手順が記載される。

## 技術実装方針

### Phase 1: コア機能実装

#### 1.1 プロンプトシステムの改修

**ファイル**: `src/commands/create/prompts/blob-prompts.ts`

**変更内容**:

```typescript
// 新しいBlobConfiguration型
interface BlobConfiguration {
	mode: "new" | "existing" | "none";
	storeId?: string;
	storeUrl?: string;
	storeName?: string;
	token?: string;
}

// 3択選択プロンプト
const blobModePrompt = {
	type: "select",
	choices: [
		{ name: "新規Blobストアを作成", value: "new" },
		{ name: "既存Blobストアを利用", value: "existing" },
		{ name: "Blob機能を使用しない", value: "none" },
	],
};
```

#### 1.2 起動条件の修正

**ファイル**: `src/commands/create/commands.ts`

**変更内容**:

```typescript
// 修正前: template.includes("nextjs")
// 修正後: プロジェクトタイプベースの判定
const shouldConfigureBlob = (type: string, template: string) => {
	return type === "nextjs" && template === "fullstack-admin";
};
```

### Phase 2: Vercel CLI統合

#### 2.1 型定義の拡張

**ファイル**: `src/utils/vercel-cli/types.ts`

**変更内容**:

```typescript
interface BlobStore {
	id: string;
	name: string;
	url: string; // 必須化
	created: string;
}

interface BlobOperationResult {
	store: BlobStore;
	token?: string; // 新規作成時のみ
}
```

#### 2.2 Base URL取得機能

**ファイル**: `src/utils/vercel-cli/blob.ts`

**新規追加**:

```typescript
export const normalizeBlobUrl = (url: string): string => {
	// https://プレフィックス付与、末尾スラッシュ除去
	return url.replace(/\/$/, "").startsWith("https://") ? url : `https://${url}`;
};
```

### Phase 3: テンプレート統合

#### 3.1 環境変数テンプレート

**ファイル**: `templates/nextjs-fullstack-admin/.env*`

**追加プレースホルダー**:

```
# Vercel Blob Configuration
BLOB_READ_WRITE_TOKEN={{BLOB_READ_WRITE_TOKEN}}
BLOB_STORE_ID={{BLOB_STORE_ID}}
BLOB_BASE_URL={{BLOB_BASE_URL}}
```

#### 3.2 置換ロジック

**ファイル**: `src/commands/create/template-generators/nextjs-fullstack-admin.ts`

**修正内容**:

```typescript
const buildEnvReplacements = (config: BlobConfiguration) => {
	const blobValues =
		config.mode === "none"
			? { token: "", storeId: "", baseUrl: "" }
			: {
					token: config.token || "",
					storeId: config.storeId || "",
					baseUrl: config.storeUrl || "",
				};

	return {
		"{{BLOB_READ_WRITE_TOKEN}}": blobValues.token,
		"{{BLOB_STORE_ID}}": blobValues.storeId,
		"{{BLOB_BASE_URL}}": blobValues.baseUrl,
		// 既存の置換ロジック...
	};
};
```

### Phase 4: 国際化・テスト

#### 4.1 メッセージ国際化

**ファイル**: `src/i18n.ts`

**追加メッセージ**:

```typescript
blob: {
  setupPrompt: 'Vercel Blobの設定方法を選択してください',
  modeNew: '新規Blobストアを作成',
  modeExisting: '既存Blobストアを利用',
  modeNone: 'Blob機能を使用しない',
  // エラーメッセージ等...
}
```

#### 4.2 テスト作成

**新規ファイル**: `test/unit/src/commands/create/blob-integration.test.ts`

**テスト観点**:

- 3つのモード選択とそれぞれの設定結果
- 環境変数ファイルへの正しい値の反映
- エラー時のフォールバック動作

## 実装タスク

### フェーズ1: 基盤実装（優先度: 高）

1. **型定義とインターフェース設計**
   - [ ] `BlobConfiguration` 型を拡張（mode/storeUrl/storeName 追加）
   - [ ] `BlobStore` 型のurl必須化
   - [ ] エラー型の拡張

2. **プロンプトシステム改修**
   - [ ] 3択選択UI実装（新規/既存/使用しない）
   - [ ] 起動条件修正（プロジェクトタイプベース）
   - [ ] i18n対応メッセージ追加

### フェーズ2: Vercel CLI統合（優先度: 高）

3. **Base URL取得機能**
   - [ ] URL正規化ヘルパー実装
   - [ ] JSONパース処理強化
   - [ ] エラーハンドリング改善

4. **CLIラッパー改修**
   - [ ] `createBlobStore` 戻り値更新
   - [ ] `listBlobStores` でURL確実取得
   - [ ] エラーメッセージ日本語化

### フェーズ3: テンプレート統合（優先度: 高）

5. **環境変数テンプレート**
   - [ ] `.env*` ファイルにBase URLプレースホルダー追加
   - [ ] 置換ロジック実装
   - [ ] 空文字フォールバック対応

6. **生成フロー統合**
   - [ ] `generateProject` との連携
   - [ ] README更新ロジック
   - [ ] 設定完了通知

### フェーズ4: 品質保証（優先度: 中）

7. **テスト実装**
   - [ ] プロンプトフロー単体テスト
   - [ ] 環境変数置換テスト
   - [ ] エンドツーエンドテスト

8. **ドキュメント更新**
   - [ ] レビュー文書更新
   - [ ] 使用方法ガイド作成
   - [ ] エラー対応手順

## テスト要件

### 必須テストケース

1. **プロンプト選択フロー**
   - 新規作成: Store情報取得・保持確認
   - 既存利用: 一覧取得・選択・URL設定確認
   - 使用しない: null返却・スキップ確認

2. **環境変数生成**
   - 全`.env*`ファイルへの正しい値反映
   - Blob未使用時の空文字設定
   - プレースホルダー置換確認

3. **エラーハンドリング**
   - Vercel CLI未インストール時
   - 認証失敗時
   - ネットワークエラー時
   - 不正なトークン時

4. **国際化**
   - 日本語/英語両ロケールでの表示確認
   - エラーメッセージの適切な翻訳

## リスク管理

### 高リスク項目

1. **Vercel CLI依存性**
   - **リスク**: CLI仕様変更、JSON応答フォーマット変更
   - **対策**: 厳格なバリデーション、フォールバック機能

2. **認証・権限**
   - **リスク**: チーム環境での認証失敗、scope指定未対応
   - **対策**: エラーメッセージ改善、手動設定案内

### 中リスク項目

3. **テンプレート互換性**
   - **リスク**: 既存プロジェクトとの非互換性
   - **対策**: 段階的移行、フォールバック対応

4. **パフォーマンス**
   - **リスク**: Vercel API呼び出し遅延
   - **対策**: タイムアウト設定、プログレス表示

## 成功判定基準

### 機能要件

- [ ] Next.jsテンプレート選択時にBlob設定プロンプトが確実に表示される
- [ ] 3つの選択肢すべてで適切な結果が得られる
- [ ] 生成された`.env*`ファイルに正しい値が設定される
- [ ] エラー時に適切なメッセージが表示される

### 品質要件

- [ ] 全テストがパスする
- [ ] 日本語/英語両方で正しく動作する
- [ ] レビュー文書が最新状態になっている
- [ ] パフォーマンスが許容範囲内（<10秒）
