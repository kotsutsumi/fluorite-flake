# monorepo-readyなプロジェクト作成

[ STATUS:DONE ]

「単体として使うが、いつでも増やせる」形です。まずはワークスペースをONにした1パッケージ。
fluorite-flakeが利用できる時点で、`node`は使えていますが、`pnpm`の利用が必須です。

## 実装の前提条件

- Node.js 20.0.0以上が必要
- pnpm 10.0.0以上が必要
- 既存の`createProject`関数を拡張してmonorepo対応を追加

## pnpmの利用確認

`new` コマンドでプロジェクトを作成し始めたときに、以下の確認を実装：

1. **pnpm存在確認**: `pnpm --version`コマンドで存在確認
2. **バージョン確認**: v10.0.0以上がインストールされているか確認
3. **エラーハンドリング**: インストールされていなければ適切なエラーメッセージと共に終了
4. **ガイダンス**: 終了時にpnpm最新版の導入方法を多言語対応で提示

```typescript
// 実装例
async function validatePnpm(): Promise<boolean> {
	try {
		const { stdout } = await execa("pnpm", ["--version"]);
		const version = stdout.trim();
		const majorVersion = parseInt(version.split(".")[0]);

		if (majorVersion < 10) {
			console.error(
				chalk.red(`❌ pnpm v${version} detected. v10.0.0+ required.`),
			);
			showPnpmInstallGuide();
			return false;
		}

		console.log(chalk.green(`✅ pnpm v${version} detected.`));
		return true;
	} catch (error) {
		console.error(chalk.red("❌ pnpm not found."));
		showPnpmInstallGuide();
		return false;
	}
}
```

## 生成されるディレクトリ構造

```
repo/
├─ package.json            # "private": true, "workspaces": ["apps/*","packages/*"]
├─ pnpm-workspace.yaml     # pnpmなら必須
├─ turbo.json / nx.json    # （任意）将来に備えたタスクランナー設定
├─ tsconfig.base.json      # 共有ts設定
├─ .biome.json / .eslintrc.json  # 共有Lint/Format
├─ .husky/                 # 共有git hooks
├─ apps/
│  └─ web/                 # ← 今はここに1つ（Next.js等）
└─ packages/               # ← 将来libsを追加
```

### pnpm-workspace.yaml

```
packages:
  - "apps/*"
  - "packages/*"
```

### turbo.json

```
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": [
    "package.json",
    "pnpm-lock.yaml",
    "tsconfig.base.json",
    ".ultracite.json"
  ],
  "tasks": {
    "dev": {
      "cache": false,
      "persistent": true,
      "dependsOn": ["^dev?"],
      "env": ["NODE_ENV", "NEXT_PUBLIC_"]
    },
    "build": {
      "dependsOn": ["^build"],
      "outputs": [
        "dist/**",
        "build/**",
        ".next/**",
        "out/**"
      ],
      "env": ["NODE_ENV"]
    },
    "typecheck": {
      "dependsOn": ["^typecheck"]
    },
    "test": {
      "dependsOn": ["^test"],
      "outputs": ["coverage/**", "reports/**"]
    },
    "lint": {
      "dependsOn": ["^lint"],
      "outputs": []
    },
    "format": {
      "cache": false,
      "outputs": []
    },
    "check": {
      "dependsOn": ["lint", "typecheck", "test"],
      "outputs": []
    }
  },
  "pipeline": {}
}
```

### biome.json

現在のプロジェクトで使用中のUltraciteと整合性を保つため、`.ultracite.json`ではなく`biome.json`を使用：

```json
{
	"$schema": "https://biomejs.dev/schemas/2.2.5/schema.json",
	"extends": ["ultracite"],
	"formatter": {
		"indentStyle": "space",
		"indentWidth": 4,
		"lineWidth": 100
	},
	"files": {
		"experimentalScannerIgnores": [
			"node_modules/**",
			"dist/**",
			"build/**",
			".next/**",
			"out/**",
			"coverage/**",
			"**/*.min.js"
		]
	},
	"overrides": [
		{
			"includes": ["**/*.ts", "**/*.tsx"],
			"javascript": {
				"formatter": {
					"quoteStyle": "double",
					"trailingComma": "all"
				}
			}
		}
	]
}
```

### tsconfig.base.json

```
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["ES2023", "DOM"],
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "resolveJsonModule": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "allowJs": false,
    "strict": true,
    "noFallthroughCasesInSwitch": true,
    "forceConsistentCasingInFileNames": true,
    "baseUrl": ".",
    "paths": {
      "@repo/ui/*": ["packages/ui/src/*"],
      "@repo/config/*": ["packages/config/*"]
    },
    "jsx": "react-jsx"
  },
  "exclude": ["node_modules", "dist", "build", ".next", "coverage"]
}
```

### package.json

```json
{
	"name": "<プロジェクト名に置き換える>-workspace",
	"private": true,
	"packageManager": "pnpm@10.18.0",
	"workspaces": ["apps/*", "packages/*"],
	"scripts": {
		"dev": "turbo run dev --filter=apps/web",
		"build": "turbo run build",
		"lint": "ultracite check",
		"format": "ultracite fix",
		"test": "vitest run --coverage",
		"check": "turbo run check",
		"typecheck": "turbo run typecheck"
	},
	"devDependencies": {
		"@types/node": "^22.10.2",
		"typescript": "^5.7.2",
		"vitest": "^3.2.4",
		"turbo": "^2.2.2",
		"ultracite": "^5.5.0",
		"tsx": "^4.19.2",
		"husky": "^9.1.5",
		"lint-staged": "^15.3.0"
	},
	"lint-staged": {
		"*.{js,jsx,ts,tsx,json,md,css}": ["ultracite fix"]
	},
	"engines": {
		"node": ">=20.0.0",
		"pnpm": ">=10.18.0"
	}
}
```

## 実装手順

1. **バリデーション機能の追加**
   - `src/utils/pnpm-validator.ts` でpnpmバージョン確認機能を実装
   - 多言語対応のエラーメッセージを `src/i18n/` に追加

2. **テンプレート作成**
   - `templates/monorepo/` ディレクトリを作成
   - 上記の設定ファイルをテンプレートとして配置

3. **既存コマンドの拡張**
   - `createProject` 関数にmonorepoオプションを追加
   - フレームワーク選択時にmonorepoモードの選択肢を追加

4. **コマンドオプション追加**

   ```bash
   fluorite-flake new my-project --type nextjs --monorepo
   ```

5. **テストの追加**
   - pnpmバリデーション機能のユニットテスト
   - monorepoプロジェクト生成の統合テスト

## 注意点

- 現在のプロジェクトで使用中のUltracite v5.5.0との互換性を保つ
- インデント設定（スペース4）の整合性を維持
- 既存のフレームワーク生成機能との共存
- エラーハンドリングと適切なユーザーガイダンス
