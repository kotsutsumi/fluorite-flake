# Next.jsプロジェクト生成時のVercel Blobトークン発行フロー改善

[ STATUS:DONE ]

## 概要
- Next.js フルスタックテンプレート生成時に Vercel Blob を「既存ストア利用」または「新規作成」から選択し、`BLOB_READ_WRITE_TOKEN` を確実に配布するフローへ改修する。
- Blob ストア作成／選択に伴うトークン取得タイミングを整理し、`.env*` への書き込みとテンプレート差し込みを自動化する。
- ユーザーが CLI 実行後に手作業でトークン／Store ID／Base URL を整備する必要がない状態を目指す。

## 背景
- `src/commands/create/prompts/blob-prompts.ts` では三択プロンプトを用意しているが、`listBlobStores` が常に空配列を返すため既存ストア選択パスが動作しない。
- `createBlobStore` は `vercel blob store add` の戻り値からトークンを取得しておらず、ユーザー入力トークンをそのまま使い回しているため「新規作成時に自動発行されたトークンを受け取る」ケースをカバーできていない。
- Vercel CLI 48.2.1 基準の実装となっており、最新 CLI の `blob store list --json` や REST API を活用できていない。
- `.env*` への埋め込みは `blobConfig.token` 単一値を全環境に流用しており、環境別に管理したい場合や、入力キャンセル時のフォールバックが曖昧。

## 目的
1. 既存ストアの一覧取得 → 選択 → `BLOB_READ_WRITE_TOKEN` の確保までを CLI 内で完結させる。
2. 新規ストア作成後に RW トークンを発行し、その値を `.env`, `.env.development`, `.env.staging`, `.env.prod` へ自動反映する。
3. トークン取得が失敗した場合でもユーザーに再入力/再試行パスを提示し、最終的に Blob 無効化へ安全にフォールバックできるようにする。

## スコープ
- Next.js フルスタックテンプレート (`templates/nextjs-fullstack-admin/`) と、それを操作する CLI (`src/commands/create/*`) の Blob 関連フロー。
- `src/utils/vercel-cli/*` における Blob 操作用ラッパーの拡張（ストア一覧、トークン発行、詳細取得）。
- 国際化メッセージ (`src/i18n.ts`) とレビュー文書の更新。
- テスト（ユニット／テンプレート生成 E2E）の追加または修正。

### アウトオブスコープ
- 他テンプレート（Expo/Tauri 等）での Blob 統合。
- トークンローテーションや複数トークン管理 UI の実装。
- Vercel プロジェクト／チーム切替 UI の提供。

## 現状課題の詳細
1. **既存ストア選択不可**
   - `listBlobStores` が CLI 互換性の問題で空配列を返し、`selectExistingStore` で例外が発生する。
2. **トークン自動生成未対応**
   - 新規作成時、CLI が自動発行したトークンを受け取らず、手動入力トークンに依存している。
3. **トークン検証の副作用**
   - `validateBlobToken`／`listBlobStores` がテスト用ストアを作成して削除する方式のため、認証失敗時のエラー判定が不安定。
4. **i18n とログ整備不足**
   - 例外発生時のメッセージが日本語化されておらず、ユーザーに再入力手順が伝わりにくい。
5. **テンプレート差し込みの一律運用**
   - 全環境同一トークン前提での置換となっており、今後環境別トークンに発展させる余地を開けていない。

## 方針・フェーズ分割
### Phase 0: 仕様調査と互換性確認
- 現行で採用する Vercel CLI バージョンを確認し、`blob store list --json` や `vercel api /v2/blob/stores` が利用可能か検証する。
- REST API 利用時に必要なスコープ・認証方法を整理し、CLI ラッパーで再利用可能な抽象を決める。

### Phase 1: Blob 操作ユーティリティの刷新
- `src/utils/vercel-cli/blob-operations.ts`
  - `listBlobStores` を CLI 48.2.1 互換のポーリング実装から、最新 CLI or REST API 呼び出し（`vercel api` 経由）に置き換える。
  - `createBlobStore` で CLI が返す JSON/テキストを解析し、生成された RW トークンを取得する（取得できない場合は後続で `createBlobToken` を呼ぶ）。
  - 新規ヘルパー `createBlobToken({ storeId, scope, tokenType })` を追加し、トークン生成専用コマンド (`vercel blob store tokens issue` 相当) または API エンドポイントへ委譲する。
  - `getBlobStore` を REST API ベースに刷新し、URL／リージョン情報を正確に取得する。
  - エラー型を拡張し、トークン失効／認証不足／HTTP 429 を区別できるようにする。

### Phase 2: プロンプトフローの改修
- `src/commands/create/prompts/blob-prompts.ts`
  - 既存ストア選択時に `listBlobStores` の結果を表示し、選択後に `createBlobToken` を呼び出して RW トークンを即時生成。
  - 新規作成時に `createBlobStore` → `createBlobToken` の連鎖を行い、CLI がトークンを返さなかった場合でも確実にトークンを取得する。
  - トークン取得失敗時のリトライ回数制御と、フォールバック（Blob 無効化）選択肢を UI に提示。
  - 取得した `BlobConfiguration` に `issuedTokenId` や `tokenScope` などメタ情報を保持できるよう型を拡張する。
  - `promptForToken` は既存ストア利用時のみを想定し、発行フローではユーザー入力を不要にする。

### Phase 3: テンプレート生成と環境変数反映
- `src/commands/create/template-generators/nextjs-fullstack-admin.ts`
  - `blobConfig` 拡張に合わせて `.env*` の置換ロジックを見直し、空文字フォールバック・環境別トークンにも対応できる構造へ整理。
  - Blob 無効化時には関連プレースホルダーを空文字で埋めつつ、テンプレート内ロジック（`src/lib/storage.ts`）が安全に動作することを再確認。
- `templates/nextjs-fullstack-admin/.env*`
  - 必要ならば `_TOKEN_ID` や `_TOKEN_SCOPE` 等の追加プレースホルダーを用意。

### Phase 4: i18n とドキュメント
- `src/i18n.ts` に新規メッセージ（トークン発行成功／失敗、REST API 失敗、フォールバック案内）を追加。
- `docs/reviews/src/commands/create/*.md` を更新し、イテレーション手順に沿ってレビュー内容を反映。
- `docs/guides` 系に Blob 利用ガイドが存在する場合は更新。

### Phase 5: テスト整備
- ユニットテストで `createBlobToken`, `listBlobStores` の異常系をモックして検証。
- テンプレート生成テストで、新規・既存・未設定パスそれぞれの `.env*` 出力をスナップショット確認。
- `pnpm dev` 実行時の開発モードログが過剰にならないか確認し、必要であればデバッグログを調整。

## 実装タスク詳細

### Phase 1: Blob 操作ユーティリティの刷新
1. **`src/utils/vercel-cli/blob-types.ts`** - 型定義の拡張
   - `BlobConfiguration` に以下フィールドを追加：
     - `tokenId?: string` - 発行されたトークンのID
     - `tokenExpiresAt?: string` - トークンの有効期限
     - `tokenScope?: string` - トークンのスコープ（read/write権限）
     - `isAutoGenerated?: boolean` - 自動生成されたトークンかどうか

2. **`src/utils/vercel-cli/blob-operations.ts`** - コア機能の実装
   - `listBlobStores()` の刷新：
     - 現行の空配列問題を解決
     - `vercel api /v2/blob/stores` または最新CLI互換の実装
     - エラーハンドリングとレスポンス検証を追加
   - `createBlobToken()` の新規追加：
     - ストアIDからトークンを生成する専用関数
     - `vercel blob store tokens issue` 相当の機能
     - 生成されたトークン情報の構造化
   - `createBlobStore()` の改修：
     - CLI実行後の戻り値解析でトークン自動取得
     - 取得失敗時の `createBlobToken()` へのフォールバック
   - `getBlobStore()` のREST API化：
     - URL・リージョン情報の正確な取得
     - エラー型の詳細化（認証失効・HTTP 429等）

### Phase 2: プロンプトフローの改修
3. **`src/commands/create/prompts/blob-prompts.ts`** - ユーザーインタラクションの改善
   - 既存ストア選択フローの修正：
     - `listBlobStores()` 結果の適切な表示
     - 選択後の `createBlobToken()` 自動実行
   - 新規作成フローの拡張：
     - `createBlobStore()` → `createBlobToken()` の確実な連鎖
     - トークン取得失敗時のリトライ機能（最大3回）
   - フォールバック処理の追加：
     - Blob機能無効化の選択肢提示
     - ユーザーフレンドリーなエラーメッセージ
   - `promptForToken()` の条件付き実行：
     - 既存ストア利用時のみユーザー入力を要求
     - 自動発行時はスキップ

### Phase 3: テンプレート生成と環境変数反映
4. **`src/commands/create/template-generators/nextjs-fullstack-admin.ts`** - 環境変数処理の改善
   - `buildBlobEnvReplacements()` 関数の抽出：
     - 従来の `buildEnvReplacements()` からBlob関連処理を分離
     - 環境別トークン対応の基盤整備
   - エラーハンドリングの強化：
     - Blob設定が不完全な場合の安全なフォールバック
     - 空文字埋めと警告メッセージの表示
   - 将来拡張性の確保：
     - 複数環境での異なるトークン対応準備

### Phase 4: 国際化とメッセージ
5. **`src/i18n.ts`** - ユーザーメッセージの追加
   - 新規メッセージキーの追加：
     - `blobTokenIssueSuccess` - トークン発行成功
     - `blobTokenIssueFailed` - トークン発行失敗
     - `blobApiError` - API呼び出しエラー
     - `blobFallbackPrompt` - フォールバック選択のプロンプト
     - `blobRetryPrompt` - リトライ確認のプロンプト
   - 英語・日本語の両言語対応

### Phase 5: テスト整備
6. **`test/unit/utils/vercel-cli/blob-operations.test.ts`** - ユニットテストの追加
   - 新機能の網羅的テスト
   - モック化による異常系テスト
   - レスポンス形式の変更に対する堅牢性テスト

7. **`test/functional/commands/create/blob-integration.test.ts`** - 統合テストの追加
   - エンドツーエンドのフロー検証
   - `.env*` ファイルの出力確認
   - 各パス（既存・新規・無効化）の動作検証

## テスト計画
- **ユニットテスト**: Blob 操作ユーティリティのモック化により、成功・認証エラー・ネットワークエラーを網羅。
- **統合テスト**: テンプレート生成 CLI をモック CLI 依存で実行し、`.env*` と生成ログを検証。
- **回帰テスト**: Blob 無効化パスを通した際にテンプレートビルドが成功するか確認（`pnpm build`, `pnpm test`）。
- **ドキュメント検証**: `pnpm lint` で i18n のキー漏れ、`pnpm format` で整形確認。

## リスクと緩和策
- **REST API 仕様変更**: Vercel CLI / API の変更に備えて、レスポンススキーマを型定義し、未知フィールドは無視する。
- **トークン作成制限**: 1 ストアあたりのトークン発行上限に触れる可能性 → 既存トークンの再利用または再発行の選択肢を UI で提示。
- **チーム／スコープ不一致**: CLI 実行ユーザーのデフォルトチームと生成対象が異なる場合、`--scope` オプション／環境変数によるスコープ指定をガイドに明記。
- **非同期処理の待ち時間**: API 呼び出しのタイムアウトに備え、CLI 側でスピナー表示とタイムアウトメッセージを追加。

## 未解決事項 / 要検討
- トークンを `.env*` へ直接書き込むか、`vercel env add` を併用するかの最終決定。
- チームメンバー共有を想定したトークン保管方針（Git 管理 vs Secrets Manager）のガイダンス追加有無。
- Vercel CLI の将来バージョンに合わせた実装分岐（例: `vercel` バージョンチェック）を行うかどうか。

## 実装優先度と進行計画

### 🚀 高優先度（即座に実装すべき項目）
1. **型定義の拡張** (`blob-types.ts`)
   - 既存コードとの互換性を保ちつつ、新機能の基盤を構築
2. **listBlobStores()の修正** (`blob-operations.ts`)
   - 現在の空配列問題を解決し、既存ストア選択を機能させる
3. **createBlobToken()の実装** (`blob-operations.ts`)
   - トークン自動生成の核となる機能

### 🔥 中優先度（フロー改善に必要）
4. **プロンプトフローの改修** (`blob-prompts.ts`)
   - ユーザー体験の向上とエラーハンドリング
5. **環境変数処理の改善** (`nextjs-fullstack-admin.ts`)
   - より堅牢な設定ファイル生成

### ⚡ 低優先度（品質向上）
6. **国際化メッセージ** (`i18n.ts`)
   - より良いユーザーメッセージ
7. **テスト整備**
   - 回帰防止と品質保証

## 実装判断基準

### ✅ 必須機能
- 既存ストア一覧取得と選択
- 新規ストア作成時のトークン自動取得
- 失敗時の適切なフォールバック

### 🎯 推奨機能
- リトライ機能（最大3回）
- 詳細なエラーメッセージ
- 環境別トークン対応の基盤

### 🚫 実装しない機能（当面）
- トークンローテーション
- 複数トークン管理UI
- Vercel プロジェクト/チーム切替UI

## 完了条件

### ✅ 機能要件
- [x] 既存ストア選択パスが正常動作する
- [x] 新規ストア作成時にトークンが自動取得される
- [x] 失敗時にBlob無効化へ安全にフォールバックできる
- [x] `.env*` ファイルに適切な値が設定される

### ✅ 品質要件
- [x] `pnpm build && pnpm test && pnpm lint` が全て成功する
- [x] 新規追加のテストが90%以上のカバレッジを達成する
- [x] 国際化メッセージが英語・日本語で適切に表示される

### ✅ ドキュメント要件
- [x] `docs/reviews/src/**/*.md` が最新状態に更新される
- [x] 実装完了後に `docs/plans/done/0019.md` が作成される
- [x] 変更内容が適切にレビュー文書に反映される

