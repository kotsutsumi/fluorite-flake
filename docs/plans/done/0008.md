# E2Eテスト環境構築計画

[ STATUS:DONE ]

## 概要

Fluorite CLIツールの品質と信頼性を確保するための包括的なE2E（End-to-End）テスト環境を構築する。実際のユーザーシナリオをベースにした自動化テストを実装し、継続的インテグレーション（CI）に統合する。

## 目標

1. **リアルワールドテスト**: 実際のユーザー操作をシミュレーション
2. **自動化**: CI/CDパイプラインでの自動実行
3. **包括的カバレッジ**: 全主要機能のテストカバレッジ
4. **継続的品質保証**: リグレッション防止とバグ早期発見
5. **クロスプラットフォーム**: macOS/Linux/Windowsでの動作確認

## テスト対象機能

### 1. プロジェクト生成（create コマンド）
- Next.js プロジェクト生成
- Expo プロジェクト生成
- Tauri プロジェクト生成
- モノレポ構造生成
- TypeScript/JavaScript 選択
- 依存関係インストール

### 2. TUI ダッシュボード（dashboard コマンド）
- ダッシュボード起動
- サービス切り替え
- タブナビゲーション
- キーボード操作
- エラーハンドリング

### 3. サービス統合
- Vercel CLI 連携
- Turso CLI 連携
- Supabase CLI 連携
- GitHub CLI 連携
- 認証状態管理

### 4. CLI 基本機能
- ヘルプ表示
- バージョン表示
- 国際化（日本語/英語）
- エラーメッセージ
- デバッグモード

## テスト環境設計

### ディレクトリ構造
```
test/e2e/
├── fixtures/             # テスト用データ
│   ├── projects/         # プロジェクトテンプレート
│   ├── configs/          # 設定ファイル
│   └── mocks/            # モックデータ
├── specs/                # テストスペック
│   ├── create/           # プロジェクト生成テスト
│   ├── dashboard/        # ダッシュボードテスト
│   ├── services/         # サービス統合テスト
│   └── cli/              # CLI基本機能テスト
├── helpers/              # テストヘルパー
│   ├── cli-runner.ts     # CLI実行ヘルパー
│   ├── project-utils.ts  # プロジェクト操作ユーティリティ
│   ├── temp-manager.ts   # 一時ディレクトリ管理
│   └── assertions.ts     # カスタムアサーション
└── setup/                # テスト環境セットアップ
    ├── global-setup.ts   # グローバルセットアップ
    ├── global-teardown.ts # グローバルクリーンアップ
    └── test-config.ts    # テスト設定
```

### テクノロジースタック
- **テストフレームワーク**: Vitest
- **CLI テスティング**: execa
- **ファイルシステム**: fs-extra
- **一時ディレクトリ**: tmp
- **アサーション**: expect
- **モック**: vi (Vitest)

## テストケース詳細

### 1. プロジェクト生成テスト
```typescript
describe('プロジェクト生成', () => {
  test('Next.js プロジェクトが正常に生成される', async () => {
    const result = await runCLI(['create', 'test-project', '--type', 'nextjs']);
    expect(result.exitCode).toBe(0);
    expect(await exists('test-project/package.json')).toBe(true);
    expect(await exists('test-project/next.config.js')).toBe(true);
  });

  test('TypeScript プロジェクトの依存関係が正しく設定される', async () => {
    const result = await runCLI(['create', 'ts-project', '--typescript']);
    const packageJson = await readJSON('ts-project/package.json');
    expect(packageJson.devDependencies).toHaveProperty('@types/node');
  });
});
```

### 2. ダッシュボードテスト
```typescript
describe('TUI ダッシュボード', () => {
  test('ダッシュボードが起動する', async () => {
    const child = spawnCLI(['dashboard']);
    await waitForOutput(child, 'Vercel');
    await sendKey(child, 'q'); // 終了
    expect(child.exitCode).toBe(0);
  });

  test('サービス切り替えが動作する', async () => {
    const child = spawnCLI(['dashboard']);
    await waitForOutput(child, 'Vercel');
    await sendKey(child, 't'); // Turso に切り替え
    await waitForOutput(child, 'Turso');
    await sendKey(child, 'q');
  });
});
```

### 3. エラーハンドリングテスト
```typescript
describe('エラーハンドリング', () => {
  test('存在しないコマンドで適切なエラーメッセージを表示', async () => {
    const result = await runCLI(['invalid-command']);
    expect(result.exitCode).toBe(1);
    expect(result.stderr).toContain('Unknown command');
  });

  test('必須パラメータが不足時にヘルプを表示', async () => {
    const result = await runCLI(['create']);
    expect(result.exitCode).toBe(1);
    expect(result.stdout).toContain('Usage:');
  });
});
```

## CI/CD統合

### GitHub Actions ワークフロー
```yaml
name: E2E Tests

on: [push, pull_request]

jobs:
  e2e-tests:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node: [18, 20]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Install dependencies
        run: pnpm install

      - name: Build project
        run: pnpm build

      - name: Run E2E tests
        run: pnpm test:e2e

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results-${{ matrix.os }}-node${{ matrix.node }}
          path: test/e2e/results/
```

## パフォーマンステスト

### テスト項目
1. **プロジェクト生成速度**: 各プロジェクトタイプの生成時間
2. **ダッシュボード起動時間**: TUI起動までの時間
3. **CLI レスポンス時間**: コマンド実行時間
4. **メモリ使用量**: 実行時のメモリ消費
5. **並行処理**: 複数プロセス同時実行

### ベンチマーク基準
- プロジェクト生成: < 30秒
- ダッシュボード起動: < 3秒
- ヘルプ表示: < 1秒
- メモリ使用量: < 100MB

## テストデータ管理

### モックサービス
- GitHub API モック
- Vercel API モック
- Supabase API モック
- Turso API モック

### テスト用プロジェクト
- 最小構成プロジェクト
- 複雑な構成プロジェクト
- エラーケース用プロジェクト

## 実行とレポート

### テスト実行コマンド
```bash
# 全E2Eテスト実行
pnpm test:e2e

# 特定テストスイート実行
pnpm test:e2e --grep "プロジェクト生成"

# ウォッチモード
pnpm test:e2e --watch

# カバレッジレポート付き
pnpm test:e2e --coverage

# 詳細レポート生成
pnpm test:e2e --reporter=html
```

### レポート出力
- HTML レポート: `test/e2e/reports/index.html`
- JUnit XML: `test/e2e/reports/junit.xml`
- カバレッジ: `test/e2e/coverage/`
- スクリーンショット: `test/e2e/screenshots/`

## 実装フェーズ

### Phase 1: 基盤構築
- [ ] テスト環境セットアップ
- [ ] CLI実行ヘルパー実装
- [ ] 一時ディレクトリ管理実装
- [ ] 基本アサーション実装

### Phase 2: コアテスト実装
- [ ] プロジェクト生成テスト
- [ ] CLI基本機能テスト
- [ ] エラーハンドリングテスト
- [ ] 国際化テスト

### Phase 3: TUIテスト実装
- [ ] ダッシュボードテスト
- [ ] キーボード操作テスト
- [ ] 画面遷移テスト
- [ ] エラー表示テスト

### Phase 4: サービス統合テスト
- [ ] 各種CLI連携テスト
- [ ] 認証状態テスト
- [ ] API連携テスト
- [ ] モック環境構築

### Phase 5: CI/CD統合
- [ ] GitHub Actions設定
- [ ] クロスプラットフォームテスト
- [ ] パフォーマンステスト
- [ ] レポート自動生成

## 品質基準

### テストカバレッジ目標
- E2E機能カバレッジ: 90%以上
- 主要ユーザーフロー: 100%
- エラーシナリオ: 80%以上
- クロスプラットフォーム: 3OS対応

### 成功基準
- [ ] 全テストがCI環境で通る
- [ ] パフォーマンス基準をクリア
- [ ] クロスプラットフォーム動作確認
- [ ] 自動化されたレグレッション検出

## 運用・保守

### 定期実行
- 毎日: スモークテスト
- 毎週: フルE2Eテスト
- リリース前: 包括的テスト

### メンテナンス
- テストケース定期見直し
- モックデータ更新
- パフォーマンス基準調整
- 新機能テスト追加

---
**作成日**: 2024年12月
**更新予定**: 実装進捗に応じて随時更新