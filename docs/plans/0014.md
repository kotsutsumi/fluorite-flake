# ルートからの pnpm 操作一元化

[ STATUS:PLANNING ]

## 目的
- 生成されたモノレポ（例: `apps/web`（Next.js）, 将来的には `apps/backend`, `apps/mobile` 等）に対して、プロジェクトルートで `pnpm <command>` を実行すれば各アプリ固有のスクリプトが実行できるようにする。
- 開発者がアプリディレクトリへ `cd` してからコマンドを実行する手間をなくし、操作性を向上させる。

## ゴール
1. ルート `package.json` のスクリプト経由で、`apps/web`（Next.js）の `env:*`, `db:*`, `dev`, `build`, `lint` 等が呼び出せる。
2. 将来的に `apps/expo` などが追加されても同じ方針で操作可能にするため、再利用しやすい仕組みを整えておく。
3. README やテンプレートドキュメントで、ルート操作の方法が明記されている。

## スコープ
- ルート `package.json` のスクリプト追加/更新（`pnpm --filter` の活用）。
- `pnpm-workspace.yaml` の設定確認（`apps/*` がワークスペースに含まれていること）。
- `templates/nextjs-fullstack-admin` 等のテンプレートに内包された `package.json` スクリプトの整備。
- CLI 生成処理でのスクリプト追加（必要に応じて）。

## アウトオブスコープ
- 他のパッケージマネージャ（npm/yarn）での対応。
- 既存ユーザー環境への自動移行。

## 詳細設計案
1. **ルート `package.json` へのスクリプト集約**
   - 例: Next.js アプリ（`apps/web`）向け:
     ```json
     "scripts": {
       "web:dev": "pnpm --filter apps/web dev",
       "web:build": "pnpm --filter apps/web build",
       "web:db:generate": "pnpm --filter apps/web db:generate",
       "web:env:encrypt": "pnpm --filter apps/web env:encrypt"
     }
     ```
   - Expo や Backend など他アプリにも同様のプレフィックスを設定しやすい命名規約を検討。

2. **既存テンプレートの `package.json` 調整**
   - 各アプリケーション側のスクリプトを整理し、ルートから呼び出す前提で命名統一（例: `db:*`, `env:*`）。
   - ルートから呼び出した際にパス参照が崩れないよう、相対パスではなく `process.cwd()` を基準に処理。

3. **CLI 生成処理との連携**
   - `src/commands/create/template-generators/*` でテンプレートをコピーする際、ルート `package.json` へのスクリプト追加や `pnpm-workspace.yaml` の更新が必要か確認。
   - モノレポ構造（`apps/*`, `packages/*`）を前提とし、生成直後に全アプリがワークスペースとして認識されることを保証。

4. **テスト方針**
   - 単体テスト：生成後の `package.json` / `pnpm-workspace.yaml` に期待するエントリが存在するかを検証。
   - 統合テスト：テンプレート生成 → ルートで `pnpm web:dev --help` 等を実行し、正しいコマンドが呼ばれるか（モック or スナップショット）。
   - 手動検証：実際に `pnpm web:dev`, `pnpm web:env:encrypt` などを実行して挙動確認。

5. **ドキュメント更新**
   - `templates/nextjs-fullstack-admin/README.md` やルート README に「ルートからの操作例」を追記。
   - `pnpm run` コマンド一覧を表形式で整理し、開発者が迷わないようにする。

## TODO / 未確定事項
- [ ] 将来的に追加予定のアプリ（Expo / Backend）のディレクトリ名・スクリプト名を確定。
- [ ] ルートスクリプトの命名規則（`web:*`, `expo:*`, `backend:*` など）を統一。
- [ ] `pnpm --filter` のバージョン互換性確認（必要なら `pnpm >= x.x.x` を明記）。
- [ ] 各アプリ固有の `.env` / `scripts/` がルートから呼び出しても問題ないか検証（カレントディレクトリ依存部の見直し）。

## リスク / 懸念
- スクリプト名増加により `package.json` が煩雑になる → 説明付きで一覧化し、プレフィックスを統一。
- `pnpm --filter` はパッケージ名ベースでフィルタするため、`apps/web` の `package.json` name が適切に設定されている必要がある。
- ルートからの実行時にファイルパスが崩れる場合がある → スクリプト内で `path.resolve` を活用する。

## 次のステップ
1. TODO の内容を整理し、対応方針を確定。
2. 計画レビュー → 問題なければ `[ STATUS:READY ]` へ変更。
3. 既存テンプレートの `package.json` / スクリプト整備、ドキュメント更新、動作確認を実施。
