# データベース自動生成および環境プロビジョニング

[ STATUS:READY ]

## 実装フェーズ
**Phase 1**: DB作成ユーティリティとプロンプト実装 (週1-2)
**Phase 2**: テンプレート統合とCI処理 (週3-4)
**Phase 3**: テスト・ドキュメント整備 (週5)

## 目的
- Fluorite Flake で Next.js プロジェクトを生成する際、Turso / Supabase のデータベースを自動的に用意し、 `.env.*` へ接続設定を自動投入する。
- 新規作成と既存データベース利用を選択可能にし、どちらの場合でも初期化～マイグレーション～シードまで一気通貫で完了させる。
- CI / Vercel デプロイ時に適切な DB セットアップが走るよう、テンプレートに付属するスクリプト群を整備する。

## ゴール
1. プロジェクト生成フローに「DB 作成モード」（新規 / 既存）が追加され、必要な情報をプロンプトで収集できる。
2. 選択された DB タイプに応じて `dev / staging / prod` それぞれの DB を作成し、パスワード（またはトークン）を発行・更新する。
3. `.env`, `.env.development`, `.env.staging`, `.env.prod` へ接続情報が自動記入され、ローカル開発・Vercel デプロイの両方で即利用可能。
4. `pnpm db:generate`, `pnpm db:reset`, `pnpm db:migrate` を含むセットアップスクリプトが、Turso / Supabase どちらでも正常に動作する。
5. `scripts/ci-db.sh` 相当の CI 処理がテンプレートに含まれ、自動ビルド時に環境ごとのマイグレーション方針（dev: 完全再作成 / staging・prod: 条件付きシード）を実行できる。

## スコープ
- プロジェクト生成コマンド (`create` / `new`) の改善（プロンプト追加、環境ファイル生成、DB 作成処理）。
- `templates/nextjs-fullstack-admin` のスクリプト整備（DB 初期化、CI 処理、補助ユーティリティ）。
- Turso CLI / Supabase CLI ラッパーの拡張（DB 作成、パスワード再生、既存 DB 列挙、ステータス確認）。
- README / テンプレートドキュメントの更新。

## アウトオブスコープ
- 他データベース（PlanetScale・Neon など）への拡張。
- 既存プロジェクトへの後付けマイグレーション手順提供。
- デプロイ後の監視・アラート等の運用機能。

## 前提・依存
- Turso CLI / Supabase CLI がローカル環境で認証済みであること（必要時にガイドを表示）。
- `src/utils/turso-cli`, `src/utils/supabase-cli` が既に存在し、基本的なコマンド実行機能を備えている。
- plan 0010（Vercel 連携）と連携して `.env.*` 内容が重複しないよう調整する必要がある。

## 詳細設計

### 1. プロジェクト生成フロー拡張

#### 1.1 新プロンプト実装 (`src/commands/create/database-provisioning/`)
```typescript
// src/commands/create/database-provisioning/types.ts
export interface DatabaseProvisioningConfig {
    provider: 'turso' | 'supabase';
    mode: 'create' | 'existing';
    naming: {
        dev: string;
        staging: string;
        prod: string;
    };
    options: {
        preserveData: boolean;
        autoMigrate: boolean;
        skipProvisioning: boolean;
    };
}

// src/commands/create/database-provisioning/prompts.ts
export async function collectDatabaseConfig(
    projectName: string,
    existingProvider?: 'turso' | 'supabase'
): Promise<DatabaseProvisioningConfig>
```

#### 1.2 プロンプトフロー設計
```
1. DB プロバイダ選択 (既存 database オプションと統合)
   ┌─ Turso → 認証チェック → 既存DB一覧取得
   └─ Supabase → 認証チェック → 既存プロジェクト一覧取得

2. 作成モード選択
   ┌─ 新規作成 → 命名設定 (project-dev/stg/prod)
   └─ 既存利用 → 一覧から選択 + データ保持設定

3. 詳細オプション
   ├─ 自動マイグレーション有効化 (default: true)
   ├─ データ保持設定 (既存のみ, default: false)
   └─ プロビジョニングスキップ (--no-db-provision)
```

#### 1.3 GenerationContext拡張
```typescript
// src/commands/create/types.ts に追加
export interface GenerationContext {
    // 既存フィールド...
    databaseConfig?: DatabaseProvisioningConfig;
    databaseCredentials?: {
        urls: Record<'dev' | 'staging' | 'prod', string>;
        tokens: Record<'dev' | 'staging' | 'prod', string>;
    };
}
```

### 2. DB プロビジョニングユーティリティ拡張

#### 2.1 Turso CLI 拡張 (`src/utils/turso-cli/provisioning.ts`)
```typescript
// 既存機能活用: listDatabases, createDatabase, createDatabaseToken
export interface TursoProvisioningOptions {
    projectName: string;
    environments: ('dev' | 'staging' | 'prod')[];
    preserveExisting: boolean;
    location?: string;
}

export async function provisionTursoDatabases(
    options: TursoProvisioningOptions
): Promise<TursoProvisioningResult> {
    // 1. 認証チェック (既存: isAuthenticated)
    // 2. 既存DB確認 (既存: listDatabases)
    // 3. 必要に応じてDB作成 (既存: createDatabase)
    // 4. トークン生成 (既存: createDatabaseToken)
    // 5. 接続URL取得 (既存: getDatabaseUrl)
}

export async function validateTursoNaming(
    projectName: string
): Promise<{ dev: string; staging: string; prod: string }> {
    // 命名規則: {project-name}-{env} または {project-name} (prod用)
    // Turso制約: 3-32文字、英数字・ハイフンのみ
}
```

#### 2.2 Supabase CLI 拡張 (`src/utils/supabase-cli/provisioning.ts`)
```typescript
// 既存機能活用: listProjects, createProject, getApiKeys
export interface SupabaseProvisioningOptions {
    projectName: string;
    environments: ('dev' | 'staging' | 'prod')[];
    organization?: string;
    region?: string;
    plan?: 'free' | 'pro';
}

export async function provisionSupabaseProjects(
    options: SupabaseProvisioningOptions
): Promise<SupabaseProvisioningResult> {
    // 1. 認証チェック (既存: isAuthenticated)
    // 2. 組織一覧取得・選択
    // 3. 既存プロジェクト確認 (既存: listProjects)
    // 4. 必要に応じてプロジェクト作成 (既存: createProject)
    // 5. APIキー取得 (既存: getApiKeys)
    // 6. 接続URL構築
}

export async function validateSupabaseNaming(
    projectName: string
): Promise<{ dev: string; staging: string; prod: string }> {
    // 命名規則: {project-name}-{env}
    // Supabase制約: 1-63文字、英数字・ハイフンのみ、英字開始
}
```

#### 2.3 統合プロビジョニングサービス (`src/utils/database-provisioning/`)
```typescript
export class DatabaseProvisioningService {
    async provision(config: DatabaseProvisioningConfig): Promise<DatabaseCredentials> {
        // プロバイダ別処理の統合
        // 並行処理でのDB作成 (dev/staging/prod)
        // エラーハンドリングとロールバック
        // 進捗表示とユーザーフィードバック
    }

    async validateCredentials(credentials: DatabaseCredentials): Promise<ValidationResult> {
        // 作成されたDBへの接続テスト
        // 権限確認
        // マイグレーション実行可能性チェック
    }
}
```

### 3. 環境ファイル生成ロジック強化

#### 3.1 既存 `buildEnvReplacements` の拡張
```typescript
// templates/nextjs-fullstack-admin.ts の改修
interface EnvGenerationConfig {
    databaseConfig: DatabaseProvisioningConfig;
    credentials: DatabaseCredentials;
    projectName: string;
}

function buildEnvReplacements(config: EnvGenerationConfig): Record<string, string> {
    // 既存のプレースホルダー置換を実際の値で実行
    // Turso: dev=file:./dev.db, staging/prod=libsql://...
    // Supabase: postgresql://... + service role keys
}
```

#### 3.2 セキュアな認証情報管理
```typescript
// src/utils/credential-manager/
export class CredentialManager {
    // トークン・パスワードの安全な取り扱い
    async storeCredentials(envFile: string, credentials: Record<string, string>): Promise<void> {
        // 1. 既存ファイルのバックアップ
        // 2. プレースホルダー置換
        // 3. ファイル権限設定 (600)
        // 4. .gitignore確認・更新
    }

    async validateEnvFiles(directory: string): Promise<ValidationResult> {
        // 必要な環境変数の存在確認
        // 値の妥当性チェック（URL形式、トークン長等）
        // セキュリティリスク検出
    }
}
```

#### 3.3 環境別設定戦略
```
.env                 → ローカル開発用 (file:./dev.db)
.env.development     → Vercel Development環境用 (実際のDB接続)
.env.staging         → Vercel Preview環境用 (staging DB)
.env.prod           → Vercel Production環境用 (production DB)
```

### 4. CI/ビルドスクリプト整備

#### 4.1 TypeScript化されたCIスクリプト (`templates/nextjs-fullstack-admin/scripts/ci-db.ts`)
```typescript
#!/usr/bin/env tsx
/**
 * 環境に応じたデータベース初期化スクリプト
 * Vercelデプロイ時に実行され、環境変数に基づき適切なDB操作を実行
 */

interface CiDbOptions {
    environment: 'development' | 'staging' | 'production';
    force?: boolean;
    skipSeed?: boolean;
}

export async function runCiDatabase(options: CiDbOptions): Promise<void> {
    const { environment, force, skipSeed } = options;

    // 1. 環境変数検証
    await validateDatabaseEnvironment(environment);

    // 2. 環境別ストラテジー実行
    switch (environment) {
        case 'development':
            await runDevelopmentStrategy(force, skipSeed);
            break;
        case 'staging':
        case 'production':
            await runProductionStrategy(environment, force, skipSeed);
            break;
    }
}

async function runDevelopmentStrategy(force?: boolean, skipSeed?: boolean): Promise<void> {
    // 開発環境: 常に強制リセット
    await execCommand('pnpm', ['db:push', '--force-reset']);
    if (!skipSeed) {
        await execCommand('tsx', ['prisma/seed.ts']);
    }
}

async function runProductionStrategy(
    env: 'staging' | 'production',
    force?: boolean,
    skipSeed?: boolean
): Promise<void> {
    // ステージング・本番: データ存在チェック
    const hasData = await checkExistingData();

    if (!hasData || force) {
        await execCommand('pnpm', ['db:push', '--force-reset']);
        if (!skipSeed) {
            await execCommand('tsx', ['prisma/seed.ts']);
        }
    } else {
        await execCommand('pnpm', ['db:migrate', 'deploy']);
    }
}
```

#### 4.2 package.json統合
```json
{
  "scripts": {
    "build": "npm run ci:db && next build",
    "ci:db": "tsx scripts/ci-db.ts",
    "ci:db:force": "tsx scripts/ci-db.ts --force",
    "ci:db:no-seed": "tsx scripts/ci-db.ts --skip-seed"
  }
}
```

#### 4.3 Vercel設定統合
```json
// vercel.json
{
  "buildCommand": "pnpm ci:db && pnpm build",
  "env": {
    "NODE_ENV": "production"
  }
}
```

5. **Supabase ローカル開発サポート**
   - `README` に `supabase start` の利用手順、停止方法、環境変数のコピー方法を記載。
   - 生成時に `supabase/migrations` 等を含めるかを検討し、必要であればテンプレートへ追加。

## テスト戦略

### 6.1 単体テスト (`test/unit/database-provisioning/`)
```typescript
// プロンプトロジックのテスト
describe('DatabaseProvisioningPrompts', () => {
    test('should filter existing databases by naming convention', async () => {
        // モックDBリスト
        const mockDatabases = ['myapp-dev', 'myapp-staging', 'other-db'];
        const result = await filterCompatibleDatabases(mockDatabases, 'myapp');
        expect(result).toEqual(['myapp-dev', 'myapp-staging']);
    });

    test('should validate database naming constraints', async () => {
        // Turso: 3-32文字、英数字・ハイフン
        // Supabase: 1-63文字、英数字・ハイフン、英字開始
    });
});

// CLI ラッパーのモックテスト
describe('TursoProvisioningService', () => {
    beforeEach(() => {
        // CLIコマンドのモック設定
        vi.mock('../../../src/utils/turso-cli/executor.js');
    });

    test('should create databases in parallel', async () => {
        // 並行処理のテスト
        // エラーハンドリングのテスト
        // タイムアウト処理のテスト
    });
});
```

### 6.2 統合テスト (`test/integration/database-provisioning/`)
```typescript
// E2Eフローテスト（モックCLI使用）
describe('Database Provisioning Integration', () => {
    test('新規作成フロー: 完全なプロビジョニング', async () => {
        // 1. モックCLI応答設定
        mockTursoCommands({
            listDatabases: [],
            createDatabase: { success: true },
            createDatabaseToken: { token: 'mock-token' }
        });

        // 2. プロジェクト生成実行
        const result = await generateProject({
            name: 'test-app',
            template: 'nextjs-fullstack-admin',
            database: 'turso',
            databaseConfig: {
                mode: 'create',
                environments: ['dev', 'staging', 'prod']
            }
        });

        // 3. 検証
        expect(result.success).toBe(true);
        expect(existsSync(path.join(result.directory, '.env.development'))).toBe(true);

        // 4. 環境ファイル内容確認
        const envContent = await readFile(path.join(result.directory, '.env.development'), 'utf-8');
        expect(envContent).toContain('TURSO_DATABASE_URL=libsql://test-app-dev');
        expect(envContent).toContain('TURSO_AUTH_TOKEN=mock-token');
    });

    test('既存利用フロー: データベース選択とマッピング', async () => {
        // 既存DBを使用する場合のテスト
    });

    test('エラーケース: 認証失敗時の処理', async () => {
        // 認証エラーのハンドリング
        // リトライロジック
        // ユーザーガイダンス
    });
});
```

### 6.3 パフォーマンステスト
```typescript
describe('Performance Tests', () => {
    test('並行DB作成のパフォーマンス', async () => {
        // 3環境同時作成が逐次作成より高速
        // メモリ使用量の監視
        // ネットワーク負荷の確認
    });

    test('大量プロジェクト生成時のメモリリーク検出', async () => {
        // 連続生成でのメモリ使用量監視
        // 一時ファイルのクリーンアップ確認
    });
});
```

### 6.4 手動検証チェックリスト
```markdown
## 手動検証項目

### 基本フロー
- [ ] Turso新規作成: プロジェクト生成 → `pnpm dev` → DB接続確認
- [ ] Supabase新規作成: プロジェクト生成 → `pnpm dev` → DB接続確認
- [ ] 既存DB利用: 既存DBを選択 → 環境ファイル生成確認

### エラーハンドリング
- [ ] 未認証状態でのガイダンス表示
- [ ] ネットワークエラー時のリトライ処理
- [ ] 権限不足エラーの適切なメッセージ表示

### セキュリティ
- [ ] 環境ファイルの権限設定 (600)
- [ ] .gitignoreへの自動追加
- [ ] 一時ファイルの適切なクリーンアップ

### パフォーマンス
- [ ] 並行処理による高速化効果測定
- [ ] メモリ使用量の妥当性確認
- [ ] 大量ファイル生成時の安定性
```

7. **ドキュメント更新**
   - `templates/nextjs-fullstack-admin/README.md` にデータベース自動生成フローとコマンド一覧 (`pnpm db:*`, `pnpm env:*`) を追記。
   - ルート `README.md` や `docs/` に「前提として CLI 認証が必要な項目」をまとめる。

## セキュリティ・パフォーマンス考慮事項

### 5.1 セキュリティ対策
```typescript
// セキュアな認証情報管理
export class SecureCredentialHandler {
    // 1. 認証情報の暗号化保存
    async encryptAndStore(credentials: DatabaseCredentials): Promise<string> {
        // Node.js crypto モジュールを使用
        // ユーザー固有キーでの暗号化
        // 一時ファイルの安全な削除
    }

    // 2. 環境変数検証
    async validateEnvironmentSecurity(envPath: string): Promise<SecurityReport> {
        // .gitignore への追加確認
        // ファイル権限チェック (600推奨)
        // 機密情報の露出検出
        // プレーンテキストトークンの警告
    }

    // 3. クリーンアップ処理
    async cleanup(temporaryFiles: string[]): Promise<void> {
        // 一時ファイルの安全な削除
        // メモリからの認証情報クリア
        // ログファイルのサニタイズ
    }
}
```

### 5.2 パフォーマンス最適化
```typescript
// 並行処理での DB 作成
export class ConcurrentDatabaseProvisioning {
    async provisionInParallel(
        environments: ('dev' | 'staging' | 'prod')[],
        options: ProvisioningOptions
    ): Promise<ProvisioningResult[]> {
        // Promise.allSettled で並行実行
        // 失敗時の部分ロールバック
        // 進捗表示の統合
        // レート制限の考慮
    }

    // キャッシュ戦略
    private cache = new Map<string, DatabaseInfo>();

    async getCachedDatabaseList(provider: 'turso' | 'supabase'): Promise<DatabaseInfo[]> {
        // 5分間のキャッシュ
        // バックグラウンド更新
        // 認証エラー時のキャッシュクリア
    }
}
```

### 5.3 エラーハンドリング戦略
```typescript
export class DatabaseProvisioningErrorHandler {
    async handleProvisioningError(
        error: DatabaseProvisioningError,
        context: ProvisioningContext
    ): Promise<ErrorRecoveryResult> {
        switch (error.type) {
            case 'AUTHENTICATION_FAILED':
                return await this.handleAuthError(error, context);
            case 'QUOTA_EXCEEDED':
                return await this.handleQuotaError(error, context);
            case 'NETWORK_ERROR':
                return await this.handleNetworkError(error, context);
            case 'NAMING_CONFLICT':
                return await this.handleNamingConflict(error, context);
            default:
                return await this.handleUnknownError(error, context);
        }
    }

    // リトライ戦略
    async executeWithRetry<T>(
        operation: () => Promise<T>,
        options: RetryOptions = {}
    ): Promise<T> {
        // 指数バックオフ
        // 最大試行回数制限
        // ユーザーへの進捗通知
    }
}
```

## リスク / 懸念
- ユーザーが Turso / Supabase CLI にログインしていない場合、生成処理が失敗する → 事前チェックとリトライガイドが必要。
- 既存 DB のパスワード再生成に伴い、既存アプリからの接続が切れる可能性 → 注意書きや選択肢で明示。
- Supabase ローカル起動は重い（Docker 必須）。自動起動する場合はドキュメントで前提条件を強調する。

## 実装計画と解決済み課題

### 解決済みTODO項目

#### ✅ 既存DBセットの命名規則チェック
**実装方針**: `validateTursoNaming` / `validateSupabaseNaming` 関数で厳密チェック
- Turso: `{project-name}-{env}` 形式、3-32文字制限
- Supabase: `{project-name}-{env}` 形式、1-63文字制限、英字開始
- 不適合な場合は自動修正提案またはユーザー編集

#### ✅ Supabase CLI環境変数自動取得
**実装方針**: 既存 `getApiKeys` 関数を活用
```typescript
// 実装済み: src/utils/supabase-cli/projects.ts
export async function getApiKeys(projectRef: string): Promise<ApiKeys>
```
- プロジェクト作成後に `getApiKeys` で自動取得
- URL構築: `https://{project-ref}.supabase.co`

#### ✅ Tursoパスワード再生成の安全手順
**実装方針**: `createDatabaseToken` を活用した安全な更新
```typescript
// 実装済み: src/utils/turso-cli/database.ts
export async function createDatabaseToken(database: string, options?: DatabaseTokenOptions): Promise<DatabaseToken>
```
- 新トークン発行 → 環境ファイル更新 → 旧トークン無効化の順序
- ユーザーへの影響警告と確認プロンプト

#### ✅ CIスクリプトTypeScript化ビルドステップ
**実装方針**: `tsx` による直接実行
- `package.json` に `tsx` 依存関係追加済み（テンプレート内）
- `#!/usr/bin/env tsx` によるシバン実行
- Vercel等でのビルド時に自動実行

#### ✅ DB作成スキップモード (--no-db-provision)
**実装方針**: プロンプト内でのオプション提供
```typescript
interface DatabaseProvisioningConfig {
    options: {
        skipProvisioning: boolean; // CLI flag またはプロンプト選択
    };
}
```

### マイルストーン

#### Phase 1: DB作成ユーティリティ (週1-2)
- [ ] `src/commands/create/database-provisioning/` 実装
- [ ] Turso/Supabase プロビジョニングサービス
- [ ] プロンプトフロー統合

#### Phase 2: テンプレート統合とCI (週3-4)
- [ ] `generateFullStackAdmin` にDB作成統合
- [ ] `ci-db.ts` スクリプト実装
- [ ] 環境ファイル生成ロジック改修

#### Phase 3: テスト・ドキュメント (週5)
- [ ] 単体・統合テスト実装
- [ ] ドキュメント更新
- [ ] 手動検証完了

### 次のアクション
1. ✅ **計画書詳細化完了**: 実装可能レベルの詳細設計完成
2. ✅ **STATUS:READY**: 実装開始準備完了
3. **実装開始**: Phase 1から順次開発着手
4. **連携調整**: plan 0010（Vercel連携）との統合作業並行実施
