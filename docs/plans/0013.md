# デプロイ環境クリーンアップ自動化

[ STATUS:PLANNING ]

## 目的

- Fluorite Flake 生成プロジェクトで利用中の Vercel プロジェクト / Turso Cloud または Supabase データベース / Vercel Blob ストアを、1 回の CLI 操作で安全に削除できるようにする。
- 不要になった環境リソースの整理を簡単にし、費用やリソース消費を抑える。

## ゴール

1. `pnpm cleanup:deploy`（仮称）のようなコマンドを用意し、プロンプトに従うだけで全リソース削除 or 部分削除が選べる。
2. 削除前に確認メッセージや確認文字列（例: `delete <project-slug> project`）を入力させ、誤操作を防止する。
3. 削除対象は以下を想定：
   - Vercel プロジェクト（本番／プレビュー環境含む）
   - Turso DB セット（dev/stg/prod）または Supabase プロジェクト（dev/stg/prod）
   - Vercel Blob ストア
4. 実行結果をログ出力し、何が削除されたかをユーザーが確認できる。

## スコープ

- プロジェクトテンプレートにクリーンアップスクリプト（TypeScript or Node スクリプト）を追加。
- `src/utils/vercel-cli`, `src/utils/turso-cli`, `src/utils/supabase-cli` に削除関連の API を追加（リソース ID 取得、削除リクエスト）。
- `package.json` に cleanup 用スクリプトを追加し、README へ手順を記載。

## アウトオブスコープ

- 個別リソースのバックアップ・エクスポート機能（ユーザーに事前バックアップを促す）。
- Vercel 以外のホスティング・DB・ストレージへの対応。

## 詳細設計案

1. **コマンド設計**
   - `pnpm cleanup:deploy` 実行 → CLI プロンプトを順に表示：
     1. 削除対象確認（Vercel プロジェクト / DB / Blob）をチェックボックス形式で選択。
     2. 全削除を選択した場合も個別に OFF にできるようにする。
     3. 最終確認として特定の文字列（例: `delete <project-slug> all`）を入力させる。

2. **ユーティリティ API**
   - Vercel:
     - `deleteProject(projectId)`
     - `listProjects()`（必要であれば）
   - Turso:
     - `deleteDatabase(name)`、必要に応じて dev/stg/prod まとめて削除する処理。
   - Supabase:
     - `deleteProject(projectId)` または dev/stg/prod を判別して削除。
   - Blob:
     - `deleteBlobStore(storeId)`
   - いずれもラッパーの戻り値（成功/失敗）を統一し、ログ出力しやすくする。

3. **実装フロー（例）**
   - `.env` などからプロジェクト名・DB 名・Blob Store ID 等を取得。
   - 削除対象を CLI プロンプトで決定。
   - 確認文字列入力で最終承認。
   - 選択されたターゲットについて順次削除：
     - Turso / Supabase → `deleteDatabase`
     - Blob → `deleteBlobStore`
     - Vercel → `deleteProject`
   - 削除結果を一覧表示し、削除成功 / 失敗をユーザーへ通知。

4. **エラーハンドリング / 安全策**
   - 認証エラー（CLI 未ログイン）やリソース未存在時は詳細なメッセージで中断。
   - 削除処理は idempotent を心掛け、存在しないものは警告に留める。
   - 利用者へ事前バックアップを促す文言を表示。

5. **テスト方針**
   - ユニットテスト：各 CLI ラッパーの `delete*` 関数モック。
   - 統合テスト（モックベース）：
     - パラメータが `.env` から適切に読み取られるか。
     - 削除対象選択 → 確認文字列が一致 → 仮想削除 API 呼び出しが行われるか。
   - E2E（任意）：テスト用プロジェクトで実際に Vercel / Turso / Supabase リソースを作成し、削除まで通す。

6. **ドキュメント更新**
   - テンプレート README にクリーンアップ手順を追記。
   - ルート README にも「不要になったら `pnpm cleanup:deploy`」を案内。

## TODO / 要確認事項

- [ ] `.env` から利用するキー（プロジェクト ID、DB 名、Blob Store ID）の命名や保存場所を統一する。
- [ ] Supabase DB の dev/stg/prod 分離方法を確認（プロジェクトを複数作成したのか、1 プロジェクト内に複数 DB があるのか）。
- [ ] 削除コマンドの API/CLI の挙動を事前検証（特に Vercel CLI でプロジェクト削除が安定して動くか）。
- [ ] ログ出力形式（JSON or テキスト）を決めて、Script 実行後の記録を残しやすくする。

## リスク / 懸念

- 誤削除の危険性 → 確認文字列＋対象リスト表示で対策。
- CLI 認証切れや権限不足で削除できない → エラー時に再ログイン案内。
- 複数ユーザーで同じリソースを共有している場合の調整 → ドキュメントで注意を喚起。

## 次のステップ

1. TODO の調査結果を反映し計画を精緻化。
2. 問題なければ `[ STATUS:READY ]` へ変更し、実装に着手。
3. 実装後、テスト用リソースを作成 → クリーンアップで削除できることを確認。
