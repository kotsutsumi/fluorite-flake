# 07. デプロイメントとサービス統合

このドキュメントでは、fluorite-flakeプロジェクトのデプロイメント機能とサービス統合アーキテクチャについて詳しく説明します。マルチ環境デプロイメント、サービスアダプター、監視機能の設計と実装を包括的に解説します。

## 目次

1. [デプロイメント概要](#デプロイメント概要)
2. [マルチ環境アーキテクチャ](#マルチ環境アーキテクチャ)
3. [サービスアダプターシステム](#サービスアダプターシステム)
4. [デプロイメント自動化](#デプロイメント自動化)
5. [環境変数管理](#環境変数管理)
6. [監視と分析](#監視と分析)
7. [トラブルシューティング](#トラブルシューティング)
8. [ベストプラクティス](#ベストプラクティス)

## デプロイメント概要

### 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Fluorite Deployment System                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │   Development   │    │     Staging     │    │   Production    │         │
│  │   Environment   │    │   Environment   │    │   Environment   │         │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘         │
│           │                       │                       │                │
│           ▼                       ▼                       ▼                │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │     Vercel      │    │     Vercel      │    │     Vercel      │         │
│  │   dev.app.com   │    │   stg.app.com   │    │    app.com      │         │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘         │
│           │                       │                       │                │
│           └───────────────────────┼───────────────────────┘                │
│                                   │                                        │
│                   ┌───────────────▼───────────────┐                        │
│                   │         Service Mesh          │                        │
│                   │   ┌─────────┬─────────────┐   │                        │
│                   │   │Database │   Storage   │   │                        │
│                   │   │  Layer  │    Layer    │   │                        │
│                   │   └─────────┴─────────────┘   │                        │
│                   └───────────────────────────────┘                        │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                            Service Adapters                                │
│                                                                             │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │
│  │ Vercel  │ │Supabase │ │  Turso  │ │   AWS   │ │ GitHub  │ │Cloudflare│ │
│  │Adapter  │ │Adapter  │ │Adapter  │ │Adapter  │ │Adapter  │ │ Adapter │  │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘  │
│      │           │           │           │           │           │        │
│      └───────────┼───────────┼───────────┼───────────┼───────────┘        │
│                  │           │           │           │                    │
│                  ▼           ▼           ▼           ▼                    │
│           ┌─────────────────────────────────────────────────┐              │
│           │            Unified Dashboard                    │              │
│           │    Real-time Monitoring & Management           │              │
│           └─────────────────────────────────────────────────┘              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### デプロイメント戦略

fluorite-flakeは以下のデプロイメント戦略を採用しています：

1. **マルチ環境対応**: Development、Staging、Production環境の自動セットアップ
2. **サービス統合**: 複数のクラウドサービスの統一管理
3. **自動化重視**: スクリプトベースの完全自動化デプロイメント
4. **監視統合**: リアルタイムダッシュボードによる状態監視

## マルチ環境アーキテクチャ

### 環境構成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       Multi-Environment Architecture                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐        │
│ │   Development   │     │     Staging     │     │   Production    │        │
│ ├─────────────────┤     ├─────────────────┤     ├─────────────────┤        │
│ │                 │     │                 │     │                 │        │
│ │ ┌─────────────┐ │     │ ┌─────────────┐ │     │ ┌─────────────┐ │        │
│ │ │   Vercel    │ │     │ │   Vercel    │ │     │ │   Vercel    │ │        │
│ │ │  Preview    │ │     │ │  Preview    │ │     │ │ Production  │ │        │
│ │ └─────────────┘ │     │ └─────────────┘ │     │ └─────────────┘ │        │
│ │                 │     │                 │     │                 │        │
│ │ ┌─────────────┐ │     │ ┌─────────────┐ │     │ ┌─────────────┐ │        │
│ │ │ Database    │ │     │ │ Database    │ │     │ │ Database    │ │        │
│ │ │  dev_db     │ │     │ │  stg_db     │ │     │ │  prod_db    │ │        │
│ │ └─────────────┘ │     │ └─────────────┘ │     │ └─────────────┘ │        │
│ │                 │     │                 │     │                 │        │
│ │ ┌─────────────┐ │     │ ┌─────────────┐ │     │ ┌─────────────┐ │        │
│ │ │  Storage    │ │     │ │  Storage    │ │     │ │  Storage    │ │        │
│ │ │   dev_s3    │ │     │ │   stg_s3    │ │     │ │  prod_s3    │ │        │
│ │ └─────────────┘ │     │ └─────────────┘ │     │ └─────────────┘ │        │
│ │                 │     │                 │     │                 │        │
│ │ ENV Variables:  │     │ ENV Variables:  │     │ ENV Variables:  │        │
│ │ • .env.development │  │ • .env.staging    │  │ • .env.production │     │
│ │ • Branch: dev     │     │ • Branch: staging │     │ • Branch: main    │     │
│ │ • URL: *-dev.app  │     │ • URL: *-stg.app  │     │ • URL: app.com    │     │
│ └─────────────────┘     └─────────────────┘     └─────────────────┘        │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                            Deployment Flow                                 │
│                                                                             │
│     Development           Staging              Production                   │
│         │                   │                     │                        │
│         ▼                   ▼                     ▼                        │
│ ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                   │
│ │   Commit    │────▶│   PR Test   │────▶│   Deploy    │                   │
│ │   to dev    │     │  to staging │     │ to production│                   │
│ └─────────────┘     └─────────────┘     └─────────────┘                   │
│         │                   │                     │                        │
│         ▼                   ▼                     ▼                        │
│ ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                   │
│ │ Auto Deploy │     │ Auto Deploy │     │Manual Approve│                   │
│ │   + Test    │     │   + Test    │     │   + Deploy   │                   │
│ └─────────────┘     └─────────────┘     └─────────────┘                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### デプロイメント設定

#### Vercel設定（vercel.json）

```json
{
  "buildCommand": "pnpm run build",
  "devCommand": "pnpm run dev",
  "installCommand": "pnpm install",
  "framework": "nextjs",
  "outputDirectory": ".next",
  "env": {
    "NODE_ENV": "production",
    "TURSO_DATABASE_URL": "@turso_database_url",
    "TURSO_AUTH_TOKEN": "@turso_auth_token",
    "DATABASE_URL": "@database_url"
  },
  "envFilesystem": [
    ".env.production",
    ".env.staging",
    ".env.development"
  ]
}
```

#### package.jsonスクリプト

```json
{
  "scripts": {
    "deploy": "vercel",
    "deploy:prod": "vercel --prod",
    "deploy:staging": "vercel --preview",
    "deploy:dev": "vercel --preview",
    "deploy:setup": "bash scripts/setup-deployment.sh",
    "deploy:setup:prod": "bash scripts/setup-deployment.sh prod",
    "deploy:setup:staging": "bash scripts/setup-deployment.sh staging",
    "deploy:setup:dev": "bash scripts/setup-deployment.sh dev",
    "deploy:auto": "bash scripts/automated-deployment.sh",
    "deploy:destroy": "tsx scripts/destroy-deployment.ts",
    "env:pull": "vercel env pull",
    "env:pull:prod": "vercel env pull --environment=production",
    "env:pull:staging": "vercel env pull --environment=preview --git-branch=staging",
    "env:pull:dev": "vercel env pull --environment=preview --git-branch=development"
  }
}
```

## サービスアダプターシステム

### ベースアダプターインターフェース

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Service Adapter Architecture                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │                      BaseServiceAdapter                                │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │                                                                         │ │
│ │  Core Interface:                                                        │ │
│ │  • initialize(config)    - アダプター初期化                             │ │
│ │  • authenticate(auth)    - 認証処理                                     │ │
│ │  • connect()            - サービス接続                                  │ │
│ │  • disconnect()         - サービス切断                                  │ │
│ │  • healthCheck()        - ヘルスチェック                                │ │
│ │                                                                         │ │
│ │  Data Operations:                                                       │ │
│ │  • getDashboardData()   - ダッシュボードデータ取得                       │ │
│ │  • getMetrics()         - メトリクス取得                                │ │
│ │  • getLogs()           - ログデータ取得                                 │ │
│ │                                                                         │ │
│ │  Resource Management:                                                   │ │
│ │  • listResources()      - リソース一覧                                  │ │
│ │  • getResource()        - リソース詳細                                  │ │
│ │  • executeAction()      - アクション実行                                │ │
│ │                                                                         │ │
│ │  Events:                                                                │ │
│ │  • subscribe()          - イベント購読                                  │ │
│ │  • unsubscribe()        - イベント解除                                  │ │
│ │                                                                         │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                     │                                       │
│                                     ▼                                       │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │                       Concrete Adapters                                │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │                                                                         │ │
│ │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │ │
│ │ │ Vercel   │ │Supabase  │ │  Turso   │ │   AWS    │ │ GitHub   │      │ │
│ │ │ Adapter  │ │ Adapter  │ │ Adapter  │ │ Adapter  │ │ Adapter  │      │ │
│ │ └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘      │ │
│ │     │           │           │           │           │                 │ │
│ │     ▼           ▼           ▼           ▼           ▼                 │ │
│ │ ┌─────────────────────────────────────────────────────────────────┐   │ │
│ │ │              Service-Specific Capabilities                     │   │ │
│ │ ├─────────────────────────────────────────────────────────────────┤   │ │
│ │ │                                                                 │   │ │
│ │ │ Vercel:        Supabase:      Turso:         AWS:              │   │ │
│ │ │ • Deployments  • Database     • Database     • S3 Storage      │   │ │
│ │ │ • Domains      • Auth         • Replication  • CloudWatch     │   │ │
│ │ │ • Analytics    • Storage      • Analytics    • IAM            │   │ │
│ │ │ • Functions    • Edge Func    • Backup       • Lambda         │   │ │
│ │ │                                                                 │   │ │
│ │ │ GitHub:        Cloudflare:                                      │   │ │
│ │ │ • Repositories • Workers                                        │   │ │
│ │ │ • Actions      • KV Storage                                     │   │ │
│ │ │ • Issues       • Analytics                                      │   │ │
│ │ │ • Releases     • DNS                                            │   │ │
│ │ │                                                                 │   │ │
│ │ └─────────────────────────────────────────────────────────────────┘   │ │
│ │                                                                         │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### アダプター実装パターン

#### Vercelアダプター例

```typescript
export class VercelAdapter extends BaseServiceAdapter {
    readonly name = 'vercel';
    readonly displayName = 'Vercel';
    readonly capabilities: ServiceCapabilities = {
        realTimeUpdates: true,
        logStreaming: true,
        metricsHistory: true,
        resourceManagement: true,
        multiProject: true,
        deployments: true,
        analytics: true,
        fileOperations: true,
        database: false,
        userManagement: false,
    };

    async getDashboardData(): Promise<ServiceDashboardData> {
        const [projects, deployments, domains] = await Promise.all([
            this.getProjects(),
            this.getDeployments(),
            this.getDomains(),
        ]);

        return {
            timestamp: Date.now(),
            projects,
            deployments,
            domains,
            summary: {
                totalProjects: projects.length,
                totalDeployments: deployments.length,
                totalDomains: domains.length,
                activeDeployments: deployments.filter(d => d.state === 'READY').length,
            },
        };
    }
}
```

### サービス統合フロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Service Integration Flow                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ 1. Project Generation                                                       │
│    ┌─────────────┐                                                          │
│    │   Create    │ ── Config ──▶ ┌─────────────────────────────────────┐    │
│    │  Project    │               │       Service Selection             │    │
│    └─────────────┘               │   ┌─────────┬─────────┬─────────┐   │    │
│            │                     │   │Database │ Storage │   Auth  │   │    │
│            ▼                     │   │  Type   │  Type   │  Type   │   │    │
│    ┌─────────────┐               │   └─────────┴─────────┴─────────┘   │    │
│    │  Generate   │               └─────────────────────────────────────┘    │
│    │ Templates   │                                                          │
│    └─────────────┘                                                          │
│            │                                                                │
│            ▼                                                                │
│                                                                             │
│ 2. Service Configuration                                                    │
│    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                     │
│    │  Database   │   │  Storage    │   │    Auth     │                     │
│    │    Setup    │   │   Setup     │   │   Setup     │                     │
│    └─────────────┘   └─────────────┘   └─────────────┘                     │
│            │                 │                 │                           │
│            └─────────────────┼─────────────────┘                           │
│                              │                                             │
│                              ▼                                             │
│    ┌─────────────────────────────────────────────────────────────────┐     │
│    │                Environment Variables                            │     │
│    │   ┌─────────────┬─────────────┬─────────────┬─────────────┐     │     │
│    │   │    Local    │     Dev     │   Staging   │ Production  │     │     │
│    │   │ .env.local  │ .env.dev    │ .env.stg    │ .env.prod   │     │     │
│    │   └─────────────┴─────────────┴─────────────┴─────────────┘     │     │
│    └─────────────────────────────────────────────────────────────────┘     │
│                              │                                             │
│                              ▼                                             │
│                                                                             │
│ 3. Deployment Setup                                                         │
│    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                     │
│    │   Vercel    │   │  Database   │   │  Monitoring │                     │
│    │    Link     │   │ Migration   │   │    Setup    │                     │
│    └─────────────┘   └─────────────┘   └─────────────┘                     │
│            │                 │                 │                           │
│            └─────────────────┼─────────────────┘                           │
│                              │                                             │
│                              ▼                                             │
│                                                                             │
│ 4. Dashboard Integration                                                    │
│    ┌─────────────────────────────────────────────────────────────────┐     │
│    │                   Service Adapters                             │     │
│    │   ┌─────────┬─────────┬─────────┬─────────┬─────────┐           │     │
│    │   │ Vercel  │Supabase │  Turso  │   AWS   │ GitHub  │           │     │
│    │   │Adapter  │Adapter  │Adapter  │Adapter  │Adapter  │           │     │
│    │   └─────────┴─────────┴─────────┴─────────┴─────────┘           │     │
│    └─────────────────────────────────────────────────────────────────┘     │
│                              │                                             │
│                              ▼                                             │
│    ┌─────────────────────────────────────────────────────────────────┐     │
│    │                Unified Dashboard                                │     │
│    │   ┌─────────────┬─────────────┬─────────────┐                   │     │
│    │   │   Status    │   Metrics   │    Logs     │                   │     │
│    │   │ Monitoring  │   Graphs    │  Streaming  │                   │     │
│    │   └─────────────┴─────────────┴─────────────┘                   │     │
│    └─────────────────────────────────────────────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## デプロイメント自動化

### 自動化スクリプト構成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       Deployment Automation Scripts                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │                    setup-deployment.sh                                 │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │                                                                         │ │
│ │ 1. Prerequisites Check                                                  │ │
│ │    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                 │ │
│ │    │ Vercel CLI  │   │    Auth     │   │   Project   │                 │ │
│ │    │   Check     │──▶│   Check     │──▶│    Link     │                 │ │
│ │    └─────────────┘   └─────────────┘   └─────────────┘                 │ │
│ │                                                                         │ │
│ │ 2. Environment Configuration                                            │ │
│ │    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                 │ │
│ │    │Environment  │   │   Env Vars  │   │   Branch    │                 │ │
│ │    │ Selection   │──▶│   Loading   │──▶│   Config    │                 │ │
│ │    └─────────────┘   └─────────────┘   └─────────────┘                 │ │
│ │                                                                         │ │
│ │ 3. Service Setup                                                        │ │
│ │    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                 │ │
│ │    │  Database   │   │   Storage   │   │   Aliases   │                 │ │
│ │    │ Migration   │──▶│   Setup     │──▶│   Config    │                 │ │
│ │    └─────────────┘   └─────────────┘   └─────────────┘                 │ │
│ │                                                                         │ │
│ │ 4. Deployment                                                           │ │
│ │    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                 │ │
│ │    │   Build     │   │   Deploy    │   │  Verify     │                 │ │
│ │    │  & Test     │──▶│  to Vercel  │──▶│ & Report    │                 │ │
│ │    └─────────────┘   └─────────────┘   └─────────────┘                 │ │
│ │                                                                         │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │                 automated-deployment.sh                                │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │                                                                         │ │
│ │ Full Stack Deployment:                                                  │ │
│ │                                                                         │ │
│ │ 1. Database Setup                                                       │ │
│ │    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                 │ │
│ │    │    Turso    │   │  Supabase   │   │   Schema    │                 │ │
│ │    │ Cloud DBs   │──▶│ Cloud DBs   │──▶│ Migration   │                 │ │
│ │    └─────────────┘   └─────────────┘   └─────────────┘                 │ │
│ │                                                                         │ │
│ │ 2. Multi-Environment Deploy                                             │ │
│ │    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                 │ │
│ │    │    Dev      │   │   Staging   │   │ Production  │                 │ │
│ │    │    ENV      │──▶│     ENV     │──▶│     ENV     │                 │ │
│ │    └─────────────┘   └─────────────┘   └─────────────┘                 │ │
│ │                                                                         │ │
│ │ 3. Verification & Report                                                │ │
│ │    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                 │ │
│ │    │   Health    │   │    URLs     │   │ Management  │                 │ │
│ │    │   Check     │──▶│   Report    │──▶│  Commands   │                 │ │
│ │    └─────────────┘   └─────────────┘   └─────────────┘                 │ │
│ │                                                                         │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │                 destroy-deployment.ts                                  │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │                                                                         │ │
│ │ Cleanup Operations:                                                     │ │
│ │                                                                         │ │
│ │ 1. Confirmation                                                         │ │
│ │    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                 │ │
│ │    │    User     │   │  Resource   │   │    Data     │                 │ │
│ │    │ Confirmation│──▶│   Analysis  │──▶│   Backup    │                 │ │
│ │    └─────────────┘   └─────────────┘   └─────────────┘                 │ │
│ │                                                                         │ │
│ │ 2. Safe Deletion                                                        │ │
│ │    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                 │ │
│ │    │   Vercel    │   │  Database   │   │   Storage   │                 │ │
│ │    │  Projects   │──▶│  Resources  │──▶│  Resources  │                 │ │
│ │    └─────────────┘   └─────────────┘   └─────────────┘                 │ │
│ │                                                                         │ │
│ │ 3. Verification                                                         │ │
│ │    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                 │ │
│ │    │  Deletion   │   │   Report    │   │    Logs     │                 │ │
│ │    │ Verification│──▶│  Generate   │──▶│   Archive   │                 │ │
│ │    └─────────────┘   └─────────────┘   └─────────────┘                 │ │
│ │                                                                         │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### スクリプト実行フロー

#### setup-deployment.sh の実行例

```bash
#!/usr/bin/env bash
set -e

PROJECT_NAME="my-app"
ENV=${1:-"prod"}

echo "🚀 Setting up Vercel deployment for $PROJECT_NAME ($ENV environment)..."

# 1. Prerequisites Check
if ! command -v vercel &> /dev/null; then
    echo "⚠️ Vercel CLI not found. Installing..."
    npm i -g vercel
fi

# 2. Authentication & Project Link
echo "📝 Checking Vercel authentication..."
if ! vercel whoami &> /dev/null; then
    echo "Logging in to Vercel..."
    vercel login
fi

if [ ! -f ".vercel/project.json" ]; then
    echo "🔗 Linking to Vercel project..."
    vercel link --yes
fi

# 3. Environment Setup
case $ENV in
    "prod"|"production")
        ENV_FILE=".env.production"
        ENV_FLAG="--environment=production"
        ;;
    "stg"|"staging")
        ENV_FILE=".env.staging"
        ENV_FLAG="--environment=preview --git-branch=staging"
        ;;
    "dev"|"development")
        ENV_FILE=".env.development"
        ENV_FLAG="--environment=preview --git-branch=development"
        ;;
esac

# 4. Environment Variables Upload
if [ -f "$ENV_FILE" ]; then
    echo "📄 Loading environment variables from $ENV_FILE..."
    while IFS= read -r line; do
        if [[ ! "$line" =~ ^# ]] && [[ -n "$line" ]]; then
            KEY=$(echo "$line" | cut -d '=' -f 1)
            VALUE=$(echo "$line" | cut -d '=' -f 2-)
            echo "   Setting $KEY..."
            echo "$VALUE" | vercel env add "$KEY" $ENV_FLAG --yes
        fi
    done < "$ENV_FILE"
fi

# 5. Database Migration (if applicable)
if [ "$ENV" == "prod" ] && [ -f "package.json" ]; then
    if grep -q "db:migrate:prod" package.json; then
        echo "🗄️ Running database migrations..."
        npm run db:migrate:prod
    fi
fi

# 6. Deploy
echo "🚀 Deploying to Vercel ($ENV)..."
if [ "$ENV" == "prod" ]; then
    vercel --prod
else
    DEPLOYMENT_URL=$(vercel --preview)
    echo "✅ Preview URL: $DEPLOYMENT_URL"
fi

echo "✅ Deployment setup complete!"
```

## 環境変数管理

### 環境変数構成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       Environment Variables Management                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │                        Local Development                                │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │                                                                         │ │
│ │ .env.local (Git ignored)                                                │ │
│ │ ┌─────────────────────────────────────────────────────────────────────┐ │ │
│ │ │ # Database                                                          │ │ │
│ │ │ DATABASE_URL="file:./dev.db"                                        │ │ │
│ │ │ TURSO_DATABASE_URL="http://localhost:8080"                          │ │ │
│ │ │ TURSO_AUTH_TOKEN="local-dev-token"                                  │ │ │
│ │ │                                                                     │ │ │
│ │ │ # Storage                                                           │ │ │
│ │ │ BLOB_READ_WRITE_TOKEN="local-blob-token"                            │ │ │
│ │ │ AWS_ACCESS_KEY_ID="minioadmin"                                      │ │ │
│ │ │ AWS_SECRET_ACCESS_KEY="minioadmin"                                  │ │ │
│ │ │ S3_ENDPOINT="http://localhost:9000"                                 │ │ │
│ │ │                                                                     │ │ │
│ │ │ # Authentication                                                    │ │ │
│ │ │ NEXTAUTH_SECRET="local-dev-secret"                                  │ │ │
│ │ │ NEXTAUTH_URL="http://localhost:3000"                                │ │ │
│ │ └─────────────────────────────────────────────────────────────────────┘ │ │
│ │                                                                         │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │                       Environment Templates                             │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │                                                                         │ │
│ │ .env.development                                                        │ │
│ │ ┌─────────────────────────────────────────────────────────────────────┐ │ │
│ │ │ NODE_ENV=development                                                │ │ │
│ │ │ DATABASE_URL="libsql://my-app-dev-db.turso.io"                     │ │ │
│ │ │ TURSO_AUTH_TOKEN="dev-auth-token"                                   │ │ │
│ │ │ NEXTAUTH_URL="https://my-app-dev.vercel.app"                       │ │ │
│ │ └─────────────────────────────────────────────────────────────────────┘ │ │
│ │                                                                         │ │
│ │ .env.staging                                                            │ │
│ │ ┌─────────────────────────────────────────────────────────────────────┐ │ │
│ │ │ NODE_ENV=staging                                                    │ │ │
│ │ │ DATABASE_URL="libsql://my-app-staging-db.turso.io"                 │ │ │
│ │ │ TURSO_AUTH_TOKEN="staging-auth-token"                               │ │ │
│ │ │ NEXTAUTH_URL="https://my-app-staging.vercel.app"                   │ │ │
│ │ └─────────────────────────────────────────────────────────────────────┘ │ │
│ │                                                                         │ │
│ │ .env.production                                                         │ │
│ │ ┌─────────────────────────────────────────────────────────────────────┐ │ │
│ │ │ NODE_ENV=production                                                 │ │ │
│ │ │ DATABASE_URL="libsql://my-app-prod-db.turso.io"                    │ │ │
│ │ │ TURSO_AUTH_TOKEN="prod-auth-token"                                  │ │ │
│ │ │ NEXTAUTH_URL="https://my-app.com"                                   │ │ │
│ │ └─────────────────────────────────────────────────────────────────────┘ │ │
│ │                                                                         │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │                        Vercel Environment                               │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │                                                                         │ │
│ │ Environment Settings:                                                   │ │
│ │ ┌─────────────┬─────────────┬─────────────┬─────────────┐               │ │
│ │ │   Variable  │ Development │   Staging   │ Production  │               │ │
│ │ ├─────────────┼─────────────┼─────────────┼─────────────┤               │ │
│ │ │ NODE_ENV    │ development │   staging   │ production  │               │ │
│ │ │ DB_URL      │   dev-db    │   stg-db    │   prod-db   │               │ │
│ │ │ AUTH_SECRET │ dev-secret  │ stg-secret  │ prod-secret │               │ │
│ │ │ STORAGE_KEY │   dev-key   │   stg-key   │   prod-key  │               │ │
│ │ └─────────────┴─────────────┴─────────────┴─────────────┘               │ │
│ │                                                                         │ │
│ │ Git Branch Mapping:                                                     │ │
│ │ ┌─────────────┬─────────────┬─────────────┐                             │ │
│ │ │ Environment │ Git Branch  │   URL       │                             │ │
│ │ ├─────────────┼─────────────┼─────────────┤                             │ │
│ │ │ Development │    dev      │ *-dev.app   │                             │ │
│ │ │ Staging     │  staging    │ *-stg.app   │                             │ │
│ │ │ Production  │    main     │   app.com   │                             │ │
│ │ └─────────────┴─────────────┴─────────────┘                             │ │
│ │                                                                         │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 環境変数セキュリティ

1. **機密情報の分離**
   - 本番用とテスト用のキーを分離
   - API キーとシークレットの定期ローテーション
   - 最小権限の原則

2. **自動化されたセキュリティ**
   - 環境変数の自動検証
   - シークレットの暗号化保存
   - アクセスログの記録

3. **開発体験の最適化**
   - ローカル開発用のモック値
   - 環境間での一貫性保証
   - エラーメッセージの改善

## 監視と分析

### リアルタイムダッシュボード

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Real-time Dashboard System                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │                        Dashboard Architecture                           │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │                                                                         │ │
│ │     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐             │ │
│ │     │    TUI      │     │    Web      │     │   Mobile    │             │ │
│ │     │ Dashboard   │     │ Dashboard   │     │ Dashboard   │             │ │
│ │     └─────────────┘     └─────────────┘     └─────────────┘             │ │
│ │            │                   │                   │                    │ │
│ │            └───────────────────┼───────────────────┘                    │ │
│ │                                │                                        │ │
│ │                    ┌───────────▼───────────┐                            │ │
│ │                    │    Dashboard API      │                            │ │
│ │                    │    Orchestrator       │                            │ │
│ │                    └───────────┬───────────┘                            │ │
│ │                                │                                        │ │
│ │                    ┌───────────▼───────────┐                            │ │
│ │                    │   Service Adapters    │                            │ │
│ │                    │      Registry         │                            │ │
│ │                    └───────────┬───────────┘                            │ │
│ │                                │                                        │ │
│ │     ┌─────────────┬─────────────┼─────────────┬─────────────┐            │ │
│ │     │             │             │             │             │            │ │
│ │     ▼             ▼             ▼             ▼             ▼            │ │
│ │ ┌────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐        │ │
│ │ │ Vercel │ │ Supabase │ │  Turso   │ │   AWS    │ │ GitHub   │        │ │
│ │ │Adapter │ │ Adapter  │ │ Adapter  │ │ Adapter  │ │ Adapter  │        │ │
│ │ └────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘        │ │
│ │                                                                         │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │                         Monitor Capabilities                            │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │                                                                         │ │
│ │ Real-time Metrics:                                                      │ │
│ │ ┌─────────────┬─────────────┬─────────────┬─────────────┐               │ │
│ │ │Performance  │    Usage    │   Errors    │  Resources  │               │ │
│ │ ├─────────────┼─────────────┼─────────────┼─────────────┤               │ │
│ │ │• Response   │• Requests   │• Error Rate │• CPU Usage  │               │ │
│ │ │  Times      │• Data       │• Error      │• Memory     │               │ │
│ │ │• Throughput │  Transfer   │  Types      │• Storage    │               │ │
│ │ │• Latency    │• Active     │• Recent     │• Network    │               │ │
│ │ │  P95/P99    │  Users      │  Failures   │  Bandwidth  │               │ │
│ │ └─────────────┴─────────────┴─────────────┴─────────────┘               │ │
│ │                                                                         │ │
│ │ Live Logs:                                                              │ │
│ │ ┌─────────────┬─────────────┬─────────────┬─────────────┐               │ │
│ │ │  Deployment │   Database  │   Storage   │    Auth     │               │ │
│ │ ├─────────────┼─────────────┼─────────────┼─────────────┤               │ │
│ │ │• Build Logs │• Query Logs │• Upload     │• Login      │               │ │
│ │ │• Deploy     │• Migration  │  Logs       │  Attempts   │               │ │
│ │ │  Status     │  Logs       │• Access     │• Token      │               │ │
│ │ │• Function   │• Backup     │  Logs       │  Refresh    │               │ │
│ │ │  Logs       │  Status     │• Error      │• Permission │               │ │
│ │ │             │             │  Reports    │  Changes    │               │ │
│ │ └─────────────┴─────────────┴─────────────┴─────────────┘               │ │
│ │                                                                         │ │
│ │ Health Monitoring:                                                      │ │
│ │ ┌─────────────┬─────────────┬─────────────┬─────────────┐               │ │
│ │ │   Service   │ Connectivity│ Authentication│  Response │               │ │
│ │ │  Uptime     │   Status    │    Status     │   Times   │               │ │
│ │ ├─────────────┼─────────────┼─────────────┼─────────────┤               │ │
│ │ │• 99.9%      │• Connected  │• Authenticated│• < 200ms   │               │ │
│ │ │  Target     │• Latency    │• Token Valid  │• P95 < 1s  │               │ │
│ │ │• SLA        │  Monitoring │• Permissions  │• Error     │               │ │
│ │ │  Tracking   │• Timeout    │  Check        │  Recovery  │               │ │
│ │ │• Downtime   │  Detection  │• Refresh      │• Failover  │               │ │
│ │ │  Alerts     │             │  Logic        │  Status    │               │ │
│ │ └─────────────┴─────────────┴─────────────┴─────────────┘               │ │
│ │                                                                         │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### メトリクス収集システム

#### パフォーマンスメトリクス

```typescript
interface PerformanceMetrics {
    avgResponseTime: number;    // 平均応答時間（ミリ秒）
    throughput: number;         // 秒あたりのリクエスト数
    errorRate: number;          // エラー率（パーセンテージ）
    activeConnections: number;  // アクティブな接続数
    p95ResponseTime: number;    // 95パーセンタイル応答時間
    p99ResponseTime: number;    // 99パーセンタイル応答時間
}

interface UsageMetrics {
    requests: number;           // 総リクエスト数
    dataTransfer: number;       // データ転送量（バイト）
    resourceUtilization: number; // リソース使用率（パーセンテージ）
    cost?: number;              // コスト情報（利用可能な場合）
    activeUsers: number;        // アクティブユーザー数
    sessionDuration: number;    // 平均セッション時間
}

interface ErrorMetrics {
    totalErrors: number;        // 総エラー数
    errorsByType: Record<string, number>; // タイプ別エラー数
    recentErrors: ErrorSummary[]; // 最近のエラー
    errorTrends: ErrorTrend[];   // エラー傾向
}
```

### アラートシステム

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Alert System                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │                         Alert Triggers                                 │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │                                                                         │ │
│ │ Critical Alerts (Immediate Action):                                     │ │
│ │ ┌─────────────┬─────────────┬─────────────┬─────────────┐               │ │
│ │ │ Service     │  Database   │  Security   │ Performance │               │ │
│ │ │ Down        │   Error     │   Breach    │ Degradation │               │ │
│ │ ├─────────────┼─────────────┼─────────────┼─────────────┤               │ │
│ │ │• 0% Uptime  │• Connection │• Auth       │• Response   │               │ │
│ │ │• Deploy     │  Failure    │  Failure    │  > 5s       │               │ │
│ │ │  Failure    │• Migration  │• Token      │• Error Rate │               │ │
│ │ │• API        │  Error      │  Expiry     │  > 10%      │               │ │
│ │ │  Timeout    │• Data       │• Permission │• Memory     │               │ │
│ │ │             │  Corruption │  Escalation │  > 90%      │               │ │
│ │ └─────────────┴─────────────┴─────────────┴─────────────┘               │ │
│ │                                                                         │ │
│ │ Warning Alerts (Review Required):                                       │ │
│ │ ┌─────────────┬─────────────┬─────────────┬─────────────┐               │ │
│ │ │  Resource   │   Usage     │    Cost     │   Quality   │               │ │
│ │ │  Limits     │   Spikes    │  Overrun    │  Metrics    │               │ │
│ │ ├─────────────┼─────────────┼─────────────┼─────────────┤               │ │
│ │ │• CPU > 80%  │• Traffic    │• Budget     │• Test       │               │ │
│ │ │• Memory     │  +200%      │  +20%       │  Failures   │               │ │
│ │ │  > 75%      │• Storage    │• Usage      │• Code       │               │ │
│ │ │• Storage    │  > 85%      │  Anomaly    │  Quality    │               │ │
│ │ │  > 80%      │• Request    │• Forecast   │• Coverage   │               │ │
│ │ │             │  Backlog    │  Alert      │  < 80%      │               │ │
│ │ └─────────────┴─────────────┴─────────────┴─────────────┘               │ │
│ │                                                                         │ │
│ │ Info Alerts (Monitoring):                                               │ │
│ │ ┌─────────────┬─────────────┬─────────────┬─────────────┐               │ │
│ │ │ Deployment  │   Updates   │  Maintenance│ Optimization│               │ │
│ │ │  Success    │  Available  │   Window    │ Suggestions │               │ │
│ │ ├─────────────┼─────────────┼─────────────┼─────────────┤               │ │
│ │ │• New        │• Security   │• Scheduled  │• Performance│               │ │
│ │ │  Release    │  Patches    │  Backup     │  Tuning     │               │ │
│ │ │• Environment│• Feature    │• System     │• Cost       │               │ │
│ │ │  Ready      │  Updates    │  Updates    │  Optimization│              │ │
│ │ │• Health     │• Config     │• Cert       │• Resource   │               │ │
│ │ │  Check OK   │  Changes    │  Renewal    │  Right-size │               │ │
│ │ └─────────────┴─────────────┴─────────────┴─────────────┘               │ │
│ │                                                                         │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │                        Alert Channels                                  │ │
│ ├─────────────────────────────────────────────────────────────────────────┤ │
│ │                                                                         │ │
│ │ ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   │ │
│ │ │   Console   │   │    Email    │   │    Slack    │   │  Webhook    │   │ │
│ │ │  Dashboard  │   │   Alerts    │   │   Channel   │   │   Custom    │   │ │
│ │ └─────────────┘   └─────────────┘   └─────────────┘   └─────────────┘   │ │
│ │       │                 │                 │                 │           │ │
│ │       ▼                 ▼                 ▼                 ▼           │ │
│ │ ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   │ │
│ │ │• Real-time  │   │• Digest     │   │• Immediate  │   │• Integration│   │ │
│ │ │  Updates    │   │  Reports    │   │  Critical   │   │  with       │   │ │
│ │ │• Interactive│   │• Weekly     │   │• Discussion │   │  External   │   │ │
│ │ │  Charts     │   │  Summary    │   │  Threads    │   │  Tools      │   │ │
│ │ │• Drill-down │   │• Trend      │   │• @channel   │   │• PagerDuty  │   │ │
│ │ │  Analysis   │   │  Analysis   │   │  Mentions   │   │• DataDog    │   │ │
│ │ └─────────────┘   └─────────────┘   └─────────────┘   └─────────────┘   │ │
│ │                                                                         │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## トラブルシューティング

### 一般的な問題と解決策

#### デプロイメント失敗

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Deployment Troubleshooting                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ 1. Authentication Issues                                                    │
│    ┌─────────────────────────────────────────────────────────────────────┐ │
│    │ Problem: "Not authenticated with Vercel"                           │ │
│    │                                                                     │ │
│    │ Solutions:                                                          │ │
│    │ • Run: vercel login                                                 │ │
│    │ • Check: vercel whoami                                              │ │
│    │ • Verify: VERCEL_TOKEN environment variable                        │ │
│    │ • Reset: vercel logout && vercel login                             │ │
│    │                                                                     │ │
│    │ Debug Commands:                                                     │ │
│    │ $ vercel whoami --debug                                             │ │
│    │ $ export VERCEL_TOKEN="your-token"                                 │ │
│    │ $ vercel ls --debug                                                 │ │
│    └─────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ 2. Environment Variable Issues                                              │
│    ┌─────────────────────────────────────────────────────────────────────┐ │
│    │ Problem: "Missing required environment variables"                   │ │
│    │                                                                     │ │
│    │ Solutions:                                                          │ │
│    │ • Check: .env files exist and are properly formatted              │ │
│    │ • Verify: Variable names match exactly                             │ │
│    │ • Upload: Run setup-deployment.sh script                           │ │
│    │ • Validate: vercel env ls                                          │ │
│    │                                                                     │ │
│    │ Debug Commands:                                                     │ │
│    │ $ vercel env ls --environment=production                           │ │
│    │ $ vercel env pull .env.vercel.local                                │ │
│    │ $ cat .env.production | vercel env add                             │ │
│    └─────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ 3. Build Failures                                                           │
│    ┌─────────────────────────────────────────────────────────────────────┐ │
│    │ Problem: "Build failed with exit code 1"                           │ │
│    │                                                                     │ │
│    │ Solutions:                                                          │ │
│    │ • Check: TypeScript errors (npm run type-check)                   │ │
│    │ • Verify: Dependencies installation (npm ci)                       │ │
│    │ • Test: Local build (npm run build)                               │ │
│    │ • Review: Build logs in Vercel dashboard                          │ │
│    │                                                                     │ │
│    │ Debug Commands:                                                     │ │
│    │ $ npm run build -- --debug                                         │ │
│    │ $ vercel logs --follow                                              │ │
│    │ $ vercel build --debug                                              │ │
│    └─────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ 4. Database Connection Issues                                               │
│    ┌─────────────────────────────────────────────────────────────────────┐ │
│    │ Problem: "Database connection failed"                               │ │
│    │                                                                     │ │
│    │ Solutions:                                                          │ │
│    │ • Verify: DATABASE_URL and auth tokens                             │ │
│    │ • Check: Database service status                                   │ │
│    │ • Test: Connection from local environment                          │ │
│    │ • Review: Network configuration and firewall                      │ │
│    │                                                                     │ │
│    │ Debug Commands:                                                     │ │
│    │ $ npm run db:migrate                                               │ │
│    │ $ npm run db:seed                                                  │ │
│    │ $ turso db show my-app-prod                                        │ │
│    └─────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### ログ分析とデバッグ

#### ログ収集と分析

```bash
# Vercelデプロイメントログ
vercel logs --follow
vercel logs <deployment-url>

# データベースログ（Turso）
turso db shell my-app-prod --command ".log"

# アプリケーションログ
tail -f /var/log/app/application.log

# エラーログの分析
grep "ERROR" /var/log/app/* | tail -50

# パフォーマンス分析
npm run analyze
npm run lighthouse
```

### ヘルスチェックシステム

```typescript
// ヘルスチェック実装例
export async function healthCheck(): Promise<HealthStatus> {
    const checks: HealthCheck[] = [];
    const start = Date.now();

    // データベース接続チェック
    try {
        await db.raw('SELECT 1');
        checks.push({
            name: 'Database',
            status: 'pass',
            message: 'Database connection successful',
            duration: Date.now() - start,
        });
    } catch (error) {
        checks.push({
            name: 'Database',
            status: 'fail',
            message: `Database connection failed: ${error}`,
            duration: Date.now() - start,
        });
    }

    // 外部API接続チェック
    try {
        const response = await fetch('/api/health');
        if (response.ok) {
            checks.push({
                name: 'API',
                status: 'pass',
                message: 'API endpoint responding',
                duration: Date.now() - start,
            });
        }
    } catch (error) {
        checks.push({
            name: 'API',
            status: 'fail',
            message: `API endpoint unreachable: ${error}`,
            duration: Date.now() - start,
        });
    }

    const overallStatus = checks.every(c => c.status === 'pass')
        ? 'healthy'
        : checks.some(c => c.status === 'fail')
            ? 'unhealthy'
            : 'degraded';

    return {
        status: overallStatus,
        timestamp: Date.now(),
        responseTime: Date.now() - start,
        checks,
    };
}
```

## ベストプラクティス

### セキュリティ

1. **認証情報の管理**
   - 本番用とテスト用のキーを分離
   - 定期的なトークンローテーション
   - 最小権限の原則の適用

2. **アクセス制御**
   - IAMロールベースのアクセス制御
   - ネットワークレベルのセキュリティ
   - 監査ログの保持

3. **データ保護**
   - 転送時および保存時の暗号化
   - 個人データのマスキング
   - バックアップの暗号化

### パフォーマンス

1. **リソース最適化**
   - 適切なリソースサイジング
   - CDNの活用
   - 画像とアセットの最適化

2. **監視とアラート**
   - 包括的なメトリクス収集
   - プロアクティブなアラート設定
   - 傾向分析とキャパシティプランニング

3. **自動化**
   - CI/CDパイプラインの完全自動化
   - 自動スケーリング
   - 自動回復メカニズム

### 運用

1. **ドキュメント化**
   - 運用手順書の整備
   - インシデント対応プレイブック
   - アーキテクチャ図の最新化

2. **テスト戦略**
   - 本番に近い環境でのテスト
   - カナリアデプロイメント
   - ロードテストの実施

3. **継続的改善**
   - 定期的なセキュリティレビュー
   - パフォーマンス最適化
   - コスト最適化

---

fluorite-flakeのデプロイメントシステムは、モダンなクラウドアーキテクチャとDevOpsベストプラクティスを統合して、高可用性、スケーラビリティ、セキュリティを提供します。統一されたダッシュボードとサービスアダプターにより、複数のクラウドサービスを効率的に管理し、リアルタイムでの監視と迅速な問題解決を可能にしています。