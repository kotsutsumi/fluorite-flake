# Fluorite-flake ジェネレーター設計

## 1. ジェネレーターシステム概要

Fluorite-flakeのジェネレーターシステムは、複数のフレームワークとサービス統合に対応した階層型アーキテクチャです。ベースフレームワークの生成から、データベース・認証・ストレージなどの機能統合まで、段階的かつ組み合わせ可能な設計となっています。

### 1.1 ジェネレーターアーキテクチャ概観

```
┌─────────────────────────────────────────────────────────────────┐
│                   ジェネレーターアーキテクチャ                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │ ベースフレーム   │    │  機能統合       │    │  後処理      │ │
│  │ ワーク生成       │ ──►│  ジェネレーター │ ──►│  ジェネレータ │ │
│  │                 │    │                 │    │              │ │
│  │ ├ Next.js       │    │ ├ データベース   │    │ ├ 依存関係    │ │
│  │ ├ Expo          │    │ ├ 認証          │    │ │   インストール│ │
│  │ ├ Tauri         │    │ ├ ストレージ     │    │ ├ Git初期化   │ │
│  │ └ Flutter       │    │ ├ デプロイ       │    │ └ セットアップ │ │
│  │                 │    │ └ Storybook     │    │   完了報告   │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                       生成処理フロー                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 設定解析・前処理                                             │
│     ├ プロジェクト設定の検証                                     │
│     ├ テンプレートマップの解決                                   │
│     └ 依存関係の計算                                             │
│                                                                 │
│  2. ベースプロジェクト生成                                       │
│     ├ フレームワーク固有の構造作成                               │
│     ├ package.json生成                                          │ │
│     ├ 設定ファイル作成                                           │
│     └ 基本コンポーネント配置                                     │
│                                                                 │
│  3. 機能統合レイヤー実行                                         │
│     ├ データベース統合（ORM設定含む）                            │
│     ├ 認証システム統合                                           │
│     ├ ストレージサービス統合                                     │
│     └ デプロイメント設定                                         │
│                                                                 │
│  4. 最終処理・検証                                               │
│     ├ 依存関係の解決・インストール                               │
│     ├ ファイル一貫性検証                                         │
│     └ プロジェクト起動可能性確認                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 2. ベースフレームワークジェネレーター

### 2.1 フレームワーク別ジェネレーター設計

#### 2.1.1 Next.js ジェネレーター
```
┌─────────────────────────────────────────────────────────┐
│                Next.js ジェネレーター                   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  生成構造:                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ project-name/                                       │ │
│  │ ├── app/                     # App Router構造       │ │
│  │ │   ├── layout.tsx            # ルートレイアウト    │ │
│  │ │   ├── page.tsx              # ホームページ        │ │
│  │ │   ├── globals.css           # グローバルスタイル  │ │
│  │ │   └── components/           # 共通コンポーネント  │ │
│  │ │       └── ui/               # UIコンポーネント    │ │
│  │ ├── public/                  # 静的ファイル        │ │
│  │ ├── package.json             # 依存関係設定        │ │
│  │ ├── tsconfig.json            # TypeScript設定      │ │
│  │ ├── tailwind.config.ts       # Tailwind CSS設定    │ │
│  │ ├── postcss.config.mjs       # PostCSS設定         │ │
│  │ ├── next.config.mjs          # Next.js設定         │ │
│  │ └── .env.example             # 環境変数テンプレート │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  生成ロジック:                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ export async function generateNextProject(config) { │ │
│  │   // 1. プロジェクトディレクトリ作成                │ │
│  │   await fs.ensureDir(config.projectPath);           │ │
│  │                                                     │ │
│  │   // 2. 基本構造作成                                │ │
│  │   await createNextAppStructure(config);             │ │
│  │                                                     │ │
│  │   // 3. package.json生成                            │ │
│  │   await generatePackageJson(config, 'nextjs');      │ │
│  │                                                     │ │
│  │   // 4. 設定ファイル配置                            │ │
│  │   await createConfigFiles(config);                  │ │
│  │                                                     │ │
│  │   // 5. テンプレートファイル展開                    │ │
│  │   await expandTemplates(config);                    │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  主な機能:                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ App Router対応                                    │ │
│  │ ├ TypeScript完全対応                                │ │
│  │ ├ Tailwind CSS統合                                  │ │
│  │ ├ ESLint・Prettier設定                              │ │
│  │ ├ API Routes基盤                                    │ │
│  │ └ SEO・パフォーマンス最適化                          │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 2.1.2 Expo ジェネレーター
```
┌─────────────────────────────────────────────────────────┐
│                 Expo ジェネレーター                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  生成構造:                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ project-name/                                       │ │
│  │ ├── app/                     # Expo Router構造      │ │
│  │ │   ├── (tabs)/              # タブベースナビ      │ │
│  │ │   │   ├── index.tsx         # ホームタブ          │ │
│  │ │   │   └── settings.tsx      # 設定タブ           │ │
│  │ │   ├── +not-found.tsx        # 404ページ          │ │
│  │ │   └── _layout.tsx           # ルートレイアウト    │ │
│  │ ├── components/              # 再利用コンポーネント │ │
│  │ ├── constants/               # 定数・設定           │ │
│  │ ├── hooks/                   # カスタムフック       │ │
│  │ ├── assets/                  # 画像・フォント       │ │
│  │ ├── app.config.js            # Expo設定            │ │
│  │ ├── metro.config.js          # Metro bundler設定   │ │
│  │ ├── babel.config.js          # Babel設定           │ │
│  │ └── package.json             # 依存関係設定        │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  生成ロジック:                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ export async function generateExpoProject(config) { │ │
│  │   // 1. Expo CLI互換性チェック                      │ │
│  │   await verifyExpoEnvironment();                    │ │
│  │                                                     │ │
│  │   // 2. プロジェクト構造作成                        │ │
│  │   await createExpoAppStructure(config);             │ │
│  │                                                     │ │
│  │   // 3. Expo設定ファイル生成                        │ │
│  │   await createExpoConfig(config);                   │ │
│  │                                                     │ │
│  │   // 4. ネイティブ依存関係設定                      │ │
│  │   await setupNativeDependencies(config);            │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  主な機能:                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ Expo Router v3対応                                │ │
│  │ ├ TypeScript完全対応                                │ │
│  │ ├ NativeWind (Tailwind for React Native)           │ │
│  │ ├ Expo dev tools統合                                │ │
│  │ ├ プラットフォーム固有設定                          │ │
│  │ └ EAS Build設定                                     │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 2.1.3 Tauri ジェネレーター
```
┌─────────────────────────────────────────────────────────┐
│                Tauri ジェネレーター                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  生成構造:                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ project-name/                                       │ │
│  │ ├── src-tauri/               # Rustバックエンド     │ │
│  │ │   ├── src/                 # Rustソースコード     │ │
│  │ │   │   ├── main.rs           # メインエントリ      │ │
│  │ │   │   └── lib.rs            # ライブラリコード    │ │
│  │ │   ├── Cargo.toml           # Rust依存関係         │ │
│  │ │   ├── tauri.conf.json      # Tauri設定            │ │
│  │ │   └── build.rs             # ビルドスクリプト     │ │
│  │ ├── src/                     # フロントエンド       │ │
│  │ │   ├── components/          # Reactコンポーネント  │ │
│  │ │   ├── App.tsx              # メインアプリ         │ │
│  │ │   └── main.tsx             # エントリポイント     │ │
│  │ ├── public/                  # 静的アセット         │ │
│  │ ├── package.json             # Node.js依存関係      │ │
│  │ ├── vite.config.ts           # Vite設定             │ │
│  │ └── tsconfig.json            # TypeScript設定       │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  生成ロジック:                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ export async function generateTauriProject(config) {│ │
│  │   // 1. Rust環境確認                                │ │
│  │   await verifyRustEnvironment();                    │ │
│  │                                                     │ │
│  │   // 2. フロントエンド構造作成                      │ │
│  │   await createTauriFrontend(config);                │ │
│  │                                                     │ │
│  │   // 3. Rustバックエンド作成                        │ │
│  │   await createTauriBackend(config);                 │ │
│  │                                                     │ │
│  │   // 4. Tauri設定ファイル生成                       │ │
│  │   await generateTauriConfig(config);                │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  主な機能:                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ Rust + React統合                                  │ │
│  │ ├ ネイティブAPIアクセス                             │ │
│  │ ├ システム統合機能                                   │ │
│  │ ├ セキュアな IPC通信                                │ │
│  │ ├ クロスプラットフォーム対応                        │ │
│  │ └ バンドル・配布設定                                │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 2.1.4 Flutter ジェネレーター
```
┌─────────────────────────────────────────────────────────┐
│               Flutter ジェネレーター                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  生成構造:                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ project_name/                                       │ │
│  │ ├── lib/                     # Dartソースコード     │ │
│  │ │   ├── main.dart             # アプリエントリ      │ │
│  │ │   ├── screens/              # 画面コンポーネント  │ │
│  │ │   ├── widgets/              # 再利用ウィジェット  │ │
│  │ │   ├── models/               # データモデル        │ │
│  │ │   ├── services/             # ビジネスロジック    │ │
│  │ │   └── utils/                # ユーティリティ      │ │
│  │ ├── test/                    # テストファイル       │ │
│  │ ├── android/                 # Android固有設定      │ │
│  │ ├── ios/                     # iOS固有設定          │ │
│  │ ├── web/                     # Web固有設定          │ │
│  │ ├── pubspec.yaml             # Dart依存関係         │ │
│  │ └── analysis_options.yaml    # Dart解析設定         │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  生成ロジック:                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ export async function generateFlutterProject(cfg) { │ │
│  │   // 1. Flutter SDK確認                             │ │
│  │   await verifyFlutterSDK();                         │ │
│  │                                                     │ │
│  │   // 2. プロジェクト作成                            │ │
│  │   await createFlutterApp(config);                   │ │
│  │                                                     │ │
│  │   // 3. プロジェクト構造拡張                        │ │
│  │   await enhanceFlutterStructure(config);            │ │
│  │                                                     │ │
│  │   // 4. 依存関係・設定ファイル生成                  │ │
│  │   await configurePubspec(config);                   │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  主な機能:                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ マルチプラットフォーム対応                        │ │
│  │ ├ Material Design 3対応                             │ │
│  │ ├ 状態管理（Provider/Riverpod）                     │ │
│  │ ├ 国際化対応                                         │ │
│  │ ├ テーマ・ダークモード                               │ │
│  │ └ ホットリロード開発環境                             │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 3. 機能統合ジェネレーター

### 3.1 データベースジェネレーター

```
┌─────────────────────────────────────────────────────────┐
│               データベースジェネレーター                │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  統合アーキテクチャ:                                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │                                                     │ │
│  │  Database Type Selection                            │ │
│  │  ┌─────────┬─────────┬─────────┐                   │ │
│  │  │  Turso  │Supabase │  None   │                   │ │
│  │  └─────────┴─────────┴─────────┘                   │ │
│  │       │         │         │                        │ │
│  │       ▼         ▼         ▼                        │ │
│  │  ORM Selection                                      │ │
│  │  ┌─────────────────┬─────────────────┐             │ │
│  │  │     Prisma      │     Drizzle     │             │ │
│  │  └─────────────────┴─────────────────┘             │ │
│  │       │                     │                      │ │
│  │       ▼                     ▼                      │ │
│  │  Framework Integration                              │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │ ├ スキーマ定義                                  │ │ │
│  │  │ ├ クライアント設定                              │ │ │
│  │  │ ├ API Routes生成                                │ │ │
│  │  │ ├ サンプルCRUDコンポーネント                    │ │ │
│  │  │ └ 環境変数設定                                  │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  │                                                     │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  setupDatabase 実装:                                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ export async function setupDatabase(config) {       │ │
│  │   if (config.database === 'none') return;           │ │
│  │                                                     │ │
│  │   // データベース別設定                             │ │
│  │   switch (config.database) {                        │ │
│  │     case 'turso':                                   │ │
│  │       await setupTurso(config);                     │ │
│  │       break;                                        │ │
│  │     case 'supabase':                                │ │
│  │       await setupSupabase(config);                  │ │
│  │       break;                                        │ │
│  │   }                                                 │ │
│  │                                                     │ │
│  │   // ORM別設定                                      │ │
│  │   switch (config.orm) {                             │ │
│  │     case 'prisma':                                  │ │
│  │       await setupPrisma(config);                    │ │
│  │       break;                                        │ │
│  │     case 'drizzle':                                 │ │
│  │       await setupDrizzle(config);                   │ │
│  │       break;                                        │ │
│  │   }                                                 │ │
│  │                                                     │ │
│  │   // サンプルAPI・コンポーネント生成                │ │
│  │   await generateDatabaseSamples(config);            │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 3.1.1 Turso + Drizzle 統合
```
┌─────────────────────────────────────────────────────────┐
│                Turso + Drizzle 統合                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  生成ファイル:                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ lib/                                                │ │
│  │ ├── db/                                             │ │
│  │ │   ├── index.ts              # DB接続設定          │ │
│  │ │   ├── schema.ts             # Drizzleスキーマ      │ │
│  │ │   └── migrations/           # マイグレーション     │ │
│  │ ├── drizzle.config.ts         # Drizzle設定         │ │
│  │ └── .env.example             # 環境変数テンプレート │ │
│  │     ├ TURSO_DATABASE_URL                            │ │
│  │     └ TURSO_AUTH_TOKEN                              │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  設定テンプレート:                                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ // lib/db/index.ts                                  │ │
│  │ import { drizzle } from 'drizzle-orm/libsql'        │ │
│  │ import { createClient } from '@libsql/client'        │ │
│  │                                                     │ │
│  │ const client = createClient({                       │ │
│  │   url: process.env.TURSO_DATABASE_URL!,             │ │
│  │   authToken: process.env.TURSO_AUTH_TOKEN           │ │
│  │ })                                                  │ │
│  │                                                     │ │
│  │ export const db = drizzle(client)                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 3.1.2 Supabase + Prisma 統合
```
┌─────────────────────────────────────────────────────────┐
│               Supabase + Prisma 統合                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  生成ファイル:                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ prisma/                                             │ │
│  │ ├── schema.prisma            # Prismaスキーマ       │ │
│  │ └── migrations/              # DBマイグレーション   │ │
│  │ lib/                                                │ │
│  │ ├── prisma.ts                # Prismaクライアント   │ │
│  │ └── supabase.ts              # Supabaseクライアント │ │
│  │ .env.example                                        │ │
│  │ ├ DATABASE_URL               # Supabase DB URL      │ │
│  │ ├ NEXT_PUBLIC_SUPABASE_URL   # パブリックURL        │ │
│  │ └ NEXT_PUBLIC_SUPABASE_ANON_KEY # 匿名キー          │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  設定テンプレート:                                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ // prisma/schema.prisma                             │ │
│  │ generator client {                                  │ │
│  │   provider = "prisma-client-js"                     │ │
│  │ }                                                   │ │
│  │                                                     │ │
│  │ datasource db {                                     │ │
│  │   provider  = "postgresql"                          │ │
│  │   url       = env("DATABASE_URL")                   │ │
│  │   directUrl = env("DIRECT_URL")                     │ │
│  │ }                                                   │ │
│  │                                                     │ │
│  │ model User {                                        │ │
│  │   id    String @id @default(cuid())                 │ │
│  │   email String @unique                              │ │
│  │   name  String?                                     │ │
│  │   // ... その他のフィールド                         │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.2 認証ジェネレーター

```
┌─────────────────────────────────────────────────────────┐
│                 認証ジェネレーター                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  認証プロバイダー対応:                                  │
│  ┌─────────────────────────────────────────────────────┐ │
│  │                                                     │ │
│  │  NextAuth.js                                        │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │ ├ OAuth プロバイダー対応                        │ │ │
│  │  │   ├ Google, GitHub, Discord                     │ │ │
│  │  │   └ カスタムプロバイダー                        │ │ │
│  │  │ ├ セッション管理                                │ │ │
│  │  │ ├ JWT & Database セッション                     │ │ │
│  │  │ └ ミドルウェア統合                              │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  │                                                     │ │
│  │  Clerk                                              │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │ ├ ユーザー管理UI                                │ │ │
│  │  │ ├ 多要素認証（MFA）                             │ │ │
│  │  │ ├ ソーシャルログイン                            │ │ │
│  │  │ └ 組織・チーム機能                              │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  │                                                     │ │
│  │  Supabase Auth                                      │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │ ├ 統合認証ソリューション                        │ │ │
│  │  │ ├ Row Level Security (RLS)                       │ │ │
│  │  │ ├ リアルタイム購読                              │ │ │
│  │  │ └ サーバーレス関数統合                          │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  │                                                     │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  setupAuth 実装:                                        │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ export async function setupAuth(config) {           │ │
│  │   if (!config.auth) return;                         │ │
│  │                                                     │ │
│  │   const authProvider = determineAuthProvider(config);│ │
│  │                                                     │ │
│  │   switch (authProvider) {                           │ │
│  │     case 'nextauth':                                │ │
│  │       await setupNextAuth(config);                  │ │
│  │       break;                                        │ │
│  │     case 'clerk':                                   │ │
│  │       await setupClerk(config);                     │ │
│  │       break;                                        │ │
│  │     case 'supabase':                                │ │
│  │       await setupSupabaseAuth(config);              │ │
│  │       break;                                        │ │
│  │   }                                                 │ │
│  │                                                     │ │
│  │   // 認証コンポーネント・フック生成                 │ │
│  │   await generateAuthComponents(config, authProvider);│ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.3 ストレージジェネレーター

```
┌─────────────────────────────────────────────────────────┐
│                ストレージジェネレーター                  │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ストレージプロバイダー対応:                            │
│  ┌─────────────────────────────────────────────────────┐ │
│  │                                                     │ │
│  │  Vercel Blob                                        │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │ ├ エッジネットワーク最適化                      │ │ │
│  │  │ ├ 自動CDN配信                                    │ │ │
│  │  │ ├ 画像最適化統合                                │ │ │
│  │  │ └ TypeScript完全対応                            │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  │                                                     │ │
│  │  Cloudflare R2                                      │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │ ├ S3互換API                                     │ │ │
│  │  │ ├ グローバルエッジ配信                          │ │ │
│  │  │ ├ 価格効率的ストレージ                          │ │ │
│  │  │ └ Workers統合                                   │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  │                                                     │ │
│  │  AWS S3                                             │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │ ├ 企業レベルの信頼性                            │ │ │
│  │  │ ├ 詳細なアクセス制御                            │ │ │
│  │  │ ├ バックアップ・バージョニング                  │ │ │
│  │  │ └ CloudFront CDN統合                            │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  │                                                     │ │
│  │  Supabase Storage                                   │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │ ├ 統合認証・認可                                │ │ │
│  │  │ ├ RLS（Row Level Security）                      │ │ │
│  │  │ ├ リアルタイム更新                              │ │ │
│  │  │ └ 画像変換・最適化                              │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  │                                                     │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 4. テンプレートシステム

### 4.1 テンプレートエンジン設計

```
┌─────────────────────────────────────────────────────────┐
│                テンプレートエンジン                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  テンプレートファイル構造:                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ src/templates/                                      │ │
│  │ ├── template-map.json        # マッピング設定       │ │
│  │ ├── nextjs/                  # Next.jsテンプレート │ │
│  │ │   ├── base/                # ベース構造           │ │
│  │ │   │   ├── package.json.template                   │ │
│  │ │   │   ├── tsconfig.json.template                  │ │
│  │ │   │   └── app/                                    │ │
│  │ │   │       ├── layout.tsx.template                 │ │
│  │ │   │       └── page.tsx.template                   │ │
│  │ │   ├── auth/                # 認証統合             │ │
│  │ │   │   ├── nextauth/         # NextAuth.js         │ │
│  │ │   │   └── clerk/            # Clerk               │ │
│  │ │   └── database/            # データベース統合     │ │
│  │ │       ├── turso/            # Turso               │ │
│  │ │       └── supabase/         # Supabase            │ │
│  │ ├── expo/                    # Expoテンプレート     │ │
│  │ ├── tauri/                   # Tauriテンプレート    │ │
│  │ └── flutter/                 # Flutterテンプレート  │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  テンプレート変数システム:                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 変数置換パターン:                                   │ │
│  │ ├ {{PROJECT_NAME}}           # プロジェクト名       │ │
│  │ ├ {{PROJECT_NAME_KEBAB}}     # ケバブケース名       │ │
│  │ ├ {{PROJECT_NAME_SNAKE}}     # スネークケース名     │ │
│  │ ├ {{FRAMEWORK}}              # フレームワーク名     │ │
│  │ ├ {{DATABASE_TYPE}}          # データベース種別     │ │
│  │ ├ {{ORM_TYPE}}               # ORM種別              │ │
│  │ ├ {{AUTH_PROVIDER}}          # 認証プロバイダー     │ │
│  │ └ {{STORAGE_PROVIDER}}       # ストレージプロバイダ │ │
│  │                                                     │ │
│  │ 条件分岐パターン:                                   │ │
│  │ ├ {{#if DATABASE_ENABLED}}...{{/if}}               │ │
│  │ ├ {{#unless AUTH_DISABLED}}...{{/unless}}          │ │
│  │ └ {{#each DEPENDENCIES}}...{{/each}}               │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  readTemplateWithReplacements 実装:                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ export async function readTemplateWithReplacements( │ │
│  │   templatePath: string,                             │ │
│  │   replacements: Record<string, any>                 │ │
│  │ ): Promise<string> {                                │ │
│  │   const content = await readTemplate(templatePath); │ │
│  │                                                     │ │
│  │   return content.replace(                           │ │
│  │     /\{\{([^}]+)\}\}/g,                             │ │
│  │     (match, key) => {                               │ │
│  │       const value = replacements[key.trim()];       │ │
│  │       return value !== undefined ? String(value)    │ │
│  │                                  : match;           │ │
│  │     }                                               │ │
│  │   );                                                │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 4.2 設定管理システム

```
┌─────────────────────────────────────────────────────────┐
│                  設定管理システム                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  フレームワーク設定管理:                                │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ // src/config/framework-configs/frameworks.ts       │ │
│  │ export const FRAMEWORK_CONFIGS = {                  │ │
│  │   nextjs: {                                         │ │
│  │     name: "Next.js",                                │ │
│  │     dependencies: [                                 │ │
│  │       "next", "react", "react-dom",                 │ │
│  │       "@types/node", "@types/react"                 │ │
│  │     ],                                              │ │
│  │     devDependencies: [                              │ │
│  │       "typescript", "tailwindcss", "autoprefixer"   │ │
│  │     ],                                              │ │
│  │     scripts: {                                      │ │
│  │       "dev": "next dev",                            │ │
│  │       "build": "next build",                        │ │
│  │       "start": "next start"                         │ │
│  │     },                                              │ │
│  │     supportedDatabases: ["turso", "supabase"],      │ │
│  │     supportedAuth: ["nextauth", "clerk", "supabase"]│ │
│  │   },                                                │ │
│  │   // ... 他のフレームワーク設定                      │ │
│  │ };                                                  │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  パッケージバージョン管理:                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ // src/config/package-versions/version-groups.ts    │ │
│  │ export const VERSION_GROUPS = {                     │ │
│  │   // React エコシステム                             │ │
│  │   react: "^18.3.1",                                │ │
│  │   "react-dom": "^18.3.1",                          │ │
│  │   "@types/react": "^18.3.12",                       │ │
│  │   "@types/react-dom": "^18.3.1",                    │ │
│  │                                                     │ │
│  │   // Next.js                                        │ │
│  │   next: "^14.2.13",                                │ │
│  │                                                     │ │
│  │   // TypeScript                                     │ │
│  │   typescript: "^5.6.3",                            │ │
│  │   "@types/node": "^22.8.1",                         │ │
│  │                                                     │ │
│  │   // Styling                                        │ │
│  │   tailwindcss: "^3.4.12",                          │ │
│  │   autoprefixer: "^10.4.20"                         │ │
│  │ };                                                  │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 5. ジェネレーター実行フロー

### 5.1 実行オーケストレーション

```
┌─────────────────────────────────────────────────────────┐
│              ジェネレーター実行フロー                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  runProjectGeneration 実装:                             │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ export async function runProjectGeneration(         │ │
│  │   config: ProjectConfig                             │ │
│  │ ) {                                                 │ │
│  │   const spinner = ora('プロジェクト生成中...').start();│ │
│  │                                                     │ │
│  │   try {                                             │ │
│  │     // 1. ベースフレームワーク生成                  │ │
│  │     await generateFrameworkProject(config);         │ │
│  │     spinner.text = 'データベース統合中...';          │ │
│  │                                                     │ │
│  │     // 2. データベース統合                          │ │
│  │     await setupDatabase(config);                    │ │
│  │     spinner.text = '認証システム設定中...';          │ │
│  │                                                     │ │
│  │     // 3. 認証システム統合                          │ │
│  │     await setupAuth(config);                        │ │
│  │     spinner.text = 'ストレージ設定中...';            │ │
│  │                                                     │ │
│  │     // 4. ストレージ統合                            │ │
│  │     await setupStorage(config);                     │ │
│  │     spinner.text = 'デプロイ設定中...';              │ │
│  │                                                     │ │
│  │     // 5. デプロイメント設定                        │ │
│  │     await setupDeployment(config);                  │ │
│  │     spinner.text = 'フィニッシュアップ中...';        │ │
│  │                                                     │ │
│  │     // 6. 後処理                                    │ │
│  │     await finalize(config);                         │ │
│  │                                                     │ │
│  │     spinner.succeed('プロジェクト生成完了！');        │ │
│  │                                                     │ │
│  │   } catch (error) {                                 │ │
│  │     spinner.fail('プロジェクト生成失敗');            │ │
│  │     throw error;                                    │ │
│  │   }                                                 │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  並列処理最適化:                                        │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ // 独立性の高い処理の並列実行                       │ │
│  │ await Promise.allSettled([                          │ │
│  │   setupDatabase(config),                            │ │
│  │   setupStorage(config),                             │ │
│  │   setupStorybook(config)                            │ │
│  │ ]);                                                 │ │
│  │                                                     │ │
│  │ // 依存関係のある処理は順次実行                     │ │
│  │ await setupAuth(config);        // DB後に実行       │ │
│  │ await setupDeployment(config);  // 最後に実行       │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 5.2 エラーハンドリング・ロールバック

```
┌─────────────────────────────────────────────────────────┐
│              エラーハンドリング戦略                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  段階的ロールバック:                                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ class GenerationError extends Error {                │ │
│  │   constructor(                                       │ │
│  │     message: string,                                │ │
│  │     public stage: string,                           │ │
│  │     public rollbackActions: Array<() => Promise<void>>│ │
│  │   ) {                                               │ │
│  │     super(message);                                 │ │
│  │   }                                                 │ │
│  │ }                                                   │ │
│  │                                                     │ │
│  │ async function executeWithRollback(                 │ │
│  │   config: ProjectConfig,                            │ │
│  │   stage: string,                                    │ │
│  │   action: () => Promise<void>,                      │ │
│  │   rollback: () => Promise<void>                     │ │
│  │ ) {                                                 │ │
│  │   try {                                             │ │
│  │     await action();                                 │ │
│  │   } catch (error) {                                 │ │
│  │     await rollback();                               │ │
│  │     throw new GenerationError(                      │ │
│  │       `Failed at stage: ${stage}`,                  │ │
│  │       stage,                                        │ │
│  │       [rollback]                                    │ │
│  │     );                                              │ │
│  │   }                                                 │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  検証・品質チェック:                                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ async function validateGeneratedProject(            │ │
│  │   config: ProjectConfig                             │ │
│  │ ) {                                                 │ │
│  │   // 1. 必須ファイル存在確認                        │ │
│  │   const requiredFiles = getRequiredFiles(config);   │ │
│  │   for (const file of requiredFiles) {               │ │
│  │     if (!await fs.pathExists(file)) {               │ │
│  │       throw new Error(`Missing required: ${file}`); │ │
│  │     }                                               │ │
│  │   }                                                 │ │
│  │                                                     │ │
│  │   // 2. 設定ファイル構文チェック                    │ │
│  │   await validateConfigFiles(config);                │ │
│  │                                                     │ │
│  │   // 3. 依存関係整合性チェック                      │ │
│  │   await validateDependencies(config);               │ │
│  │                                                     │ │
│  │   // 4. TypeScript型チェック                        │ │
│  │   if (config.framework !== 'flutter') {             │ │
│  │     await validateTypeScript(config);               │ │
│  │   }                                                 │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 6. 拡張性・カスタマイズ

### 6.1 新フレームワーク追加ガイド

```
┌─────────────────────────────────────────────────────────┐
│              新フレームワーク追加手順                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. ジェネレーター実装                                  │
│     └ src/generators/[framework]-generator.ts           │
│                                                         │
│  2. 設定追加                                            │
│     └ src/config/framework-configs/frameworks.ts        │
│                                                         │
│  3. テンプレート作成                                    │
│     └ src/templates/[framework]/                        │
│                                                         │
│  4. 型定義更新                                          │
│     └ src/commands/create/types.ts                      │
│                                                         │
│  5. CLI統合                                             │
│     └ src/cli.ts バリデーション追加                     │
│                                                         │
│  6. テスト作成                                          │
│     ├ test/unit/generators/[framework]-generator.test.ts│
│     └ test/scenario/[framework]/[framework].test.ts     │
│                                                         │
│  7. ドキュメント更新                                    │
│     ├ README.md                                         │
│     └ docs/ 関連ファイル                                │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 6.2 カスタムテンプレート

```
┌─────────────────────────────────────────────────────────┐
│               カスタムテンプレート                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  テンプレート作成ガイドライン:                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 1. ファイル命名規則                                 │ │
│  │    ├ .template 拡張子の使用                         │ │
│  │    ├ 変数置換: {{VARIABLE_NAME}}                    │ │
│  │    └ 条件分岐: {{#if CONDITION}}...{{/if}}          │ │
│  │                                                     │ │
│  │ 2. 変数スコープ                                     │ │
│  │    ├ プロジェクト設定変数                           │ │
│  │    ├ フレームワーク固有変数                         │ │
│  │    └ 機能統合変数                                   │ │
│  │                                                     │ │
│  │ 3. 品質要求                                         │ │
│  │    ├ TypeScript型安全性                             │ │
│  │    ├ Linter・Formatter設定                          │ │
│  │    ├ セキュリティベストプラクティス                 │ │
│  │    └ パフォーマンス最適化                           │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  テンプレート例:                                        │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ // package.json.template                            │ │
│  │ {                                                   │ │
│  │   "name": "{{PROJECT_NAME_KEBAB}}",                 │ │
│  │   "version": "0.1.0",                               │ │
│  │   "private": true,                                  │ │
│  │   "scripts": {                                      │ │
│  │     "dev": "{{DEV_SCRIPT}}",                        │ │
│  │     "build": "{{BUILD_SCRIPT}}"                     │ │
│  │   },                                                │ │
│  │   "dependencies": {                                 │ │
│  │     {{#each DEPENDENCIES}}                          │ │
│  │     "{{name}}": "{{version}}"{{#unless @last}},{{/unless}}│ │
│  │     {{/each}}                                       │ │
│  │   }                                                 │ │
│  │   {{#if DEV_DEPENDENCIES}}                          │ │
│  │   ,"devDependencies": {                             │ │
│  │     {{#each DEV_DEPENDENCIES}}                      │ │
│  │     "{{name}}": "{{version}}"{{#unless @last}},{{/unless}}│ │
│  │     {{/each}}                                       │ │
│  │   }                                                 │ │
│  │   {{/if}}                                           │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

*次章: [04_ダッシュボード機能](./04_ダッシュボード機能.md)*