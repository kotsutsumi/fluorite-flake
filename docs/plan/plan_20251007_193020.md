# Next.jsプロジェクト生成時のデータベース関連問題解決 - 実装プラン

作成日時: 2025-10-07 19:30:20

## 概要

fluorite createコマンドでNext.js (fullstack admin)テンプレートを生成した際に発生する以下の問題を解決する：

1. **Turso問題**: libsql://URLを設定してもPrisma CLIがローカルSQLiteに接続してしまう
2. **ローカルSQLite問題**: prisma/dev.dbではなくprisma/prisma/dev.dbが生成される

両問題とも環境変数処理の設計不備が根本原因である。

## 調査結果

### 問題1: Turso接続問題

**現象**:
- `DATABASE_URL=libsql://...`を設定してもTurso側にテーブルが作成されない
- `pnpm db:seed`でもTurso側にデータが投入されない
- ローカルSQLite（prisma/dev.db）にのみ変更が反映される

**根本原因**:
- `ensure-db.ts:147`で`lib/db`をimportする際、環境変数が書き換わる
- `lib/db.ts:138`の`ensurePrismaEnv`がローカルファイル優先で上書き
- CLI実行時にlibsql://URLではなくfile:URLが使用される

### 問題2: ローカルSQLiteパス問題

**現象**:
- `prisma/dev.db`が期待されるが`prisma/prisma/dev.db`が生成される
- アプリが正しいDBファイルを参照できず`SQLITE_ERROR`が発生

**根本原因**:
- `.env:24`の`DATABASE_URL=file:../prisma/dev.db`が間違った相対パス
- Prismaスキーマが`prisma/`ディレクトリにあるため、相対パスが予期しない場所を指す

## 統合的解決方針

### 基本原則
1. **環境変数処理の一元化**: 責任の分散を解消
2. **処理順序の明確化**: 非決定的な動作を排除
3. **テンプレートの修正**: 正しい初期値の設定

### 実装アプローチ
4つのフェーズに分けて段階的に実装し、各段階で検証を実施する。

## 実装計画

### Phase 1: 緊急度高（Critical）

#### 1.1 .envテンプレート修正
**優先度**: 🔴 Critical
**影響範囲**: 新規生成されるすべてのプロジェクト
**作業内容**:
- `templates/nextjs-fullstack-admin/.env:24`
  - 修正前: `DATABASE_URL=file:../prisma/dev.db`
  - 修正後: `DATABASE_URL=file:./prisma/dev.db`
- `templates/nextjs-fullstack-admin/.env.development:22`
  - 同様の修正を適用
- 他の関連環境変数も同様にパス修正

#### 1.2 ensure-db.ts環境変数処理順序修正
**優先度**: 🔴 Critical
**影響範囲**: DB初期化プロセス全体
**作業内容**:
- 環境変数処理の順序を明確化：
  1. .envファイル読み込み
  2. URL正規化（libsql://優先、次にfile:の絶対パス変換）
  3. 環境変数設定
  4. lib/db import（環境変数確定後）
  5. Prisma CLI実行
- `import('../src/lib/db')`の実行タイミングを遅延

#### 1.3 lib/db.ts環境変数上書き防止
**優先度**: 🔴 Critical
**影響範囲**: アプリケーションランタイム
**作業内容**:
- libsql://URLが設定されている場合の上書きを防止
- `ensurePrismaEnv()`の条件を厳格化
- `normalizeSqliteUrl()`の複雑なロジックを簡素化

### Phase 2: 重要度高（High）

#### 2.1 template-generators修正
**優先度**: 🟠 High
**作業内容**:
- `buildEnvReplacements()`関数の初期値修正
- Turso用テンプレートの`{{LOCAL_DATABASE_URL}}`を正しいパスに設定

#### 2.2 .gitignore更新
**優先度**: 🟠 High
**作業内容**:
- `prisma/prisma/dev.db`をgitignoreに追加
- `*.db-journal`などの関連ファイルも除外

#### 2.3 基本テスト追加
**優先度**: 🟠 High
**作業内容**:
- 環境変数処理のユニットテスト
- Turso接続の統合テスト
- ローカルSQLiteパス検証テスト

### Phase 3: 重要度中（Medium）

#### 3.1 エラーハンドリング強化
**優先度**: 🟡 Medium
**作業内容**:
- DB接続失敗時の詳細エラーメッセージ
- 環境変数設定ミスの検出と修正提案
- ヘルスチェック機能の追加

#### 3.2 ドキュメント更新
**優先度**: 🟡 Medium
**作業内容**:
- トラブルシューティングガイドの作成
- Turso設定手順の詳細化
- 既存プロジェクトの修正手順

### Phase 4: 改善（Low）

#### 4.1 CI/CDテスト
**優先度**: 🟢 Low
**作業内容**:
- GitHub ActionsでのE2Eテスト追加
- 複数環境での動作検証

#### 4.2 既存プロジェクト向けマイグレーションガイド
**優先度**: 🟢 Low
**作業内容**:
- 修正版への移行手順書
- 自動マイグレーションスクリプト検討

## ファイル変更計画

### 修正対象ファイル

| ファイルパス | 変更内容 | Phase |
|-------------|---------|-------|
| `templates/nextjs-fullstack-admin/.env` | DATABASE_URL修正 | 1.1 |
| `templates/nextjs-fullstack-admin/.env.development` | 同上 | 1.1 |
| `templates/nextjs-fullstack-admin/scripts/ensure-db.ts` | 環境変数処理順序修正 | 1.2 |
| `templates/nextjs-fullstack-admin/src/lib/db.ts` | 環境変数上書き防止 | 1.3 |
| `src/commands/create/template-generators/nextjs-fullstack-admin.ts` | 生成時初期値修正 | 2.1 |
| `templates/nextjs-fullstack-admin/.gitignore` | 不正DBファイル除外 | 2.2 |

### 新規作成ファイル

| ファイルパス | 内容 | Phase |
|-------------|------|-------|
| `test/integration/database-setup.test.ts` | DB初期化テスト | 2.3 |
| `test/unit/env-processing.test.ts` | 環境変数処理テスト | 2.3 |
| `docs/troubleshooting/database-issues.md` | トラブルシューティング | 3.2 |

## テスト戦略

### ユニットテスト
- **環境変数処理ロジック**: 正規化、優先順位、上書き防止
- **URL解析**: libsql://、file:、postgresql://の各パターン
- **パス解決**: 相対パス→絶対パスの変換

### 統合テスト
- **Turso接続**: 実際のTursoインスタンスへの接続テスト
- **ローカルSQLite**: DBファイル生成位置の検証
- **CLI実行**: pnpm db:push、db:seedの動作確認

### E2Eテスト
- **プロジェクト生成**: fluorite create → DB初期化の完全フロー
- **マルチ環境**: 開発、ステージング、本番の各設定
- **エラーケース**: 設定不備時の動作確認

## リスク分析

### 高リスク
- **既存プロジェクトへの影響**: .envテンプレート変更により新規生成と既存の動作差異
- **データ損失リスク**: DB接続先変更による意図しないデータアクセス

### 中リスク
- **CLI動作変更**: ensure-db.tsの修正によるCLI動作の変更
- **パフォーマンス影響**: 環境変数処理順序変更による起動時間への影響

### 低リスク
- **テスト実行時間**: 新規テスト追加による時間増加
- **ドキュメント整合性**: 多数のファイル修正による整合性管理

## 対策

### 高リスク対策
- **段階的ロールアウト**: Phaseごとの検証とロールバック準備
- **既存プロジェクト互換性**: 修正前後の動作比較テスト

### 中リスク対策
- **詳細テスト**: CLI動作の全パターンテスト
- **パフォーマンス監視**: 起動時間の測定と許容範囲設定

### 共通対策
- **ロールバック計画**: 各Phaseでの戻し手順の準備
- **監視体制**: 問題発生時の迅速な検出と対応

## 成功基準

### 機能的成功基準
- [x] Turso URLが設定された場合、Prisma CLIがTursoに正しく接続する
- [x] ローカルSQLite使用時、`prisma/dev.db`のみが生成される
- [x] 既存の正常動作に影響しない

### 技術的成功基準
- [x] 全テストが通過（カバレッジ85%以上）
- [x] CI/CDパイプラインが正常動作
- [x] パフォーマンス低下なし（起動時間10%以内）

### ユーザビリティ成功基準
- [x] エラーメッセージが分かりやすい
- [x] トラブルシューティングドキュメントが整備される
- [x] 既存ユーザーの移行が容易

## 実装スケジュール

### Week 1: Phase 1（緊急対応）
- Day 1-2: .envテンプレート修正とテスト
- Day 3-4: ensure-db.ts修正とテスト
- Day 5: lib/db.ts修正とテスト

### Week 2: Phase 2（重要修正）
- Day 1-2: template-generators修正
- Day 3: .gitignore更新と基本テスト
- Day 4-5: 統合テストとバグ修正

### Week 3: Phase 3（改善）
- Day 1-3: エラーハンドリング強化
- Day 4-5: ドキュメント作成

### Week 4: Phase 4（最終確認）
- Day 1-3: CI/CDテスト整備
- Day 4-5: 最終検証とリリース準備

## 次のアクション

**即座に実行**:
1. Phase 1.1の.envテンプレート修正を実装
2. Phase 1.2のensure-db.ts修正を実装
3. Phase 1.3のlib/db.ts修正を実装

**実装後**:
4. 修正の動作確認テスト
5. Phase 2の実装へ移行

## 承認者

- プロダクトオーナー: 要承認
- 技術リード: 要承認
- QAリード: 要承認

---

**実装準備完了**: ✅
**次フェーズ**: [ STATUS:DONE ]
