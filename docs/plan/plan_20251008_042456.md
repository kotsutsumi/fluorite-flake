# Next.js プロジェクト生成時のログ改善 - 実装計画

**作成日時**: 2025-10-08 04:24:56
**調査結果**: [docs/investigate/0006.md](../investigate/0006.md)
**ステータス**: DONE

## 概要

Next.js fullstack-admin テンプレート生成時に発生する `pnpm` の進捗ログと `ora` スピナーの競合問題を解決し、ログの視認性を向上させる。

## 問題の詳細

### 現象
- `pnpm install` 実行時に進捗ログとスピナーが同じ行を取り合い、ログが崩れて表示される
- 警告やエラーメッセージが視認しづらくなり、重要な情報を見落とすリスクがある

### 技術的原因
- `ora` スピナーと `pnpm` デフォルトレポーターが同時に行を再描画
- `stdio: "inherit"` によりCLI側でログ整形ができない状態

## 実装方針

### 採用する解決策
1. **スピナーの一時停止・再開制御** (メイン解決策)
2. **pnpm レポーターの変更** (補助的改善)

### 技術的アプローチ
- `pnpm` コマンド実行前にスピナーを適切に停止・再開
- `--reporter append-only` オプションで動的更新を無効化
- 進捗情報の視認性を保持しながらログ競合を解消

## 詳細実装タスク

### 優先度: 高 (Phase 1)
1. **スピナー制御ユーティリティの実装**
   - `src/utils/spinner-control/index.ts` を新規作成
   - `pauseSpinner()`, `resumeSpinner()`, `updateSpinnerMessage()` 機能
   - エラーハンドリングと状態管理

2. **nextjs-fullstack-admin.ts の修正**
   - `runSetupCommands` 関数にスピナー制御パラメータを追加
   - `pnpm` コマンドに `--reporter append-only` オプションを追加
   - 各コマンド実行前後でのスピナー制御

3. **generator.ts の修正**
   - `handleAdvancedTemplate` 関数でスピナー参照を渡すように変更
   - スピナー制御ユーティリティのインポート

### 優先度: 中 (Phase 2)
4. **単体テストの実装**
   - `test/unit/src/utils/spinner-control/index.test.ts` を新規作成
   - スピナー制御機能のテストケース
   - モック化した `ora` での動作検証

5. **統合テストの更新**
   - 既存の `nextjs-fullstack-admin.test.ts` を更新
   - スピナー制御が統合された状態でのテスト

### 優先度: 低 (Phase 3)
6. **他テンプレートへの展開**
   - Expo/Tauri テンプレートでの同様の改善適用
   - 共通化可能な部分の抽出

7. **クロスプラットフォーム対応**
   - Windows/macOS/Linux での動作検証
   - 環境依存の問題対応

## ファイル変更計画

### 新規作成ファイル
```
src/utils/spinner-control/
├── index.ts                 # スピナー制御ユーティリティ (exports)
├── spinner-controller.ts   # メイン制御ロジック
└── types.ts                # 型定義

test/unit/src/utils/spinner-control/
├── index.test.ts           # ユーティリティのテスト
└── spinner-controller.test.ts # 制御ロジックのテスト
```

### 修正対象ファイル
```
src/commands/create/
├── generator.ts                                  # スピナー参照の受け渡し
└── template-generators/
    └── nextjs-fullstack-admin.ts               # スピナー制御 + pnpm オプション

test/unit/src/commands/create/template-generators/
└── nextjs-fullstack-admin.test.ts              # テストケース更新
```

## テスト戦略

### 単体テスト (Unit Tests)
- **対象**: `src/utils/spinner-control/` の新規関数群
- **手法**: モック化した `ora` スピナーでの動作検証
- **カバレッジ**: 95%以上

### 統合テスト (Integration Tests)
- **対象**: `runSetupCommands` でのスピナー制御統合
- **手法**: `execa` モック化によるコマンド実行シミュレート
- **検証**: スピナー状態の正確な遷移

### E2Eテスト (End-to-End Tests)
- **対象**: 実際のCLI実行でのログ競合解消
- **手法**: 手動テスト + 部分的自動化
- **検証**: ログの視認性向上の確認

### テスト実行環境
- **自動**: CI/CD パイプライン、`pnpm test`
- **手動**: デバッグモードでの視覚的確認
- **クロスプラットフォーム**: Windows/macOS/Linux

## リスク分析と対策

### 高リスク
1. **環境・OS依存の問題**
   - **リスク**: ターミナル制御の動作が環境で異なる
   - **対策**: クロスプラットフォームテスト、フォールバック機能
   - **緩和策**: 段階的ロールアウト

### 中リスク
2. **スピナー制御の複雑化**
   - **リスク**: 予期しない動作やデッドロック
   - **対策**: シンプルなインターフェース、充実したエラーハンドリング
   - **緩和策**: 既存動作へのフォールバック

3. **他テンプレートへの影響**
   - **リスク**: Expo/Tauri で同様問題が未解決
   - **対策**: 段階的適用、共通アーキテクチャ検討
   - **緩和策**: テンプレート別の個別対応

### 低リスク
4. **pnpm レポーター変更の副作用**
   - **リスク**: 進捗情報の冗長化
   - **対策**: 設定可能オプション、段階的導入
   - **緩和策**: デフォルトレポーターへの復帰

## 実装スケジュール

### Phase 1: 基本実装 (1-2日)
- [x] スピナー制御ユーティリティ実装
- [x] nextjs-fullstack-admin.ts 修正
- [x] generator.ts 修正
- [x] 基本動作確認

### Phase 2: テストと品質保証 (1日)
- [x] 単体テスト実装
- [x] 統合テスト更新
- [x] E2Eテスト (手動)
- [x] リグレッションテスト

### Phase 3: 追加改善 (1-2日)
- [ ] 他テンプレートへの展開
- [ ] クロスプラットフォーム対応
- [ ] ドキュメント更新

## 完了基準

### 必須条件
- [x] Next.js fullstack-admin テンプレート生成時にログ競合が発生しない
- [x] 警告・エラーメッセージの視認性が向上している
- [x] 全テストが通過する (単体・統合・E2E)
- [x] 既存機能に回帰がない

### 追加条件
- [ ] 他環境 (Windows/Linux) での動作確認
- [ ] パフォーマンスの劣化がない
- [ ] ユーザー体験の改善が確認できる

### 品質基準
- [x] 新規コードのテストカバレッジ ≥ 95%
- [x] リント・フォーマットエラーなし
- [x] TypeScript ビルドエラーなし
- [x] ドキュメント更新完了

## 参考資料

### 関連ファイル
- [調査結果](../investigate/0006.md)
- `src/commands/create/generator.ts`
- `src/commands/create/template-generators/nextjs-fullstack-admin.ts`

### 外部リソース
- [ora ドキュメント](https://github.com/sindresorhus/ora)
- [pnpm レポーター設定](https://pnpm.io/cli/install#--reporter)
- [execa ドキュメント](https://github.com/sindresorhus/execa)

### 技術仕様
- Node.js 20.0.0+
- TypeScript 5.x
- Vitest テストフレームワーク
- クロスプラットフォーム対応 (Windows/macOS/Linux)

---
**次のアクション**: `[ STATUS:READY ]` → 実装フェーズへ移行