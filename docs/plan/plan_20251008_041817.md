# Turso テーブル作成失敗修正 - 実装計画

## 1. 問題概要

### 現象
- `pnpm dev new` で Next.js (`fullstack-admin` テンプレート) 生成時にTurso テーブル作成・シード投入が全環境（dev/staging/prod）で失敗
- Prisma 6.16.3 で `datasourceUrl` と `datasources` を同時指定することにより「Can not use "datasourceUrl" and "datasources" options at the same time.」エラーが発生
- CLI は失敗後も「成功」として処理を完了するため、テーブル未作成状態で成果物が生成される

### 根本原因
1. **PrismaClient 初期化の非互換性**: `src/utils/turso-cli/provisioning.ts:674-681` で libsql アダプター使用時に `datasourceUrl` と `datasources` を同時指定
2. **不適切なエラーハンドリング**: Prisma 例外が警告として処理され、CLI 全体は成功扱いになる
3. **ユーザビリティの問題**: エラー発生時にユーザーが問題に気づきにくい

## 2. 実装方針

### 2.1 PrismaClient 初期化の修正
**方針**: `datasourceUrl` のみを使用し、`datasources` ブロックを削除する（Prisma 6.12以降の推奨方法）

**修正箇所**: `src/utils/turso-cli/provisioning.ts:674-681`

```typescript
// 現在の問題のあるコード
const prisma = new PrismaClient({
    adapter,
    datasourceUrl: prismaDatasourceUrl,
    datasources: {              // ← 削除対象
        db: {
            url: prismaDatasourceUrl,
        },
    },
});

// 修正後のコード
const prisma = new PrismaClient({
    adapter,
    datasourceUrl: prismaDatasourceUrl,
    // datasources ブロックは削除
});
```

### 2.2 エラーハンドリングの改善
**方針**: 致命的エラーと回復可能エラーを分類し、適切な例外処理を実装

1. **致命的エラー（即座に例外をthrow）**:
   - PrismaClient 初期化失敗
   - 認証情報の不正/欠如
   - ネットワーク接続の完全失敗

2. **回復可能エラー（警告として処理し続行）**:
   - 個別SQL文の実行失敗
   - 一部環境での失敗（他環境は継続）

3. **段階的フェイルオーバー**:
   - 全環境失敗時は CLI 全体を失敗として扱う
   - 部分的失敗時は警告を表示し成功として扱う

### 2.3 ユーザーエクスペリエンスの向上
1. **明確なエラーメッセージ**: 復旧手順を含む詳細なガイダンス
2. **失敗時の次アクション**: 具体的な対処方法の提示
3. **成功/失敗の明確な区別**: ユーザーが状況を正確に把握できる出力

## 3. 技術詳細

### 3.1 コード変更詳細

#### ファイル: `src/utils/turso-cli/provisioning.ts`

**変更箇所1**: PrismaClient 初期化（674-681行目）
```typescript
// 修正前
const prisma = new PrismaClient({
    adapter,
    datasourceUrl: prismaDatasourceUrl,
    datasources: {
        db: {
            url: prismaDatasourceUrl,
        },
    },
});

// 修正後
const prisma = new PrismaClient({
    adapter,
    datasourceUrl: prismaDatasourceUrl,
});
```

**変更箇所2**: エラーハンドリング改善（685-690行目周辺）
```typescript
// 修正前（685-690行目周辺）
try {
    await prisma.$connect();
    console.log("✅ Turso接続成功");
    // テーブル作成処理...
} catch (error) {
    // 現在は適切にハンドリングされていない
}

// 修正後
try {
    await prisma.$connect();
    console.log("✅ Turso接続成功");
    // テーブル作成処理...
} catch (error) {
    const errorMessage = error instanceof Error ? error.message : String(error);

    // Prisma 初期化失敗は致命的エラーとして扱う
    if (errorMessage.includes("datasourceUrl") && errorMessage.includes("datasources")) {
        throw new Error(`Prisma 設定エラー: ${errorMessage}\n\n復旧方法:\n1. Prisma バージョンを確認してください (現在: 6.16.3)\n2. libsql アダプター使用時は datasourceUrl のみを指定してください\n3. 詳細は https://pris.ly/d/client-constructor を参照してください`);
    }

    // その他の致命的エラー
    if (errorMessage.includes("authentication") || errorMessage.includes("network") || errorMessage.includes("connection")) {
        throw new Error(`データベース接続エラー: ${errorMessage}\n\n復旧方法:\n1. 'turso auth whoami' で認証状態を確認\n2. ネットワーク接続を確認\n3. データベース URL と認証トークンを確認`);
    }

    // 回復可能エラーは警告として処理
    console.warn(`⚠️ ${env}環境のテーブル作成で問題が発生しました: ${errorMessage}`);
    console.warn("   アプリケーション初回起動時にテーブル作成が実行されます。");
}
```

**変更箇所3**: 環境別エラーハンドリング（436-463行目）
```typescript
// createTablesInTursoDatabases 関数内
let failedEnvironments: string[] = [];
let successfulEnvironments: string[] = [];

for (const env of environments) {
    try {
        // 既存の処理...
        await withTemporaryEnv(envVars, async () => {
            await executeTursoBootstrap({
                projectPath: webAppPath,
                environmentVariables: envVars,
            });
        });

        successfulEnvironments.push(env);
        console.log(`📊 ${env}環境のテーブル作成が完了しました`);
    } catch (error) {
        failedEnvironments.push(env);
        const errorMessage = error instanceof Error ? error.message : String(error);

        // 致命的エラーの場合は即座に例外をthrow
        if (errorMessage.includes("Prisma 設定エラー") || errorMessage.includes("認証情報が不足")) {
            throw error;
        }

        // 回復可能エラーは警告として処理
        console.warn(`⚠️ ${env}環境のテーブル作成で問題が発生しました: ${errorMessage}`);
    }
}

// 結果の判定
if (failedEnvironments.length === environments.length) {
    throw new Error(`全ての環境でテーブル作成に失敗しました:\n失敗環境: ${failedEnvironments.join(", ")}\n\n復旧方法:\n1. Turso CLI の認証状況を確認\n2. データベースの存在を確認\n3. ネットワーク接続を確認`);
} else if (failedEnvironments.length > 0) {
    console.warn(`\n⚠️ 一部環境でテーブル作成に失敗しました:`);
    console.warn(`   成功: ${successfulEnvironments.join(", ")}`);
    console.warn(`   失敗: ${failedEnvironments.join(", ")}`);
    console.warn(`   失敗した環境は、アプリケーション初回起動時にテーブル作成が実行されます。`);
}
```

### 3.2 影響を受けるファイル
1. **主要変更**: `src/utils/turso-cli/provisioning.ts`
2. **テスト追加**: `test/unit/utils/turso-cli/provisioning.test.ts`
3. **新規テスト**: `test/integration/turso-bootstrap.test.ts`

## 4. テスト計画

### 4.1 ユニットテスト拡張
**ファイル**: `test/unit/utils/turso-cli/provisioning.test.ts`

```typescript
describe("PrismaClient初期化", () => {
    it("datasourceUrlのみでの初期化が成功すること", async () => {
        // モック環境でPrismaClient初期化をテスト
        const mockPrismaClient = vi.fn().mockImplementation(() => ({
            $connect: vi.fn().mockResolvedValue(undefined),
            $disconnect: vi.fn().mockResolvedValue(undefined),
        }));

        // テスト実行
        expect(() => {
            new mockPrismaClient({
                adapter: mockAdapter,
                datasourceUrl: "libsql://test.turso.io",
            });
        }).not.toThrow();
    });

    it("datasourceUrlとdatasourcesの同時指定でエラーになること", () => {
        // 旧コードパターンでの例外発生を確認
        const mockPrismaClient = vi.fn().mockImplementation(() => {
            throw new Error("Can not use \"datasourceUrl\" and \"datasources\" options at the same time.");
        });

        expect(() => {
            new mockPrismaClient({
                adapter: mockAdapter,
                datasourceUrl: "libsql://test.turso.io",
                datasources: { db: { url: "libsql://test.turso.io" } },
            });
        }).toThrow("datasourceUrl");
    });

    it("Prisma設定エラー時に適切なエラーメッセージが表示されること", async () => {
        // エラーメッセージの内容とフォーマットをテスト
    });
});

describe("エラーハンドリング", () => {
    it("致命的エラー時に例外がthrowされること", async () => {
        // 認証エラー、ネットワークエラーでの例外処理をテスト
    });

    it("回復可能エラー時に警告が表示され処理が継続されること", async () => {
        // 個別SQL失敗での警告処理をテスト
    });

    it("全環境失敗時にCLI全体が失敗として扱われること", async () => {
        // 全環境でのテーブル作成失敗時の例外処理をテスト
    });
});
```

### 4.2 統合テスト（新規作成）
**ファイル**: `test/integration/turso-bootstrap.test.ts`

```typescript
describe("Turso Bootstrap 統合テスト", () => {
    it("executeTursoBootstrap関数が正常に動作すること", async () => {
        // モック環境での関数全体のテスト
    });

    it("環境変数の設定とPrismaClient初期化が連携すること", async () => {
        // 環境変数からPrismaClient初期化までの統合テスト
    });

    it("エラーケースでの例外伝播が正しく動作すること", async () => {
        // エラー発生時の例外処理の統合テスト
    });
});
```

### 4.3 E2Eテスト強化
**ファイル**: `test/scenario/create-nextjs-turso.test.ts`（新規または既存拡張）

```typescript
describe("Next.js + Turso プロジェクト作成 E2E", () => {
    it("fullstack-adminテンプレートでTursoテーブル作成が成功すること", async () => {
        // 実際のCLIコマンド実行での動作確認
    });

    it("認証情報不足時に適切なエラーメッセージが表示されること", async () => {
        // エラーケースでのE2Eテスト
    });
});
```

### 4.4 回帰テスト
1. **既存URL処理機能**: `cleanDatabaseUrl` 関数への影響確認
2. **他DBプロバイダー**: SQLite、PostgreSQL等への影響確認
3. **既存テンプレート**: 他のテンプレートへの影響確認

## 5. リスク分析と対策

### 5.1 技術的リスク

| リスク | 影響度 | 対策 |
|--------|---------|------|
| Prisma バージョン互換性 | 中 | Prisma 6.16.3での動作確認、将来バージョンでのテスト |
| libsql アダプター変更 | 中 | 公式ドキュメントとの照合、アダプター仕様の確認 |
| 既存機能への影響 | 低 | 包括的な回帰テスト実行 |
| 環境固有の問題 | 中 | 複数環境（dev/staging/prod）での動作確認 |

### 5.2 運用リスク

| リスク | 影響度 | 対策 |
|--------|---------|------|
| エラーメッセージの理解性 | 低 | 明確で実用的なエラーメッセージの作成 |
| 復旧手順の有効性 | 中 | 実際のエラーシナリオでの手順検証 |
| ユーザー体験の低下 | 低 | E2Eテストでのユーザーフロー確認 |

### 5.3 リリース後の監視ポイント
1. **Prisma 初期化エラー**: 新しいエラーパターンの発生有無
2. **テーブル作成成功率**: 環境別の成功率監視
3. **ユーザーフィードバック**: エラーメッセージの理解度

## 6. 実装順序

### フェーズ1: コア修正（高優先度）
1. **PrismaClient 初期化修正** - `datasources` ブロック削除
2. **基本エラーハンドリング改善** - 致命的エラーの例外処理
3. **ユニットテスト追加** - 修正箇所のテストカバレッジ確保

### フェーズ2: エラーハンドリング強化（中優先度）
1. **段階的エラー処理** - 環境別失敗時の適切な処理
2. **ユーザビリティ向上** - エラーメッセージと復旧手順の改善
3. **統合テスト追加** - 関数全体のテストカバレッジ

### フェーズ3: 品質保証（中優先度）
1. **E2Eテスト強化** - 実際のCLI使用での動作確認
2. **回帰テスト実行** - 既存機能への影響確認
3. **ドキュメント更新** - エラー対応手順の文書化

### フェーズ4: 検証・監視（低優先度）
1. **実環境での動作確認** - 複数のTurso環境での検証
2. **パフォーマンス確認** - 修正による性能影響の測定
3. **長期監視設定** - エラー発生率の継続監視

## 7. 検証方法

### 7.1 修正後の動作確認手順

#### 基本動作確認
```bash
# 1. プロジェクト作成
pnpm dev new

# 2. テンプレート選択
# projects → nextjs → fullstack-admin → turso → 既存DB使用 → autoMigrate: true

# 3. 成功ログの確認
# ✅ Turso接続成功
# 📊 dev環境のテーブル作成が完了しました
# 📊 staging環境のテーブル作成が完了しました
# 📊 prod環境のテーブル作成が完了しました
```

#### エラーケース確認
```bash
# 1. 認証情報なしでのテスト
unset TURSO_AUTH_TOKEN
pnpm dev new
# 期待: 明確なエラーメッセージと復旧手順の表示

# 2. 不正なURL設定でのテスト
export TURSO_DATABASE_URL="invalid-url"
pnpm dev new
# 期待: URLバリデーションエラーと修正手順の表示
```

### 7.2 テーブル作成確認
```bash
# Turso CLI でテーブル存在確認
turso db shell <database-name>
.tables
.schema User
.schema Post
```

### 7.3 品質メトリクス
1. **テストカバレッジ**: 修正箇所90%以上
2. **エラー発生率**: CLI実行での例外発生率5%以下
3. **復旧成功率**: エラーメッセージに従った復旧成功率90%以上

## 8. 完了基準

### 8.1 機能要件
- [ ] PrismaClient 初期化エラーの解消
- [ ] 適切なエラーハンドリングの実装
- [ ] 明確なエラーメッセージと復旧手順の提供
- [ ] 全環境（dev/staging/prod）でのテーブル作成成功

### 8.2 品質要件
- [ ] ユニットテスト追加（90%以上のカバレッジ）
- [ ] 統合テスト実装
- [ ] E2Eテスト実行成功
- [ ] 回帰テスト全てパス

### 8.3 ドキュメント要件
- [ ] エラー対応手順の文書化
- [ ] テスト手順の文書化
- [ ] 実装変更内容の記録

## 9. 関連リソース

### 9.1 技術参考資料
- [Prisma Client Constructor Reference](https://pris.ly/d/client-constructor)
- [Prisma libSQL/Turso Adapter Documentation](https://www.prisma.io/docs/orm/adapters/turso)
- [Turso CLI Documentation](https://docs.turso.tech/cli)

### 9.2 社内リソース
- 調査結果: `docs/investigate/0004.md`
- 既存テスト: `test/unit/utils/turso-cli/provisioning.test.ts`
- 実装対象: `src/utils/turso-cli/provisioning.ts`

---

**作成日**: 2025-10-08 04:18:17
**最終更新**: 2025-10-08 04:18:17
**ステータス**: [ STATUS:DONE ]