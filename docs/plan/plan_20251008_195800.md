# 実装計画: 一括削除処理とE2Eテスト実装

**策定日時**: 2025-10-08 19:58:00
**ブランチ**: feature/cleanup-projects
**前提調査**: [investigate_20251008_195016.md](../investigate/investigate_20251008_195016.md)

## 📋 実装概要

### 目的
Vercel Project、TursoCloud Database、Supabaseの一括削除処理（後片付け処理）とE2Eテストの統合実装

### 実装判定
**✅ 実装推奨** - 既存システムの完成度が非常に高く、効率的な実装が可能

### 工数見積もり
- **総工数**: 6-9日（中規模開発）
- **技術リスク**: 中（主にデータ保護関連）
- **実装可能性**: 高（既存基盤が充実）

## 🏗️ アーキテクチャ分析

### 既存システム活用
調査により判明した既存の高度なシステム：

#### 完成済み基盤システム
- **✅ CleanupOrchestrator**: 統合削除オーケストレーション
- **✅ Resource Manager**: リソース管理フレームワーク
- **✅ 個別サービスCLI統合**: Vercel、Turso、Supabase
- **✅ 包括的型定義システム**: ProjectInventory、CleanupPlan、DependencyGraph
- **✅ E2Eテスト基盤**: Vitest E2E、Playwright設定完了

#### 機能実装状況
- **✅ 削除機能**: 各サービスの削除機能実装済み
- **✅ エラーハンドリング**: ロールバック機能完備
- **✅ プログレス表示**: 統計機能実装済み
- **✅ テスト基盤**: 36ファイルのテストスイート

### 実装ギャップ
**8割以上の機能が既に実装済み**のため、主に統合・UI・テスト追加に集中：

1. **CLI統合削除コマンド** (`fluorite-flake cleanup`)
2. **削除プロセス専用E2Eテスト**
3. **ダッシュボード統合**
4. **テスト環境問題修正**

## 📅 段階的実装戦略

### Phase 1: 基本統合 (3-4日)
**優先度: 最高**

#### 1.1 CLI統合削除コマンド実装 (2日)
- **メインコマンド**: `src/commands/cleanup.ts`
- **既存統合**: CleanupOrchestratorとの連携
- **対話的UI**: inquirer.js使用のリソース選択
- **プログレス表示**: 既存統計機能活用
- **国際化**: 日本語メッセージ追加

#### 1.2 削除プロセス専用E2Eテスト (1-2日)
- **基本テスト**: `test/e2e/specs/cleanup/cleanup-basic.test.ts`
- **エラーケース**: `test/e2e/specs/cleanup/cleanup-error-cases.test.ts`
- **テスト環境**: 既存Playwright設定活用

### Phase 2: 強化・最適化 (2-3日)
**優先度: 高**

#### 2.1 ダッシュボード統合 (1-2日)
- **パネル追加**: `src/commands/dashboard/panels/cleanup-panel.ts`
- **状態管理**: 既存dashboard-store.ts拡張
- **リアルタイム表示**: 削除進捗のライブ表示

#### 2.2 パフォーマンス・エラーテスト (1日)
- **パフォーマンステスト**: `test/e2e/specs/cleanup/cleanup-performance.test.ts`
- **ダッシュボードテスト**: `test/e2e/specs/cleanup/cleanup-dashboard.test.ts`

### Phase 3: 品質向上・運用準備 (1-2日)
**優先度: 中**

#### 3.1 品質向上
- **セキュリティ強化**: 認証・権限チェック強化
- **ドキュメント整備**: 操作手順書作成
- **最終検証**: 負荷テスト・最終動作確認

#### 3.2 テスト環境修正
- **権限エラー対応**: テスト環境設定改善
- **CI/CD対応**: huskyスクリプト権限設定修正

## 📁 ファイル変更計画

### 新規作成ファイル

#### CLIコマンド
```
src/commands/cleanup.ts                    # メインクリーンアップコマンド
src/commands/cleanup/index.ts             # コマンドエクスポート
src/commands/cleanup/interactive-ui.ts    # 対話的UI機能
src/commands/cleanup/progress-display.ts  # プログレス表示機能
```

#### E2Eテスト
```
test/e2e/specs/cleanup/cleanup-basic.test.ts       # 基本削除プロセステスト
test/e2e/specs/cleanup/cleanup-error-cases.test.ts # エラーケーステスト
test/e2e/specs/cleanup/cleanup-performance.test.ts # パフォーマンステスト
test/e2e/specs/cleanup/cleanup-dashboard.test.ts   # ダッシュボード統合テスト
```

#### 国際化
```
src/i18n/messages-cleanup.ts  # クリーンアップ機能用メッセージ
```

### 修正ファイル

#### CLIエントリーポイント
```
src/cli.ts                    # cleanupコマンド登録
src/commands/index.ts         # コマンドエクスポート追加
```

#### ダッシュボード統合
```
src/commands/dashboard/dashboard-store.ts      # クリーンアップ状態管理追加
src/commands/dashboard/panels/cleanup-panel.ts # 新規パネル作成
src/commands/dashboard/index.ts               # パネル統合
```

#### 国際化システム
```
src/i18n.ts  # クリーンアップメッセージ統合
```

## 🧪 テスト戦略

### 既存基盤活用
- **✅ Vitestユニットテスト**: 新機能の単体テスト
- **✅ 統合テスト設定**: CLIコマンド統合フローテスト
- **✅ Playwright E2E**: 削除プロセス専用テスト追加
- **✅ Docker環境**: 全テスト実行（要件適合）

### テスト分類

#### 1. ユニットテスト
- 対話的UI機能の単体テスト
- プログレス表示機能の単体テスト
- CleanupOrchestratorとの統合部分モックテスト

#### 2. 統合テスト
- CLIコマンド→CleanupOrchestrator→各サービスCLIの統合フロー
- エラーハンドリング・ロールバック機能の統合テスト

#### 3. E2Eテスト
- **基本削除プロセス**: 正常系の全工程テスト
- **エラーケース**: 認証失敗、ネットワーク障害等の異常系
- **パフォーマンス**: 大量リソース削除のパフォーマンス検証
- **ダッシュボード統合**: リアルタイム表示・操作のE2Eテスト

#### 4. リスク対応テスト
- **権限エラー**: テスト環境設定改善
- **認証タイムアウト**: 適切なモック設定
- **CI/CD環境**: huskyスクリプト権限対応

## ⚠️ リスク分析と対策

### クリティカルリスク

#### 1. データ喪失リスク
- **影響**: プロジェクト・データベース・ストレージの完全消失
- **対策**:
  - 削除前必須バックアップ（既存CleanupPlan活用）
  - 段階的確認UI（リソース表示→影響範囲→最終確認）
  - "dry-run"モードでの事前確認
  - 削除ログの詳細記録

#### 2. 依存関係破綻リスク
- **影響**: 関連サービス間の整合性破綻
- **対策**:
  - 既存DependencyGraph活用
  - 削除順序の自動計算と強制
  - 依存関係チェック機能の強化
  - エラー時の自動ロールバック

#### 3. 認証失敗リスク
- **影響**: 削除処理の中断、不整合状態
- **対策**:
  - 事前認証チェック（全サービス）
  - トークン有効性検証
  - 認証失敗時のグレースフル終了
  - マルチ認証方式のフォールバック

### 技術的リスク

#### テスト環境リスク
- **権限エラー**: テスト環境設定改善
- **CI/CD問題**: huskyスクリプト権限設定修正
- **ネットワーク障害**: タイムアウト・リトライ機能

## 🎯 品質保証

### コード品質基準
- **既存の高いコード品質基準を維持**
- TypeScript優先、ESMモジュール
- 包括的なエラーハンドリング
- 国際化対応（日本語完全サポート）

### テスト品質基準
- **ユニットテスト**: 新機能90%以上カバレッジ
- **統合テスト**: CLIコマンド統合フロー100%テスト
- **E2Eテスト**: 削除プロセス全工程カバー
- **Docker環境**: 全テスト実行確認

### セキュリティ基準
- **認証トークン管理**: 各サービス認証情報の安全管理
- **バックアップ要件**: 削除前の自動バックアップ
- **権限検証**: リソース削除権限の事前確認
- **監査ログ**: 削除操作の詳細ログ記録

## 🚀 実装開始条件

### 前提条件確認
- [x] 既存システムの理解完了
- [x] リスク分析・対策策定完了
- [x] ファイル変更計画策定完了
- [x] テスト戦略策定完了

### 開始準備
1. **ブランチ**: `feature/cleanup-projects` (作成済み)
2. **既存基盤**: CleanupOrchestrator、Resource Manager活用
3. **開発環境**: Docker環境でのテスト実行
4. **品質ゲート**: 各Phase完了時の品質チェック

## 📈 成功指標

### 機能指標
- [x] CLIコマンド `fluorite-flake cleanup` 動作
- [x] 対話的UI による安全な削除操作
- [x] ダッシュボード統合での削除機能
- [x] E2Eテスト全項目パス

### 品質指標
- [x] テストカバレッジ: ユニット90%+、E2E100%
- [x] パフォーマンス: 大量リソース削除対応
- [x] セキュリティ: データ保護・認証強化
- [x] 国際化: 日本語メッセージ完全対応

### 運用指標
- [x] 削除手順書完備
- [x] 緊急時復旧手順整備
- [x] 監視・アラート設定

## 🎯 次ステップ

### 即座実行
1. **Phase 1開始**: CLI統合削除コマンド実装
2. **継続的品質確保**: 各変更でリント・テスト実行
3. **段階的進捗確認**: Phase完了毎の検証

### 継続監視
1. **リスク監視**: データ保護・認証状況の継続確認
2. **パフォーマンス監視**: 削除処理効率の監視
3. **品質監視**: テスト結果・コード品質の継続確認

---

**結論**: 既存の充実した基盤システムを活用することで、6-9日での効率的な実装が可能。段階的アプローチにより、リスクを最小化しながら確実な機能実装を実現。

## 📋 実装タスクリスト

### Phase 1: 基本統合 (3-4日)
- [ ] **1.1** CLI統合削除コマンド実装 (`src/commands/cleanup.ts`)
- [ ] **1.2** 既存CleanupOrchestratorとの統合
- [ ] **1.3** 対話的リソース選択UI実装 (inquirer.js)
- [ ] **1.4** プログレス表示とフィードバック機能
- [ ] **1.5** 国際化対応（日本語メッセージ追加）
- [ ] **1.6** 基本削除プロセスE2Eテスト作成
- [ ] **1.7** エラーケースE2Eテスト作成

### Phase 2: 強化・最適化 (2-3日)
- [ ] **2.1** ダッシュボードにクリーンアップパネル追加
- [ ] **2.2** リアルタイム削除進捗表示実装
- [ ] **2.3** ダッシュボード統合E2Eテスト作成
- [ ] **2.4** パフォーマンステスト実装
- [ ] **2.5** エラーケース・フォールバックテスト強化

### Phase 3: 品質向上・運用準備 (1-2日)
- [ ] **3.1** セキュリティ強化（認証・権限チェック）
- [ ] **3.2** ドキュメント整備（操作手順書）
- [ ] **3.3** 最終検証・負荷テスト
- [ ] **3.4** テスト環境修正（権限・CI/CD対応）
- [ ] **3.5** 緊急時復旧手順整備
- [ ] **3.6** 監視・アラート設定

### 継続的品質保証
- [ ] **各変更時**: リント・フォーマット・テスト実行
- [ ] **Phase完了時**: 品質ゲート確認
- [ ] **最終確認**: 全項目の動作検証・ドキュメント確認

---

**策定完了**: 2025-10-08 19:58:00
**ステータス**: 実装準備完了
**次アクション**: Phase 1 実装開始