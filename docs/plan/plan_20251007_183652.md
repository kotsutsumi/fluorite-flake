# Next.jsプロジェクト作成フローの改善 - 実装計画書（ブラッシュアップ版）

**作成日時**: 2025-01-07 18:36:52
**基準計画**: docs/plans/0020.md
**ステータス**: READY FOR IMPLEMENTATION

## 📋 概要

既存の`src/commands/create/commands.ts`における課題を解決し、すべての選択肢確定まで副作用を発生させない、ユーザーフレンドリーなプロジェクト作成フローを実装する。

## 🎯 改善目標

### 主要課題
- 現在: データベース選択後即座にTursoプロビジョニングが実行される
- 問題: ユーザーが後から設定変更する際のリカバリーコストが高い

### 解決方針
入力収集 → 確認 → 実行の3段階フローに再設計し、確認前の副作用を完全に排除する。

## 🏗 実装設計

### 新しいフロー設計

```
1. 入力収集フェーズ (副作用なし)
   ├── プロジェクト名入力
   ├── プロジェクトタイプ・テンプレート選択
   ├── データベース設定収集（プロビジョニングなし）
   └── Blob設定収集

2. 確認フェーズ
   ├── 全設定内容の表示
   ├── ユーザー最終確認
   └── キャンセル可能

3. 実行フェーズ (副作用あり)
   ├── データベースプロビジョニング
   ├── プロジェクト生成
   └── テーブル作成
```

### アーキテクチャ変更

#### 現在の問題のある構造
```typescript
// 現在: handleDatabaseAndBlobSetup内で即座にプロビジョニング実行
handleDatabaseAndBlobSetup() {
  const config = await collectDatabaseConfig();
  if (!config.skipProvisioning) {
    const result = await provisioningService.provision(config); // 副作用！
  }
}
```

#### 改善後の構造
```typescript
// 改善後: 段階分離
const inputs = await collectUserInputs();        // 副作用なし
const confirmed = await displayConfirmation(inputs); // 確認
if (confirmed) {
  const result = await executeProvisioning(inputs);  // 副作用あり
  await generateProject(config, result);
}
```

## 📁 ファイル変更計画

### 既存ファイルの変更

#### 1. `src/commands/create/commands.ts` (メイン対象)
**変更内容**:
- `handleDatabaseAndBlobSetup`関数を分離
- `collectUserInputs`, `displayConfirmation`, `executeProvisioning`関数を追加
- `createCommand`, `newCommand`の実装統一

**変更箇所**:
- 420-422行: createCommandのhandleDatabaseAndBlobSetup呼び出し
- 507-508行: newCommandのhandleDatabaseAndBlobSetup呼び出し
- 121-217行: handleDatabaseAndBlobSetup関数全体

#### 2. 関連ファイルの確認
- `src/commands/create/database-provisioning/prompts.ts`: 設定収集のみのバージョン確認
- `src/commands/create/prompts/blob-prompts.ts`: 動作確認

### 新規作成ファイル

#### 1. `src/commands/create/confirmation/index.ts`
**責務**: 設定確認画面の表示とユーザー確認処理
```typescript
export interface ConfirmationInputs {
  projectName: string;
  projectType: string;
  template?: string;
  databaseConfig?: DatabaseProvisioningConfig;
  blobConfig?: BlobConfiguration;
  monorepoPreference: boolean;
}

export async function displayConfirmation(inputs: ConfirmationInputs): Promise<boolean>;
```

#### 2. `src/commands/create/execution/index.ts`
**責務**: 実際のプロビジョニング実行処理
```typescript
export interface ExecutionResult {
  databaseCredentials?: DatabaseCredentials;
  databases?: DatabaseInfo[];
  blobCredentials?: BlobCredentials;
}

export async function executeProvisioning(inputs: ConfirmationInputs): Promise<ExecutionResult>;
```

#### 3. `src/i18n.ts` (メッセージ追加)
**追加メッセージ**:
```typescript
confirmation: {
  title: "設定確認",
  projectInfo: "プロジェクト情報",
  databaseInfo: "データベース設定",
  continuePrompt: "この設定でプロジェクトを作成しますか？",
  cancelled: "プロジェクト作成をキャンセルしました"
}
```

## 🧪 テスト戦略

### テストシナリオ

#### 正常系テスト
1. **Next.js + Turso新規DB作成**: フル機能テスト
2. **Next.js + Turso既存DB再利用**: DB再利用パターン
3. **Next.jsフルスタック + Turso + Blob**: 複合設定テスト
4. **各段階でのキャンセル**: ユーザーキャンセル処理

#### 異常系テスト
1. **不正入力**: プロジェクト名、データベース設定の検証
2. **プロビジョニング失敗**: エラーハンドリングとロールバック
3. **ネットワークエラー**: 外部API呼び出し失敗時の処理
4. **ディスク容量不足**: リソース不足時の処理

#### 回帰テスト
1. **既存コマンド動作**: createCommand, newCommandの互換性
2. **他プロジェクトタイプ**: Expo, Tauriの動作確認
3. **国際化**: en/ja両ロケールでの動作確認

### テスト構成

#### ユニットテスト (`test/unit/commands/create/`)
- `confirmation.test.ts`: 確認画面ロジック
- `execution.test.ts`: プロビジョニング実行ロジック
- `flow-integration.test.ts`: フロー統合テスト

#### 機能テスト (`test/functional/cli/`)
- `create-flow.test.ts`: 完全なプロジェクト作成フロー
- `cancel-flow.test.ts`: キャンセル処理テスト

#### モック戦略
- `DatabaseProvisioningService`: プロビジョニング処理
- `TursoCliExecutor`: Turso CLI呼び出し
- `fs` operations: ファイルシステム操作
- User input prompts: ユーザー入力

## ⚠️ リスク分析と対策

### 高リスク

#### 既存機能の破損
- **影響**: 既存のcreateCommand, newCommandが動作しなくなる
- **対策**:
  - 段階的移行による安全な実装
  - 広範囲な回帰テストの実行
  - feature flagによる制御可能な展開

### 中リスク

#### データベースプロビジョニング失敗時の不整合
- **影響**: 部分的にプロジェクトが作成された状態で処理が停止
- **対策**:
  - トランザクショナルな処理設計
  - 詳細なロールバック手順の実装
  - 状態管理の明確化

#### ユーザビリティの悪化
- **影響**: 新フローが理解しにくい、操作が煩雑になる
- **対策**:
  - プロトタイプでのユーザビリティテスト
  - 段階的な情報開示
  - 明確な確認画面設計

### 低リスク

#### パフォーマンス低下
- **影響**: 確認段階の追加により処理時間が増加
- **対策**:
  - 非同期処理の活用
  - プログレス表示の実装
  - キャッシュ機能の検討

## 📅 実装スケジュール

### フェーズ1: コア機能分離 (1-2日)
- [ ] `handleDatabaseAndBlobSetup`関数の分離
- [ ] `collectUserInputs`, `executeProvisioning`関数の実装
- [ ] `confirmation.ts`, `execution.ts`ファイル作成
- [ ] 基本的な動作確認

### フェーズ2: newCommandでの検証 (1日)
- [ ] 新フローを`newCommand`に適用
- [ ] エラーハンドリングの実装
- [ ] 基本機能テストの実行

### フェーズ3: createCommandの統一 (1日)
- [ ] `createCommand`を新フローに移行
- [ ] 両コマンドの動作統一
- [ ] 回帰テストの実行

### フェーズ4: テストとドキュメント (1日)
- [ ] ユニットテスト追加
- [ ] 機能テスト実行
- [ ] i18nメッセージ更新
- [ ] ドキュメント更新

## ✅ 成功判定基準

### 機能要件
- [ ] 全入力確定前にファイル生成・DB操作が実行されない
- [ ] Next.js + Tursoプロジェクトが新フローで正常作成される
- [ ] キャンセル処理が各段階で適切に動作する
- [ ] 既存テストがすべて通過する

### 品質要件
- [ ] en/ja両ロケールでメッセージが整合している
- [ ] エラーメッセージが適切に表示される
- [ ] ロールバック処理が正常に動作する
- [ ] パフォーマンスが既存レベルを維持している

## 🔄 ロールバック戦略

### 段階的実装とブランチ戦略
- 各フェーズでgitブランチを作成: `feature/create-flow-phase-{1-4}`
- 問題発生時は前フェーズに戻せる設計
- 既存の`handleDatabaseAndBlobSetup`関数は一時的に保持

### 緊急時対応
- 重大な問題発生時は元の実装に即座復帰可能
- 段階的な機能無効化によるサービス継続
- 詳細な問題分析とフィードバック収集

## 🚀 実装開始準備

### 前提条件確認
- [ ] 開発環境でのビルド・テスト実行確認
- [ ] 既存テストスイートの全通過確認
- [ ] Git履歴のクリーンアップ

### 開発開始時の初期作業
- [ ] feature/create-flow-improvementブランチ作成
- [ ] 実装計画のissue作成
- [ ] チームレビュー依頼の準備

---

**実装準備完了**: このドキュメントに基づいて安全で効率的な実装が可能です。