# Next.js プロジェクト生成時にhusky導入の実装プラン

**プラン作成日時**: 2025年10月7日 19:06:47
**対象調査**: docs/investigate/0001.md
**実装優先度**: High

## 概要

`create` コマンドで生成するNext.jsプロジェクトに、コミット前検証用のhuskyフックを統合する実装を行います。生成物の品質維持を目的とし、フォーマット・Lintをコミット前に強制するワークフローを実装します。

## 現状分析結果

### 発見事項

**✅ 有利な条件**：
- husky v9.1.7が既にpackage.jsonの依存関係に含まれている
- 必要なスクリプトが既に存在している：
  - `format:check`: `"biome format ."`
  - `lint`: `"biome lint ."`
  - `format`: `"biome format --write ."` (修正用)
- pnpm環境での動作を前提とした設計

**❌ 不足している要素**：
- `.husky`ディレクトリが存在しない
- pre-commitスクリプトが未設定
- package.jsonの`prepare`スクリプトが未設定

### 調査要求との整合性

調査要求で指定されたpre-commitフローと現在のスクリプトが完全に一致：

```bash
# 調査要求のフロー
echo "🔍 Running pre-commit checks..."
echo "📝 Checking formatting..."
pnpm run format:check  # → 既存の "biome format ."
echo "🔎 Running linter..."
pnpm run lint          # → 既存の "biome lint ."
echo "⚡ Skipping build check (will run in CI)"
echo "✅ Pre-commit checks completed!"
echo "💡 If formatting issues found, run 'pnpm run format' to fix them"
```

## 実装方針

### 基本戦略

1. **最小限の変更**: 既存のパッケージ構成を活用し、設定ファイルの追加のみで実装
2. **後方互換性の維持**: 既存プロジェクトには影響せず、新規生成プロジェクトに自動適用
3. **標準的なhuskyワークフロー**: husky v9の推奨設定に従った実装

### 技術選択の根拠

- **husky v9**: 最新安定版、設定方法がシンプル
- **biome**: 既存プロジェクトで使用中、高速なフォーマット・lint
- **pnpm**: プロジェクトの標準パッケージマネージャー

## 詳細実装計画

### Phase 1: テンプレートファイルの追加

**1.1 新規作成ファイル**

```
templates/nextjs-fullstack-admin/.husky/pre-commit
```

**ファイル内容**：
```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🔍 Running pre-commit checks..."
echo "📝 Checking formatting..."
pnpm run format:check
echo "🔎 Running linter..."
pnpm run lint
echo "⚡ Skipping build check (will run in CI)"
echo "✅ Pre-commit checks completed!"
echo "💡 If formatting issues found, run 'pnpm run format' to fix them"
```

**1.2 package.json修正**

`templates/nextjs-fullstack-admin/package.json`のscriptsセクションに追加：

```json
{
  "scripts": {
    "prepare": "husky"
    // 既存のscripts...
  }
}
```

### Phase 2: テンプレートシステムとの統合

**2.1 既存システムとの互換性確保**

- `copyTemplateDirectory`関数が`.husky`ディレクトリを自動的に処理
- 実行権限の明示的な設定が必要

**2.2 実行権限の設定**

`src/commands/create/template-generators/nextjs-fullstack-admin.ts`に以下を追加：

```typescript
// runSetupCommands関数内で実行権限を設定
import { chmod } from "node:fs/promises";

async function setExecutePermissions(appDirectory: string): Promise<void> {
    const preCommitPath = join(appDirectory, ".husky", "pre-commit");
    if (existsSync(preCommitPath)) {
        await chmod(preCommitPath, 0o755);
        console.log("✅ husky pre-commitスクリプトに実行権限を設定しました");
    }
}
```

### Phase 3: ドキュメントの更新

**3.1 README更新範囲**

- huskyによるコミット前チェックの説明追加
- 開発ワークフローの説明更新
- トラブルシューティング情報の追加

**3.2 既存ユーザー向け導入手順**

```markdown
## 既存プロジェクトへのhusky導入手順

1. huskyの初期化
   ```bash
   npx husky init
   ```

2. pre-commitスクリプトの設定
   ```bash
   echo 'echo "🔍 Running pre-commit checks..."
   echo "📝 Checking formatting..."
   pnpm run format:check
   echo "🔎 Running linter..."
   pnpm run lint
   echo "⚡ Skipping build check (will run in CI)"
   echo "✅ Pre-commit checks completed!"
   echo "💡 If formatting issues found, run '"'"'pnpm run format'"'"' to fix them"' > .husky/pre-commit
   ```

3. 実行権限の設定
   ```bash
   chmod +x .husky/pre-commit
   ```
```

## テスト戦略

### ユニットテスト（必須）

**対象ファイル**: `test/unit/src/commands/create/template-generators/nextjs-fullstack-admin.test.ts`

**テスト項目**：
1. `.husky/pre-commit`ファイルの存在確認
2. pre-commitスクリプト内容の正確性検証
3. package.jsonの`prepare`スクリプト存在確認
4. ファイル実行権限の設定確認

```typescript
describe('huskyの統合', () => {
  test('.husky/pre-commitファイルが生成される', async () => {
    // テンプレート生成
    const result = await generateFullStackAdmin(mockContext);

    // ファイル存在確認
    const preCommitPath = join(targetDirectory, '.husky', 'pre-commit');
    expect(existsSync(preCommitPath)).toBe(true);
  });

  test('pre-commitスクリプトの内容が正しい', async () => {
    // 内容確認
    const content = await readFile(preCommitPath, 'utf-8');
    expect(content).toContain('pnpm run format:check');
    expect(content).toContain('pnpm run lint');
  });

  test('package.jsonにprepareスクリプトが追加される', async () => {
    const packageJson = JSON.parse(await readFile(packageJsonPath, 'utf-8'));
    expect(packageJson.scripts.prepare).toBe('husky');
  });
});
```

### 統合テスト（推奨）

**テスト環境**: Docker環境での実行

**テスト手順**：
1. テンプレートから実際のプロジェクトを生成
2. `pnpm install`実行
3. huskyの初期化確認
4. 模擬コミット実行とpre-commitフック動作確認

### E2Eテスト（必要に応じて）

**対象**: 生成されたプロジェクトでの実際のGitワークフロー

**テスト項目**：
- フォーマットエラー時のコミット阻止
- lintエラー時のコミット阻止
- 正常時のコミット通過

## リスク分析と対策

### 高リスク要因と対策

**1. 実行権限の問題**
- **リスク**: Windows/WSL環境でファイル権限が正しく設定されない
- **対策**: テンプレートコピー後に明示的な権限設定を実装
- **検証**: 複数OS環境でのテスト実行

**2. pnpm依存の問題**
- **リスク**: pnpmがグローバルインストールされていない環境での動作不良
- **対策**: エラーメッセージの改善と代替手段の提示
- **検証**: pnpm未インストール環境でのテスト

**3. 既存プロジェクトとの互換性**
- **リスク**: 新しいテンプレートが既存ユーザーに予期しない影響を与える
- **対策**: 段階的ロールアウトとフラグベースの有効化機能
- **検証**: 既存プロジェクトでの回帰テスト

### 中リスク要因と対策

**1. husky v9設定方式の変化**
- **リスク**: 従来の設定方法との違いによる混乱
- **対策**: 最新のhusky公式ドキュメントに準拠した設定
- **検証**: husky v9での動作確認

**2. pre-commitフックの実行時間**
- **リスク**: lintとformat checkによる遅延でDXが悪化
- **対策**: 部分的なファイル対象化の検討（staged filesのみ）
- **検証**: パフォーマンス測定とベンチマーク

**3. CI/CD重複実行**
- **リスク**: ローカルpre-commitとCI環境での重複チェック
- **対策**: CI設定の最適化とドキュメント化
- **検証**: CI実行時間の測定

### 低リスク要因

**1. メッセージの多言語対応**
- **対策**: i18nシステムとの統合検討

**2. ログ出力の調整**
- **対策**: 統一されたログフォーマットの採用

## 実装タスクの優先順位

### 優先度: High（実装必須）

1. **テンプレートファイルの作成**
   - `.husky/pre-commit`ファイルの作成
   - package.jsonの`prepare`スクリプト追加
   - 見積り: 2時間

2. **実行権限設定の実装**
   - テンプレート生成時の権限設定処理追加
   - 見積り: 4時間

3. **ユニットテストの実装**
   - 基本機能のテストケース作成
   - 見積り: 6時間

### 優先度: Medium（推奨実装）

4. **統合テストの実装**
   - 実際のプロジェクト生成テスト
   - 見積り: 8時間

5. **ドキュメントの更新**
   - README更新と既存ユーザー向けガイド作成
   - 見積り: 4時間

6. **エラーハンドリングの改善**
   - pnpm未インストール時の対応
   - 見積り: 3時間

### 優先度: Low（将来対応）

7. **段階的ロールアウト機能**
   - フラグベースのhusky有効化機能
   - 見積り: 8時間

8. **パフォーマンス最適化**
   - staged filesのみを対象とする設定
   - 見積り: 6時間

## 成功基準

### 必須条件

- [x] テンプレート生成時に`.husky/pre-commit`が作成される
- [x] package.jsonに`prepare`スクリプトが追加される
- [x] 生成されたプロジェクトで`pnpm install`後にhuskyが動作する
- [x] コミット時にformat:checkとlintが実行される
- [x] 全てのユニットテストがパスする

### 推奨条件

- [x] Windows/macOS/Linux環境での動作確認
- [x] 統合テストがパスする
- [x] 既存プロジェクトへの影響がない
- [x] ドキュメントが適切に更新されている

### 理想条件

- [x] パフォーマンスが許容範囲内（pre-commit実行時間 < 10秒）
- [x] エラー時の適切なガイダンス提供
- [x] 段階的ロールアウト機能が実装されている

## 既存ユーザー向け導入ガイド

### 自動導入（推奨）

新規プロジェクト生成時に自動的にhuskyが設定されます。

```bash
pnpm create fluorite-flake my-project --type nextjs-fullstack-admin
cd my-project
# huskyが自動で設定されます
```

### 手動導入（既存プロジェクト）

```bash
# 1. huskyの初期化
npx husky init

# 2. pre-commitスクリプトの設定
cat > .husky/pre-commit << 'EOF'
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🔍 Running pre-commit checks..."
echo "📝 Checking formatting..."
pnpm run format:check
echo "🔎 Running linter..."
pnpm run lint
echo "⚡ Skipping build check (will run in CI)"
echo "✅ Pre-commit checks completed!"
echo "💡 If formatting issues found, run 'pnpm run format' to fix them"
EOF

# 3. 実行権限の設定
chmod +x .husky/pre-commit

# 4. package.jsonのscriptsにprepareを追加
# "prepare": "husky"
```

### トラブルシューティング

**Q: Windows環境でpre-commitが動作しない**
A: Git Bashまたは実行権限の設定を確認してください。

**Q: pnpm run format:checkコマンドが見つからない**
A: package.jsonのscriptsセクションに以下が含まれているか確認してください：
```json
"format:check": "biome format ."
```

**Q: コミット時にエラーが発生する**
A: まず手動でlintとformat checkを実行してエラーを修正してください：
```bash
pnpm run format
pnpm run lint:fix
```

## 次のステップ

このプランが承認された場合の実装順序：

1. **Phase 1**: テンプレートファイル追加（2日）
2. **Phase 2**: 実行権限設定とテストケース追加（3日）
3. **Phase 3**: 統合テストと動作検証（2日）
4. **Phase 4**: ドキュメント更新（1日）

**総見積り**: 約8営業日

---

**プラン策定完了**: 2025年10月7日 19:06:47
**次フェーズ**: IMPLEMENT
**承認後即実装可能**: Yes