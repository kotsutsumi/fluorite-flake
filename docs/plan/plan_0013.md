# 実装プラン: ローカルSQLiteでNext.jsプロジェクト生成が失敗する問題の修正

## 概要

Next.js フルスタック管理テンプレートで「ローカル SQLite」を選択した際にプロジェクト生成が失敗する問題を修正する。根本原因は`database`選択情報がデータフロー中で失われることであり、型定義とデータ受け渡しロジックの修正が必要。

## 問題の詳細

### 根本原因
1. `ConfirmationInputs`型に`database`フィールドが存在せず、確認フェーズ以降で選択情報が失われる
2. SQLite経路では`inputs.databaseConfig`が`undefined`となり、`config.database`が未設定になる
3. `generateFullStackAdmin`が`config.database`を必須としているため、未設定時に例外が発生する

### 現在の問題のあるフロー
```
ユーザー選択 → collectDatabaseAndBlobConfiguration → collectUserInputs
→ confirmationなし → createAndValidateConfig → generateFullStackAdmin(失敗)
```

### 修正後の期待フロー
```
ユーザー選択 → collectDatabaseAndBlobConfiguration → collectUserInputs(database保持)
→ confirmation(database表示) → createAndValidateConfig(database渡し) → generateFullStackAdmin(成功)
```

## 実装方針

### フェーズ1: 基本修正（P0 - 修正必須）

#### 1.1 型定義の修正
- **ファイル**: `src/commands/create/confirmation/index.ts`
- **変更内容**:
  ```typescript
  interface ConfirmationInputs {
    // 既存フィールド
    database?: DatabaseType; // 追加
  }
  ```

#### 1.2 データフローの修正
- **ファイル**: `src/commands/create/confirmation/index.ts`
- **変更内容**: `collectUserInputs`関数で`database`を保持・返却
  ```typescript
  export async function collectUserInputs(/* ... */): Promise<ConfirmationInputs> {
    // ...
    return {
      // 既存のフィールド
      database, // 追加
    };
  }
  ```

#### 1.3 config作成時のdatabase渡し
- **ファイル**: `src/commands/create/commands.ts`
- **変更内容**: `createAndValidateConfig`呼び出し時に`database`を渡す
  ```typescript
  const config = createAndValidateConfig({
    // 既存パラメータ
    database: inputs.databaseConfig ? database : inputs.database, // 修正
  });
  ```

### フェーズ2: ユーザビリティ改善（P1 - 高優先度）

#### 2.1 確認画面でのデータベース種別表示
- **ファイル**: `src/commands/create/confirmation/index.ts`
- **変更内容**: 確認プロンプトにデータベース情報を追加

#### 2.2 エラーメッセージの改善
- **ファイル**: `src/commands/create/template-generators/nextjs-fullstack-admin.ts`
- **変更内容**: 失敗時に`result.errors`や`error.message`を具体的に表示

### フェーズ3: 品質確保（P2 - 中優先度）

#### 3.1 i18n文言の追加
- **ファイル**: `src/i18n/en.json`, `src/i18n/ja.json`
- **変更内容**: 確認画面用のデータベース表示文言を追加

#### 3.2 テスト追加
- **対象**: `test/`ディレクトリ下の適切な場所
- **内容**: SQLite選択時の単体・統合テスト

## 影響ファイル分析

### 変更必須ファイル
1. `src/commands/create/confirmation/index.ts` - 型定義とデータフロー修正
2. `src/commands/create/commands.ts` - config作成時のdatabase渡し
3. `src/commands/create/template-generators/nextjs-fullstack-admin.ts` - エラーハンドリング
4. `src/i18n/en.json`, `src/i18n/ja.json` - i18n文言追加

### 確認必須ファイル
1. `src/commands/create/template-generators/types.ts` - DatabaseType定義確認
2. 既存テストファイル - 回帰テスト確認

### テストファイル（新規追加）
1. `test/unit/commands/create/confirmation.test.ts` - collectUserInputsテスト
2. `test/functional/commands/sqlite-selection.test.ts` - SQLite選択統合テスト

## テスト戦略

### 単体テスト
- [ ] `collectUserInputs`関数のdatabase保持・返却テスト
- [ ] `createAndValidateConfig`関数のSQLite対応テスト
- [ ] エラーメッセージ表示の改善テスト

### 統合テスト
- [ ] `create`コマンドでのSQLite選択テスト（モノレポ・非モノレポ）
- [ ] `new`コマンドでのSQLite選択テスト（モノレポ・非モノレポ）
- [ ] 確認画面でのデータベース種別表示テスト

### E2Eテスト（推奨）
- [ ] 実際のユーザーフローテスト（プロンプト選択から完了まで）
- [ ] 生成ファイル内容検証（.env、prisma/schema.prisma等）

### Docker環境での実行
- 全テストをDocker環境で実行し、環境差異を排除

## リスク分析と対策

### 技術的リスク

#### 高リスク
1. **型定義変更の影響範囲**
   - リスク: `ConfirmationInputs`変更により他機能に影響
   - 対策: 既存テスト実行による回帰確認

2. **createAndValidateConfig引数変更**
   - リスク: API変更により他呼び出し箇所に影響
   - 対策: 全呼び出し箇所の調査と一貫した修正

#### 中リスク
3. **i18n文言追加**
   - リスク: 翻訳品質と一貫性
   - 対策: 既存パターンに従った自然な表現使用

4. **確認画面表示変更**
   - リスク: ユーザーの混乱
   - 対策: 既存表示パターンに合わせた自然な追加

#### 低リスク
5. **新規テスト追加の複雑性**
   - リスク: 既存テスト構造との整合性
   - 対策: 既存パターンを参考にした一貫構造

## 実装順序と優先度

### P0: 修正必須（即座に実装）
1. `ConfirmationInputs`型にdatabase追加
2. `collectUserInputs`でdatabase保持・返却
3. `createAndValidateConfig`呼び出し時のdatabase渡し

### P1: ユーザビリティ改善（24時間以内）
4. エラーメッセージの具体化
5. 確認画面でのデータベース種別表示

### P2: 品質確保（1週間以内）
6. SQLite選択時のユニットテスト追加
7. i18n文言の整備

### P3: 将来の改善（次回リリース）
8. デバッグログの改善
9. 回帰テストの強化

## 完了条件と成功指標

### 完了条件
- [ ] ローカルSQLite選択時にテンプレート生成が成功する
- [ ] 確認画面にデータベース種別が表示される
- [ ] 失敗時に具体的なエラーメッセージが表示される
- [ ] 全ての既存テストがパスする
- [ ] 新規追加テストがパスする

### 成功指標
- [ ] 再現手順（調査書の手順1-4）で操作が成功する
- [ ] エラー時のユーザビリティが向上する（具体的メッセージ表示）
- [ ] テストカバレッジが維持・向上する
- [ ] 他のデータベース選択（PostgreSQL、MySQL等）に影響しない

### 受入基準
- [ ] `pnpm dev new` → Next.js fullstack-admin → ローカルSQLite → 成功
- [ ] `pnpm dev create` → Next.js fullstack-admin → ローカルSQLite → 成功
- [ ] 確認画面に「データベース: ローカルSQLite」が表示される
- [ ] 失敗時に具体的な原因（Template generation failedではない）が表示される

## 作業見積もり

### 開発工数
- フェーズ1（基本修正）: 4-6時間
- フェーズ2（ユーザビリティ改善）: 3-4時間
- フェーズ3（品質確保）: 6-8時間
- **合計**: 13-18時間

### テスト工数
- 単体テスト作成: 4-6時間
- 統合テスト作成: 4-6時間
- E2Eテスト作成: 2-4時間
- **合計**: 10-16時間

### 総工数
- **開発**: 13-18時間
- **テスト**: 10-16時間
- **総計**: 23-34時間

## 関連ファイル一覧

### 主要修正ファイル
```
src/commands/create/confirmation/index.ts
src/commands/create/commands.ts
src/commands/create/template-generators/nextjs-fullstack-admin.ts
src/i18n/en.json
src/i18n/ja.json
```

### 確認対象ファイル
```
src/commands/create/template-generators/types.ts
src/commands/create/utils.ts
test/ (既存テストファイル全般)
```

### 新規作成ファイル
```
test/unit/commands/create/confirmation.test.ts
test/functional/commands/sqlite-selection.test.ts
```

## 実装開始条件

このプランが承認され次第、フェーズ1から順次実装を開始する。各フェーズ完了時に回帰テストを実行し、問題がないことを確認してから次フェーズに進む。

---

**プラン策定日**: 2025-10-08
**対象調査**: docs/investigate/0013.md
**実装予定開始**: プラン承認後即座
**実装予定完了**: プラン承認後2-3営業日内