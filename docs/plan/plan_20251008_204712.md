# Expo管理画面機能実装プラン

[ STATUS:DONE ]

## プラン概要

**作成日時**: 2025-10-08 20:47
**ブランチ**: feature/expo-admin-dashboard
**計画者**: Claude Code AI
**基準調査**: docs/investigate/investigate_20251008_203827.md

**目的**: Expoプロジェクト生成時に、Next.jsプロジェクト生成と同等の管理画面機能を同梱し、GraphQLでログインやPOST表示ができる連携機能を実装する

## 実装方針

### 採用アプローチ: Monorepo統合方式

**選択理由**:
- 既存のmonorepo生成機能を活用可能
- Next.js fullstack-adminの構造をそのまま利用可能
- スキーマ・型定義の共有が容易
- 将来的な保守性が高い

### アーキテクチャ設計

```
templates/expo-fullstack-admin/
├── apps/
│   ├── backend/         # GraphQL API (Apollo Server + Prisma)
│   ├── mobile/          # Expo App (Apollo Client)
│   └── admin/           # Next.js Admin Panel (Better Auth)
└── packages/
    └── shared/          # 共通ライブラリ・型定義
```

### データフロー設計

```
[Expo App] <--GraphQL--> [Apollo Server] <--Prisma--> [Database]
                              ^
                              |
                         [Next.js Admin] <--Better Auth--> [Session Store]
```

## 詳細実装タスク

### Phase 1: テンプレート基盤作成（工数: 1日）

#### 1.1 プロジェクト構造作成
- **優先度**: 高
- **担当**: 自動生成システム
- **作業内容**:
  - `templates/expo-fullstack-admin/` ディレクトリ作成
  - Monorepo基盤の `apps/` と `packages/` ディレクトリ作成
  - ルート `package.json` と `pnpm-workspace.yaml` 作成

#### 1.2 既存資産の統合
- **優先度**: 高
- **作業内容**:
  - `templates/nextjs-fullstack-admin/` の内容を `apps/admin/` にコピー
  - 既存の `templates/expo-graphql/` を `apps/mobile/` のベースとして活用
  - 環境変数設定の調整とパス修正

#### 1.3 共通パッケージ設計
- **優先度**: 中
- **作業内容**:
  - `packages/shared/` ディレクトリ作成
  - 共通型定義の抽出
  - GraphQLスキーマの共有化準備

#### 成功基準:
- ✅ Monorepo構造が正しく作成されている
- ✅ 各アプリケーションが独立してビルド可能
- ✅ pnpmワークスペースが正常に動作する

### Phase 2: GraphQL API拡張（工数: 3日）

#### 2.1 GraphQLスキーマ定義 (1日)
- **優先度**: 高
- **作業内容**:
  - `apps/backend/src/schema/index.ts` 作成
  - User, Post, Organization型の定義
  - Query, Mutation, Subscription操作の定義

**GraphQLスキーマ例**:
```graphql
type User {
  id: ID!
  email: String!
  name: String
  role: Role!
  posts: [Post!]!
  createdAt: DateTime!
  updatedAt: DateTime!
}

type Post {
  id: ID!
  title: String!
  content: String
  published: Boolean!
  author: User!
  createdAt: DateTime!
  updatedAt: DateTime!
}

enum Role {
  ADMIN
  ORG_ADMIN
  USER
}

type Query {
  me: User
  users(limit: Int, offset: Int): [User!]!
  posts(published: Boolean, limit: Int, offset: Int): [Post!]!
  post(id: ID!): Post
}

type Mutation {
  login(email: String!, password: String!): AuthPayload!
  logout: Boolean!
  createPost(title: String!, content: String): Post!
  updatePost(id: ID!, title: String, content: String): Post!
  deletePost(id: ID!): Boolean!
}

type AuthPayload {
  token: String!
  user: User!
}
```

#### 2.2 リゾルバー実装 (1日)
- **優先度**: 高
- **作業内容**:
  - `apps/backend/src/resolvers/userResolvers.ts` 実装
  - `apps/backend/src/resolvers/postResolvers.ts` 実装
  - `apps/backend/src/resolvers/authResolvers.ts` 実装
  - `apps/backend/src/resolvers/organizationResolvers.ts` 実装

#### 2.3 認証統合 (1日)
- **優先度**: 高
- **作業内容**:
  - `apps/backend/src/auth/context.ts` でGraphQLコンテキスト作成
  - Better Auth互換のJWT認証実装
  - ロールベースアクセス制御の実装
  - セッション管理機能の統合

#### 成功基準:
- ✅ すべてのGraphQL操作が正常に動作する
- ✅ 認証・認可が正しく機能する
- ✅ データベース操作が正常に動作する

### Phase 3: Expo側実装（工数: 3日）

#### 3.1 Apollo Client セットアップ (1日)
- **優先度**: 高
- **作業内容**:
  - `apps/mobile/src/apollo/client.ts` 実装
  - GraphQLクエリ・ミューテーション定義
  - キャッシュ設定とエラーハンドリング

**Apollo Client設定例**:
```typescript
import { ApolloClient, InMemoryCache, createHttpLink } from '@apollo/client';
import { setContext } from '@apollo/client/link/context';
import AsyncStorage from '@react-native-async-storage/async-storage';

const httpLink = createHttpLink({
  uri: 'http://localhost:4000/graphql',
});

const authLink = setContext(async (_, { headers }) => {
  const token = await AsyncStorage.getItem('authToken');
  return {
    headers: {
      ...headers,
      authorization: token ? `Bearer ${token}` : "",
    }
  };
});

export const client = new ApolloClient({
  link: authLink.concat(httpLink),
  cache: new InMemoryCache(),
});
```

#### 3.2 認証状態管理 (1日)
- **優先度**: 高
- **作業内容**:
  - `apps/mobile/src/auth/AuthContext.tsx` 実装
  - AsyncStorageを使ったトークン管理
  - ログイン・ログアウト機能実装
  - 認証状態に基づいたナビゲーション制御

#### 3.3 管理画面UI実装 (1日)
- **優先度**: 中
- **作業内容**:
  - `apps/mobile/src/screens/LoginScreen.tsx` 実装
  - `apps/mobile/src/screens/PostsScreen.tsx` 実装
  - `apps/mobile/src/screens/UsersScreen.tsx` 実装
  - `apps/mobile/src/screens/ProfileScreen.tsx` 実装

#### 成功基準:
- ✅ Apollo Clientが正常に動作する
- ✅ 認証フローが完全に機能する
- ✅ モバイルUIからCRUD操作が可能
- ✅ リアルタイム更新が動作する

### Phase 4: テスト実装（工数: 2日）

#### 4.1 GraphQL APIテスト (1日)
- **優先度**: 中
- **作業内容**:
  - `apps/backend/src/__tests__/resolvers/` でリゾルバーテスト
  - `apps/backend/src/__tests__/auth/` で認証ロジックテスト
  - データベース操作のテスト

#### 4.2 統合・E2Eテスト (1日)
- **優先度**: 中
- **作業内容**:
  - React Native Testing Libraryでコンポーネントテスト
  - Playwrightによる管理画面E2Eテスト
  - 認証フローの結合テスト

#### 成功基準:
- ✅ 全てのテストが正常にパスする
- ✅ テストカバレッジが80%以上
- ✅ E2Eテストで主要フローが動作確認できる

## ファイル変更計画

### 新規作成ファイル一覧

#### テンプレート基盤
```
templates/expo-fullstack-admin/
├── package.json
├── README.md
├── pnpm-workspace.yaml
├── .gitignore
└── .env.example
```

#### バックエンドAPI
```
templates/expo-fullstack-admin/apps/backend/
├── package.json
├── tsconfig.json
├── src/
│   ├── index.ts
│   ├── schema/
│   │   └── index.ts
│   ├── resolvers/
│   │   ├── userResolvers.ts
│   │   ├── postResolvers.ts
│   │   ├── authResolvers.ts
│   │   └── organizationResolvers.ts
│   └── auth/
│       └── context.ts
└── prisma/
    ├── schema.prisma
    └── seed.ts
```

#### モバイルアプリ
```
templates/expo-fullstack-admin/apps/mobile/
├── package.json
├── App.tsx
├── app.json
├── babel.config.js
└── src/
    ├── apollo/
    │   └── client.ts
    ├── auth/
    │   └── AuthContext.tsx
    ├── screens/
    │   ├── LoginScreen.tsx
    │   ├── PostsScreen.tsx
    │   ├── UsersScreen.tsx
    │   └── ProfileScreen.tsx
    └── components/
        └── PostCard.tsx
```

#### 管理画面（Next.js fullstack-adminからコピー）
```
templates/expo-fullstack-admin/apps/admin/
└── [既存のNext.js fullstack-adminの全ファイル]
```

#### 共通パッケージ
```
templates/expo-fullstack-admin/packages/shared/
├── package.json
├── tsconfig.json
└── src/
    ├── types/
    │   └── index.ts
    ├── graphql/
    │   └── schema.ts
    └── auth/
        └── utils.ts
```

### 修正が必要な既存ファイル

#### 1. src/commands/create/constants.ts
```typescript
export const PROJECT_TEMPLATES = {
    nextjs: [
        "typescript",
        "app-router",
        "pages-router",
        "javascript",
        "fullstack-admin",
    ],
    expo: [
        "typescript",
        "tabs",
        "navigation",
        "javascript",
        "fullstack-graphql",
        "fullstack-admin", // 追加
    ],
    // ...
} as const;

export const PROJECT_TYPE_DESCRIPTIONS = {
    // ...
    expo: {
        name: "Expo",
        description: "React Native framework for mobile development",
        templates: {
            typescript: "TypeScript with navigation",
            tabs: "Tab-based navigation",
            navigation: "Stack navigation",
            javascript: "JavaScript with navigation",
            "fullstack-graphql": "Mobile + Web with GraphQL Backend (TypeScript)",
            "fullstack-admin": "Mobile + Admin Panel with GraphQL Backend (TypeScript)", // 追加
        },
    },
    // ...
} as const;
```

#### 2. src/commands/create/template-generators/expo-fullstack-admin.ts (新規作成)
```typescript
/**
 * Expo + Fullstack Admin テンプレートジェネレーター
 */
import { join } from "node:path";
import { copyTemplateDirectory } from "../../../utils/template-manager/index.js";
import type { GenerationContext, TemplateGenerationResult } from "./types.js";

const TEMPLATE_NAME = "expo-fullstack-admin";
const VARIABLE_FILES = ["package.json"];

export async function generateExpoFullstackAdmin(context: GenerationContext): Promise<TemplateGenerationResult> {
    // 実装内容
}
```

#### 3. src/commands/create/template-generators/index.ts
```typescript
export { generateExpoGraphQL } from "./expo-graphql.js";
export { generateExpoFullstackAdmin } from "./expo-fullstack-admin.js"; // 追加
export { generateFullStackAdmin } from "./nextjs-fullstack-admin.js";
export { generateTauriCrossPlatform } from "./tauri-cross-platform.js";
```

#### 4. src/commands/create/generator.ts
```typescript
// handleAdvancedTemplate関数内に追加
if (config.type === "nextjs") {
    result = await generateFullStackAdmin(generationContext, spinnerController);
} else if (config.type === "expo") {
    if (config.template === "fullstack-graphql") {
        result = await generateExpoGraphQL(generationContext);
    } else if (config.template === "fullstack-admin") {
        result = await generateExpoFullstackAdmin(generationContext); // 追加
    }
} else if (config.type === "tauri") {
    result = await generateTauriCrossPlatform(generationContext);
}
```

## テスト戦略

### 1. 単体テスト
- **対象**: GraphQLリゾルバー、認証ロジック、React Nativeコンポーネント
- **ツール**: Jest, React Native Testing Library
- **カバレッジ目標**: 80%以上

### 2. 統合テスト
- **対象**: Apollo Serverの統合、データベース操作、認証フロー
- **ツール**: Jest, Apollo Server Testing
- **実行環境**: Docker環境

### 3. E2Eテスト
- **対象**: 管理画面のユーザーフロー、Expo側のCRUD操作
- **ツール**: Playwright, Expo Testing Library
- **テストケース**:
  - ログイン・ログアウトフロー
  - 投稿のCRUD操作
  - ユーザー管理機能
  - 権限制御の動作

## リスク分析と対策

### 高リスク要因

#### 1. 複雑性増加リスク
- **影響度**: 高
- **発生確率**: 中
- **対策**:
  - 段階的実装によるリスク分散
  - 各フェーズでの動作確認
  - コードレビューの徹底
- **モニタリング指標**:
  - ビルド時間 (<5分)
  - テスト実行時間 (<10分)
  - バンドルサイズ (<50MB)

#### 2. 認証互換性リスク
- **影響度**: 高
- **発生確率**: 中
- **対策**:
  - Better Auth互換のJWT実装
  - フォールバック認証方式の準備
  - 認証テストの充実
- **緊急時対応**:
  - セッション認証への切り替え
  - シンプルなAPI認証への縮退

#### 3. 型安全性リスク
- **影響度**: 中
- **発生確率**: 低
- **対策**:
  - GraphQL Code Generatorの活用
  - TypeScript strictモードの徹底
  - 型定義の共有化

### 中リスク要因

#### 1. パフォーマンスリスク
- **対策**: バンドルサイズ監視、lazy loading実装
- **目標値**:
  - 初期ロード時間 <3秒
  - APIレスポンス時間 <500ms

#### 2. 依存関係管理リスク
- **対策**:
  - pnpmワークスペースの活用
  - 依存関係バージョンの固定
  - 定期的な依存関係更新

### 低リスク要因

#### 1. 設定管理リスク
- **対策**: 環境変数の一元管理、設定ファイルのテンプレート化

#### 2. デプロイリスク
- **対策**: Docker化、CI/CDパイプラインの整備

## 実装スケジュール

### フェーズ別実装順序

```
Day 1: Phase 1 - テンプレート基盤作成
├── 午前: プロジェクト構造作成
├── 午後: 既存資産統合・共通パッケージ設計

Day 2-4: Phase 2 - GraphQL API拡張
├── Day 2: GraphQLスキーマ定義
├── Day 3: リゾルバー実装
├── Day 4: 認証統合

Day 5-7: Phase 3 - Expo側実装
├── Day 5: Apollo Client セットアップ
├── Day 6: 認証状態管理
├── Day 7: 管理画面UI実装

Day 8-9: Phase 4 - テスト実装
├── Day 8: 単体・統合テスト
├── Day 9: E2Eテスト・最終調整
```

### マイルストーン

- **Day 1終了**: 基盤構造完成、各アプリケーションが個別ビルド可能
- **Day 4終了**: GraphQL APIが完全動作、認証機能が実装完了
- **Day 7終了**: Expo側からの管理機能アクセスが完全動作
- **Day 9終了**: 全機能動作確認完了、テスト全パス

## 成功基準

### 機能要件
- ✅ Expoプロジェクト生成時に管理画面が同梱される
- ✅ GraphQLでログイン・POST表示ができる
- ✅ Expo側から管理画面機能にアクセス可能
- ✅ 包括的なテストが実装されている
- ✅ Next.jsテンプレート更新時の追従可能性が担保されている

### 品質要件
- ✅ コードカバレッジ80%以上
- ✅ ビルドエラー0件
- ✅ ESLint・Prettier警告0件
- ✅ TypeScriptエラー0件
- ✅ セキュリティ脆弱性0件

### パフォーマンス要件
- ✅ アプリ起動時間 <3秒
- ✅ APIレスポンス時間 <500ms
- ✅ バンドルサイズ <50MB
- ✅ ビルド時間 <5分

## 保守・運用計画

### 継続的メンテナンス
1. **Next.js fullstack-admin更新時の同期**:
   - 四半期ごとの機能差分チェック
   - 自動化された同期スクリプトの開発
   - バージョン管理とマイグレーション手順

2. **依存関係管理**:
   - 月次の依存関係更新
   - セキュリティアップデートの自動適用
   - 破壊的変更の事前検証

3. **ドキュメント保守**:
   - API仕様書の自動生成
   - ユーザーガイドの定期更新
   - 開発者向けドキュメントの充実

### モニタリング計画
- パフォーマンス監視ダッシュボード
- エラー追跡とアラート設定
- ユーザビリティ分析

## 結論

本プランにより、Expo管理画面機能の実装は**技術的に実現可能**であり、**9日間での完成**が見込まれます。段階的なアプローチによりリスクを最小化し、既存のNext.js fullstack-adminテンプレートの高い完成度を最大限活用することで、高品質な機能を効率的に実装できる計画となっています。

実装完了後は、両方のテンプレート（Next.js fullstack-admin、Expo fullstack-admin）の機能的等価性を維持し、継続的な保守・運用により長期的な価値を提供します。