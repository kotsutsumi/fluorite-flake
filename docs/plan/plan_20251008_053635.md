# テストスイート改善プラン

## 概要
- **作成日**: 2025-10-08 05:36:35
- **調査基準文書**: docs/investigate/0008.md
- **目的**: `pnpm test run`で実行されないテストの統合と、失敗テストの修正

## 問題の分析

### 1. 設定不一致問題（Critical）
- **問題**: `vitest.config.ts`でtest/functionalディレクトリを参照しているが、実際にはtest/integrationが存在
- **影響**: 統合テスト（1ファイル）が`pnpm test run`で実行されない
- **原因**: ディレクトリ名の不一致

### 2. モック実装問題（High）
- **問題**: `vi.mocked(...).mockReturnValue is not a function`エラー
- **影響**: test/unit/src/utils/monorepo-generator/copy-templates.test.tsで14テスト失敗
- **原因**: モック設定の実装方法が不適切

### 3. 論理テストエラー（Medium）
- **問題**: `expected true to be false`アサーションエラー
- **影響**: test/unit/src/utils/pnpm-validator/validate-pnpm.test.tsで1テスト失敗
- **原因**: テストロジックの不具合

### 4. テスト実行体系の認知不足（Low）
- **問題**: `pnpm test:all`が存在するが、使用方法が不明確
- **影響**: 開発者が部分的なテスト実行しか実施しない可能性

## 実装方針

### 基本方針
1. **設定統一**: ディレクトリ構造とvitest設定の整合性を確保
2. **モック標準化**: TypeScript対応の適切なモック実装
3. **実行体系改善**: 包括的なテスト実行の促進
4. **ドキュメント化**: 明確なテスト実行ガイドライン

### アーキテクチャ方針
- **現行のプロジェクト分離を維持**: unit/integration/e2eの分離構造は適切
- **設定ファイルの最小修正**: 既存のvitest.e2e.config.tsは変更しない
- **後方互換性の確保**: 既存のnpmスクリプトは維持

## 詳細実装タスク

### フェーズ1: 設定修正（優先度: Critical）

#### タスク1.1: vitest.config.ts修正
- **ファイル**: `vitest.config.ts`
- **変更内容**:
  - 38行目: `test/functional/**/*.test.ts` → `test/integration/**/*.test.ts`
  - 49-74行目: test/scenarioプロジェクト設定を削除（未使用）
- **検証方法**: `pnpm test:run`でintegration testが実行されることを確認

#### タスク1.2: 設定クリーンアップ
- **ファイル**: `vitest.config.ts`
- **変更内容**: 未使用のtest/scenarioプロジェクト設定削除
- **効果**: 実行ログのノイズ削減

### フェーズ2: モック修正（優先度: High）

#### タスク2.1: copy-templates.test.tsモック修正
- **ファイル**: `test/unit/src/utils/monorepo-generator/copy-templates.test.ts`
- **変更内容**:
  - vi.mockの設定方法をTypeScript対応に修正
  - vi.mockedの使用方法を適切に修正
- **技術的解決策**:
  ```typescript
  // 修正前（問題）
  vi.mocked(fs.existsSync).mockReturnValue(true);

  // 修正後（解決）
  const mockFs = vi.mocked(fs);
  mockFs.existsSync.mockReturnValue(true);
  ```

#### タスク2.2: 他のテストファイル確認
- **対象**: vi.mockedを使用している他のテストファイル
- **作業**: 同様の問題がないか確認し、必要に応じて修正

### フェーズ3: テスト体系改善（優先度: Medium）

#### タスク3.1: README更新
- **ファイル**: `README.md`
- **追加内容**:
  - テスト実行コマンドの説明
  - `pnpm test:all`の推奨使用
  - CI環境での実行方法

#### タスク3.2: package.json拡張（オプション）
- **ファイル**: `package.json`
- **追加内容**:
  ```json
  "test:ci": "pnpm test:unit:run && pnpm test:integration:run && pnpm test:e2e:run",
  "test:integration": "vitest --config vitest.config.ts --project integration",
  "test:integration:run": "vitest run --config vitest.config.ts --project integration"
  ```

### フェーズ4: 個別修正（優先度: Low）

#### タスク4.1: pnpm-validator論理エラー修正
- **ファイル**: `test/unit/src/utils/pnpm-validator/validate-pnpm.test.ts`
- **問題**: 不正なバージョン文字列処理のテストロジック
- **調査**: 該当テストケースの期待値と実装の確認

## ファイル変更計画

### 修正対象ファイル
1. **vitest.config.ts** - 設定修正
2. **test/unit/src/utils/monorepo-generator/copy-templates.test.ts** - モック修正
3. **test/unit/src/utils/pnpm-validator/validate-pnpm.test.ts** - 論理エラー修正
4. **README.md** - ドキュメント更新

### 新規作成ファイル
なし（既存ファイルの修正のみ）

### 削除対象ファイル
なし

## テスト戦略

### テスト種別と実行方法
| テスト種別 | ファイル数 | 実行コマンド | 対象範囲 |
|-----------|------------|--------------|----------|
| Unit | 29 | `pnpm test:unit:run` | src/**配下の単体機能 |
| Integration | 1 | `pnpm test:integration:run`（新規） | 外部サービス連携 |
| E2E | 3 | `pnpm test:e2e:run` | エンドツーエンド |
| All | 33 | `pnpm test:all` | 全テスト |

### 検証計画
1. **フェーズ1完了後**: `pnpm test:run`で33ファイル実行を確認
2. **フェーズ2完了後**: モック関連エラー0件を確認
3. **フェーズ4完了後**: 全テスト通過を確認

### CI/CD考慮事項
- **GitHub Actions**: `pnpm test:all`の使用を推奨
- **タイムアウト設定**: integration/e2eテストの長時間実行を考慮
- **並行実行**: unit testのみ並行実行、integration/e2eは順次実行

## リスク分析と対策

### 高リスク
- **モック修正の影響範囲**: 他のテストファイルで同様の問題が発覚
  - **対策**: フェーズ2.2で全テストファイルの確認を実施

### 中リスク
- **設定変更による実行時間増加**: integration testの追加実行
  - **対策**: 実行時間を測定し、必要に応じてタイムアウト調整

### 低リスク
- **既存ワークフローの影響**: 開発者の慣習的なコマンド使用
  - **対策**: README更新で新しい実行方法を明記

## 成功基準

### 必須基準
- [ ] `pnpm test:run`で33テストファイル全て実行される
- [ ] モック関連エラー0件
- [ ] 全テストが通過する（現在の失敗テストを修正）

### 推奨基準
- [ ] README更新完了
- [ ] 新しいnpmスクリプト追加（integration test用）
- [ ] CI実行での検証完了

## スケジュール

### 推定作業時間
- **フェーズ1**: 30分（設定修正）
- **フェーズ2**: 60分（モック修正）
- **フェーズ3**: 30分（ドキュメント更新）
- **フェーズ4**: 30分（論理エラー修正）
- **検証・テスト**: 30分

### 総所要時間
**約3時間**

## 備考

### 技術的な注意点
- **vitest 3.2.4**: 現在のバージョンでのモック実装ベストプラクティスに準拠
- **TypeScript**: モック設定での型安全性を確保
- **Node.js 20+**: 最新のNode.js機能の適切な活用

### 今後の改善提案
- **プリコミットフック**: テスト実行の自動化
- **カバレッジレポート**: 統合テストカバレッジの可視化
- **パフォーマンステスト**: 重要機能の性能回帰防止

## 完了条件

プラン実装完了の判定基準：
1. 全ての実装タスクが完了している
2. 全ての成功基準（必須）が満たされている
3. リグレッションテストが通過している
4. ドキュメントが更新されている

---
**プラン作成者**: Claude Code SuperClaude Framework
**レビュー必要**: 実装前にモック修正方針の技術的妥当性確認