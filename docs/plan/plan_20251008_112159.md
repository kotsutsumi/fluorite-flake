# Nextraドキュメントプロジェクト生成機能 実装計画

**作成日時:** 2025/10/08 11:21:59
**基準調査:** docs/investigate/0014.md
**実装対象:** Fluorite Flake CLI の Nextra ドキュメントプロジェクト生成機能

## 📋 実装概要

Fluorite Flake CLI に Nextra ベースのドキュメントプロジェクト生成機能を追加する。現在 `refs/docs` に存在するリファレンス実装を配布可能なテンプレート化し、モノレポ・単一プロジェクト両方でドキュメントサイトを生成可能にする。

## 🎯 実装目標

1. **CLI UX 拡張**: ドキュメント生成選択をプロジェクト作成フローに統合
2. **テンプレート化**: `refs/docs` を `templates/docs` として配布対象化
3. **モノレポ統合**: `apps/docs` 配置で Turbo と連携
4. **依存管理**: Next 15/React 19/Nextra 4.6 の適切な統合
5. **品質保証**: 包括的テストと既存フロー保護

## 📊 実装フェーズ

### **フェーズ1: 基盤構築（P0 - 必須）**

**1.1 テンプレート基盤の準備**

- `refs/docs` → `templates/docs` 移設
- 配布対象ファイルの整理・最適化
- `.npmignore` 調整によるパッケージサイズ最適化

**1.2 型定義の拡張**

- `src/types/project-config.ts`: `shouldGenerateDocs: boolean` 追加
- `src/commands/create/confirmation/types.ts`: `ConfirmationInputs` 拡張
- TypeScript 型の整合性確保

**1.3 CLI UX の基本実装**

- `src/commands/create/inputs/collect-user-inputs.ts`: docs選択UI追加
- `src/commands/create/confirmation/index.ts`: 確認画面表示項目拡張
- テンプレート選択後のドキュメント生成有無質問

### **フェーズ2: コア機能実装（P1 - 重要）**

**2.1 docs 処理ユーティリティの作成**

```
src/utils/docs-generator/
├── index.ts              # export文
├── copy-docs-template.ts # テンプレートコピー処理
└── create-docs-package-json.ts # docs用package.json生成
```

**2.2 モノレポ生成ロジック拡張**

- `src/utils/monorepo-generator/create-structure.ts`: `apps/docs` 対応
- `src/commands/create/generator.ts`: 生成ロジック統合
- `src/commands/create/project-config.ts`: docs フラグ処理

**2.3 依存バージョン整合性の解決**

- React 18（既存アプリ）vs React 19（Nextra）の共存対応
- peerDependencies による柔軟な依存管理
- Next 15/Nextra 4.6 の適切な統合

### **フェーズ3: 拡張機能（P2 - 最適化）**

**3.1 単一プロジェクト対応**

- `docs/` ディレクトリ配置ロジック
- 非モノレポでの依存管理方法
- `pnpm --filter ./docs` 形式での運用

**3.2 Turbo パイプライン最適化**

- `templates/monorepo/package.json.template`: dev スクリプト調整
- `turbo run dev --parallel` での並列実行最適化
- ドキュメント専用タスクの追加

## 📁 ファイル変更計画

### **新規作成ファイル**

- `templates/docs/` (ディレクトリ全体、`refs/docs` から移設)
- `src/utils/docs-generator/index.ts`
- `src/utils/docs-generator/copy-docs-template.ts`
- `src/utils/docs-generator/create-docs-package-json.ts`

### **修正対象ファイル**

- `src/types/project-config.ts` - `shouldGenerateDocs` プロパティ追加
- `src/commands/create/inputs/collect-user-inputs.ts` - docs選択UI追加
- `src/commands/create/confirmation/types.ts` - 確認画面型拡張
- `src/commands/create/confirmation/index.ts` - 確認画面表示拡張
- `src/commands/create/project-config.ts` - docs フラグ処理
- `src/commands/create/generator.ts` - 生成ロジック統合
- `src/utils/monorepo-generator/create-structure.ts` - `apps/docs` 追加
- `templates/monorepo/package.json.template` - dev スクリプト調整

### **テスト関連ファイル**

- `test/unit/utils/docs-generator/` - 単体テスト追加
- `test/functional/create-with-docs.test.ts` - 統合テスト追加
- `test/scenario/docs-generation.test.ts` - E2Eテスト追加

## 🧪 テスト戦略

### **単体テスト（必須）**

- `copyDocsTemplate` 関数: ファイルコピーと置換処理の検証
- `createDocsPackageJson` 関数: 依存関係生成の確認
- `ProjectConfig` 型拡張: 型定義の整合性確認
- CLI入力処理: docs選択フローの検証

### **統合テスト（必須）**

1. **モノレポ + docs 生成**: `apps/docs` 配置確認
2. **単一プロジェクト + docs 生成**: `docs/` 配置確認
3. **docs 選択なし**: 既存フロー回帰テスト
4. **依存バージョン確認**: Next 15/React 19 の正常動作

### **E2Eテスト（重要）**

- 生成プロジェクトの `pnpm install` 成功確認
- Nextra プロジェクトの `pnpm dev` 起動確認
- モノレポでの並列実行確認（`turbo run dev`）
- ビルド成功確認（`pnpm build`）

### **品質ゲート**

- ✅ 全テスト成功率 100%
- ✅ コードカバレッジ ≥ 80%
- ✅ TypeScript型チェック通過
- ✅ Lint/Format チェック通過

## ⚠️ リスク分析と対策

### **高リスク - 即座対応必要**

**🚨 依存バージョン衝突**

- **問題:** React 18（既存アプリ）vs React 19（Nextra）の共存
- **影響:** モノレポでのインストール失敗、型エラー
- **対策:**
  - peerDependencies による柔軟な依存管理
  - モノレポでの React 19 統一検討
  - 段階的移行計画の策定

### **中リスク - 計画的対応**

**📦 npm パッケージサイズ増大**

- **問題:** Nextra テンプレートによるファイルサイズ肥大化
- **影響:** インストール時間増加、開発者体験悪化
- **対策:**
  - `.npmignore` による不要ファイル除外
  - テンプレートの最小化
  - 動的ダウンロード方式の検討

**🔄 既存フロー破綻**

- **問題:** docs 選択なしの既存動作への影響
- **影響:** 既存ユーザーのワークフロー破綻
- **対策:**
  - 徹底的な回帰テスト
  - デフォルト動作の保持
  - 段階的ロールアウト

### **低リスク - 監視対応**

**⚡ 生成時間の延長**

- **問題:** ファイルコピー増加による処理時間増
- **影響:** CLI レスポンス悪化
- **対策:**
  - 並列処理の活用
  - 進捗表示の改善

## 📅 実装スケジュール

### **マイルストーン1 (1-2日): 基盤構築**

- テンプレート移設と型定義拡張
- 基本的な CLI UX 実装
- 単体テスト追加

### **マイルストーン2 (3-5日): コア機能**

- docs 処理ユーティリティ完成
- モノレポ統合機能実装
- 依存バージョン整合性解決
- 統合テスト追加

### **マイルストーン3 (1-2日): 拡張・最適化**

- 単一プロジェクト対応
- Turbo パイプライン最適化
- E2Eテスト追加
- ドキュメント更新

## 💡 実装後の利用方法

### **モノレポでの利用**

```bash
# プロジェクト作成時にdocs生成を選択
fluorite create my-project --monorepo
# ↓ ドキュメント生成: Yes を選択

# ドキュメント開発
pnpm --filter my-project-docs dev
# または
pnpm turbo run dev --filter=my-project-docs
```

### **単一プロジェクトでの利用**

```bash
# プロジェクト作成時にdocs生成を選択
fluorite create my-project --simple
# ↓ ドキュメント生成: Yes を選択

# ドキュメント開発
pnpm --filter ./docs dev
```

## 📚 参考情報

- **調査ベース**: docs/investigate/0014.md
- **リファレンス実装**: `web/` ディレクトリ (Next 15 + Nextra 4.6)
- **テンプレート移設元**: `refs/docs` → `templates/docs`
- **依存関係**: Next 15.5.4, React 19.1.0, nextra@4.6.0, nextra-theme-docs@4.6.0

## ✅ 完了条件

1. ✅ Nextra ドキュメントプロジェクト生成が正常動作
2. ✅ モノレポ・単一プロジェクト両方で動作確認
3. ✅ 既存フローに影響なし（回帰テスト通過）
4. ✅ 全テストが成功（単体・統合・E2E）
5. ✅ 依存バージョン衝突なし
6. ✅ パッケージサイズが許容範囲内
7. ✅ ドキュメント更新完了

---

**Status**: READY FOR IMPLEMENTATION
**Next Phase**: 実装フェーズ移行
