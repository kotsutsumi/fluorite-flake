# 実装計画: pnpmバージョン動的置換機能

## プロジェクト概要

**問題**: Next.js プロジェクト生成時に pnpm 10.18.1 への更新通知が出る
**原因**: テンプレート内の `packageManager: "pnpm@10.18.0"` が固定値
**解決策**: 動的バージョン置換による自動同期機能の実装

---

## 調査結果サマリー

### 問題の核心
- `templates/monorepo/package.json.template` で `packageManager` が `pnpm@10.18.0` に固定
- ローカル環境では `pnpm 10.18.1` が利用可能だが、生成プロジェクトでは 10.18.0 が強制
- Corepack により古いバージョンがダウンロードされ、更新通知が表示

### 影響範囲
- モノレポ構成の全プロジェクトタイプ（Next.js, Expo, Tauri）
- `validatePnpm()` はバージョン検証のみでテンプレート連携なし
- `copyMonorepoTemplates()` は {{PROJECT_NAME}} のみ置換

---

## 実装方針

### 採用アプローチ: 動的置換
**理由**: 根本解決、将来のバージョンアップ自動対応、既存ロジック活用

### 実装戦略
1. `validatePnpm()` 拡張 - バージョン情報取得機能追加
2. `copyMonorepoTemplates()` 拡張 - 動的バージョン置換機能追加
3. フロー統合 - 検証からテンプレート生成への情報受け渡し
4. 下位互換性確保 - 既存API破壊の回避

---

## 詳細実装タスク

### Phase 1: Core関数拡張 (優先度: 高)

#### Task 1.1: validatePnpm 関数拡張
- **ファイル**: `src/utils/pnpm-validator/validate-pnpm.ts`
- **内容**:
  - 新しい戻り値型 `PnpmValidationResult` 定義
  - バージョン文字列取得機能追加
  - 下位互換性確保（オーバーロードまたは新関数）
- **工数**: 4-6時間

#### Task 1.2: 型定義追加
- **ファイル**: `src/utils/pnpm-validator/index.ts`
- **内容**:
  - `PnpmValidationResult` 型のexport
  - 新関数のexport
- **工数**: 1時間

#### Task 1.3: copyMonorepoTemplates 拡張
- **ファイル**: `src/utils/monorepo-generator/copy-templates.ts`
- **内容**:
  - `pnpmVersion` パラメータ追加
  - `{{PNPM_VERSION}}` プレースホルダー置換機能
  - エラーハンドリング（フォールバック: "pnpm@latest"）
- **工数**: 3-4時間

### Phase 2: テンプレート更新 (優先度: 高)

#### Task 2.1: テンプレート修正
- **ファイル**: `templates/monorepo/package.json.template`
- **内容**:
  - `packageManager` を `"pnpm@{{PNPM_VERSION}}"` に変更
  - `engines.pnpm` を `">={{PNPM_MAJOR_VERSION}}"` に変更
- **工数**: 1時間

### Phase 3: フロー統合 (優先度: 中)

#### Task 3.1: commands.ts 修正
- **ファイル**: `src/commands/create/commands.ts`
- **内容**:
  - `validatePnpm()` の新しい戻り値処理
  - バージョン情報の保存と受け渡し
- **工数**: 2-3時間

#### Task 3.2: generator.ts 修正
- **ファイル**: `src/commands/create/generator.ts`
- **内容**:
  - `copyMonorepoTemplates()` 呼び出しにバージョン渡し
  - エラーハンドリング強化
- **工数**: 2時間

### Phase 4: テスト実装 (優先度: 中)

#### Task 4.1: ユニットテスト
- **ファイル**: `test/unit/src/utils/pnpm-validator/validate-pnpm.test.ts`
- **内容**:
  - 新機能のテストケース追加
  - エラーケースのテスト
- **工数**: 3-4時間

#### Task 4.2: 統合テスト
- **ファイル**: `test/unit/src/utils/monorepo-generator/copy-templates.test.ts`
- **内容**:
  - バージョン置換のテスト
  - フォールバック動作のテスト
- **工数**: 2-3時間

#### Task 4.3: E2Eテスト
- **内容**:
  - 実際のプロジェクト生成でのバージョン確認
  - 生成物の package.json 検証
- **工数**: 2時間

---

## ファイル変更計画

### 修正ファイル (7ファイル)

1. **`src/utils/pnpm-validator/validate-pnpm.ts`**
   - 新機能: バージョン情報取得
   - 破壊的変更: なし（下位互換性確保）

2. **`src/utils/pnpm-validator/index.ts`**
   - 追加: 新型・新関数のexport

3. **`src/utils/monorepo-generator/copy-templates.ts`**
   - 新機能: 動的バージョン置換
   - パラメータ追加: `pnpmVersion?: string`

4. **`src/commands/create/commands.ts`**
   - 修正: validatePnpm 戻り値処理
   - 追加: バージョン情報の受け渡し

5. **`templates/monorepo/package.json.template`**
   - 修正: プレースホルダー追加

### テストファイル (2ファイル)

6. **`test/unit/src/utils/pnpm-validator/validate-pnpm.test.ts`**
   - 追加: 新機能テスト

7. **`test/unit/src/utils/monorepo-generator/copy-templates.test.ts`**
   - 追加: バージョン置換テスト

---

## テスト戦略

### テスト方針
- **Docker環境**: 全テストをDocker環境で実行
- **複数バージョン**: pnpm 10.18.0, 10.18.1, 10.19.x でテスト
- **CI/CD**: 自動テスト実行とカバレッジ測定

### テスト分類

#### 1. ユニットテスト
- `validatePnpm()` 新機能テスト
  - 正常系: バージョン情報取得
  - 異常系: pnpm未インストール、古いバージョン
- `copyMonorepoTemplates()` バージョン置換テスト
  - 正常系: 適切なバージョン置換
  - 異常系: 不正なバージョン文字列処理

#### 2. 統合テスト
- 全体フローでのバージョン置換動作確認
- 異常系でのフォールバック動作確認
- 既存機能への影響確認（回帰テスト）

#### 3. E2Eテスト
- 実際のプロジェクト生成での動作確認
- 生成された `package.json` の検証
- `pnpm install` 実行時の更新通知確認

#### 4. パフォーマンステスト
- バージョン取得処理の実行時間測定
- メモリ使用量の監視

### 受入基準
- [ ] 生成されたプロジェクトの `packageManager` がローカルpnpmバージョンと一致
- [ ] `pnpm install` 実行時に更新通知が表示されない
- [ ] 既存プロジェクト生成機能に影響なし
- [ ] 全テストがパス（カバレッジ90%以上）
- [ ] エラー時に適切なフォールバック動作

---

## リスク分析と対策

### 高リスク

#### 1. 破壊的変更リスク
- **リスク**: validatePnpm の戻り値型変更による影響
- **対策**: オーバーロード使用で下位互換性確保
- **監視**: 型チェックエラーの監視

#### 2. テンプレート処理失敗リスク
- **リスク**: バージョン文字列解析・置換失敗
- **対策**:
  - 厳密なバリデーション実装
  - フォールバック機能（"pnpm@latest"）
  - 詳細なエラーメッセージ
- **監視**: 生成失敗率の監視

### 中リスク

#### 3. 後方互換性リスク
- **リスク**: 既存のプロジェクト生成への影響
- **対策**:
  - 段階的移行アプローチ
  - 充実した回帰テスト
  - カナリアリリース
- **監視**: 既存機能のエラー率監視

#### 4. 運用リスク
- **リスク**: 予期しない環境・バージョンでの動作不良
- **対策**:
  - 複数環境でのテスト
  - 詳細なログ出力
  - ユーザーガイダンス強化
- **監視**: サポート問合せ増加の監視

### 緊急時対応
- **ロールバック計画**:
  - 影響範囲の特定手順
  - 緊急修正パッチの準備
  - 従来バージョンへの戻し手順

---

## 実装スケジュール

### 総工数: 20-26時間（2.5-3.5営業日）

| Phase | 期間 | 担当者 | 依存関係 |
|-------|------|--------|----------|
| Phase 1: Core関数拡張 | 1.5日 | 開発者 | なし |
| Phase 2: テンプレート更新 | 0.5日 | 開発者 | Phase 1完了 |
| Phase 3: フロー統合 | 1日 | 開発者 | Phase 1-2完了 |
| Phase 4: テスト実装 | 1日 | 開発者 | Phase 1-3完了 |
| 統合テスト・検証 | 0.5日 | QA担当 | 全Phase完了 |

### マイルストーン
- **Week 1**: Phase 1-2 完了
- **Week 2**: Phase 3-4 完了、統合テスト
- **Week 2 End**: リリース判定

---

## 受入基準

### 機能要件
- [ ] ローカルpnpmバージョンの自動検出
- [ ] テンプレートへの動的バージョン置換
- [ ] 更新通知の非表示（主要目標）
- [ ] 既存機能の正常動作維持

### 非機能要件
- [ ] パフォーマンス: バージョン取得処理 < 100ms
- [ ] 信頼性: エラー時の適切なフォールバック
- [ ] 保守性: 明確なエラーメッセージとログ
- [ ] 拡張性: 将来のpnpmバージョンへの対応

### 品質要件
- [ ] テストカバレッジ: 90%以上
- [ ] 静的解析: ESLint/TypeScriptエラーなし
- [ ] ドキュメント: 実装変更内容の文書化
- [ ] レビュー: コードレビュー完了

---

## 実装後の検証計画

### 1. 機能検証
```bash
# ローカル環境での検証
pnpm -v  # バージョン確認
pnpm dev new test-project  # プロジェクト生成
cd test-project
grep "packageManager" package.json  # バージョン確認
pnpm install  # 更新通知の確認
```

### 2. 複数環境検証
- pnpm 10.18.0 環境
- pnpm 10.18.1 環境
- pnpm 10.19.x 環境（将来バージョン）

### 3. エッジケース検証
- pnpm未インストール環境
- 権限制限環境
- ネットワーク制限環境

---

## 次のアクション

1. **実装開始**: Phase 1から順次実装
2. **テスト環境準備**: Docker環境での複数pnpmバージョン設定
3. **CI/CD設定**: 自動テスト実行環境構築
4. **ドキュメント更新**: ユーザー向け変更内容の説明

---

**プラン作成日時**: 2025-10-08 04:27:05
**作成者**: Claude Code Assistant
**ステータス**: 実装準備完了

[ STATUS:DONE ]