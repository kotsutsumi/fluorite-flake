# 実装プラン: プロジェクト作成時のdev起動問題修正

**策定日時**: 2025年10月8日 13:48:04
**対象ブランチ**: feature/fix-dev-startup-issue
**調査結果**: docs/investigate/investigate_20251008_134308.md
**優先度**: 高（開発者体験に直接影響）

## 概要

### 問題要約
monorepoプロジェクト作成時にdocsプロジェクトが含まれる場合、`pnpm dev`実行時に「next: command not found」エラーが発生。根本原因はdocsプロジェクトの依存関係がインストールされていないこと。

### 解決方針
1. **主要修正**: プロジェクト生成完了後のmonorepo再インストール
2. **予防策**: WorkspaceManagerに依存関係チェック機能追加
3. **UX改善**: エラーメッセージと進捗表示の改善

### 影響範囲
- monorepoモードのプロジェクト作成プロセス
- フルスタックテンプレート（nextjs-fullstack-admin等）
- WorkspaceManager機能
- 国際化メッセージ

## 実装計画

### フェーズ1: 主要修正（高優先度）

#### タスク1: generator.tsの修正
**ファイル**: `src/commands/create/generator.ts`
**内容**:
- `generateProject()`関数にmonorepo判定ロジック追加
- プロジェクト生成完了後の`pnpm install`再実行処理追加
- 詳細な進捗表示とエラーハンドリング

**実装詳細**:
```typescript
// generateProject()関数の最後に追加
if (isMonorepoProject) {
  // monorepoの場合のみ再インストール実行
  await executePostInstallForMonorepo(projectPath);
}
```

#### タスク2: 国際化メッセージ追加
**ファイル**: `src/i18n.ts`
**内容**:
- 再インストール関連メッセージ（英語・日本語）
- エラーメッセージの改善
- 進捗表示メッセージ

### フェーズ2: 予防策実装（中優先度）

#### タスク3: WorkspaceManager改善
**ファイル**: `src/utils/workspace-manager/workspace-manager.ts`
**内容**:
- `detectWorkspaces()`でnode_modules存在チェック追加
- `generateRootScripts()`で依存関係検証
- 依存関係未インストールの場合の警告とスキップ処理

**実装詳細**:
```typescript
// detectWorkspaces()に追加
const hasNodeModules = await fs.access(
  path.join(workspaceDir, 'node_modules')
).then(() => true).catch(() => false);

if (!hasNodeModules) {
  // 警告表示とdev scriptからの除外
}
```

#### タスク4: エラーハンドリング強化
**対象**:
- プロジェクト作成プロセス全体
- 再インストール処理
- WorkspaceManager機能

### フェーズ3: テストと検証（必須）

#### タスク5: ユニットテスト実装
**新規ファイル**: `test/unit/generator-monorepo-install.test.ts`
**内容**:
- `generateProject()`の再インストール機能テスト
- monorepoとsimple判定ロジックテスト
- エラーハンドリングテスト

**新規ファイル**: `test/unit/workspace-manager-dependency-check.test.ts`
**内容**:
- 依存関係チェック機能テスト
- node_modules存在チェックテスト
- dev script生成改善テスト

#### タスク6: 機能テスト実装
**新規ファイル**: `test/functional/create-project-dev-startup.test.ts`
**内容**:
- プロジェクト作成からdev起動までのE2Eテスト
- nextjs-fullstack-adminテンプレートでの検証
- docsプロジェクト依存関係インストール確認
- 生成されたdev scriptの動作確認

#### タスク7: 回帰テスト実行
**対象**:
- 既存の全テストスイート
- 複数テンプレートでの動作確認
- Docker環境でのテスト実行

## ファイル変更計画

### 新規作成ファイル
1. `test/unit/generator-monorepo-install.test.ts` - generator機能のunit test
2. `test/functional/create-project-dev-startup.test.ts` - dev起動問題のE2Eテスト
3. `test/unit/workspace-manager-dependency-check.test.ts` - WorkspaceManager新機能テスト

### 修正ファイル
1. `src/commands/create/generator.ts`
   - generateProject()関数にmonorepo再インストール処理追加
   - エラーハンドリング強化

2. `src/utils/workspace-manager/workspace-manager.ts`
   - detectWorkspaces()に依存関係チェック追加
   - generateRootScripts()の改善

3. `src/i18n.ts`
   - 再インストール関連メッセージ追加（英語・日本語）
   - エラーメッセージ改善

4. `test/unit/workspace-manager.test.ts`
   - 新機能のテストケース追加

### 削除ファイル
なし（既存機能を維持）

## テスト戦略

### ユニットテスト
- **カバレッジ目標**: 新規実装部分100%
- **重点項目**: monorepo判定、再インストール処理、依存関係チェック
- **モック**: fs操作、pnpmコマンド実行、プロセス実行

### 機能テスト
- **テンプレート**: nextjs-fullstack-admin、expo with docs
- **プロジェクトタイプ**: monorepo、simple
- **検証項目**: プロジェクト作成成功、dev起動成功、依存関係インストール

### Docker環境テスト
- **実行環境**: 本番と同等のDocker環境
- **対象**: 全テストスイート
- **重点**: ファイルシステム操作、パッケージマネージャー実行

### 回帰テスト
- **既存機能**: プロジェクト作成全パターン
- **パフォーマンス**: 作成時間の大幅増加がないこと
- **互換性**: 既存プロジェクトとの互換性維持

## リスク分析と対策

### 高リスク
1. **既存機能への影響**
   - **リスク**: プロジェクト作成プロセス変更による既存機能破損
   - **対策**: 包括的回帰テスト、最小限変更原則
   - **軽減策**: フィーチャーフラグ、段階的ロールアウト

2. **パフォーマンス影響**
   - **リスク**: 追加のpnpm installによる作成時間増加
   - **対策**: monorepoでのみ実行、条件付き実行
   - **軽減策**: 並列処理検討、進捗表示改善

### 中リスク
3. **エラーハンドリング不足**
   - **リスク**: 再インストール中エラーでプロジェクト不完全状態
   - **対策**: try-catch、ロールバック機能、詳細エラーメッセージ
   - **軽減策**: テスト環境での十分な検証

4. **国際化対応漏れ**
   - **リスク**: 新メッセージが英語のみ
   - **対策**: i18n.ts更新、両言語テスト
   - **軽減策**: メッセージレビュー実施

### 低リスク
5. **WorkspaceManager改善の副作用**
   - **リスク**: 依存関係チェックで予期しない動作
   - **対策**: 段階的実装、フィーチャーフラグ
   - **軽減策**: 詳細テストケース

## 受入基準

### 機能要件
- ✅ docsプロジェクト付きmonorepoで`pnpm dev`が成功する
- ✅ simpleプロジェクトで既存機能に影響がない
- ✅ nextjs-fullstack-adminテンプレートが正常動作する
- ✅ WorkspaceManagerが依存関係未インストールを適切に処理する

### 品質要件
- ✅ 全ユニットテストが通る（新規・既存）
- ✅ 機能テストが通る（E2Eシナリオ）
- ✅ Docker環境でのテスト実行が成功する
- ✅ コードカバレッジが維持される

### UX要件
- ✅ 英語・日本語両方でエラーメッセージ対応
- ✅ 再インストール時の適切な進捗表示
- ✅ プロジェクト作成時間の大幅増加がない（+30秒以内）

### 技術要件
- ✅ TypeScriptビルドエラーなし
- ✅ リント・フォーマットエラーなし
- ✅ 既存APIの互換性維持

## 実装タイムライン

### 第1週: 主要修正
- Day 1-2: generator.ts修正とユニットテスト
- Day 3: 国際化メッセージ追加
- Day 4-5: 機能テスト実装と検証

### 第2週: 予防策と最終検証
- Day 1-2: WorkspaceManager改善
- Day 3: 追加テスト実装
- Day 4: 回帰テスト実行
- Day 5: 最終検証とドキュメント更新

## 関連ファイル

### 主要実装ファイル
- `src/commands/create/generator.ts`
- `src/utils/workspace-manager/workspace-manager.ts`
- `src/i18n.ts`

### テストファイル
- `test/unit/generator-monorepo-install.test.ts`
- `test/functional/create-project-dev-startup.test.ts`
- `test/unit/workspace-manager-dependency-check.test.ts`

### 設定ファイル
- `package.json`
- `vitest.config.ts`

### 調査・計画ファイル
- `docs/investigate/investigate_20251008_134308.md`
- `docs/plan/plan_20251008_134804.md` (本ファイル)

## 次のステップ

1. **即座実行**: フェーズ1の実装開始
2. **GitHub Issue**: 詳細なIssue作成とラベル設定
3. **定期レビュー**: 実装進捗の定期確認
4. **品質チェック**: 各フェーズ完了時の品質ゲート実行

---

**ステータス**: [ STATUS:READY ]
**実装準備**: 完了
**次のフェーズ**: IMPLEMENT