# Next.jsプロジェクト生成における環境変数管理の改善実装計画

**計画策定日**: 2025年10月8日 07:29:00
**基準調査**: `docs/investigate/0012.md`
**計画ステータス**: [ STATUS:DONE ]

## 概要

Next.jsプロジェクト生成時の環境変数セットに関する5つの主要課題を解決する実装計画です。Turso選択時のdev環境URL問題、Blob変数重複、未選択プロバイダ変数残存、DATABASE_URL重複、BETTER_AUTH_SECRET固定値の課題に対応します。

## 課題背景

### 主要課題
1. **Turso dev URL問題**: `skipProvisioning`時にdev環境でSQLite URL維持
2. **Blob変数重複**: `_DEV`/`_STG`サフィックス付きと通常版の重複定義
3. **未選択プロバイダ変数**: Turso選択時でもSupabase変数が残存
4. **DATABASE_URL重複**: 3つの変数が同一値で設定
5. **BETTER_AUTH_SECRET固定値**: `change-me-*`ハードコード

### 影響範囲
- 開発者のセットアップ体験悪化
- セキュリティリスク（固定シークレット）
- 環境変数管理の複雑化
- プロダクション運用時の設定ミス誘発

## 実装方針

### 1. Turso dev URL自動補完
**方針**: `skipProvisioning`時でもdatabase namingを使用してdev URLを生成
- `credentials`未取得時: `fallbackUrl(naming.dev)`でdev環境URL生成
- 手動修正不要な状態を提供

### 2. Blob変数単一化
**方針**: `_DEV`サフィックス付き重複を削除
- テンプレートから重複定義を除去
- `buildBlobEnvReplacements`の対応プレースホルダー削除

### 3. 選択外プロバイダ変数除去
**方針**: 選択したプロバイダ以外の環境変数を削除
- Turso選択時: Supabase関連変数除去
- Supabase選択時: Turso関連変数除去

### 4. DATABASE_URL系整理
**方針**: プロバイダごとに必要な変数のみ設定
- **Turso**: `DATABASE_URL`と`PRISMA_DATABASE_URL`のみ
- **Supabase**: `DATABASE_URL`、`DIRECT_DATABASE_URL`、`PRISMA_DATABASE_URL`

### 5. BETTER_AUTH_SECRET自動生成
**方針**: CLI実行時に環境ごとに固有のシークレットを生成
- `crypto.randomBytes(32).toString('hex')`使用
- 既存ファイル再実行時は値があればスキップ

## 詳細タスク分解

### 【優先度1: Critical】緊急修正

#### Task 1.1: Turso dev URL自動補完修正
- **対象ファイル**: `src/commands/create/template-generators/nextjs-fullstack-admin.ts:196-248`
- **実装内容**:
  - `buildEnvReplacements`関数でdev環境URLロジック修正
  - `credentials`未取得時の`fallbackUrl(naming.dev)`適用
  - `DEV_DATABASE_URL`等への自動設定実装
- **受入基準**: `skipProvisioning`時でもdev環境で`libsql://`URL生成

#### Task 1.2: BETTER_AUTH_SECRET自動生成実装
- **対象ファイル**: `src/commands/create/template-generators/nextjs-fullstack-admin.ts`（新規関数追加）
- **実装内容**:
  - シークレット生成ユーティリティ関数作成
  - `configureEnvironmentFiles`後処理でシークレット置換
  - 既存値チェック機能（再実行時スキップ）
- **受入基準**: 4つの`.env*`で固有の32バイトランダム値設定

### 【優先度2: High】構造改善

#### Task 2.1: Blob変数重複削除
- **対象ファイル**:
  - `templates/nextjs-fullstack-admin/.env*`（4ファイル）
  - `src/commands/create/template-generators/nextjs-fullstack-admin.ts`
- **実装内容**:
  - 全`.env*`から`*_DEV`/`*_STG`/`*_PROD`サフィックス版削除
  - `buildBlobEnvReplacements`対応プレースホルダー削除
- **受入基準**: Blob変数の単一定義のみ残存

#### Task 2.2: 未選択プロバイダ変数除去
- **対象ファイル**: `src/commands/create/template-generators/nextjs-fullstack-admin.ts`
- **実装内容**:
  - `buildEnvReplacements`で選択外プロバイダ変数削除ロジック追加
  - プレースホルダー条件付き設定実装
- **受入基準**: 選択したプロバイダの変数のみ設定

### 【優先度3: Medium】最適化

#### Task 3.1: DATABASE_URL系整理
- **対象ファイル**: `src/commands/create/template-generators/nextjs-fullstack-admin.ts`
- **実装内容**:
  - Turso選択時: `DIRECT_DATABASE_URL`削除ロジック
  - Supabase選択時: 全URL変数維持
- **受入基準**: プロバイダごと最適な変数セット

### 【優先度4: Test】テスト実装

#### Task 4.1: ユニットテスト拡張
- **対象ファイル**: `test/unit/src/commands/create/template-generators/nextjs-fullstack-admin.test.ts`
- **実装内容**:
  - `skipProvisioning`ケースのURL生成テスト
  - BETTER_AUTH_SECRET生成テスト
  - Blob変数重複除去テスト
  - プロバイダ別変数除去テスト
- **受入基準**: 修正機能の90%以上カバレッジ

#### Task 4.2: 統合テスト新規作成
- **対象ファイル**: `test/integration/nextjs-fullstack-admin-env.test.ts`（新規）
- **実装内容**:
  - Turso + skipProvisioning統合テスト
  - Supabase選択統合テスト
  - 生成された`.env*`ファイル検証
- **受入基準**: end-to-end での環境変数生成検証

## ファイル変更計画

### 修正対象ファイル
1. **`src/commands/create/template-generators/nextjs-fullstack-admin.ts`**
   - `buildEnvReplacements`関数の大幅修正
   - BETTER_AUTH_SECRET生成機能追加

2. **環境変数テンプレート（4ファイル）**
   - `templates/nextjs-fullstack-admin/.env`
   - `templates/nextjs-fullstack-admin/.env.development`
   - `templates/nextjs-fullstack-admin/.env.staging`
   - `templates/nextjs-fullstack-admin/.env.prod`
   - Blob変数重複削除

3. **テストファイル**
   - 既存: `test/unit/src/commands/create/template-generators/nextjs-fullstack-admin.test.ts`
   - 新規: `test/integration/nextjs-fullstack-admin-env.test.ts`

### 実装順序
1. **Phase 1**: Critical修正（Task 1.1, 1.2）
2. **Phase 2**: 構造改善（Task 2.1, 2.2）
3. **Phase 3**: 最適化（Task 3.1）
4. **Phase 4**: テスト整備（Task 4.1, 4.2）

## テスト戦略

### テスト方針
- **ユニットテスト**: `buildEnvReplacements`関数の各機能個別検証
- **統合テスト**: プロジェクト生成全体のflow検証
- **回帰テスト**: 既存機能への影響排除確認
- **Docker環境実行**: 全テストをDocker環境で実行

### 主要テストケース
1. **Turso dev URL自動補完**
   - `credentials`有無での正常URL生成
   - `naming.dev`カスタム値対応

2. **BETTER_AUTH_SECRET自動生成**
   - 32バイトランダム値生成
   - 環境ごと固有値設定
   - 既存値スキップ動作

3. **Blob変数・プロバイダ変数除去**
   - 重複定義削除確認
   - 選択外プロバイダ変数除去確認

4. **エラーケース**
   - 不正設定値処理
   - ファイル権限エラー対応

## リスク分析と対策

### 高リスク
1. **既存プロジェクトへの影響**
   - **リスク**: 生成物の互換性破綻
   - **対策**: 段階的リリース、テンプレートバージョニング

2. **Blob変数削除の後方互換性**
   - **リスク**: 既存スクリプトの動作停止
   - **対策**: `env-clear-vercel.ts`との調整、移行ガイド提供

### 中リスク
3. **BETTER_AUTH_SECRET生成エラー**
   - **リスク**: `crypto.randomBytes`失敗
   - **対策**: フォールバック機能、エラーハンドリング強化

4. **DATABASE_URL系変更の影響**
   - **リスク**: Prisma CLI動作不良
   - **対策**: 各プロバイダでの動作確認、ドキュメント更新

## 実装スケジュール

### Week 1: Critical修正
- Day 1-2: Task 1.1 (Turso dev URL修正)
- Day 3-4: Task 1.2 (BETTER_AUTH_SECRET自動生成)
- Day 5: 統合テスト・動作確認

### Week 2: 構造改善・最適化
- Day 1-2: Task 2.1 (Blob変数重複削除)
- Day 3-4: Task 2.2 (未選択プロバイダ変数除去)
- Day 5: Task 3.1 (DATABASE_URL系整理)

### Week 3: テスト整備・品質確保
- Day 1-3: Task 4.1, 4.2 (テスト拡張・新規作成)
- Day 4-5: 回帰テスト、ドキュメント更新

## 受入基準

### 機能要件
1. **Turso選択 + skipProvisioning時**
   - `.env.development`でdev環境URL自動生成
   - 手動修正不要な状態

2. **BETTER_AUTH_SECRET**
   - 4つの`.env*`で固有の32バイトランダム値
   - 再実行時の既存値保持

3. **変数クリーンアップ**
   - Blob変数重複削除完了
   - 選択外プロバイダ変数除去完了
   - プロバイダごと最適な変数セット

### 品質要件
1. **テストカバレッジ**: 修正部分90%以上
2. **回帰テスト**: 既存機能正常動作確認
3. **パフォーマンス**: プロジェクト生成時間変化なし
4. **セキュリティ**: シークレット生成の暗号学的安全性

### 非機能要件
1. **互換性**: 既存生成プロジェクトとの共存
2. **保守性**: コードの可読性・拡張性維持
3. **ドキュメント**: 変更内容の十分な文書化

## まとめ

本実装計画により、Next.jsプロジェクト生成時の環境変数管理における5つの主要課題が解決され、開発者体験の大幅な向上とセキュリティ強化が実現されます。段階的な実装とテスト戦略により、品質と安定性を確保しながら改善を進めます。

---

**次のアクション**: 実装フェーズへの移行
**実装開始条件**: 本計画の承認完了後
**完了予定**: 3週間後