# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリのコードを扱う際のガイダンスを提供します。

## 基本

- 応答は、全て日本語で行う事
- **コード変更後の自動処理**: ファイルの作成・編集・削除を行った場合、必ずイテレーション作業を実行する事

## 実装方針

Typescriptのモジュールは、`xxxx.ts`でまとめるよりも、

```
xxxx/index.ts # exports
    /hoge1.ts # some func
    /hoge2.ts # some func
```

のように、各関数、型などは分割して作成する事

## イテレーション作業

**自動実行**: コードの修正・追加・削除を行った際は、**必ず**以下の処理を実行してください。

**手動実行**: ユーザーが `/iter` と入力した場合

**重要**:
- ファイルの作成・編集・削除などのコード変更を行った場合、**自動的に**以下の作業を順番に実行してください
- `/iter` コマンドが入力された場合も、同様に以下の作業を実行してください
- 他の作業は中断してこの処理を優先してください

### イテレーション作業の実行順序

1. レビュー作業
2. 実装作業
3. クリーンアップ
4. EOFタグ追加
5. コードコメント作業

各段階で進捗を報告し、完了後は次の段階に進んでください。

### レビュー作業

- `coderabbit --prompt-only` を実行した結果を基にして修正作業を行うこと

#### レポート作成

`docs/reviews/<ソースのディレクトリ>/<ファイル名>.md` として、修正されたファイルの処理内容を詳細に説明したドキュメントを作成する事
作成されていないファイルが無いかを確認して、未作成のものは作成する事
コードが修正されている可能性があるので、一通りドキュメントと差異が無いか確認する事

### 実装作業

`docs/plans` 下のファイルがある場合、実装計画のファイルです。
内容を確認して、実装を行ってください。
ファイル内に、`[ STATUS:READY ]` を記載されている時だけ実装を実行してください。
実装後、`docs/implement-reports` に同じファイル名で、実装報告を記載してください。

この作業を行った際は、分かり易く実装作業をしたことをコンソールに表示してください。

**実装作業の表示例**:
```
🔧 実装作業開始: docs/plans/[ファイル名] の内容を実装中...
✅ 実装完了: [実装した機能の概要]
📝 実装報告作成: docs/implement-reports/[ファイル名].md
```

### クリーンアップ

```
/fl:cleanup --loop --wave-mode --delegate --until-perfect --ultrathink "pnpm lint && pnpm format && pnpm build で出る警告・エラーを全て解消"
```

### 4. srcディレクトリ下の .ts, .tsx, .js, .jsxの末尾にEOFを付ける

ファイルの最後に

```
// EOF
```

を必ず付ける事

### 5. コードコメント

- コードのコメントは全て日本語で記述する事
- 可能な限りコードの処理内容をコメントで記載する事
- 既存のコード内のコメントで日本語になっていないものは翻訳して修正する事
- 特にtestディレクトリ下のテストコードは、ステップバイステップの詳細なコメントを記述する事

## 開発コマンド

```bash
# 開発ワークフロー
pnpm dev                 # デバッグ出力付きで開発モードでCLIを実行
pnpm build               # TypeScriptをdist/にビルド
pnpm test                # Vitestでユニットテストを実行
pnpm test:run            # ウォッチモードなしでテストを一度実行
pnpm test:coverage       # カバレッジレポート付きでテストを実行

# コード品質
pnpm lint                # Biomeでリント
pnpm format              # Biomeでフォーマット
pnpm check               # リントとフォーマットチェックの両方を実行

# 特定コンポーネントのテスト
pnpm test src/debug      # 特定のモジュールをテスト
pnpm test src/header
```

## 高レベルアーキテクチャ

### CLIフレームワークとコマンド構造

このプロジェクトは[Citty](https://github.com/unjs/citty)を使用したCLIツールで、モジュラーなコマンド構造を採用：

- **エントリーポイント**: `src/cli.ts` - 開発モード初期化付きのメインCLIエントリーポイント
- **コマンド**: `src/commands/create.ts` - TypeScript優先テンプレート付きのプロジェクト作成ロジック
- **コアモジュール**: 各ユーティリティは集中した責務を持つ（debug、header、i18n）

### 国際化（i18n）システム

プロジェクトには包括的なi18nシステム（`src/i18n.ts`）があります：

- **ロケール検出**: 環境変数（`FLUORITE_LOCALE`、`LANG`など）とIntl APIから自動検出
- **サポートロケール**: 英語（`en`）と日本語（`ja`）、英語がフォールバック
- **メッセージ構造**: CLI出力、コマンド説明、デバッグ情報用の型付きメッセージインターフェース
- **使用方法**: すべてのユーザー向け文字列は`getMessages()`または`getMessagesForLocale()`を使用

### 開発モードとデバッグシステム

`NODE_ENV=development`の場合、CLIは広範囲なデバッグを提供：

- **ワークスペース設定**: `temp/dev`ディレクトリを作成し、作業ディレクトリを変更
- **デバッグ出力**: 開発情報用のグレースタイルのコンソール出力
- **環境情報**: 現在のディレクトリ、Nodeバージョン、CLI引数を表示
- **デバッグログ**: `debugLog()`関数による条件付きデバッグメッセージ

### テストアーキテクチャ

Vitestによる多層テスト：

- **ユニットテスト**: `test/unit/` - 個別関数の高速で独立したテスト
- **機能テスト**: `test/functional/` - CLIコマンドの統合テスト
- **シナリオテスト**: `test/scenario/` - エンドツーエンドテスト（Flutter/Tauriは現在無効）
- **テスト設定**: 異なるタイムアウトと並行設定を持つ個別プロジェクト

### プロジェクト生成システム

複数フレームワーク用のボイラープレートプロジェクトを生成するコア機能：

- **サポートタイプ**: `nextjs`、`expo`、`tauri`でTypeScriptがデフォルトテンプレート
- **テンプレートシステム**: プロジェクトタイプごとの設定可能なテンプレート
- **バリデーション**: ユーザーフレンドリーなエラーメッセージ付きのタイプとテンプレート検証
- **スピナーUI**: ユーザーフィードバック用の`ora`による進捗表示

## 主要パターンと規約

### コード組織

- **単一責任**: 各モジュールは一つの明確な目的を持つ（debug、header、i18nなど）
- **TypeScript優先**: デフォルトテンプレートはTypeScript、全体で適切な型定義
- **ESMモジュール**: インポートで`.js`拡張子を使用するESモジュール
- **関数型スタイル**: モジュールは集中したユーティリティ関数をエクスポート

### エラーハンドリング

- **バリデーション優先**: 有用なエラーメッセージ付きの処理前入力検証
- **グレースフル失敗**: バリデーション失敗時の適切な終了コードでのコマンド終了
- **開発コンテキスト**: トラブルシューティング用の開発モードでの追加デバッグ出力

### ユーザーエクスペリエンス

- **国際化対応**: すべてのユーザー向けテキストが英語と日本語をサポート
- **進捗フィードバック**: 長時間実行操作用のスピナーアニメーション
- **有用なエラー**: 利用可能オプション付きの明確なエラーメッセージ
- **開発支援**: 開発モードでの広範囲なデバッグ情報

### テストパターン

- **包括的モッキング**: 外部依存関係（fs、chalk、process）の適切なモック
- **ロケールテスト**: 英語と日本語メッセージバリアントの両方を検証
- **環境分離**: テストは環境変数を保存・復元
- **日本語コメント**: テストファイルにはテスト目的を説明する詳細な日本語コメント

## 重要な実装注意事項

### Node.js互換性

- **最小バージョン**: Node.js 20.0.0+が必要
- **ファイルシステム**: 非推奨の`fs.rmdirSync()`の代わりに最新の`fs.rmSync()`を使用
- **ESMのみ**: package.jsonで`"type": "module"`の純粋ESMパッケージ

### 開発ワークフロー

- **ホットリロード**: `pnpm dev`は即座のフィードバック用にtsxで実行
- **品質ゲート**: リントとフォーマット用のBiome（ESLint/Prettierの置き換え）
- **カバレッジ**: CLIエントリーポイントを除外したカバレッジレポート付きVitest
- **多言語**: テストコメントとユーザー出力の両方が英語と日本語をサポート

### フレームワーク統合

CLIは複数のフレームワークタイプをスキャフォールドするよう設計、各々特定の規約を持つ：

- 全フレームワークでTypeScriptがデフォルト選択
- フレームワーク固有のテンプレートと検証ルール
- 新しいプロジェクトタイプ追加用の拡張可能なコマンド構造
