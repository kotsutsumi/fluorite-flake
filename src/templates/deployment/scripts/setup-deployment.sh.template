#!/usr/bin/env bash
set -e

PROJECT_NAME="{{projectName}}"
ENV=${1:-"prod"}

echo "ðŸš€ Setting up Vercel deployment for $PROJECT_NAME ($ENV environment)..."

# Check if vercel CLI is installed
if ! command -v vercel &> /dev/null; then
    echo "âš ï¸ Vercel CLI not found. Installing..."
    npm i -g vercel
fi

# Login to Vercel (if not already logged in)
echo "ðŸ“ Checking Vercel authentication..."
if ! vercel whoami &> /dev/null; then
    echo "Logging in to Vercel..."
    vercel login
fi

# Link to Vercel project
if [ ! -f ".vercel/project.json" ]; then
    echo "ðŸ”— Linking to Vercel project..."
    vercel link --yes
else
    echo "âœ… Already linked to Vercel project"
fi

# Set environment-specific variables
echo "ðŸ” Setting environment variables for $ENV..."

BRANCH_FLAG=""

if [ "$ENV" == "prod" ] || [ "$ENV" == "production" ]; then
    ENV_FILE=".env.production"
    ENV_FLAG="--environment=production"
    BRANCH_FLAG=""
    ENV_NAME="production"
elif [ "$ENV" == "stg" ] || [ "$ENV" == "staging" ]; then
    ENV_FILE=".env.staging"
    ENV_FLAG="--environment=preview"
    BRANCH_FLAG="--git-branch=staging"
    ENV_NAME="staging"
elif [ "$ENV" == "dev" ] || [ "$ENV" == "development" ]; then
    ENV_FILE=".env.development"
    ENV_FLAG="--environment=preview"
    BRANCH_FLAG="--git-branch=development"
    ENV_NAME="development"
else
    echo "âŒ Invalid environment. Use: prod, staging, or dev"
    exit 1
fi

{{blobStorageSetup}}

# Load environment variables from file and set them in Vercel
if [ -f "$ENV_FILE" ]; then
    echo "ðŸ“„ Loading environment variables from $ENV_FILE..."

    # Read each line from the env file
    while IFS= read -r line; do
        # Skip comments and empty lines
        if [[ ! "$line" =~ ^# ]] && [[ -n "$line" ]]; then
            # Extract key and value
            KEY=$(echo "$line" | cut -d '=' -f 1)
            VALUE=$(echo "$line" | cut -d '=' -f 2- | sed 's/^"//' | sed 's/"$//')

            # Set the environment variable in Vercel
            echo "   Setting $KEY..."
            echo "$VALUE" | vercel env add "$KEY" $ENV_FLAG $BRANCH_FLAG --yes 2>/dev/null || true
        fi
    done < "$ENV_FILE"

    echo "âœ… Environment variables set for $ENV_NAME"
else
    echo "âš ï¸ No environment file found at $ENV_FILE"
fi

{{databaseMigrations}}

# Deploy to Vercel
echo "ðŸš€ Deploying to Vercel ($ENV_NAME)..."

if [ "$ENV" == "prod" ] || [ "$ENV" == "production" ]; then
    vercel --prod
else
    DEPLOYMENT_URL=$(vercel --preview)
    echo ""
    echo "âœ… Deployment complete!"
    echo "ðŸ”— Preview URL: $DEPLOYMENT_URL"

    # Create alias for staging/dev environments
    if [ "$ENV" == "stg" ] || [ "$ENV" == "staging" ]; then
        ALIAS="${PROJECT_NAME}-staging.vercel.app"
        vercel alias $DEPLOYMENT_URL $ALIAS
        echo "ðŸ”— Staging alias: https://$ALIAS"
    elif [ "$ENV" == "dev" ] || [ "$ENV" == "development" ]; then
        ALIAS="${PROJECT_NAME}-dev.vercel.app"
        vercel alias $DEPLOYMENT_URL $ALIAS
        echo "ðŸ”— Development alias: https://$ALIAS"
    fi
fi

echo ""
echo "âœ… Deployment setup complete for $ENV_NAME!"
echo ""
echo "ðŸ“š Next steps:"
echo "   - Visit your deployment URL to see the app"
echo "   - Run '{{packageManager}} run deploy:$ENV' for future deployments"
echo "   - Run '{{packageManager}} run deploy:destroy' to remove everything"