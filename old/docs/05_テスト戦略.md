# Fluorite-flake テスト戦略

## 1. テスト戦略概要

Fluorite-flakeは4層のテスト戦略を採用しており、高品質なソフトウェアの継続的な提供を実現しています。各テスト層は独自の責任範囲を持ち、段階的な品質保証を行います。

### 1.1 テスト戦略ピラミッド

```
┌─────────────────────────────────────────────────────────────────┐
│                      テスト戦略ピラミッド                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                         ┌─────────────┐                         │
│                         │     E2E     │ (Playwright)            │
│                         │  ブラウザ   │ 実行時間: 数分〜数十分   │
│                         │  自動化     │ 頻度: リリース前        │
│                         └─────────────┘                         │
│                                                                 │
│                     ┌─────────────────────┐                     │
│                     │      Scenario       │ (Vitest)            │
│                     │   シナリオテスト    │ 実行時間: 数分       │
│                     │                     │ 頻度: CI/CD         │
│                     └─────────────────────┘                     │
│                                                                 │
│                 ┌─────────────────────────────┐                 │
│                 │       Functional           │ (Vitest)         │
│                 │      機能テスト             │ 実行時間: 数秒〜  │
│                 │                             │         数十秒   │
│                 └─────────────────────────────┘ 頻度: 毎コミット │
│                                                                 │
│             ┌─────────────────────────────────────┐             │
│             │            Unit Tests              │ (Vitest)     │
│             │          ユニットテスト             │ 実行時間:     │
│             │                                     │ <100ms/test  │
│             └─────────────────────────────────────┘ 頻度: 開発中  │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                          実行方針                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  開発時 (pnpm test):          Unit + Functional                 │
│  CI/CD (pnpm test:all):       Unit + Functional + Scenario      │
│  リリース前:                   全テスト + E2E                   │
│  ナイトリー:                   全テスト + パフォーマンス         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 2. テスト実行環境

### 2.1 Vitest設定（vitest.config.ts）

```
┌─────────────────────────────────────────────────────────┐
│                   Vitest設定概要                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  テストフレームワーク: Vitest v3.2.4                   │
│  実行環境: Node.js                                      │
│  グローバル設定: true                                   │
│                                                         │
│  プロジェクト分割:                                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ unit:        test/unit/**/*.test.ts                 │ │
│  │ ├ タイムアウト: 10秒                                │ │
│  │ ├ 実行モード: 並列                                  │ │
│  │ └ 目的: 高速フィードバック                          │ │
│  │                                                     │ │
│  │ functional:  test/functional/**/*.test.ts           │ │
│  │ ├ タイムアウト: 30秒                                │ │
│  │ ├ 実行モード: 並列                                  │ │
│  │ └ 目的: 統合機能検証                                │ │
│  │                                                     │ │
│  │ scenario:    test/scenario/**/*.test.ts             │ │
│  │ ├ タイムアウト: 5分                                 │ │
│  │ ├ 実行モード: シーケンシャル（maxConcurrency: 1）   │ │
│  │ ├ スレッド: シングルスレッド強制                    │ │
│  │ └ 目的: エンドツーエンド検証                        │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  カバレッジ設定:                                        │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 対象: src/**/*.ts                                   │ │
│  │ 除外:                                               │ │
│  │ ├ src/cli.ts           # CLIエントリポイント        │ │
│  │ ├ src/index.ts         # ライブラリエクスポート     │ │
│  │ ├ **/*.d.ts           # 型定義ファイル              │ │
│  │ ├ *.config.ts         # 設定ファイル                │ │
│  │ └ test/               # テストディレクトリ          │ │
│  │                                                     │ │
│  │ レポート形式: text, json, html                      │ │
│  │ 目標カバレッジ: 90%以上                             │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 2.2 実行コマンド

```
┌─────────────────────────────────────────────────────────┐
│                  テスト実行コマンド                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  開発者用コマンド:                                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ pnpm test              # Unit + Functional (推奨)   │ │
│  │ pnpm test:unit         # ユニットテストのみ         │ │
│  │ pnpm test:functional   # 機能テストのみ             │ │
│  │ pnpm test:watch        # ウォッチモード             │ │
│  │ pnpm test:ui           # GUI テストランナー         │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  CI/CD用コマンド:                                       │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ pnpm test:all          # 全プロジェクト             │ │
│  │ pnpm test:scenario     # シナリオテスト（重い）     │ │
│  │ pnpm test:coverage     # カバレッジレポート付き     │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  E2Eテスト:                                             │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ pnpm test:e2e          # Playwrightブラウザテスト   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  実行時間目安:                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ pnpm test              ~30秒                        │ │
│  │ pnpm test:unit         ~10秒                        │ │
│  │ pnpm test:functional   ~20秒                        │ │
│  │ pnpm test:scenario     ~5分                         │ │
│  │ pnpm test:e2e          ~10分                        │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 3. ユニットテスト（test/unit/）

### 3.1 ユニットテスト設計原則

```
┌─────────────────────────────────────────────────────────┐
│                ユニットテスト設計原則                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  F.I.R.S.T 原則:                                        │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ Fast      - 高速実行 (<100ms/test)                  │ │
│  │ Independent - テスト間の独立性保証                  │ │
│  │ Repeatable - 実行環境に依存しない再現性             │ │
│  │ Self-Validating - 自己検証（パス/フェイル明確）     │ │
│  │ Timely    - コード変更と同期したテスト更新          │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  単体分離原則:                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ 外部依存のモック・スタブ化                        │ │
│  │ ├ ファイルI/O操作のメモリ化                         │ │
│  │ ├ ネットワーク通信の仮想化                          │ │
│  │ ├ 時間・ランダム値の固定化                          │ │
│  │ └ サイドエフェクトの完全制御                        │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  テストカバレッジ目標:                                  │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ライン カバレッジ: 90%以上                          │ │
│  │ ブランチカバレッジ: 85%以上                         │ │
│  │ 関数 カバレッジ: 95%以上                            │ │
│  │ 重要パス カバレッジ: 100%                           │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.2 ユニットテスト構造

```
┌─────────────────────────────────────────────────────────┐
│                ユニットテスト構造                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  test/unit/                                             │
│  ├── commands/               # コマンドロジック         │
│  │   ├── generate-framework-project.test.ts             │
│  │   ├── get-auth-text.test.ts                          │
│  │   ├── get-deployment-text.test.ts                    │
│  │   └── is-config-complete.test.ts                     │
│  ├── config/                 # 設定管理                 │
│  │   ├── categories.test.ts                             │
│  │   ├── database-configs.test.ts                       │
│  │   ├── framework-configs.test.ts                      │
│  │   └── package-versions.test.ts                       │
│  ├── generators/             # ジェネレーター            │
│  │   ├── auth-generator.test.ts                         │
│  │   ├── database-generator.test.ts                     │
│  │   ├── next-generator.test.ts                         │
│  │   └── storage-generator.test.ts                      │
│  ├── services/               # サービスアダプター        │
│  │   ├── aws-adapter.test.ts                            │
│  │   ├── service-factory.test.ts                        │
│  │   └── vercel-adapter.test.ts                         │
│  ├── utils/                  # ユーティリティ            │
│  │   ├── file-generation.test.ts                        │
│  │   ├── package-json.test.ts                           │
│  │   ├── slugify.test.ts                                │
│  │   └── template-reader.test.ts                        │
│  └── tauri/                  # Tauriサイドカー          │
│       └── sidecar.test.ts                               │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.3 ユニットテスト例

```typescript
┌─────────────────────────────────────────────────────────┐
│              ユニットテストサンプル                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  // test/unit/utils/slugify.test.ts                     │
│  import { describe, it, expect } from 'vitest';         │
│  import { slugify } from '../../../src/utils/slugify.js';│
│                                                         │
│  describe('slugify', () => {                            │
│    it('should convert spaces to hyphens', () => {       │
│      expect(slugify('my project')).toBe('my-project');  │
│    });                                                  │
│                                                         │
│    it('should handle special characters', () => {       │
│      expect(slugify('My Project!')).toBe('my-project'); │
│    });                                                  │
│                                                         │
│    it('should handle empty string', () => {             │
│      expect(slugify('')).toBe('');                      │
│    });                                                  │
│                                                         │
│    it('should handle unicode characters', () => {       │
│      expect(slugify('プロジェクト名')).toBe('');        │
│    });                                                  │
│  });                                                    │
│                                                         │
│  // test/unit/generators/next-generator.test.ts         │
│  import { describe, it, expect, vi, beforeEach } from   │
│         'vitest';                                       │
│  import { generateNextProject } from                    │
│    '../../../src/generators/next-generator.js';        │
│                                                         │
│  // ファイルシステムモック                               │
│  vi.mock('fs-extra', () => ({                           │
│    ensureDir: vi.fn(),                                  │
│    writeFile: vi.fn(),                                  │
│    copy: vi.fn()                                        │
│  }));                                                   │
│                                                         │
│  describe('generateNextProject', () => {                │
│    beforeEach(() => {                                   │
│      vi.clearAllMocks();                                │
│    });                                                  │
│                                                         │
│    it('should generate basic Next.js structure', () => {│
│      const config = {                                   │
│        projectName: 'test-app',                         │
│        projectPath: '/tmp/test-app',                    │
│        framework: 'nextjs' as const,                    │
│        // ... 他の設定                                  │
│      };                                                 │
│                                                         │
│      await generateNextProject(config);                 │
│                                                         │
│      expect(fs.ensureDir).toHaveBeenCalledWith(         │
│        '/tmp/test-app'                                  │
│      );                                                 │
│    });                                                  │
│  });                                                    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 4. 機能テスト（test/functional/）

### 4.1 機能テスト設計

```
┌─────────────────────────────────────────────────────────┐
│                  機能テスト設計                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  目的:                                                  │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ CLIコマンドの統合機能検証                         │ │
│  │ ├ 実際のファイル生成・操作の確認                    │ │
│  │ ├ コマンドオプションの動作検証                      │ │
│  │ ├ エラーハンドリングの確認                          │ │
│  │ └ プロセス間通信の検証                              │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  実行環境:                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ テンポラリディレクトリ使用                        │ │
│  │ ├ ファイルシステム実操作                            │ │
│  │ ├ 実際のCLI実行                                     │ │
│  │ ├ プロセス制御・監視                                │ │
│  │ └ 自動クリーンアップ                                │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  テストヘルパー活用:                                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ cli-runner.ts      # CLI実行ヘルパー             │ │
│  │ ├ temp-dir.ts        # 一時ディレクトリ管理         │ │
│  │ ├ project-generator.ts # プロジェクト生成ヘルパー   │ │
│  │ └ global-setup.ts    # グローバル設定              │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 4.2 機能テスト構造

```
┌─────────────────────────────────────────────────────────┐
│                機能テスト構造                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  test/functional/                                       │
│  └── cli/                    # CLIコマンドテスト        │
│      ├── create.test.ts      # createコマンド           │
│      ├── list.test.ts        # listコマンド            │
│      └── version.test.ts     # versionコマンド          │
│                                                         │
│  テストシナリオ例:                                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ create.test.ts:                                     │ │
│  │ ├ 基本的なプロジェクト生成                          │ │
│  │ ├ 各フレームワークオプション検証                    │ │
│  │ ├ データベース統合検証                              │ │
│  │ ├ 認証システム統合検証                              │ │
│  │ ├ エラーケース処理                                  │ │
│  │ └ ファイル出力検証                                  │ │
│  │                                                     │ │
│  │ list.test.ts:                                       │ │
│  │ ├ プロジェクト一覧表示                              │ │
│  │ ├ フィルタリング機能                                │ │
│  │ └ 出力フォーマット検証                              │ │
│  │                                                     │ │
│  │ version.test.ts:                                    │ │
│  │ ├ バージョン情報表示                                │ │
│  │ ├ package.json整合性                                │ │
│  │ └ 依存関係バージョン確認                            │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 4.3 機能テスト例

```typescript
┌─────────────────────────────────────────────────────────┐
│               機能テストサンプル                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  // test/functional/cli/create.test.ts                  │
│  import { describe, it, expect, beforeEach, afterEach } │
│         from 'vitest';                                  │
│  import { runCli } from '../../helpers/cli-runner.js';  │
│  import { createTempDir, cleanupTempDir } from          │
│         '../../helpers/temp-dir.js';                    │
│  import fs from 'fs-extra';                             │
│                                                         │
│  describe('create command', () => {                     │
│    let tempDir: string;                                 │
│                                                         │
│    beforeEach(async () => {                             │
│      tempDir = await createTempDir();                   │
│    });                                                  │
│                                                         │
│    afterEach(async () => {                              │
│      await cleanupTempDir(tempDir);                     │
│    });                                                  │
│                                                         │
│    it('should create Next.js project', async () => {   │
│      const result = await runCli([                      │
│        'create',                                        │
│        '--name', 'test-app',                            │
│        '--path', tempDir,                               │
│        '--framework', 'nextjs',                         │
│        '--database', 'none',                            │
│        '--storage', 'none',                             │
│        '--package-manager', 'pnpm',                     │
│        '--no-auth',                                     │
│        '--no-deployment'                                │
│      ]);                                                │
│                                                         │
│      expect(result.exitCode).toBe(0);                   │
│      expect(result.stdout).toContain('生成完了');       │
│                                                         │
│      // 生成されたファイルの検証                        │
│      const projectPath = path.join(tempDir, 'test-app');│
│      expect(await fs.pathExists(                        │
│        path.join(projectPath, 'package.json')           │
│      )).toBe(true);                                     │
│      expect(await fs.pathExists(                        │
│        path.join(projectPath, 'next.config.mjs')        │
│      )).toBe(true);                                     │
│                                                         │
│      // package.jsonの内容検証                          │
│      const packageJson = await fs.readJson(             │
│        path.join(projectPath, 'package.json')           │
│      );                                                 │
│      expect(packageJson.name).toBe('test-app');         │
│      expect(packageJson.dependencies.next).toBeDefined();│
│    });                                                  │
│                                                         │
│    it('should handle invalid framework', async () => {  │
│      const result = await runCli([                      │
│        'create',                                        │
│        '--framework', 'invalid'                         │
│      ]);                                                │
│                                                         │
│      expect(result.exitCode).toBe(1);                   │
│      expect(result.stderr).toContain('Invalid framework');│
│    });                                                  │
│  });                                                    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 5. シナリオテスト（test/scenario/）

### 5.1 シナリオテスト設計

```
┌─────────────────────────────────────────────────────────┐
│                シナリオテスト設計                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  目的:                                                  │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ エンドツーエンドのプロジェクト生成                │ │
│  │ ├ 実際の依存関係インストール検証                    │ │
│  │ ├ 生成プロジェクトの起動確認                        │ │
│  │ ├ ビルド・デプロイプロセス確認                      │ │
│  │ └ 実環境での動作保証                                │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  実行特性:                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ 実行時間: 数分（依存関係インストール含む）        │ │
│  │ ├ 実行頻度: CI/CD・リリース前                       │ │
│  │ ├ 並列度: シーケンシャル実行（リソース競合回避）    │ │
│  │ ├ タイムアウト: 5分                                 │ │
│  │ └ クリーンアップ: 完全自動化                        │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  検証項目:                                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ プロジェクト生成成功                              │ │
│  │ ├ package.json依存関係整合性                        │ │
│  │ ├ TypeScript型チェック通過                          │ │
│  │ ├ Lint・フォーマットルール準拠                      │ │
│  │ ├ 開発サーバー起動確認                              │ │
│  │ ├ ビルドプロセス成功                                │ │
│  │ └ 基本機能動作確認                                  │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 5.2 シナリオテスト構造

```
┌─────────────────────────────────────────────────────────┐
│               シナリオテスト構造                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  test/scenario/                                         │
│  ├── nextjs/                 # Next.jsシナリオ         │
│  │   └── nextjs.test.ts                                 │
│  ├── expo/                   # Expoシナリオ            │
│  │   └── expo.test.ts                                   │
│  ├── tauri/                  # Tauriシナリオ           │
│  │   └── tauri.test.ts                                  │
│  └── flutter/                # Flutterシナリオ         │
│      └── flutter.test.ts                               │
│                                                         │
│  シナリオフロー例（Next.js）:                           │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 1. プロジェクト生成                                 │ │
│  │    └ フルオプション指定での生成                     │ │
│  │                                                     │ │
│  │ 2. 依存関係インストール                             │ │
│  │    └ pnpm install 実行・成功確認                    │ │
│  │                                                     │ │
│  │ 3. 型チェック・Lint                                 │ │
│  │    ├ TypeScript型チェック                           │ │
│  │    └ ESLint・Prettier検証                           │ │
│  │                                                     │ │
│  │ 4. 開発サーバー起動                                 │ │
│  │    ├ pnpm dev バックグラウンド実行                  │ │
│  │    ├ ポート応答確認                                 │ │
│  │    └ 適切な終了処理                                 │ │
│  │                                                     │ │
│  │ 5. ビルド検証                                       │ │
│  │    ├ pnpm build 実行                                │ │
│  │    ├ 出力ファイル確認                               │ │
│  │    └ 最適化・圧縮確認                               │ │
│  │                                                     │ │
│  │ 6. 機能統合検証                                     │ │
│  │    ├ データベース接続（設定時）                     │ │
│  │    ├ 認証フロー（設定時）                           │ │
│  │    └ ストレージアクセス（設定時）                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 5.3 シナリオテスト例

```typescript
┌─────────────────────────────────────────────────────────┐
│              シナリオテストサンプル                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  // test/scenario/nextjs/nextjs.test.ts                 │
│  import { describe, it, expect, beforeAll, afterAll }   │
│         from 'vitest';                                  │
│  import { generateProject } from                        │
│         '../../helpers/project-generator.js';           │
│  import { execa } from 'execa';                         │
│  import fs from 'fs-extra';                             │
│  import path from 'path';                               │
│                                                         │
│  describe('Next.js project scenario', () => {           │
│    let projectPath: string;                             │
│    let cleanupFn: () => Promise<void>;                  │
│                                                         │
│    beforeAll(async () => {                              │
│      const result = await generateProject({             │
│        framework: 'nextjs',                             │
│        database: 'turso',                               │
│        orm: 'drizzle',                                  │
│        auth: true,                                      │
│        storage: 'vercel-blob',                          │
│        deployment: true                                 │
│      });                                                │
│                                                         │
│      projectPath = result.path;                         │
│      cleanupFn = result.cleanup;                        │
│    }, 120000); // 2分タイムアウト                       │
│                                                         │
│    afterAll(async () => {                               │
│      await cleanupFn();                                 │
│    });                                                  │
│                                                         │
│    it('should install dependencies successfully',       │
│       async () => {                                     │
│      const result = await execa('pnpm', ['install'], {  │
│        cwd: projectPath,                                │
│        stdio: 'pipe'                                    │
│      });                                                │
│                                                         │
│      expect(result.exitCode).toBe(0);                   │
│      expect(await fs.pathExists(                        │
│        path.join(projectPath, 'node_modules')           │
│      )).toBe(true);                                     │
│    }, 180000); // 3分タイムアウト                       │
│                                                         │
│    it('should pass TypeScript check', async () => {     │
│      const result = await execa('pnpm', ['build'], {    │
│        cwd: projectPath,                                │
│        stdio: 'pipe'                                    │
│      });                                                │
│                                                         │
│      expect(result.exitCode).toBe(0);                   │
│      expect(result.stdout).toContain('Compiled');       │
│    }, 120000);                                          │
│                                                         │
│    it('should start dev server', async () => {          │
│      const devProcess = execa('pnpm', ['dev'], {        │
│        cwd: projectPath,                                │
│        stdio: 'pipe'                                    │
│      });                                                │
│                                                         │
│      // サーバー起動待機                                │
│      await new Promise(resolve => setTimeout(resolve,   │
│                                   10000));              │
│                                                         │
│      // ポート応答確認                                  │
│      const response = await fetch('http://localhost:3000');│
│      expect(response.status).toBe(200);                 │
│                                                         │
│      // プロセス終了                                    │
│      devProcess.kill('SIGTERM');                        │
│      await devProcess;                                  │
│    }, 60000);                                           │
│  });                                                    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 6. E2Eテスト（test/e2e/）

### 6.1 Playwright E2Eテスト

```
┌─────────────────────────────────────────────────────────┐
│                 Playwright E2Eテスト                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  目的:                                                  │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ ブラウザ自動化によるユーザーシナリオ検証          │ │
│  │ ├ 認証・CRUD・ストレージ機能のE2E確認               │ │
│  │ ├ クロスブラウザ互換性確認                          │ │
│  │ ├ パフォーマンス・アクセシビリティ検証              │ │
│  │ └ ビジュアル回帰テスト                              │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  設定（playwright.config.ts）:                         │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ browsers: Chrome, Firefox, Safari                   │ │
│  │ headless: true (CI), false (local debug)            │ │
│  │ timeout: 30秒                                       │ │
│  │ retries: 2回（CI環境）                              │ │
│  │ workers: 並列実行数                                 │ │
│  │ screenshot: failure時                               │ │
│  │ video: retain-on-failure                            │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  テスト構造:                                            │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ test/e2e/nextjs/                                    │ │
│  │ ├── auth.e2e.test.ts         # 認証フロー           │ │
│  │ ├── content.e2e.test.ts      # コンテンツ管理       │ │
│  │ ├── organization.e2e.test.ts # 組織・チーム機能     │ │
│  │ ├── storage.e2e.test.ts      # ストレージ操作       │ │
│  │ ├── users.e2e.test.ts        # ユーザー管理         │ │
│  │ ├── fixtures/                # テストデータ         │ │
│  │ │   └── project.ts                                  │ │
│  │ └── utils.ts                 # E2Eヘルパー          │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 6.2 E2Eテスト例

```typescript
┌─────────────────────────────────────────────────────────┐
│                 E2Eテストサンプル                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  // test/e2e/nextjs/auth.e2e.test.ts                    │
│  import { test, expect } from '@playwright/test';       │
│  import { setupProject } from './fixtures/project.js';  │
│                                                         │
│  test.describe('Authentication Flow', () => {           │
│    test.beforeEach(async ({ page }) => {                │
│      await setupProject();                              │
│      await page.goto('http://localhost:3000');          │
│    });                                                  │
│                                                         │
│    test('should login with email and password',         │
│          async ({ page }) => {                          │
│      // ログインページに移動                            │
│      await page.click('[data-testid="login-button"]');  │
│                                                         │
│      // フォーム入力                                    │
│      await page.fill('[data-testid="email"]',           │
│                     'test@example.com');               │
│      await page.fill('[data-testid="password"]',        │
│                     'password123');                    │
│                                                         │
│      // ログイン実行                                    │
│      await page.click('[data-testid="submit"]');        │
│                                                         │
│      // ダッシュボードページに遷移                      │
│      await expect(page).toHaveURL('/dashboard');        │
│      await expect(page.locator('[data-testid="user-menu"]'))│
│        .toBeVisible();                                  │
│    });                                                  │
│                                                         │
│    test('should handle login error', async ({ page }) => {│
│      await page.click('[data-testid="login-button"]');  │
│      await page.fill('[data-testid="email"]',           │
│                     'invalid@example.com');            │
│      await page.fill('[data-testid="password"]',        │
│                     'wrongpassword');                  │
│      await page.click('[data-testid="submit"]');        │
│                                                         │
│      // エラーメッセージ表示確認                        │
│      await expect(page.locator('[data-testid="error"]'))│
│        .toContainText('Invalid credentials');           │
│    });                                                  │
│                                                         │
│    test('should logout successfully', async ({ page }) => {│
│      // ログイン状態のセットアップ                      │
│      await login(page, 'test@example.com', 'password123');│
│                                                         │
│      // ログアウト                                      │
│      await page.click('[data-testid="user-menu"]');     │
│      await page.click('[data-testid="logout"]');        │
│                                                         │
│      // ホームページに戻る                              │
│      await expect(page).toHaveURL('/');                 │
│      await expect(page.locator('[data-testid="login-button"]'))│
│        .toBeVisible();                                  │
│    });                                                  │
│  });                                                    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 7. テストヘルパー・ユーティリティ

### 7.1 共通テストヘルパー

```
┌─────────────────────────────────────────────────────────┐
│                共通テストヘルパー                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  test/helpers/                                          │
│  ├── cli-runner.ts           # CLI実行ヘルパー         │
│  ├── temp-dir.ts             # 一時ディレクトリ管理     │
│  ├── project-generator.ts    # プロジェクト生成ヘルパー │
│  └── global-setup.ts         # グローバルセットアップ   │
│                                                         │
│  cli-runner.ts 機能:                                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ export async function runCli(                       │ │
│  │   args: string[],                                   │ │
│  │   options?: {                                       │ │
│  │     cwd?: string;                                   │ │
│  │     env?: Record<string, string>;                   │ │
│  │     timeout?: number;                               │ │
│  │   }                                                 │ │
│  │ ): Promise<{                                        │ │
│  │   exitCode: number;                                 │ │
│  │   stdout: string;                                   │ │
│  │   stderr: string;                                   │ │
│  │   duration: number;                                 │ │
│  │ }> {                                                │ │
│  │   const startTime = Date.now();                     │ │
│  │   const result = await execa('node',                │ │
│  │     ['dist/cli.js', ...args], {                     │ │
│  │       cwd: options?.cwd,                            │ │
│  │       env: { ...process.env, ...options?.env },     │ │
│  │       timeout: options?.timeout || 30000,           │ │
│  │       reject: false                                 │ │
│  │     });                                             │ │
│  │                                                     │ │
│  │   return {                                          │ │
│  │     exitCode: result.exitCode || 0,                 │ │
│  │     stdout: result.stdout || '',                    │ │
│  │     stderr: result.stderr || '',                    │ │
│  │     duration: Date.now() - startTime                │ │
│  │   };                                                │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  temp-dir.ts 機能:                                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ export async function createTempDir(                │ │
│  │   prefix = 'fluorite-test-'                         │ │
│  │ ): Promise<string> {                                │ │
│  │   const tempDir = await fs.mkdtemp(                 │ │
│  │     path.join(os.tmpdir(), prefix)                  │ │
│  │   );                                                │ │
│  │   return tempDir;                                   │ │
│  │ }                                                   │ │
│  │                                                     │ │
│  │ export async function cleanupTempDir(               │ │
│  │   dirPath: string                                   │ │
│  │ ): Promise<void> {                                  │ │
│  │   if (await fs.pathExists(dirPath)) {               │ │
│  │     await fs.remove(dirPath);                       │ │
│  │   }                                                 │ │
│  │ }                                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 8. CI/CD統合

### 8.1 GitHub Actions統合

```yaml
┌─────────────────────────────────────────────────────────┐
│               GitHub Actions統合例                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  name: Test Suite                                       │
│                                                         │
│  on:                                                    │
│    push:                                                │
│      branches: [main, develop]                          │
│    pull_request:                                        │
│      branches: [main]                                   │
│                                                         │
│  jobs:                                                  │
│    test:                                                │
│      runs-on: ubuntu-latest                             │
│      strategy:                                          │
│        matrix:                                          │
│          node-version: [18, 20]                         │
│                                                         │
│      steps:                                             │
│        - uses: actions/checkout@v4                      │
│                                                         │
│        - name: Setup Node.js                            │
│          uses: actions/setup-node@v4                    │
│          with:                                          │
│            node-version: ${{ matrix.node-version }}     │
│            cache: 'pnpm'                                │
│                                                         │
│        - name: Install dependencies                     │
│          run: pnpm install                              │
│                                                         │
│        - name: Build project                            │
│          run: pnpm build                                │
│                                                         │
│        - name: Run unit tests                           │
│          run: pnpm test:unit                            │
│                                                         │
│        - name: Run functional tests                     │
│          run: pnpm test:functional                      │
│                                                         │
│        - name: Run scenario tests                       │
│          run: pnpm test:scenario                        │
│          if: matrix.node-version == 20                  │
│                                                         │
│        - name: Upload coverage                          │
│          uses: codecov/codecov-action@v3                │
│          if: matrix.node-version == 20                  │
│                                                         │
│    e2e:                                                 │
│      runs-on: ubuntu-latest                             │
│      if: github.event_name == 'pull_request'            │
│                                                         │
│      steps:                                             │
│        - uses: actions/checkout@v4                      │
│        - uses: actions/setup-node@v4                    │
│        - name: Install dependencies                     │
│          run: pnpm install                              │
│        - name: Install Playwright                       │
│          run: npx playwright install                    │
│        - name: Run E2E tests                            │
│          run: pnpm test:e2e                             │
│        - name: Upload test results                      │
│          uses: actions/upload-artifact@v3               │
│          if: failure()                                  │
│          with:                                          │
│            name: playwright-report                      │
│            path: playwright-report/                     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 9. 品質メトリクス・レポート

### 9.1 品質目標・KPI

```
┌─────────────────────────────────────────────────────────┐
│                   品質目標・KPI                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  コードカバレッジ目標:                                  │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ ラインカバレッジ: 90%以上                         │ │
│  │ ├ ブランチカバレッジ: 85%以上                       │ │
│  │ ├ 関数カバレッジ: 95%以上                           │ │
│  │ └ 重要パスカバレッジ: 100%                          │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  パフォーマンス目標:                                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ ユニットテスト: <100ms/test                       │ │
│  │ ├ 機能テスト: <30秒                                 │ │
│  │ ├ シナリオテスト: <5分                              │ │
│  │ ├ E2Eテスト: <30分                                  │ │
│  │ └ 全テストスイート: <45分                           │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  信頼性目標:                                            │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ テスト成功率: 99%以上                             │ │
│  │ ├ フレーク率: <1%                                   │ │
│  │ ├ 回帰率: <0.5%                                     │ │
│  │ └ 自動化率: 95%以上                                 │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  リリース品質:                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ ├ ゼロダウンタイムデプロイ                          │ │
│  │ ├ 自動ロールバック機能                              │ │
│  │ ├ 包括的回帰テスト                                  │ │
│  │ └ ユーザー受け入れテスト                            │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

*次章: [06_ユーティリティ](./06_ユーティリティ.md)*